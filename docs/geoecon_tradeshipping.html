<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Kuantara – Trade & Shipping</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Fira Code -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;700&display=swap">

  <style>
    :root {
      --amber:#ffbf00;
      --bg-root:#000000;
      --bg-main:#111111;
      --border-soft:#2b2b2b;
      --text-main:#f5f5f5;
      --text-muted:#9b9b9b;
      --chip-bg:#111111;
      --pos:#22c55e;
      --neg:#ef4444;
    }

    *{
      box-sizing:border-box;
      margin:0;
      padding:0;
      font-family:"Fira Code",monospace!important;
      scrollbar-width:thin;
      scrollbar-color:#333 #000;
    }
    *::-webkit-scrollbar{
      width:6px;
      height:6px;
    }
    *::-webkit-scrollbar-track{
      background:#000;
    }
    *::-webkit-scrollbar-thumb{
      background:#333;
      border-radius:3px;
    }

    html,body{
      width:100%;
      height:100%;
      background-color:var(--bg-root);
      color:var(--text-main);
    }

    body{
      padding:16px;
      display:flex;
      flex-direction:column;
    }

    /* ROW: 1/4 + 3/4 layout */
    .panel-row{
      flex:1;
      display:flex;
      flex-direction:row;
      gap:12px;
      min-height:0;
      width:100%;
    }

    .panel-card{
      background:var(--bg-main);
      border-radius:4px;
      border:1px solid var(--border-soft);
      padding:16px;
      display:flex;
      flex-direction:column;
      overflow:hidden;
      min-height:0;
    }

    .snapshot-panel{
      flex:1;         /* 1/4 */
      max-width:420px;
      min-width:240px;
      overflow-y:auto;
    }

    .map-panel{
      flex:3;         /* 3/4 */
      min-width:0;
    }

    /* --- Market Snapshot content --- */
    .section-header{
      margin-bottom:10px;
    }
    .section-label{
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:0.12em;
      color:var(--text-muted);
      display:block;
      margin-bottom:4px;
    }
    .section-header h2{
      font-size:14px;
      font-weight:700;
      color:var(--amber);
    }

    .asset-grid{
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .asset-card{
      padding:12px;
      border-radius:4px;
      border:1px solid var(--border-soft);
      background:#111111;
      display:flex;
      flex-direction:column;
      gap:4px;
      transition:border-color 0.15s, background 0.15s;
    }
    .asset-card:hover{
      border-color:#444;
      background:#141414;
    }

    .asset-card-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:2px;
    }
    .ticker{
      font-size:12px;
      font-weight:700;
      color:var(--amber);
    }
    .exchange{
      font-size:9px;
      color:var(--text-muted);
      opacity:0.7;
    }
    .asset-name{
      font-size:11px;
      font-weight:500;
      line-height:1.3;
    }
    .asset-desc{
      font-size:10px;
      color:var(--text-muted);
      margin-bottom:4px;
      line-height:1.3;
    }

    .asset-meta-row{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      margin-top:4px;
      border-top:1px solid #202020;
      padding-top:6px;
      gap:8px;
    }

    .chip{
      padding:2px 6px;
      border-radius:4px;
      background:var(--chip-bg);
      border:1px solid #2b2b2b;
      font-size:9px;
      color:#d0d0d0;
    }

    .price-block{
      text-align:right;
      font-size:9px;
      line-height:1.3;
    }
    .price-main{
      display:block;
      font-size:12px;
      font-weight:600;
      color:#ffffff;
    }
    .price-line{
      display:flex;
      justify-content:flex-end;
      gap:4px;
    }
    .price-label{
      color:var(--text-muted);
    }
    .pos{color:var(--pos);}
    .neg{color:var(--neg);}

    .panel-note{
      margin-top:10px;
      padding:8px;
      background:#080808;
      border:1px dashed #333;
      border-radius:4px;
      font-size:9px;
      color:var(--text-muted);
      line-height:1.4;
    }

    /* --- Map content --- */
    .map-header{
      margin-bottom:8px;
    }
    .map-title{
      font-size:12px;
      font-weight:600;
      color:var(--amber);
    }
    .map-sub{
      font-size:10px;
      color:var(--text-muted);
    }

    .map-wrapper{
      position:relative;
      width:100%;
      height:100%;
      min-height:320px;   /* ukuran map dipertahankan */
      border-radius:4px;
      overflow:hidden;
      border:1px solid var(--border-soft);
      background:#000000;
      margin-top:6px;
    }

    /* Overlay mini quote stack (dummy) */
    .map-stats{
      position:absolute;
      top:6px;
      right:6px;
      z-index:60;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .map-stat-card{
      background:rgba(17,17,17,0.95);
      border:1px solid var(--border-soft);
      border-radius:4px;
      padding:6px 8px;
      min-width:150px;
      box-shadow:0 0 10px rgba(0,0,0,0.6);
    }
    .map-stat-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:2px;
    }
    .map-stat-ticker{
      font-size:10px;
      color:var(--amber);
      font-weight:600;
    }
    .map-stat-label{
      font-size:9px;
      color:var(--text-muted);
    }
    .map-stat-price{
      font-size:11px;
      font-weight:600;
    }
    .map-stat-change{
      font-size:9px;
      display:flex;
      justify-content:space-between;
      gap:6px;
      margin-top:1px;
    }

    /* Header blocker */
    .vf-header-blocker{
      position:absolute;
      top:0;
      left:0;
      width:100%;
      height:22px;
      background-color:#000000;
      z-index:50;
      display:flex;
      align-items:center;
      justify-content:center;
      border-bottom:1px solid var(--border-soft);
      pointer-events:auto;
    }
    .vf-header-blocker::after{
      content:"LIVE AIS FEED • REALTIME TRACKING";
      font-size:9px;
      font-weight:600;
      color:#333333;
      letter-spacing:0.2em;
    }

    /* Footer blocker */
    .vf-footer-blocker{
      position:absolute;
      bottom:0;
      left:0;
      width:100%;
      height:25px;
      background-color:#000000;
      z-index:50;
      border-top:1px solid #1a1a1a;
      pointer-events:auto;
    }

    .map-wrapper iframe{
      position:absolute !important;
      top:0 !important;
      left:0 !important;
      width:100% !important;
      height:100% !important;
      border:none !important;
      z-index:1;
    }

    /* Mobile: stack vertical */
    @media (max-width:900px){
      .panel-row{
        flex-direction:column;
      }
      .snapshot-panel{
        max-width:100%;
      }
      .map-panel{
        min-height:360px;
      }
    }

    @media (max-width:600px){
      body{
        padding:12px;
      }
      .panel-card{
        padding:12px;
      }
    }
  </style>
</head>
<body>

  <div class="panel-row">
    <!-- PANEL 1: Market Snapshot (1/4) -->
    <div class="panel-card snapshot-panel">
      <div class="section-header">
        <span class="section-label">Market Snapshot</span>
        <h2>Shipping Rates</h2>
      </div>

      <div class="asset-grid">
        <!-- BDI -->
        <article class="asset-card" data-key="BDI">
          <div class="asset-card-header">
            <span class="ticker">BDI</span>
            <span class="exchange">INDEX</span>
          </div>
          <div class="asset-name">Baltic Dry Index</div>
          <div class="asset-desc">Benchmark for dry bulk shipping raw materials.</div>
          <div class="asset-meta-row">
            <span class="chip">Macro</span>
            <div class="price-block">
              <span class="price-main" id="price-BDI">--</span>
              <div class="price-line">
                <span class="price-label">D:</span>
                <span id="dchg-BDI" class="">--</span>
                <span class="price-label">Y:</span>
                <span id="ychg-BDI" class="">--</span>
              </div>
            </div>
          </div>
        </article>

        <!-- BDRY -->
        <article class="asset-card" data-key="BDRY">
          <div class="asset-card-header">
            <span class="ticker">BDRY</span>
            <span class="exchange">ETF</span>
          </div>
          <div class="asset-name">Breakwave Dry Bulk</div>
          <div class="asset-desc">Futures exposure to dry freight rates.</div>
          <div class="asset-meta-row">
            <span class="chip">Dry Bulk</span>
            <div class="price-block">
              <span class="price-main" id="price-BDRY">--</span>
              <div class="price-line">
                <span class="price-label">D:</span>
                <span id="dchg-BDRY" class="">--</span>
                <span class="price-label">Y:</span>
                <span id="ychg-BDRY" class="">--</span>
              </div>
            </div>
          </div>
        </article>

        <!-- SEA -->
        <article class="asset-card" data-key="SEA">
          <div class="asset-card-header">
            <span class="ticker">SEA</span>
            <span class="exchange">ETF</span>
          </div>
          <div class="asset-name">US Global Sea to Sky</div>
          <div class="asset-desc">Global cargo & logistics demand proxy.</div>
          <div class="asset-meta-row">
            <span class="chip">Logistics</span>
            <div class="price-block">
              <span class="price-main" id="price-SEA">--</span>
              <div class="price-line">
                <span class="price-label">D:</span>
                <span id="dchg-SEA" class="">--</span>
                <span class="price-label">Y:</span>
                <span id="ychg-SEA" class="">--</span>
              </div>
            </div>
          </div>
        </article>

        <!-- BOAT -->
        <article class="asset-card" data-key="BOAT">
          <div class="asset-card-header">
            <span class="ticker">BOAT</span>
            <span class="exchange">ETF</span>
          </div>
          <div class="asset-name">SonicShares Shipping</div>
          <div class="asset-desc">Broad maritime shipping equity exposure.</div>
          <div class="asset-meta-row">
            <span class="chip">Equities</span>
            <div class="price-block">
              <span class="price-main" id="price-BOAT">--</span>
              <div class="price-line">
                <span class="price-label">D:</span>
                <span id="dchg-BOAT" class="">--</span>
                <span class="price-label">Y:</span>
                <span id="ychg-BOAT" class="">--</span>
              </div>
            </div>
          </div>
        </article>
      </div>

      <div class="panel-note" id="statusNote">
        &gt; SYSTEM STATUS: INIT<br>
        &gt; DATA FEED: Connecting to Kuantara TradingView REST…
      </div>
    </div>

    <!-- PANEL 2: Map (3/4) -->
    <div class="panel-card map-panel">
      <div class="map-header">
        <div class="map-title">Shipping Traffic</div>
        <div class="map-sub">Live AIS Positioning Data</div>
      </div>

      <div class="map-wrapper" id="vf-map">
        <!-- Top blocker -->
        <div class="vf-header-blocker"></div>
        <!-- Bottom blocker -->
        <div class="vf-footer-blocker"></div>

        <!-- VesselFinder embed -->
        <script type="text/javascript">
          var width = "100%";
          var height = "100%";
          var latitude = "36.00";
          var longitude = "-5.40";
          var zoom = "9";
          var names = true;

          var mmsi = "";
          var imo = "";
          var show_track = false;
          var fleet = "";
          var fleet_name = "";
          var fleet_timespan = "1440";
        </script>
        <script type="text/javascript" src="https://www.vesselfinder.com/aismap.js"></script>
        <iframe name="vesselfinder" id="vesselfinder" width="100%" height="400" frameborder="0"
                src="https://www.vesselfinder.com/aismap?zoom=9&lat=36.00&lon=-5.40&width=100%25&height=400&names=true&track=false&fleet=&fleet_name=&fleet_timespan=1440&fleet_hide_old_positions=false&clicktoact=false&store_pos=true">
          Browser does not support embedded objects.<br/>
          Visit directly <a href="https://www.vesselfinder.com" target="_blank">www.vesselfinder.com</a>
        </iframe>
      </div>
    </div>
  </div>

<script>
  // ================================
  // 1) CONFIG – Kuantara TV REST API
  // ================================
  const BASE_URL = "https://kuancloud.loclx.io";

  // mapping kartu -> TradingView symbol
  const SNAPSHOT_CONFIG = {
    BDI:  { tvSymbol: "INDEX:BDI" },          // sesuaikan dengan backend-mu
    BDRY: { tvSymbol: "AMEX:BDRY" },
    SEA:  { tvSymbol: "AMEX:SEA" },
    BOAT: { tvSymbol: "AMEX:BOAT" }
  };

  const INTERVAL = "1D";      // daily bars
  const BARS_COUNT = 260;     // ~1Y trading days

  // ==========================
  // 2) Helper number + format
  // ==========================
  function formatNum(x, d = 2) {
    if (x == null || !isFinite(x)) return "--";
    return Number(x).toFixed(d);
  }
  function formatPct(x) {
    if (x == null || !isFinite(x)) return "--";
    const v = Number(x);
    const sign = v > 0 ? "+" : v < 0 ? "" : "";
    return sign + v.toFixed(2) + "%";
  }

  // ==========================
  // 3) Fetch OHLCV dari TV API
  // ==========================
  async function fetchOhlcv(tvSymbol) {
    const url = `${BASE_URL}/api/tvohlc/ohlcv?symbol=${encodeURIComponent(tvSymbol)}&interval=${encodeURIComponent(INTERVAL)}&bars_count=${BARS_COUNT}`;
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);

    const json = await res.json();
    const rec = (json.results || []).find(r => r.symbol === tvSymbol) || (json.results || [])[0];
    if (!rec || !rec.bars || !rec.bars.length) throw new Error("No bars");
    return rec.bars;
  }

  // hitung daily & yearly change (%) dari deret close
  function calcChanges(bars) {
    if (!bars.length) return { last: null, dChg: null, yChg: null };

    const closes = bars.map(b => Number(b.close));
    const lastIdx = closes.length - 1;
    const last = closes[lastIdx];
    const prev = closes[lastIdx - 1] ?? last;

    const daily = prev ? ((last / prev) - 1) * 100 : null;

    // yearly: pakai bar ~252 hari yang lalu kalau ada
    const baseIdx = Math.max(0, closes.length - 252);
    const base = closes[baseIdx];
    const yearly = base ? ((last / base) - 1) * 100 : null;

    return { last, dChg: daily, yChg: yearly };
  }

  // ==========================
  // 4) Update DOM satu kartu
  // ==========================
  function updateCard(key, data) {
    const priceEl = document.getElementById(`price-${key}`);
    const dEl     = document.getElementById(`dchg-${key}`);
    const yEl     = document.getElementById(`ychg-${key}`);

    if (!priceEl || !dEl || !yEl) return;

    const { last, dChg, yChg } = data;

    priceEl.textContent = formatNum(last);

    function setChange(el, val) {
      el.classList.remove("pos","neg");
      const txt = formatPct(val);
      el.textContent = txt;
      if (val > 0) el.classList.add("pos");
      else if (val < 0) el.classList.add("neg");
    }

    setChange(dEl, dChg);
    setChange(yEl, yChg);
  }

  // ==========================
  // 5) Main loader
  // ==========================
  async function refreshSnapshots() {
    const statusEl = document.getElementById("statusNote");
    statusEl.innerHTML = "&gt; SYSTEM STATUS: LOADING…<br>&gt; DATA FEED: /api/tvohlc/ohlcv (daily)";

    let ok = 0;
    let fail = 0;

    const entries = Object.entries(SNAPSHOT_CONFIG);

    await Promise.all(entries.map(async ([key, cfg]) => {
      try {
        const bars = await fetchOhlcv(cfg.tvSymbol);
        const changes = calcChanges(bars);
        updateCard(key, changes);
        ok++;
      } catch (err) {
        console.error("Snapshot error", key, err);
        fail++;
        // biarkan card tetap "--"
      }
    }));

    if (fail === 0) {
      statusEl.innerHTML =
        "&gt; SYSTEM STATUS: ONLINE<br>" +
        "&gt; DATA FEED: Kuantara TradingView REST (D 1D, ~1Y history)";
    } else if (ok > 0) {
      statusEl.innerHTML =
        `&gt; SYSTEM STATUS: PARTIAL (${ok} OK / ${fail} FAIL)<br>` +
        "&gt; DATA FEED: Check symbol mapping in SNAPSHOT_CONFIG.";
    } else {
      statusEl.innerHTML =
        "&gt; SYSTEM STATUS: ERROR<br>" +
        "&gt; DATA FEED: Cannot reach /api/tvohlc/ohlcv – verify backend.";
    }
  }

  // jalankan saat load
  document.addEventListener("DOMContentLoaded", () => {
    refreshSnapshots();
    // kalau mau auto-refresh tiap beberapa menit, aktifkan:
    // setInterval(refreshSnapshots, 300000); // 5 menit
  });
</script>

</body>
</html>
