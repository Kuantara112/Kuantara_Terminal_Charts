<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Kuantara – Central Bank Monitor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;600&display=swap">
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

  <style>
    :root {
      /* Palette Minimalis Dark Mode */
      --bg-body: #050505;
      --bg-panel: #0f0f0f;
      --border-color: #262626;
      --text-main: #e5e5e5;
      --text-muted: #737373;
      --accent: #d4d4d4; /* Putih redup untuk highlight */
      
      --font-stack: "Fira Code", monospace;
      --fs-sm: 11px;
      --fs-xs: 10px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }

    body {
      background: var(--bg-body);
      color: var(--text-main);
      font-family: var(--font-stack);
      height: 100vh;
      width: 100vw;
      overflow: hidden; /* Desktop: prevent body scroll */
      font-size: var(--fs-sm);
    }

    /* === Layout Grid Utama 2x2 (semua panel sama besar) === */
    .dashboard {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      gap: 8px;
      height: 100%;
      padding: 8px;
    }

    /* === Panel Styles === */
    .panel {
      background: var(--bg-panel);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      display: flex;
      flex-direction: column;
      overflow: hidden; /* Konten scroll di dalam body */
      min-width: 0;
      min-height: 0;
    }

    .panel-header {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--bg-panel);
      flex-shrink: 0;
      gap: 8px;
    }

    .panel-title {
      font-weight: 600;
      font-size: 12px;
      letter-spacing: -0.02em;
    }

    .panel-meta {
      font-size: var(--fs-xs);
      color: var(--text-muted);
      white-space: nowrap;
    }

    .panel-body {
      flex: 1;
      overflow: auto; /* Scrollable area */
      position: relative;
    }

    /* Scrollbar Styling */
    .panel-body::-webkit-scrollbar { width: 6px; height: 6px; }
    .panel-body::-webkit-scrollbar-track { background: var(--bg-panel); }
    .panel-body::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

    /* === Tabel Styling (Shared) === */
    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed; /* Penting untuk alignment */
    }

    th, td {
      padding: 8px 12px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    th {
      position: sticky;
      top: 0;
      background: var(--bg-panel);
      color: var(--text-muted);
      font-weight: 500;
      font-size: var(--fs-xs);
      z-index: 10;
      border-bottom: 1px solid var(--border-color);
    }

    tr:hover td { background: #1a1a1a; }
    
    .text-sub { font-size: 9px; color: var(--text-muted); display: block; margin-top: 2px; }
    .cb-name { font-weight: 500; color: #fff; }

    /* Lebar Kolom Tabel Kebijakan */
    .col-cb { width: 32%; }
    .col-rate { width: 23%; }
    .col-stance { width: 15%; }
    .col-meet { width: 20%; }
    .col-chg { width: 10%; text-align: right; }

    /* === Stance Tag === */
    .stance-tag {
      display: inline-block;
      font-size: 9px;
      padding: 1px 6px;
      border-radius: 3px;
      border: 1px solid #3a3a3a;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .stance-hawk {
      color: #ef5350;
      border-color: rgba(239, 83, 80, 0.7);
    }
    .stance-dove {
      color: #66bb6a;
      border-color: rgba(102, 187, 106, 0.7);
    }
    .stance-hold {
      color: var(--text-muted);
      border-color: #444;
    }

    /* === Chart View Only === */
    #chartView {
      width: 100%;
      height: 100%;
    }

    /* === Calendar Styling === */
    .cal-date { width: 80px; color: var(--text-muted); }
    .cal-cb { width: 50px; }
    .cal-event { width: auto; } /* Fluid */
    .cal-data { width: 60px; text-align: right; }

    .badge {
      font-size: 9px; padding: 1px 4px; border-radius: 3px; font-weight: 600;
    }
    .badge.us { color: #81c784; background: rgba(129, 199, 132, 0.1); }
    .badge.eu { color: #64b5f6; background: rgba(100, 181, 246, 0.1); }
    .badge.uk { color: #e57373; background: rgba(229, 115, 115, 0.1); }
    .badge.jp { color: #ffd54f; background: rgba(255, 213, 79, 0.1); }
    .badge.id { color: #ba68c8; background: rgba(186, 104, 200, 0.1); }
    .badge.ot { color: #90a4ae; background: rgba(144, 164, 174, 0.1); }

    /* === CB News List === */
    .news-list {
      padding: 8px 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .news-item {
      padding: 6px 0;
      border-bottom: 1px solid #181818;
    }
    .news-item:last-child {
      border-bottom: none;
    }
    .news-meta {
      font-size: 9px;
      color: var(--text-muted);
      margin-bottom: 2px;
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }
    .news-title {
      font-size: 11px;
      color: var(--text-main);
      white-space: normal;
    }

    /* Dropdown untuk topic CB (pakai struktur Fastbull) */
    .cb-topic-select {
      background: #050505;
      border: 1px solid var(--border-color);
      color: var(--text-main);
      font-size: 9px;
      padding: 3px 6px;
      border-radius: 3px;
      font-family: var(--font-stack);
      max-width: 220px;
      width: 100%;
      appearance: none;
      -moz-appearance: none;
      -webkit-appearance: none;
    }
    .cb-topic-select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(255,191,0,0.25);
    }
    .cb-topic-select optgroup {
      font-style: normal;
      color: var(--accent);
      background: #1a1a1a;
    }
    .cb-topic-select option {
      color: var(--text-main);
      background: #000000;
      padding: 3px 4px;
    }

    /* === RESPONSIVE === */
    @media (max-width: 900px) {
      body { overflow-y: auto; height: auto; } /* Allow main scroll on tablet/mobile */
      .dashboard {
        display: flex;
        flex-direction: column;
        height: auto;
        gap: 12px;
      }
      .panel { min-height: 320px; }
      #chartView { min-height: 240px; }
    }
  </style>
</head>
<body>

<div class="dashboard">
  <!-- TOP LEFT: POLICY RATES -->
  <section class="panel" id="panel-policy">
    <header class="panel-header">
      <div class="panel-title">Global Policy Rates</div>
      <div class="panel-meta" id="policy-status">Syncing...</div>
    </header>
    <div class="panel-body">
      <div style="min-width: 450px;">
        <table>
          <thead>
            <tr>
              <th class="col-cb">Central Bank</th>
              <th class="col-rate">Rate (ACT)</th>
              <th class="col-stance">Stance</th>
              <th class="col-meet">Next Meeting</th>
              <th class="col-chg">Chg (bps)</th>
            </tr>
          </thead>
          <tbody id="policy-body">
            <tr>
              <td colspan="5" style="text-align:center; padding:20px; color:#555;">
                Loading Fastbull Policy Rates...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- TOP RIGHT: INTEREST RATES TREND (ECharts) -->
  <section class="panel" id="panel-trend">
    <header class="panel-header">
      <div class="panel-title">Interest Rates Trend</div>
      <div class="panel-meta" id="trend-status">Syncing...</div>
    </header>
    <div class="panel-body">
      <div id="chartView"></div>
    </div>
  </section>

  <!-- BOTTOM LEFT: CENTRAL BANK 24/7 HEADLINES (pakai struktur topic Fastbull) -->
  <section class="panel" id="panel-news">
    <header class="panel-header">
      <div class="panel-title">Central Bank 24/7 Headlines</div>
      <div style="display:flex;align-items:center;gap:8px;min-width:0;">
        <select id="cb-topic-select" class="cb-topic-select">
          <option value="all_cb">Loading...</option>
        </select>
        <div class="panel-meta" id="cb-news-status">Syncing...</div>
      </div>
    </header>
    <div class="panel-body">
      <div class="news-list" id="cb-news-feed">
        <div style="padding:12px; font-size:10px; color:var(--text-muted);">
          Loading central bank headlines...
        </div>
      </div>
    </div>
  </section>

  <!-- BOTTOM RIGHT: 30-DAY CB CALENDAR -->
  <section class="panel" id="panel-calendar">
    <header class="panel-header">
      <div class="panel-title">30-Day Calendar</div>
      <div class="panel-meta" id="cal-status">Syncing...</div>
    </header>
    <div class="panel-body">
      <div id="calendar-view" style="min-width: 400px;">
        <table>
          <thead>
            <tr>
              <th class="cal-date">Date (UTC)</th>
              <th class="cal-cb">Bank</th>
              <th class="cal-event">Event</th>
              <th class="cal-data">Prev</th>
              <th class="cal-data">Fcst</th>
            </tr>
          </thead>
          <tbody id="calendar-body">
            <tr>
              <td colspan="5" style="text-align:center; padding:20px; color:#555;">
                Loading Fastbull Data...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>
</div>

<script>
  // === GLOBAL ECHARTS INSTANCE UNTUK TREND ===
  var trendChart = null;

  // --- Helper rate parsing (handle "3.75-4.0" jadi 3.75) ---
  function parseRateToNumber(rateStr) {
    if (!rateStr) return NaN;
    const firstPart = String(rateStr).split(/[-–]/)[0].trim();
    const val = parseFloat(firstPart);
    return val;
  }

  // === 1. POLICY RATES – getWebCentralBankInterestRate ===
  async function loadPolicyRates() {
    const tbody = document.getElementById('policy-body');
    const statusEl = document.getElementById('policy-status');

    tbody.innerHTML = `
      <tr>
        <td colspan="5" style="text-align:center; padding:10px; color:#555;">
          Loading Fastbull Policy Rates...
        </td>
      </tr>
    `;
    statusEl.textContent = "Syncing...";

    const url = "https://api.fastbull.com/fastbull-macro-data-service/api/getWebCentralBankInterestRate";

    try {
      const headers = {
        "Accept": "application/json, text/plain, */*",
        "lang": "en",
        "client-type": "Web",
        "client-version": "4.2.0",
        "version": "4",
        "timestamp": String(Date.now())
      };

      const res = await fetch(url, { headers });
      if (!res.ok) throw new Error("HTTP " + res.status);

      const json = await res.json();

      let list = [];
      if (Array.isArray(json.data)) {
        list = json.data;
      } else if (typeof json.bodyMessage === "string") {
        try {
          list = JSON.parse(json.bodyMessage);
        } catch (e) {
          console.error("Failed to parse bodyMessage:", e);
        }
      }

      if (!Array.isArray(list) || !list.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" style="text-align:center; padding:10px; color:#555;">
              No policy rate data.
            </td>
          </tr>
        `;
        statusEl.textContent = "No Data";
        return;
      }

      list.sort((a, b) => (a.bankId || 0) - (b.bankId || 0));

      tbody.innerHTML = "";

      list.forEach(item => {
        const bankName     = item.bankName || "Central Bank";
        const abbr         = item.abbreviation || "";
        const currentRate  = item.currentRate || "-";
        const lastRate     = item.lastRate || "-";
        const addRateStr   = item.addRate || "0";
        const addRateVal   = Number(addRateStr);
        const nextRate     = item.nextRate || "-";
        const cpiValue     = item.cpiValue || null;

        let stanceLabel = "Hold";
        let stanceClass = "stance-hold";

        if (!isNaN(addRateVal)) {
          if (addRateVal > 0) {
            stanceLabel = "Hawk";
            stanceClass = "stance-hawk";
          } else if (addRateVal < 0) {
            stanceLabel = "Dove";
            stanceClass = "stance-dove";
          }
        }

        const stanceSub =
          cpiValue != null
            ? `Inflation ~ ${cpiValue}%`
            : `Δ last rate: ${addRateStr} bps`;

        let nextMeetingHtml = "-";
        if (item.nextRateTime) {
          const tsMs = item.nextRateTime * 1000;
          const d = new Date(tsMs);
          if (!isNaN(d.getTime())) {
            const dayStr = d.toLocaleDateString("en-GB", {
              day: "2-digit",
              month: "short",
              year: "numeric"
            });
            const timeStr = d.toLocaleTimeString("en-GB", {
              hour: "2-digit",
              minute: "2-digit"
            });
            nextMeetingHtml = `
              ${dayStr}
              <span class="text-sub">Next Rate: ${nextRate} · ${timeStr} UTC</span>
            `;
          }
        }

        let chgColor = "var(--text-muted)";
        if (!isNaN(addRateVal)) {
          if (addRateVal > 0) chgColor = "#66bb6a";
          else if (addRateVal < 0) chgColor = "#ef5350";
        }

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>
            <span class="cb-name">${bankName}</span>
            <span class="text-sub">${abbr}</span>
          </td>
          <td>
            ${currentRate}
            <span class="text-sub">Last: ${lastRate}</span>
          </td>
          <td>
            <span class="stance-tag ${stanceClass}">${stanceLabel}</span>
            <span class="text-sub">${stanceSub}</span>
          </td>
          <td>
            ${nextMeetingHtml}
          </td>
          <td style="text-align:right; color:${chgColor};">
            ${isNaN(addRateVal) ? "-" : addRateVal}
          </td>
        `;
        tbody.appendChild(row);
      });

      statusEl.textContent = "Updated";
    } catch (err) {
      console.error(err);
      tbody.innerHTML = `
        <tr>
          <td colspan="5" style="text-align:center; padding:10px; color:#ef5350;">
            Failed to load policy rates. Check console / network.
          </td>
        </tr>
      `;
      statusEl.textContent = "Error";
    }
  }

  // === 2. INTEREST RATES TREND – getHistoryInterestRate per bank ===
  async function loadInterestTrend() {
    const status = document.getElementById("trend-status");
    const dom = document.getElementById("chartView");

    if (!trendChart) {
      trendChart = echarts.init(dom);
      window.addEventListener("resize", () => {
        if (trendChart) trendChart.resize();
      });
    }

    status.textContent = "Syncing...";

    const BANKS = [
      { id: 1, code: "FED", name: "Federal Reserve" },
      { id: 2, code: "ECB", name: "European Central Bank" },
      { id: 3, code: "BOE", name: "Bank of England" },
      { id: 4, code: "BOJ", name: "Bank of Japan" },
      { id: 5, code: "BOC", name: "Bank of Canada" },
      { id: 6, code: "RBA", name: "Reserve Bank of Australia" },
      { id: 7, code: "RBNZ", name: "Reserve Bank of New Zealand" },
      { id: 8, code: "SNB", name: "Swiss National Bank" }
    ];

    const BASE_URL = "https://api.fastbull.com/fastbull-macro-data-service/api/getHistoryInterestRate";
    const endTime = Date.now();

    // cutoff Oktober 2024 untuk SNB
    const SNB_CUTOFF_MS = Date.UTC(2024, 9, 1); // 1 Oct 2024 (month 9)

    async function fetchHistory(bank) {
      const url = `${BASE_URL}?bankId=${bank.id}&endTime=${endTime}&startTime=`;
      try {
        const headers = {
          "Accept": "application/json, text/plain, */*",
          "lang": "en",
          "client-type": "Web",
          "client-version": "4.2.0",
          "version": "4",
          "timestamp": String(Date.now())
        };

        const res = await fetch(url, { headers });
        if (!res.ok) throw new Error("HTTP " + res.status);

        const json = await res.json();
        let list = [];

        if (Array.isArray(json.data)) {
          list = json.data;
        } else if (typeof json.bodyMessage === "string") {
          try {
            list = JSON.parse(json.bodyMessage);
          } catch (e) {
            console.error("Failed to parse bodyMessage for bank", bank.id, e);
          }
        }

        if (!Array.isArray(list)) return [];

        let pts = list
          .map(row => {
            const t = (row.createTime || 0) * 1000;
            const rateStr = row.currentRate || row.predictionRate || row.lastRate;
            const val = parseRateToNumber(rateStr);
            if (!t || isNaN(val)) return null;
            return [t, val];
          })
          .filter(Boolean);

        // khusus SNB: buang data sebelum 1 Okt 2024
        if (bank.code === "SNB") {
          pts = pts.filter(([t]) => t >= SNB_CUTOFF_MS);
        }

        pts.sort((a, b) => a[0] - b[0]);
        return pts;
      } catch (err) {
        console.error("Failed to fetch history for bank", bank.id, err);
        return [];
      }
    }

    try {
      const allHistories = await Promise.all(BANKS.map(fetchHistory));

      const series = [];
      allHistories.forEach((pts, idx) => {
        if (!pts.length) return;
        const b = BANKS[idx];
        series.push({
          name: b.code,
          type: "line",
          showSymbol: false,
          smooth: true,
          data: pts
        });
      });

      if (!series.length) {
        trendChart.clear();
        trendChart.setOption({
          backgroundColor: "transparent",
          graphic: {
            type: "text",
            left: "center",
            top: "middle",
            style: {
              text: "No rate history data",
              fill: "#777",
              fontSize: 12
            }
          }
        });
        status.textContent = "No Data";
        return;
      }

      const option = {
        backgroundColor: "transparent",
        grid: { top: 32, right: 18, bottom: 30, left: 48 },
        tooltip: {
          trigger: "axis",
          axisPointer: { type: "line" },
          backgroundColor: "#111",
          borderColor: "#333",
          textStyle: { color: "#eee", fontSize: 10 },
          valueFormatter: v => (v == null ? "-" : v.toFixed(2) + "%")
        },
        legend: {
          top: 6,
          left: 40,
          textStyle: { color: "#bdbdbd", fontSize: 10 }
        },
        xAxis: {
          type: "time",
          axisLine: { lineStyle: { color: "#333" } },
          axisLabel: {
            color: "#777",
            fontSize: 10,
            formatter: value => {
              const d = new Date(value);
              return d.toLocaleDateString("en-GB", {
                month: "short",
                year: "2-digit"
              });
            }
          },
          splitLine: { lineStyle: { color: "#1a1a1a" } }
        },
        yAxis: {
          type: "value",
          axisLine: { lineStyle: { color: "#333" } },
          axisLabel: {
            color: "#777",
            fontSize: 10,
            formatter: value => value.toFixed(1) + "%"
          },
          splitLine: { lineStyle: { color: "#1a1a1a" } }
        },
        series
      };

      trendChart.setOption(option, true);
      status.textContent = "Updated";
    } catch (e) {
      console.error(e);
      trendChart.clear();
      trendChart.setOption({
        backgroundColor: "transparent",
        graphic: {
          type: "text",
          left: "center",
          top: "middle",
          style: {
            text: "Error loading interest rate trend",
            fill: "#ef5350",
            fontSize: 12
          }
        }
      });
      status.textContent = "Error";
    }
  }

  // === 3. Calendar Logic (Fastbull getInterestRateById per bank) ===
  async function loadCalendar() {
    const tbody  = document.getElementById('calendar-body');
    const status = document.getElementById('cal-status');

    tbody.innerHTML = `
      <tr>
        <td colspan="5" style="text-align:center; padding:10px; color:#555;">
          Loading Central Bank Schedules...
        </td>
      </tr>
    `;
    status.textContent = "Syncing...";

    const now    = Date.now();
    const future = now + 30 * 24 * 60 * 60 * 1000;

    const BANKS = [
      { id: 1, code: "FED", badge: "us" },
      { id: 2, code: "ECB", badge: "eu" },
      { id: 3, code: "BOE", badge: "uk" },
      { id: 4, code: "BOJ", badge: "jp" },
      { id: 5, code: "BOC", badge: "ot" },
      { id: 6, code: "RBA", badge: "ot" },
      { id: 7, code: "RBNZ", badge: "ot" },
      { id: 8, code: "SNB", badge: "ot" }
    ];

    const BASE_URL = "https://api.fastbull.com/fastbull-macro-data-service/api/getInterestRateById";

    async function fetchBankSchedules(bank) {
      const url = `${BASE_URL}?bankId=${bank.id}`;
      try {
        const headers = {
          "Accept": "application/json, text/plain, */*",
          "lang": "en",
          "client-type": "Web",
          "client-version": "4.2.0",
          "version": "4",
          "timestamp": String(Date.now())
        };

        const res = await fetch(url, { headers });
        if (!res.ok) throw new Error("HTTP " + res.status);

        const json = await res.json();
        if (typeof json.bodyMessage !== "string") return [];

        let inner;
        try {
          inner = JSON.parse(json.bodyMessage);
        } catch (e) {
          console.error("Failed to parse bodyMessage for bank", bank.id, e);
          return [];
        }

        const base   = inner.rateBaseModel || {};
        const detail = inner.scheduleDetailModels || [];

        const bankName  = base.bankName || bank.code;
        const abbr      = base.abbreviation || bank.code;
        const badge     = bank.badge;

        const events = [];

        detail.forEach(dayBlock => {
          const schedules = dayBlock.scheduleList || [];
          schedules.forEach(ev => {
            const ts = ev.startTime || ev.currentTime || 0;
            if (!ts) return;

            if (ts < now || ts > future) return;

            events.push({
              ts,
              localTime: ev.localTime || "",
              title: ev.events || "(No title)",
              bankCode: abbr,
              bankName,
              badgeClass: badge
            });
          });
        });

        return events;
      } catch (err) {
        console.error("Failed to fetch schedule for bank", bank.id, err);
        return [];
      }
    }

    try {
      const allLists = await Promise.all(BANKS.map(fetchBankSchedules));
      let allEvents = allLists.flat();

      allEvents.sort((a, b) => a.ts - b.ts);

      tbody.innerHTML = "";

      if (!allEvents.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" style="text-align:center; padding:10px; color:#555;">
              No central bank events within the next 30 days.
            </td>
          </tr>
        `;
        status.textContent = "Data Empty";
        return;
      }

      allEvents.forEach(ev => {
        const d = new Date(ev.ts);

        const day  = d.toLocaleDateString("en-GB", {
          day: "2-digit",
          month: "short"
        });
        const timeUtc = d.toISOString().slice(11, 16);

        const row = document.createElement("tr");
        row.innerHTML = `
          <td class="cal-date">
            ${day}
            <span style="font-size:8px; opacity:0.6; display:block;">${timeUtc} UTC</span>
          </td>
          <td class="cal-cb">
            <span class="badge ${ev.badgeClass}">${ev.bankCode}</span>
          </td>
          <td class="cal-event">
            ${ev.title}
            <span class="text-sub">${ev.bankName}</span>
          </td>
          <td class="cal-data text-sub">
            ${ev.localTime || "-"}
          </td>
          <td class="cal-data text-sub">
            -
          </td>
        `;
        tbody.appendChild(row);
      });

      status.textContent = "Updated";
    } catch (e) {
      console.error(e);
      tbody.innerHTML = `
        <tr>
          <td colspan="5" style="text-align:center; padding:10px; color:#ef5350;">
            API Load Failed. Check Console.
          </td>
        </tr>
      `;
      status.textContent = "Error";
    }
  }

  // === 4. FASTBULL TOPIC STRUCTURE (NEWS) ===
  const FASTBULL_NEWS_ENDPOINT = "https://api.fastbull.com/fastbull-news-service/api/getNewsPageByTagIds";
  const FASTBULL_NEWS_HEADERS = { 
    Accept: "application/json",
    "client-type": "4",
    clientversion: "latest",
    langid: "13"
  };
  const FASTBULL_CORS_PROXY = "https://api.allorigins.win/raw?url=";

  const FASTBULL_TAG_DATA = [
    {
      categoryName: "Highlights",
      tagList: [
        { id: 143, tagName: "Breaking/Top News" },
        { id: 174, tagName: "Corporate Announcements" }
      ]
    },
    {
      categoryName: "Macro & Central Banks",
      tagList: [
        { id: 100, tagName: "All Central Banks" },
        { id: 115, tagName: "Fed (USA)" },
        { id: 118, tagName: "ECB (Europe)" },
        { id: 120, tagName: "BOE (UK)" },
        { id: 123, tagName: "BOJ (Japan)" },
        { id: 124, tagName: "RBA (Australia)" },
        { id: 116, tagName: "BOC (Canada)" },
        { id: 114, tagName: "PBOC (China)" },
        { id: 132, tagName: "Central Banks Updates" },
        { id: 110, tagName: "Inflation" },
        { id: 111, tagName: "Interest Rates" },
        { id: 112, tagName: "Employment" },
        { id: 125, tagName: "Monetary Policy" },
        { id: 127, tagName: "Fiscal Policy" }
      ]
    },
    {
      categoryName: "Markets",
      tagList: [
        { id: 94, tagName: "Forex (FX)" },
        { id: 95, tagName: "Stocks (Equities)" },
        { id: 152, tagName: "Major Indices" },
        { id: 169, tagName: "Stock Ratings" },
        { id: 163, tagName: "Dividends" },
        { id: 97, tagName: "Commodities" },
        { id: 117, tagName: "Trade" }
      ]
    },
    {
      categoryName: "Crypto",
      tagList: [
        { id: 98, tagName: "Cryptocurrency" },
        { id: 155, tagName: "Bitcoin" },
        { id: 157, tagName: "Ethereum" },
        { id: 134, tagName: "Regulation (Crypto)" }
      ]
    },
    {
      categoryName: "Geopolitics & Events",
      tagList: [
        { id: 136, tagName: "National Security" },
        { id: 105, tagName: "Disasters/Accidents" },
        { id: 108, tagName: "Russia-Ukraine" },
        { id: 177, tagName: "Middle East" },
        { id: 176, tagName: "Trump Trade" },
        { id: 135, tagName: "Politics" }
      ]
    }
  ];

  const FASTBULL_ID_TO_LABEL = {};
  FASTBULL_TAG_DATA.forEach(cat => {
    cat.tagList.forEach(tag => {
      FASTBULL_ID_TO_LABEL[tag.id] = tag.tagName;
      FASTBULL_ID_TO_LABEL[String(tag.id)] = tag.tagName;
    });
  });

  function getCentralBankTagIdsArray() {
    const cat = FASTBULL_TAG_DATA.find(c => c.categoryName === "Macro & Central Banks");
    if (!cat) return [];
    return cat.tagList.map(t => t.id);
  }
  function getCentralBankTagIdsJoined() {
    return getCentralBankTagIdsArray().join(",");
  }

  function resolveFastbullTagLabel(rawTagsArray, currentTopicId) {
    if (!Array.isArray(rawTagsArray)) return "News";

    if (currentTopicId && currentTopicId !== "all_cb") {
      const targetId = String(currentTopicId);
      if (rawTagsArray.includes(targetId) && FASTBULL_ID_TO_LABEL[targetId]) {
        return FASTBULL_ID_TO_LABEL[targetId];
      }
    }

    for (const id of rawTagsArray) {
      const label = FASTBULL_ID_TO_LABEL[id];
      if (label && id !== "143") return label;
    }

    if (rawTagsArray.includes("143")) return "Breaking News";
    return "News";
  }

  function formatFastbullTime(ts) {
    if (!ts) return "";
    const d = new Date(ts);
    if (isNaN(d.getTime())) return "";
    const dateStr = d.toLocaleDateString("en-GB", { day:"2-digit", month:"short" });
    const timeStr = d.toLocaleTimeString("en-GB", { hour:"2-digit", minute:"2-digit" });
    return { dateStr, timeStr };
  }

  function normalizeCbNewsItem(item, currentTopicId) {
    const rawTagsStr = typeof item.tags === "string" ? item.tags : "";
    const rawTagsArray = rawTagsStr.split(",").map(t => t.trim()).filter(Boolean);
    const label = resolveFastbullTagLabel(rawTagsArray, currentTopicId);
    const { dateStr, timeStr } = formatFastbullTime(item.releasedDate);

    return {
      id: item.newsId,
      label,
      title: item.newsTitle || "Untitled Headline",
      date: dateStr,
      time: timeStr,
      important: Number(item.important) === 1,
      rawTags: rawTagsArray
    };
  }

  const cbTopicSelect = document.getElementById("cb-topic-select");
  const cbNewsFeed   = document.getElementById("cb-news-feed");
  const cbNewsStatus = document.getElementById("cb-news-status");

  let cbCurrentTopic = "all_cb";
  let cbFastbullProxyEnabled = false;

  function initCbTopicDropdown() {
    cbTopicSelect.innerHTML = "";

    const def = document.createElement("option");
    def.value = "all_cb";
    def.textContent = "All Central Bank Topics";
    cbTopicSelect.appendChild(def);

    const macroCbCat = FASTBULL_TAG_DATA.find(c => c.categoryName === "Macro & Central Banks");
    if (!macroCbCat) return;

    const mainBanksGroup = document.createElement("optgroup");
    mainBanksGroup.label = "Major Central Banks";

    const macroLinksGroup = document.createElement("optgroup");
    macroLinksGroup.label = "Macro Links";

    macroCbCat.tagList.forEach(tag => {
      const opt = document.createElement("option");
      opt.value = String(tag.id);
      opt.textContent = tag.tagName;

      if ([
        "All Central Banks","Fed (USA)","ECB (Europe)","BOE (UK)",
        "BOJ (Japan)","RBA (Australia)","BOC (Canada)","PBOC (China)",
        "Central Banks Updates"
      ].includes(tag.tagName)) {
        mainBanksGroup.appendChild(opt);
      } else {
        macroLinksGroup.appendChild(opt);
      }
    });

    if (mainBanksGroup.children.length) cbTopicSelect.appendChild(mainBanksGroup);
    if (macroLinksGroup.children.length) cbTopicSelect.appendChild(macroLinksGroup);
  }

  function getTagIdsForCbTopic(topicKey) {
    if (topicKey === "all_cb") {
      return getCentralBankTagIdsJoined();
    }
    return String(topicKey);
  }

  function renderCbNews(list) {
    cbNewsFeed.innerHTML = "";
    if (!list || !list.length) {
      cbNewsFeed.innerHTML = "<div style='padding:12px; font-size:10px; color:var(--text-muted);'>No central bank headlines for this topic.</div>";
      return;
    }

    list.forEach(item => {
      const div = document.createElement("div");
      div.className = "news-item";
      div.innerHTML = `
        <div class="news-meta">
          <span>${item.date} · ${item.time} WIB</span>
          ${item.label ? `<span>· ${item.label}</span>` : ""}
          ${item.important ? `<span style="color:#ffb74d;">· HIGH</span>` : ""}
        </div>
        <div class="news-title">${item.title}</div>
      `;
      cbNewsFeed.appendChild(div);
    });
  }

  async function loadCbNews(topicKey) {
    const key = topicKey || cbCurrentTopic || "all_cb";
    const tagIds = getTagIdsForCbTopic(key);

    cbNewsStatus.textContent = "Syncing...";
    cbNewsFeed.innerHTML = "<div style='padding:12px; font-size:10px; color:var(--text-muted);'>Loading central bank headlines...</div>";

    const baseUrl = `${FASTBULL_NEWS_ENDPOINT}?checkImportant=0&pageSize=60&tagIds=${tagIds}`;

    try {
      let payload;
      try {
        const r = await fetch(baseUrl, { headers: FASTBULL_NEWS_HEADERS });
        if (!r.ok) throw new Error("HTTP " + r.status);
        payload = await r.json();
      } catch (err) {
        if (cbFastbullProxyEnabled) throw err;
        cbFastbullProxyEnabled = true;
        const r = await fetch(FASTBULL_CORS_PROXY + encodeURIComponent(baseUrl));
        if (!r.ok) throw new Error("HTTP " + r.status);
        payload = await r.json();
      }

      const list = JSON.parse(payload.bodyMessage || "{}").pageDatas || [];
      if (!list.length) {
        renderCbNews([]);
        cbNewsStatus.textContent = "No Data";
        return;
      }

      let items = list.map(it => normalizeCbNewsItem(it, key));

      if (key !== "all_cb") {
        const requestedIds = String(key).split(",").map(s => s.trim()).filter(Boolean);
        items = items.filter(it => it.rawTags?.some(rt => requestedIds.includes(rt)));
      }

      renderCbNews(items);
      cbNewsStatus.textContent = "Updated";
    } catch (e) {
      console.error(e);
      cbNewsFeed.innerHTML = "<div style='padding:12px; font-size:10px; color:#ef5350;'>Failed to load CB headlines. Check console / network.</div>";
      cbNewsStatus.textContent = "Error";
    }
  }

  // === INIT ===
  document.addEventListener("DOMContentLoaded", () => {
    initCbTopicDropdown();
    loadPolicyRates();
    loadInterestTrend();
    loadCalendar();
    loadCbNews(cbCurrentTopic);

    cbTopicSelect.addEventListener("change", () => {
      cbCurrentTopic = cbTopicSelect.value || "all_cb";
      loadCbNews(cbCurrentTopic);
    });

    // Auto-refresh CB news setiap 60s untuk topic aktif
    setInterval(() => loadCbNews(cbCurrentTopic), 60000);
  });
</script>
</body>
</html>
