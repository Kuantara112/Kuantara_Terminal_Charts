<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <title>Research Terminal (Mobile)</title>

  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600&display=swap"/>

  <style>
    /* --- THEME VARIABLES --- */
    :root {
      --bg-app: #050505;
      --bg-panel: #111111;
      --bg-element: #1a1a1a;
      --bg-hover: #252525;
      
      --border-main: #333333;
      --border-light: #444444;

      --text-main: #eeeeee;
      --text-muted: #888888;
      
      --accent: #ffbf00;
      --accent-dim: rgba(255, 191, 0, 0.15);

      --radius: 4px;
      --space-sm: 8px;
      --space-md: 16px;
      
      /* Tinggi toolbar fix */
      --toolbar-height: 56px;
    }

    /* --- RESET --- */
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: "Fira Code", monospace !important; -webkit-tap-highlight-color: transparent; }
    
    /* Custom Scrollbar (Thin) */
    ::-webkit-scrollbar { width: 4px; height: 4px; }
    ::-webkit-scrollbar-track { background: var(--bg-app); }
    ::-webkit-scrollbar-thumb { background: var(--border-light); border-radius: 2px; }

    html, body {
      width: 100%; height: 100%;
      background: var(--bg-app);
      color: var(--text-main);
      overflow: hidden; /* Prevent body scroll, we scroll inner elements */
      position: fixed; /* Prevent bounce effect on iOS */
    }

    /* --- LAYOUT UTAMA --- */
    .app-shell {
      display: flex;
      width: 100vw;
      height: 100dvh; /* Dynamic viewport height for mobile browsers */
      position: relative;
    }

    /* --- SIDEBAR (OFF-CANVAS ON MOBILE) --- */
    .sidebar {
      width: 300px;
      background: var(--bg-panel);
      border-right: 1px solid var(--border-main);
      display: flex;
      flex-direction: column;
      z-index: 100;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* HEADER DIHAPUS SESUAI REQUEST - Langsung ke filter */
    .sidebar-content {
      padding: var(--space-md);
      display: flex;
      flex-direction: column;
      gap: 16px;
      height: 100%;
      overflow-y: auto;
    }

    /* Mobile Overlay Background */
    .sidebar-backdrop {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.7);
      z-index: 90;
      opacity: 0; pointer-events: none;
      transition: opacity 0.3s;
      backdrop-filter: blur(2px);
    }

    /* --- FORM ELEMENTS --- */
    .form-group { display: flex; flex-direction: column; gap: 6px; }
    .form-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
    
    .kt-input, .kt-select {
      background: var(--bg-app);
      border: 1px solid var(--border-main);
      color: var(--text-main);
      padding: 10px; /* Larger touch target */
      border-radius: var(--radius);
      font-size: 12px;
      outline: none;
      width: 100%;
    }
    .kt-input:focus, .kt-select:focus { border-color: var(--accent); }

    .filter-row { display: flex; gap: 8px; }
    .filter-row > * { flex: 1; }

    .btn-reset {
      background: var(--bg-element);
      border: 1px solid var(--border-main);
      color: var(--text-muted);
      padding: 10px;
      font-size: 11px;
      cursor: pointer;
      border-radius: var(--radius);
      width: 100%;
    }
    
    /* --- DOC LIST --- */
    .list-header {
      font-size: 10px; color: var(--text-muted);
      display: flex; justify-content: space-between;
      margin-top: 8px; border-bottom: 1px solid var(--border-main);
      padding-bottom: 4px; margin-bottom: 8px;
    }

    .doc-item {
      padding: 12px;
      margin-bottom: 8px;
      background: var(--bg-element);
      border: 1px solid transparent;
      border-radius: var(--radius);
      cursor: pointer;
    }
    .doc-item.active { background: var(--accent-dim); border-color: var(--accent); }
    
    .doc-title { font-size: 13px; font-weight: 500; margin-bottom: 4px; line-height: 1.4; }
    .doc-meta { display: flex; justify-content: space-between; font-size: 10px; color: var(--text-muted); }
    .tag { color: var(--accent); }

    /* --- MAIN CONTENT --- */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #000;
      position: relative;
      width: 100%;
    }

    /* --- TOOLBAR --- */
    .toolbar {
      height: var(--toolbar-height);
      background: var(--bg-panel);
      border-bottom: 1px solid var(--border-main);
      display: flex;
      align-items: center;
      padding: 0 8px;
      gap: 8px;
      overflow-x: auto; /* Scrollable horizontal on mobile */
      white-space: nowrap;
      /* Hide scrollbar visual but keep functionality */
      scrollbar-width: none; 
    }
    .toolbar::-webkit-scrollbar { display: none; }

    .toolbar-group {
      display: flex; align-items: center; gap: 4px;
      padding-right: 8px; border-right: 1px solid var(--border-main);
    }
    .toolbar-group:last-child { border-right: none; }

    /* Mobile Menu Toggle Button */
    .btn-menu {
      display: none; /* Hidden on desktop */
      background: var(--accent);
      color: #000;
      border: none;
      font-weight: 700;
      padding: 0 12px;
      height: 32px;
      border-radius: var(--radius);
      font-size: 12px;
      align-items: center; gap: 6px;
    }

    .tool-btn {
      width: 36px; height: 36px; /* Touch friendly size */
      display: flex; align-items: center; justify-content: center;
      border: 1px solid transparent;
      background: transparent;
      color: var(--text-muted);
      border-radius: var(--radius);
      flex-shrink: 0;
    }
    .tool-btn.active { background: var(--bg-hover); color: var(--accent); border-color: var(--border-light); }
    
    /* SVG Helper */
    svg { width: 18px; height: 18px; stroke-width: 2; }

    /* --- VIEWER AREA --- */
    .viewer-viewport {
      flex: 1;
      position: relative;
      overflow: auto; /* Native scroll */
      background: #0a0a0a;
      display: flex;
      justify-content: center;
      padding: 20px;
      -webkit-overflow-scrolling: touch; /* Smooth scroll iOS */
    }

    /* Mode Handling */
    .viewer-viewport.mode-pan { touch-action: pan-x pan-y; } /* Allow native scroll */
    .viewer-viewport.mode-draw { touch-action: none; overflow: hidden; } /* Disable scroll when drawing */

    .pdf-wrapper {
      position: relative;
      background: #202020;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      transform-origin: top center;
    }

    iframe { display: block; border: none; width: 100%; height: 100%; background: #fff; pointer-events: none; /* Let touch pass to canvas wrapper */ }
    
    /* Canvas sits on top */
    canvas {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      touch-action: none; /* Handle touches manually in JS */
    }

    /* --- RESPONSIVE LOGIC --- */
    @media (max-width: 768px) {
      .sidebar {
        position: absolute; top: 0; left: 0; height: 100%; width: 85%; max-width: 320px;
        transform: translateX(-100%);
        box-shadow: 4px 0 20px rgba(0,0,0,0.8);
      }
      .sidebar.open { transform: translateX(0); }
      .sidebar-backdrop.open { opacity: 1; pointer-events: auto; }
      
      .btn-menu { display: flex; }
      .viewer-viewport { padding: 10px; align-items: flex-start; }
      
      /* Optimize for small screens */
      .pdf-wrapper { margin-bottom: 100px; } /* Extra space at bottom for scrolling */
    }
  </style>
</head>
<body>

<div class="app-shell">
  <div class="sidebar-backdrop" id="backdrop"></div>

  <aside class="sidebar" id="sidebar">
    <div class="sidebar-content">
      <div class="form-group">
        <label class="form-label">Topic Filter</label>
        <select id="topicFilter" class="kt-select">
          <option value="all">All Topics</option>
          <option value="macro">Global Macro</option>
          <option value="fx">FX Strategy</option>
          <option value="rates">Rates & Credit</option>
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label">Date Range</label>
        <div class="filter-row">
          <input type="date" id="dateFrom" class="kt-input" />
          <input type="date" id="dateTo" class="kt-input" />
        </div>
      </div>
      
      <button id="resetFilterBtn" class="btn-reset">Reset Filters</button>

      <div class="list-header">
        <span>DOCUMENTS</span>
        <span id="resultCount">0</span>
      </div>
      
      <div id="docList" style="flex:1; overflow-y:auto;">
        </div>
    </div>
  </aside>

  <main class="main-content">
    <div class="toolbar">
      <button class="btn-menu" id="menuToggle">
        <span>â˜° LIST</span>
      </button>

      <div class="toolbar-group">
        <button class="tool-btn active" id="toolPan" title="Pan">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M7 11l5-5 5 5"/><path d="M7 13l5 5 5-5"/></svg> </button>
        <button class="tool-btn" id="toolPen" title="Pen">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/></svg>
        </button>
        <button class="tool-btn" id="toolHigh" title="Highlight">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11l-6 6v3h9l3-3"/><line x1="22" y1="12" x2="17.4" y2="16.6"/></svg>
        </button>
        <button class="tool-btn" id="toolErase" title="Eraser">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21"/><path d="M22 21H7"/></svg>
        </button>
        <button class="tool-btn" id="toolClear" title="Clear">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
        </button>
      </div>

      <div class="toolbar-group">
        <button class="tool-btn" id="zoomOutBtn">-</button>
        <span style="font-size:11px; color:var(--text-muted); min-width:30px; text-align:center;" id="zoomLabel">100%</span>
        <button class="tool-btn" id="zoomInBtn">+</button>
      </div>
    </div>

    <div class="viewer-viewport mode-pan" id="viewport">
      <div class="pdf-wrapper" id="pdfWrapper">
        <iframe id="pdfFrame" src="about:blank"></iframe>
        <canvas id="pdfCanvas"></canvas>
      </div>
    </div>
  </main>
</div>

<script>
  /* --- MOCK DATA --- */
  const docs = [
    { title: "FX Strategy: USD/JPY Outlook", date: "2025-11-20", topic: "fx", pdf: "https://mozilla.github.io/pdf.js/web/compressed.tracemonkey-pldi-09.pdf" },
    { title: "Macro: Inflation Data Analysis", date: "2025-11-19", topic: "macro", pdf: "https://mozilla.github.io/pdf.js/web/compressed.tracemonkey-pldi-09.pdf" },
    { title: "Rates: 10Y Treasury Yields", date: "2025-11-18", topic: "rates", pdf: "https://mozilla.github.io/pdf.js/web/compressed.tracemonkey-pldi-09.pdf" },
    { title: "Weekly Market Recap", date: "2025-11-15", topic: "macro", pdf: "https://mozilla.github.io/pdf.js/web/compressed.tracemonkey-pldi-09.pdf" },
  ];

  /* --- ELEMENTS --- */
  const sidebar = document.getElementById('sidebar');
  const backdrop = document.getElementById('backdrop');
  const menuBtn = document.getElementById('menuToggle');
  const docList = document.getElementById('docList');
  const resultCount = document.getElementById('resultCount');
  
  const viewport = document.getElementById('viewport');
  const pdfWrapper = document.getElementById('pdfWrapper');
  const pdfFrame = document.getElementById('pdfFrame');
  const pdfCanvas = document.getElementById('pdfCanvas');
  
  let ctx = pdfCanvas.getContext('2d');
  let zoom = 1.0;
  let currentTool = 'pan';
  let isDrawing = false;
  let lastX=0, lastY=0;

  /* --- MOBILE SIDEBAR LOGIC --- */
  function toggleSidebar(show) {
    if(show) {
      sidebar.classList.add('open');
      backdrop.classList.add('open');
    } else {
      sidebar.classList.remove('open');
      backdrop.classList.remove('open');
    }
  }
  menuBtn.onclick = () => toggleSidebar(true);
  backdrop.onclick = () => toggleSidebar(false);

  /* --- LIST RENDERING --- */
  function renderList() {
    docList.innerHTML = '';
    docs.forEach(doc => {
      const el = document.createElement('div');
      el.className = 'doc-item';
      el.innerHTML = `
        <div class="doc-title">${doc.title}</div>
        <div class="doc-meta"><span>${doc.date}</span> <span class="tag" style="color:var(--accent)">${doc.topic.toUpperCase()}</span></div>
      `;
      el.onclick = () => {
        // Load PDF
        pdfFrame.src = doc.pdf + "#view=FitH";
        
        // Highlight item
        document.querySelectorAll('.doc-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
        
        // Clear canvas
        ctx.clearRect(0,0,pdfCanvas.width, pdfCanvas.height);
        
        // Close sidebar on mobile automatically
        if(window.innerWidth <= 768) toggleSidebar(false);
      };
      docList.appendChild(el);
    });
    resultCount.textContent = docs.length;
    
    // Select first automatically
    if(docs.length > 0) docList.children[0].click();
  }
  renderList();

  /* --- ZOOM & SIZE --- */
  // Set base size relative to CSS (assume ~900px base width for PDF)
  const BASE_WIDTH = 900;
  const BASE_HEIGHT = 1200;

  function resizeCanvas() {
    pdfCanvas.width = BASE_WIDTH;
    pdfCanvas.height = BASE_HEIGHT;
    pdfWrapper.style.width = BASE_WIDTH + 'px';
    pdfWrapper.style.height = BASE_HEIGHT + 'px';
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
  }
  resizeCanvas();

  function updateZoom() {
    // Zoom using CSS transform for performance
    pdfWrapper.style.transform = `scale(${zoom})`;
    document.getElementById('zoomLabel').textContent = Math.round(zoom*100) + "%";
    
    // Adjust container size so scrolling works
    // Not strictly necessary with transform, but good for margin
    const margin = (BASE_WIDTH * zoom - BASE_WIDTH) / 2;
    if(zoom > 1) pdfWrapper.style.margin = `${margin}px`;
    else pdfWrapper.style.margin = '0';
  }

  document.getElementById('zoomInBtn').onclick = () => { zoom = Math.min(zoom+0.1, 3.0); updateZoom(); };
  document.getElementById('zoomOutBtn').onclick = () => { zoom = Math.max(zoom-0.1, 0.4); updateZoom(); };
  
  // Auto fit width on load
  setTimeout(() => {
    if(window.innerWidth < 900) {
      zoom = (window.innerWidth - 40) / BASE_WIDTH;
      updateZoom();
    }
  }, 500);

  /* --- TOOLS LOGIC --- */
  function setTool(t) {
    currentTool = t;
    // Toggle UI classes
    document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
    
    const map = {'pan':'toolPan','pen':'toolPen','high':'toolHigh','erase':'toolErase'};
    if(map[t]) document.getElementById(map[t]).classList.add('active');

    // Mode switching for Touch/Scroll behavior
    if(t === 'pan') {
      viewport.classList.remove('mode-draw');
      viewport.classList.add('mode-pan');
      pdfCanvas.style.pointerEvents = 'none'; // Allow touch to go through to iframe/div for scrolling
    } else {
      viewport.classList.remove('mode-pan');
      viewport.classList.add('mode-draw');
      pdfCanvas.style.pointerEvents = 'auto'; // Capture touch for drawing
    }
  }

  document.getElementById('toolPan').onclick = () => setTool('pan');
  document.getElementById('toolPen').onclick = () => setTool('pen');
  document.getElementById('toolHigh').onclick = () => setTool('high');
  document.getElementById('toolErase').onclick = () => setTool('erase');
  document.getElementById('toolClear').onclick = () => ctx.clearRect(0,0,BASE_WIDTH,BASE_HEIGHT);

  /* --- DRAWING & TOUCH HANDLING --- */
  function getPos(e) {
    const rect = pdfCanvas.getBoundingClientRect();
    let clientX = e.clientX;
    let clientY = e.clientY;
    
    if(e.touches && e.touches.length > 0) {
      clientX = e.touches[0].clientX;
      clientY = e.touches[0].clientY;
    }

    // Need to reverse the scale to get correct coordinate on canvas
    return {
      x: (clientX - rect.left) / zoom,
      y: (clientY - rect.top) / zoom
    };
  }

  function startDraw(e) {
    if(currentTool === 'pan') return;
    isDrawing = true;
    const p = getPos(e);
    lastX = p.x; lastY = p.y;
  }

  function draw(e) {
    if(!isDrawing || currentTool === 'pan') return;
    
    // PENTING: Prevent scrolling saat menggambar
    if(e.type === 'touchmove') e.preventDefault();

    const p = getPos(e);
    
    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(p.x, p.y);
    
    if(currentTool === 'pen') {
      ctx.globalCompositeOperation = 'source-over';
      ctx.strokeStyle = '#ffbf00';
      ctx.lineWidth = 2;
      ctx.globalAlpha = 1;
    } else if(currentTool === 'high') {
      ctx.globalCompositeOperation = 'multiply';
      ctx.strokeStyle = '#ffeb3b';
      ctx.lineWidth = 12;
      ctx.globalAlpha = 0.3;
    } else if(currentTool === 'erase') {
      ctx.globalCompositeOperation = 'destination-out';
      ctx.lineWidth = 20;
      ctx.globalAlpha = 1;
    }
    
    ctx.stroke();
    lastX = p.x; lastY = p.y;
  }

  function endDraw() { isDrawing = false; }

  // Mouse Events
  pdfCanvas.addEventListener('mousedown', startDraw);
  pdfCanvas.addEventListener('mousemove', draw);
  pdfCanvas.addEventListener('mouseup', endDraw);
  
  // Touch Events (Passive: false required to preventDefault)
  pdfCanvas.addEventListener('touchstart', startDraw, {passive: false});
  pdfCanvas.addEventListener('touchmove', draw, {passive: false});
  pdfCanvas.addEventListener('touchend', endDraw);

</script>
</body>
</html>
