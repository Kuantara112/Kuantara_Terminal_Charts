<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Kuantara – 24/7 Headlines & Articles</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Fira Code -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;700&display=swap">

  <style>
    :root{
      --bg-root:#000000;
      --bg-main:#111111;
      --border-soft:#2b2b2b;
      --text-main:#f5f5f5;
      --text-muted:#9b9b9b;
      --accent:#ffbf00;

      --fs-title:14px;
      --fs-subtitle:12px;
      --fs-body:11px;
      --fs-small:9.5px;
    }

    *{
      box-sizing:border-box;
      margin:0;
      padding:0;
      font-family:"Fira Code",monospace!important;
      scrollbar-width:thin;
      scrollbar-color:rgba(0,0,0,0.6) transparent;
    }

    *::-webkit-scrollbar{
      width:6px;
      height:6px;
    }
    *::-webkit-scrollbar-track{
      background:transparent;
    }
    *::-webkit-scrollbar-thumb{
      background:rgba(0,0,0,0.7);
      border-radius:3px;
    }

    html,body{
      width:100%;
      height:100%;
      background:#000000;
      color:var(--text-main);
    }

    body{
      overflow:hidden;
    }

    .kt-root{
      width:100%;
      height:100%;
      padding:16px;
      background:var(--bg-root);
      color:var(--text-main);
    }

    .kt-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:12px;
      width:100%;
      height:100%;
      max-height:100%;
    }

    @media (max-width:840px){
      .kt-grid{
        grid-template-columns:1fr;
        grid-auto-rows:minmax(0,1fr);
      }
    }

    .kt-panel{
      background:var(--bg-main);
      border:1px solid var(--border-soft);
      border-radius:4px;
      padding:12px 14px;
      display:flex;
      flex-direction:column;
      min-width:0;
      min-height:0;
    }

    .kt-panel-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-bottom:8px;
    }

    .kt-panel-title{
      font-size:var(--fs-title);
      font-weight:600;
      color:var(--text-main);
      letter-spacing:0.02em;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .kt-panel-controls{
      display:flex;
      align-items:center;
      gap:6px;
      min-width:0;
    }

    .kt-select{
      background:#000000;
      border:1px solid var(--border-soft);
      color:var(--text-main);
      font-size:var(--fs-small);
      padding:4px 6px;
      border-radius:3px;
      outline:none;
      max-width:220px;
      width:100%;
      appearance:none;
      -moz-appearance:none;
      -webkit-appearance:none;
    }

    .kt-select:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(255,191,0,0.25);
    }

    .kt-btn{
      border:none;
      outline:none;
      cursor:pointer;
      font-size:var(--fs-small);
      padding:5px 10px;
      border-radius:3px;
      background:var(--accent);
      color:#000000;
      white-space:nowrap;
      display:inline-flex;
      align-items:center;
      gap:4px;
      flex-shrink:0;
    }

    .kt-btn:hover{
      filter:brightness(1.05);
    }

    .kt-btn:active{
      filter:brightness(0.95);
    }

    .kt-panel-body{
      border-top:1px solid var(--border-soft);
      margin-top:8px;
      padding-top:8px;
      display:flex;
      flex-direction:column;
      flex:1;
      min-height:0;
    }

    .kt-meta-row{
      display:flex;
      justify-content:space-between;
      gap:8px;
      margin-bottom:8px;
      font-size:var(--fs-small);
      color:var(--text-muted);
    }

    .kt-meta-left,
    .kt-meta-right{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      align-items:center;
    }

    .kt-feed{
      list-style:none;
      margin:0;
      padding:0;
      display:flex;
      flex-direction:column;
      gap:6px;
      flex:1;
      min-height:0;
      overflow-y:auto;
    }

    #fastbull-feed,
    #te-feed{
      max-height:100%;
    }

    .kt-item{
      border:1px solid var(--border-soft);
      border-radius:3px;
      padding:6px 6px;
      background:#111111;
      cursor:pointer;
      transition:border-color 0.2s ease, background 0.2s ease;
      display:flex;
      flex-direction:column;
      gap:4px;
    }

    .kt-item.selected{
      border-color:var(--accent);
      background:#18120a;
    }

    .kt-item[data-important="true"] .kt-item-content{
      border:1px solid rgba(14,165,233,0.65);
      background:linear-gradient(140deg,rgba(5,10,20,0.95),rgba(8,47,73,0.85));
      box-shadow:0 0 18px rgba(14,165,233,0.18);
    }

    .kt-item[data-important="true"].selected .kt-item-content{
      border-color:rgba(59,130,246,0.8);
    }

    .kt-item[data-medium="true"]:not([data-important="true"]) .kt-item-content{
      border-color:rgba(59,130,246,0.35);
      background:linear-gradient(135deg,rgba(30,64,175,0.16),rgba(6,8,12,0.96));
    }

    .kt-item .kt-item-content{
      background:rgba(255,255,255,0.01);
      border:1px solid rgba(255,255,255,0.06);
      border-radius:4px;
      padding:6px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }

    .kt-item-header{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:8px;
    }

    .kt-item-tag{
      font-size:var(--fs-small);
      color:var(--accent);
    }

    .kt-tags{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
      margin-top:2px;
    }

    .kt-tag{
      font-size:9px;
      text-transform:uppercase;
      letter-spacing:0.08em;
      padding:2px 6px;
      border:1px solid rgba(255,255,255,0.2);
      border-radius:999px;
      color:var(--text-muted);
    }

    .kt-item-title{
      font-size:var(--fs-body);
      color:var(--text-main);
    }

    .kt-item-desc{
      font-size:var(--fs-small);
      color:var(--text-muted);
      line-height:1.4;
    }

    .kt-item-meta{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      font-size:var(--fs-small);
      color:var(--text-muted);
      margin-top:2px;
    }

    .kt-item-time{
      white-space:nowrap;
    }

    .kt-copy-icon{
      border:1px solid rgba(255,255,255,0.2);
      background:rgba(0,0,0,0.3);
      color:var(--text-main);
      width:26px;
      height:22px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:4px;
      cursor:pointer;
      transition:all 0.2s ease;
      padding:0;
      flex-shrink:0;
    }

    .kt-copy-icon svg{
      width:13px;
      height:13px;
      stroke:currentColor;
    }

    .kt-copy-icon:hover{
      border-color:var(--accent);
      color:var(--accent);
    }

    .kt-copy-icon.copied{
      border-color:#2ea043;
      color:#2ea043;
    }

    .kt-empty{
      font-size:var(--fs-small);
      color:var(--text-muted);
      padding:6px 2px;
      text-align:center;
    }

    /* Kuantara AI Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.78);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 999;
    }
    .modal-card {
      width: min(960px, 100%);
      max-height: min(520px, 100%);
      background: #050505;
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 30px 120px rgba(0, 0, 0, 0.75);
      padding: 16px;
      position: relative;
      overflow-y: auto;
    }
    .modal-close {
      border: 1px solid rgba(255, 255, 255, 0.18);
      background: transparent;
      color: #ffbf00;
      width: 32px;
      height: 32px;
      border-radius: 999px;
      font-size: 1rem;
      cursor:pointer;
    }
    .modal-close:hover {
      background: rgba(255, 255, 255, 0.06);
    }
    .kuantara-chat {
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(0, 0, 0, 0.55);
      padding: 12px;
      min-height: 200px;
      max-height: 320px;
      overflow-y: auto;
      font-size: var(--fs-body);
      line-height: 1.5;
      scrollbar-width: none;
      -ms-overflow-style: none;
      margin-top:10px;
    }
    .kuantara-chat::-webkit-scrollbar {
      width: 0;
      height: 0;
    }
    .kuantara-chat .placeholder {
      font-size: 10px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: rgba(255, 255, 255, 0.4);
      text-align:center;
    }
    .kuantara-message {
      margin-bottom: 10px;
    }
    .kuantara-label {
      font-size: 9px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: rgba(255, 255, 255, 0.5);
    }
    .kuantara-message.user .kuantara-label {
      color: #7dd3fc;
    }
    .kuantara-message.ai .kuantara-label {
      color: #ffbf00;
    }
    .kuantara-block {
      margin-top: 4px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 10px;
      padding: 8px 10px;
      background: rgba(15, 23, 42, 0.9);
    }
    .kuantara-message.ai .kuantara-block {
      border-radius: 0;
      border:none;
      background: transparent;
      padding: 6px 0;
    }
    .kuantara-block .md p {
      margin: 3px 0;
    }
    .kuantara-block .md ul,
    .kuantara-block .md ol {
      padding-left: 18px;
      margin: 3px 0;
    }
    .kuantara-block .md code {
      background: rgba(255, 255, 255, 0.08);
      padding: 2px 4px;
      border-radius: 4px;
      font-size: 0.85em;
    }
    .kuantara-input {
      margin-top: 10px;
      display: flex;
      gap: 8px;
    }
    .kuantara-input textarea {
      flex: 1;
      min-height: 44px;
      max-height: 200px;
      border: 1px solid rgba(255, 255, 255, 0.14);
      background: rgba(0, 0, 0, 0.4);
      color: #fff;
      padding: 6px 8px;
      resize: none;
      font-size: var(--fs-small);
    }
    .kuantara-send-btn {
      width: 52px;
      border: none;
      border-radius: 10px;
      background: #ffffff;
      display: grid;
      place-items: center;
      color: #050505;
      cursor:pointer;
      transition: transform 0.12s ease, box-shadow 0.12s ease;
    }
    .kuantara-send-btn svg {
      width: 18px;
      height: 18px;
    }
    .kuantara-send-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(255, 255, 255, 0.14);
    }
    .kuantara-send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      box-shadow: none;
    }

    .flex{display:flex;}
    .items-center{align-items:center;}
    .justify-between{justify-content:space-between;}
    .hidden{display:none!important;}

    @media (max-width:600px){
      .modal-card{padding:12px;}
      .kuantara-chat{max-height:260px;}
    }
  </style>
</head>
<body>
<div class="kt-root">
  <div class="kt-grid">
    <!-- PANEL KIRI: 24/7 Headlines -->
    <section class="kt-panel" id="panel-fastbull">
      <div class="kt-panel-header">
        <div class="kt-panel-title">24/7 Headlines</div>
        <div class="kt-panel-controls">
          <select class="kt-select" id="fastbull-topic">
            <option value="all">All tags (Realtime)</option>
          </select>
          <button class="kt-btn" id="fastbull-recap-btn">
            Recap with AI
          </button>
        </div>
      </div>

      <div class="kt-panel-body">
        <div class="kt-meta-row">
          <div class="kt-meta-left" id="fastbull-count"></div>
          <div class="kt-meta-right"></div>
        </div>

        <ul class="kt-feed" id="fastbull-feed">
          <li class="kt-item">
            <div class="kt-item-content">
              <div class="kt-item-header">
                <div class="kt-item-tag">Loading</div>
              </div>
              <div class="kt-item-title">Memuat headlines FastBull…</div>
              <div class="kt-item-meta">
                <span class="kt-item-time">...</span>
              </div>
            </div>
          </li>
        </ul>
      </div>
    </section>

    <!-- PANEL KANAN: Articles -->
    <section class="kt-panel" id="panel-te">
      <div class="kt-panel-header">
        <div class="kt-panel-title">Articles</div>
        <div class="kt-panel-controls">
          <select class="kt-select" id="te-topic">
            <option value="all">All categories</option>
          </select>
          <button class="kt-btn" id="te-recap-btn">
            Recap with AI
          </button>
        </div>
      </div>

      <div class="kt-panel-body">
        <div class="kt-meta-row">
          <div class="kt-meta-left" id="te-count"></div>
          <div class="kt-meta-right"></div>
        </div>

        <ul class="kt-feed" id="te-feed">
          <li class="kt-item">
            <div class="kt-item-content">
              <div class="kt-item-header">
                <div class="kt-item-tag">Loading</div>
              </div>
              <div class="kt-item-title">Memuat articles Catalyst Feed…</div>
              <div class="kt-item-meta">
                <span class="kt-item-time">...</span>
              </div>
            </div>
          </li>
        </ul>
      </div>
    </section>
  </div>
</div>

<!-- Kuantara AI Modal -->
<div id="kuantaraModal" class="modal-overlay hidden">
  <div id="card" class="modal-card">
    <div class="flex items-center justify-between">
      <div>
        <p style="font-size:9px;letter-spacing:0.3em;text-transform:uppercase;color:#6b7280;">Kuantara AI</p>
        <h2 id="kuantaraTitle" style="font-size:14px;margin-top:4px;">Recap</h2>
      </div>
      <button id="kuantaraClose" type="button" class="modal-close">&times;</button>
    </div>
    <div class="kuantara-chat" id="chatList"></div>
    <div class="kuantara-input">
      <textarea id="input" placeholder="Tulis instruksi untuk Kuantara…"></textarea>
      <button id="send" type="button" class="kuantara-send-btn" aria-label="Kirim">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 19V5"></path>
          <path d="m5 12 7-7 7 7"></path>
        </svg>
      </button>
    </div>
  </div>
</div>

<script>
  // ========= CONFIG =========
  const SIDER_API_BASE = "https://sider.ai/api/chat/v1";
  const TIMEZONE = "Asia/Makassar";
  const SIDER_TOKEN = "<ISI TOKEN SIDER KAMU DI SINI>"; // PASTIKAN DIISI

  const FASTBULL_NEWS_ENDPOINT = "https://api.fastbull.com/fastbull-news-service/api/getNewsPageByTagIds";
  const FASTBULL_TAG_URL       = "https://api.fastbull.com/fastbull-news-service/api/getAINewsTagList?";
  const FASTBULL_HEADERS = {
    "Accept": "application/json",
    "client-type": "4",
    "clientversion": "latest",
    "langid": "13"
  };
  const FASTBULL_CORS_PROXY = "https://api.allorigins.win/raw?url=";

  const CATALYST_FEED_API = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLjMfNinXgjitGptTt1Uj6nE6WK7rYjGTPSt5bUFepyHsCV7ZBDGq6iUYbWvAjM_GhWNcK3REbD8jDIDwMCKO2bUgT_H_aHRBj09Gwkd2uraHiWcmpd3uD3lWgzxnxEu9UOACjLZnVbgZ9fYMy0qtS-DvoKx9KjMK-AuT30tktXjEUxt-JhCWomT15gnuyLeRstzneutXUmRPLHr_lfJyz9_SOovs6xBP-DDH4tUkDSY2SdlvYhf5nZmmY36BH4ncn8t63S2Ua7iCwCMVRs8Ey8R2aWWd6C0Sv39n4V0anX6oX-zfP8&lib=MakTJ382BM__YWV6a2eDZUSqaUOX12Qs5";

  const MAX_RECAP_ITEMS = 15;
  const FEED_DISPLAY_LIMIT = Infinity;

  const COPY_ICON_SVG = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>';

  // ========= DOM =========
  const fastbullFeedEl   = document.getElementById("fastbull-feed");
  const fastbullCountEl  = document.getElementById("fastbull-count");
  const fastbullTopicEl  = document.getElementById("fastbull-topic");
  const fastbullRecapBtn = document.getElementById("fastbull-recap-btn");

  const articlesFeedEl   = document.getElementById("te-feed");
  const articlesCountEl  = document.getElementById("te-count");
  const articlesTopicEl  = document.getElementById("te-topic");
  const articlesRecapBtn = document.getElementById("te-recap-btn");

  const kuantaraModal    = document.getElementById("kuantaraModal");
  const kuantaraCloseBtn = document.getElementById("kuantaraClose");
  const kuantaraTitleEl  = document.getElementById("kuantaraTitle");
  const chatListEl       = document.getElementById("chatList");
  const inputEl          = document.getElementById("input");
  const sendBtn          = document.getElementById("send");

  // ========= STATE =========
  const fastbullCache = new Map();
  const articlesCache = new Map();
  const fastbullTagMap = {};
  let fastbullTagsLoaded = false;
  let fastbullProxyEnabled = false;

  let isStreaming = false;
  let streamBuffer = "";
  const recapConversations = new Map();
  let messages = [];
  let selectedFastbullItemId = null;
  let selectedArticleItemId = null;

  // ========= HELPERS (SAMA SEPERTI SEBELUMNYA) =========
  const markdownToHtml = (md) => (md || "").replace(/\n/g, "<br>");

  const escapeHtml = (value = "") => {
    const str = value == null ? "" : String(value);
    return str
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;");
  };

  const parseBodyMessage = (payload) => {
    if (!payload) return null;
    let body = payload.bodyMessage;
    if (!body) return null;
    if (typeof body === "string") {
      try { return JSON.parse(body); } catch { return null; }
    }
    return body;
  };

  const resolveFastbullTagLabel = (tagIds = []) => {
    if (!Array.isArray(tagIds) || !tagIds.length) return "News";
    for (const idRaw of tagIds) {
      const id = String(idRaw).trim();
      if (!id) continue;
      if (fastbullTagMap[id]) return fastbullTagMap[id];
    }
    return "News";
  };

  const fallbackCopy = (text) => {
    const temp = document.createElement("textarea");
    temp.value = text;
    temp.style.position = "fixed";
    temp.style.opacity = "0";
    document.body.appendChild(temp);
    temp.focus();
    temp.select();
    try{ document.execCommand("copy"); }catch(e){}
    document.body.removeChild(temp);
  };

  const copyHeadlineText = async (text, buttonEl) => {
    if (!text || !buttonEl) return;
    const originalLabel = buttonEl.getAttribute("aria-label") || "Copy headline";

    const setState = (label, success = false) => {
      buttonEl.setAttribute("aria-label", label);
      buttonEl.classList.toggle("copied", success);
      clearTimeout(buttonEl._copyTimer);
      buttonEl._copyTimer = setTimeout(() => {
        buttonEl.setAttribute("aria-label", originalLabel);
        buttonEl.classList.remove("copied");
      }, 1100);
    };

    try {
      if (navigator.clipboard?.writeText) {
        await navigator.clipboard.writeText(text);
      } else {
        fallbackCopy(text);
      }
      setState("Copied!", true);
    } catch {
      setState("Copy failed", false);
    }
  };

  const bindCopyButton = (buttonEl, textProducer) => {
    if (!buttonEl || buttonEl.dataset.bound === "true") return;
    buttonEl.dataset.bound = "true";
    buttonEl.addEventListener("click", (event) => {
      event.stopPropagation();
      const text = typeof textProducer === "function" ? textProducer() : textProducer;
      copyHeadlineText(text || "", buttonEl);
    });
  };

  const formatTimestamp = (value) => {
    if (!value) return "";
    const d = new Date(value);
    if (isNaN(d.getTime())) return value;
    return d.toLocaleTimeString("id-ID", {
      hour:"2-digit",
      minute:"2-digit",
      timeZone:"Asia/Jakarta"
    }) + " WIB";
  };

  const buildCategoryChips = (categories = []) => {
    if (!categories.length) return "";
    const unique = Array.from(new Set(categories.filter(Boolean)));
    if (!unique.length) return "";
    return `<div class="kt-tags">${unique
      .slice(0, 4)
      .map((cat) => `<span class="kt-tag">${escapeHtml(cat)}</span>`)
      .join("")}</div>`;
  };

  const renderLoading = (listEl, countEl) => {
    if (listEl) listEl.innerHTML = '<li class="kt-empty">Loading...</li>';
    if (countEl) countEl.textContent = '...';
  };

  const renderFeed = (
    listEl,
    countEl,
    items,
    sourceName,
    selectedId = null,
    { showSource = true, limit = FEED_DISPLAY_LIMIT } = {}
  ) => {
    if (!listEl) return;
    listEl.innerHTML = "";

    if (!items || !items.length) {
      listEl.innerHTML = '<li class="kt-empty">No items found.</li>';
      if (countEl) countEl.textContent = "0 items";
      return;
    }

    const itemsToRender = limit === Infinity ? [...items] : items.slice(0, limit);
    if (countEl) countEl.textContent = `${itemsToRender.length} items`;

    itemsToRender.forEach(item => {
      const li = document.createElement("li");
      li.className = "kt-item";
      li.dataset.id = String(item.id ?? "");
      li.dataset.important = item.isImportant ? "true" : "false";
      li.dataset.medium = item.isMedium ? "true" : "false";

      if (selectedId && String(item.id) === selectedId) {
        li.classList.add("selected");
      }

      const tagText  = escapeHtml(item.tag || "General");
      const titleText= escapeHtml(item.title || "Untitled");
      const timeText = escapeHtml(item.time || "");
      const chips    = buildCategoryChips(item.categories || []);
      const contentBlock = item.content ? `<p class="kt-item-desc">${escapeHtml(item.content)}</p>` : "";
      const src = showSource ? escapeHtml(item.source || sourceName) : "";

      li.innerHTML = `
        <div class="kt-item-content">
          <div class="kt-item-header">
            <div style="flex:1;font-size:9px;color:var(--text-muted);">${src}</div>
            <div class="kt-item-tag">${tagText}</div>
          </div>
          <div class="kt-item-title">${titleText}</div>
          ${contentBlock}
          ${chips}
          <div class="kt-item-meta">
            <span class="kt-item-time">${timeText}</span>
            <button class="kt-copy-icon" type="button" aria-label="Copy headline">
              ${COPY_ICON_SVG}
            </button>
          </div>
        </div>
      `;
      listEl.appendChild(li);

      const copyBtn = li.querySelector(".kt-copy-icon");
      bindCopyButton(copyBtn, () => item.title || "");
    });
  };

  const applySelectionState = (listEl, selectedId) => {
    if (!listEl) return;
    listEl.querySelectorAll(".kt-item").forEach((entry) => {
      const entryId = entry.dataset?.id || "";
      entry.classList.toggle("selected", !!selectedId && entryId === selectedId);
    });
  };

  const resolveSelectedItems = (items, selectedId) => {
    if (!items || !items.length || !selectedId) return items;
    const filtered = items.filter((item) => String(item.id) === selectedId);
    return filtered.length ? filtered : items;
  };

  // ========= NORMALISASI DATA =========
  const normalizeFastbullItem = (item) => {
    const tagsRaw = (item.tags || "").split(",").map(t => t.trim()).filter(Boolean);
    const tagName = resolveFastbullTagLabel(tagsRaw);
    const isImportant = Number(item.important) === 1;
    return {
      id: item.newsId,
      source: item.simWebsiteName || "FastBull",
      tag: tagName,
      title: item.newsTitle || "Untitled Headline",
      time: formatTimestamp(item.releasedDate),
      impact: isImportant ? "High Impact" : "Medium Impact",
      isImportant,
      timestamp: item.releasedDate
    };
  };

  const normalizeCatalystItem = (item) => {
    if (!item) return null;
    const impact = (item.impact || item.importance || "").toString().trim();
    const category = item.category1 || item.category || "Catalyst";
    const isImportant = /high/i.test(impact);
    const isMedium   = /medium/i.test(impact);

    return {
      id: item.id || item.key || item.headline,
      source: item.source || "Catalyst",
      tag: category,
      title: item.headline || item.title || "Catalyst Update",
      time: formatTimestamp(item.timestamp || item.publishedAt || Date.now()),
      impact,
      isImportant,
      isMedium,
      content: item.content || item.summary || "",
      url: item.url || item.link || "",
      categories: [item.category1, item.category2, item.category3].filter(Boolean)
    };
  };

  // ========= FASTBULL TAG DROPDOWN (all_tag_names style) =========
  const populateFastbullDropdown = (tagData) => {
    if (!fastbullTopicEl) return;
    fastbullTopicEl.innerHTML = "";

    const optAll = document.createElement("option");
    optAll.value = "all";
    optAll.textContent = "All tags (Realtime)";
    fastbullTopicEl.appendChild(optAll);

    const flatTags = [];
    (tagData || []).forEach(category => {
      (category.tagList || []).forEach(tag => {
        flatTags.push({
          id: String(tag.tagId),
          name: String(tag.tagName || "").trim()
        });
      });
    });

    // JS versi:
    // const all_tag_names = flatTags.map(t => t.name);

    flatTags.sort((a, b) => a.name.localeCompare(b.name));

    flatTags.forEach(t => {
      fastbullTagMap[t.id] = t.name;
      const opt = document.createElement("option");
      opt.value = t.id;         // value = tagId
      opt.textContent = t.name; // text = tagName
      fastbullTopicEl.appendChild(opt);
    });

    fastbullTagsLoaded = true;
  };

  const fetchFastbullTags = async () => {
    try {
      let payload;
      try {
        const resp = await fetch(FASTBULL_TAG_URL, { headers: FASTBULL_HEADERS });
        if (!resp.ok) throw new Error("HTTP " + resp.status);
        payload = await resp.json();
      } catch (err) {
        const proxyResp = await fetch(FASTBULL_CORS_PROXY + encodeURIComponent(FASTBULL_TAG_URL));
        if (!proxyResp.ok) throw new Error("HTTP " + proxyResp.status);
        payload = await proxyResp.json();
      }
      const body = parseBodyMessage(payload) || [];
      populateFastbullDropdown(body);
    } catch (e) {
      console.error("Error fetching FastBull tags:", e);
      fastbullTagsLoaded = false;
    }
  };

  // ========= FETCH FASTBULL NEWS =========
  const fetchFastbullNews = async (tagIds = "-1") => {
    if (fastbullCache.has(tagIds)) {
      const data = fastbullCache.get(tagIds);
      renderFeed(
        fastbullFeedEl,
        fastbullCountEl,
        data,
        "FastBull",
        selectedFastbullItemId,
        { showSource:false }
      );
      return;
    }

    renderLoading(fastbullFeedEl, fastbullCountEl);

    try {
      const baseUrl = `${FASTBULL_NEWS_ENDPOINT}?checkImportant=0&pageSize=10000&timestamp=&includeCalendar=0&tagIds=${encodeURIComponent(tagIds)}`;
      let payload;

      try {
        const resp = await fetch(baseUrl, { headers: FASTBULL_HEADERS });
        if (!resp.ok) throw new Error("HTTP " + resp.status);
        payload = await resp.json();
      } catch (err) {
        if (fastbullProxyEnabled) throw err;
        fastbullProxyEnabled = true;
        const proxyResp = await fetch(FASTBULL_CORS_PROXY + encodeURIComponent(baseUrl));
        if (!proxyResp.ok) throw new Error("HTTP " + proxyResp.status);
        payload = await proxyResp.json();
      }

      const bodyObj = parseBodyMessage(payload) || {};
      const list = bodyObj.pageDatas || [];
      const items = list.map(normalizeFastbullItem);

      fastbullCache.set(tagIds, items);
      renderFeed(
        fastbullFeedEl,
        fastbullCountEl,
        items,
        "FastBull",
        selectedFastbullItemId,
        { showSource:false }
      );
    } catch (e) {
      console.error("Error fetching FastBull news:", e);
      fastbullFeedEl.innerHTML = '<li class="kt-empty">Error loading headlines.</li>';
      if (fastbullCountEl) fastbullCountEl.textContent = "0 items";
    }
  };

  const getCurrentFastbullTagIds = () => {
    const val = fastbullTopicEl?.value || "all";
    if (val === "all") return "-1";
    return val; // tagId
  };

  // ========= ARTICLES (KANAN) =========
  const normalizeCategoryKey = (value) => (value || "all").toLowerCase();

  const populateArticleCategories = (items) => {
    if (!articlesTopicEl) return;
    const current = articlesTopicEl.value || "all";
    const categories = Array.from(new Set(items.map((item) => item.tag).filter(Boolean))).sort((a, b) =>
      a.localeCompare(b)
    );
    articlesTopicEl.innerHTML = "";
    const defaultOption = document.createElement("option");
    defaultOption.value = "all";
    defaultOption.textContent = "All categories";
    articlesTopicEl.appendChild(defaultOption);

    categories.forEach((cat) => {
      const opt = document.createElement("option");
      opt.value = cat;
      opt.textContent = cat;
      articlesTopicEl.appendChild(opt);
    });

    if (categories.includes(current)) {
      articlesTopicEl.value = current;
    } else {
      articlesTopicEl.value = "all";
    }
  };

  const getArticleItemsForCategory = (categoryKey = "all") => {
    const baseItems = articlesCache.get("all") || [];
    if (!baseItems.length) return [];
    const normalized = normalizeCategoryKey(categoryKey);
    if (normalized === "all") return baseItems;

    const cacheKey = "filter:" + normalized;
    if (!articlesCache.has(cacheKey)) {
      const filtered = baseItems.filter((item) => normalizeCategoryKey(item.tag) === normalized);
      articlesCache.set(cacheKey, filtered);
    }
    return articlesCache.get(cacheKey) || [];
  };

  const renderArticlesByFilter = (categoryKey = "all") => {
    const items = getArticleItemsForCategory(categoryKey);
    renderFeed(
      articlesFeedEl,
      articlesCountEl,
      items,
      "Catalyst Feed",
      selectedArticleItemId,
      { limit:Infinity }
    );
  };

  const fetchArticles = async () => {
    if (!articlesCache.has("all")) {
      renderLoading(articlesFeedEl, articlesCountEl);
      try {
        const resp = await fetch(CATALYST_FEED_API);
        if (!resp.ok) throw new Error("HTTP " + resp.status);
        const payload = await resp.json();
        const items = (Array.isArray(payload) ? payload : payload?.items || [])
          .map(normalizeCatalystItem)
          .filter(Boolean);
        articlesCache.set("all", items);
      } catch (e) {
        console.error("Error fetching catalyst feed:", e);
        articlesFeedEl.innerHTML = '<li class="kt-empty">Error loading catalyst feed.</li>';
        if (articlesCountEl) articlesCountEl.textContent = "0 items";
        return;
      }
    }
    const baseItems = articlesCache.get("all") || [];
    populateArticleCategories(baseItems);
    renderArticlesByFilter(articlesTopicEl?.value || "all");
  };

  // ========= CHAT / AI (PERSIS LOGIKA LAMA) =========
  const addMessage = (sender, contentMD) => {
    messages.push({ sender, contentMD });
    renderChat();
    return messages.length - 1;
  };

  const updateMessage = (index, contentMD) => {
    if (index < 0 || index >= messages.length) return;
    messages[index].contentMD = contentMD;
    renderChat();
  };

  const renderChat = () => {
    if (!chatListEl) return;
    if (!messages.length) {
      chatListEl.innerHTML = '<p class="placeholder">AI is ready to summarize.</p>';
    } else {
      chatListEl.innerHTML = messages.map(msg => `
        <div class="kuantara-message ${msg.sender === 'Anda' ? 'user' : 'ai'}">
          <p class="kuantara-label">${msg.sender === 'Anda' ? 'YOU' : 'AI'}</p>
          <div class="kuantara-block"><div class="md">${markdownToHtml(msg.contentMD)}</div></div>
        </div>
      `).join("");
    }
    chatListEl.scrollTop = chatListEl.scrollHeight;
  };

  const resetStreamFlags = () => {
    isStreaming = false;
    streamBuffer = "";
  };

  const handleSSEData = (dataStr) => {
    if (!dataStr || dataStr === "[DONE]") return false;
    try {
      const obj = JSON.parse(dataStr);
      const payload = obj?.data ?? obj;
      if (payload?.type === "credit_info") return false;
      if (payload?.type === "message_start") return false;

      if (typeof payload?.text === "string" && payload.text) {
        streamBuffer += payload.text;
        return true;
      }

      const candidateKeys = ["token", "content", "output", "message"];
      for (const key of candidateKeys) {
        const value = payload?.[key];
        if (typeof value === "string" && value) {
          streamBuffer += value;
          return true;
        }
      }

      const choices = payload?.choices;
      if (Array.isArray(choices)) {
        let appended = false;
        choices.forEach(choice => {
          const delta = choice?.delta || choice;
          const text = delta?.content || delta?.text;
          if (typeof text === "string" && text) {
            streamBuffer += text;
            appended = true;
          }
        });
        if (appended) return true;
      }
    } catch {
      streamBuffer += dataStr;
      return true;
    }
    return false;
  };

  async function startStreaming(promptText, { userVisibleText = null } = {}) {
    if (isStreaming) return;
    isStreaming = true;
    streamBuffer = "";
    if (userVisibleText) addMessage("Anda", userVisibleText);
    const aiMessageIndex = addMessage("Kuantara", "Thinking...");

    const payload = {
      model: "grok-4",
      from: "chat",
      client_prompt: {},
      multi_content: [{ type: "text", text: promptText, user_input_text: promptText }],
      stream: true,
      output_language: "id",
    };

    try {
      const resp = await fetch(SIDER_API_BASE + "/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Accept": "text/event-stream",
          "Authorization": "Bearer " + SIDER_TOKEN,
          "x-app-name": "ChitChat_Web",
          "x-time-zone": TIMEZONE,
        },
        body: JSON.stringify(payload),
      });

      if (!resp.ok || !resp.body) {
        throw new Error("HTTP " + resp.status + " - " + resp.statusText);
      }

      const reader = resp.body.getReader();
      const decoder = new TextDecoder();
      let buffer = "";

      while (true) {
        const { value, done } = await reader.read();
        if (done) break;

        buffer += decoder.decode(value, { stream: true });
        let idx;
        let updated = false;

        while ((idx = buffer.indexOf("\n")) >= 0) {
          const rawLine = buffer.slice(0, idx);
          buffer = buffer.slice(idx + 1);
          const line = (rawLine || "").trim();
          if (!line || line === "[DONE]") continue;

          let dataLine = line;
          if (line.startsWith("data:")) {
            dataLine = line.slice(5).trim();
            if (!dataLine || dataLine === "[DONE]") continue;
          }

          if (handleSSEData(dataLine)) updated = true;
        }

        if (updated) {
          updateMessage(aiMessageIndex, streamBuffer);
        }
      }
    } catch (err) {
      updateMessage(aiMessageIndex, "**Connection Error:** " + err.message);
    } finally {
      updateMessage(aiMessageIndex, streamBuffer || "No response from AI.");
      resetStreamFlags();
    }
  }

  const buildRecapPrompt = (source, label, items) => {
    const headlines = items
      .slice(0, MAX_RECAP_ITEMS)
      .map((item, i) => `${i + 1}. [${item.time}] ${item.title}`)
      .join("\n");
    return `You are Kuantara AI. Summarize the following ${source} headlines for the '${label}' bucket into concise Indonesian bullet points. Highlight main macro/market themes, risks, and trading opportunities.\n\nData:\n${headlines}`;
  };

  const openKuantaraModal = ({ key, label, getItems }) => {
    if (!kuantaraModal) return;
    kuantaraModal.classList.remove("hidden");
    kuantaraTitleEl.textContent = label;

    if (!recapConversations.has(key)) recapConversations.set(key, []);
    messages = recapConversations.get(key);
    renderChat();

    if (isStreaming) return;

    try {
      const items = getItems();
      if (!items || !items.length) {
        addMessage("Kuantara", `No data available for ${label} to recap.`);
        return;
      }
      const prompt = buildRecapPrompt(key.startsWith("fastbull") ? "FastBull" : "Catalyst Feed", label, items);
      startStreaming(prompt, { userVisibleText: `Summarize ${label}` });
    } catch (error) {
      addMessage("Kuantara", `Failed to prepare recap data: ${error.message}`);
    }
  };

  // ========= INIT =========
  document.addEventListener("DOMContentLoaded", () => {
    // Tag FastBull -> dropdown
    fetchFastbullTags().finally(() => {
      // Default: All (-1)
      fetchFastbullNews("-1");
    });

    // Articles
    fetchArticles();

    // Ganti tag FastBull
    fastbullTopicEl.addEventListener("change", (e) => {
      e.stopPropagation();
      selectedFastbullItemId = null;
      applySelectionState(fastbullFeedEl, null);
      const tagIds = getCurrentFastbullTagIds();
      fetchFastbullNews(tagIds);
    });

    // Ganti kategori Articles
    articlesTopicEl.addEventListener("change", (e) => {
      e.stopPropagation();
      selectedArticleItemId = null;
      applySelectionState(articlesFeedEl, null);
      renderArticlesByFilter(e.target.value || "all");
    });

    // Klik item FastBull
    fastbullFeedEl?.addEventListener("click", (event) => {
      if (event.target.closest(".kt-copy-icon")) return;
      const itemEl = event.target.closest(".kt-item");
      if (!itemEl || !fastbullFeedEl.contains(itemEl) || itemEl.classList.contains("kt-empty")) return;
      const id = itemEl.dataset.id || "";
      selectedFastbullItemId = itemEl.classList.contains("selected") ? null : id;
      applySelectionState(fastbullFeedEl, selectedFastbullItemId);
    });

    // Klik item Articles
    articlesFeedEl?.addEventListener("click", (event) => {
      if (event.target.closest(".kt-copy-icon")) return;
      const itemEl = event.target.closest(".kt-item");
      if (!itemEl || !articlesFeedEl.contains(itemEl) || itemEl.classList.contains("kt-empty")) return;
      const id = itemEl.dataset.id || "";
      selectedArticleItemId = itemEl.classList.contains("selected") ? null : id;
      applySelectionState(articlesFeedEl, selectedArticleItemId);
    });

    // Recap FastBull
    fastbullRecapBtn.addEventListener("click", () => {
      const tagIds = getCurrentFastbullTagIds();
      const val = fastbullTopicEl.value || "all";
      const selectionActive = !!selectedFastbullItemId;
      let labelName;
      if (val === "all") {
        labelName = "All tags";
      } else {
        labelName = fastbullTagMap[val] || `Tag ${val}`;
      }

      openKuantaraModal({
        key: `fastbull-${tagIds}${selectionActive ? `-${selectedFastbullItemId}` : ""}`,
        label: `${selectionActive ? "Selected Headline" : "Headlines"} (${labelName})`,
        getItems: () => {
          const items = fastbullCache.get(tagIds) || [];
          return resolveSelectedItems(items, selectedFastbullItemId);
        }
      });
    });

    // Recap Articles
    articlesRecapBtn.addEventListener("click", () => {
      const topic = articlesTopicEl.value || "all";
      const topicLabel = articlesTopicEl.options[articlesTopicEl.selectedIndex]?.text || topic;
      const selectionActive = !!selectedArticleItemId;

      openKuantaraModal({
        key: `articles-${topic}${selectionActive ? `-${selectedArticleItemId}` : ""}`,
        label: `${selectionActive ? "Selected Catalyst" : "Catalyst"} (${topicLabel})`,
        getItems: () => {
          const items = getArticleItemsForCategory(topic);
          return resolveSelectedItems(items, selectedArticleItemId);
        }
      });
    });

    // Modal close
    kuantaraCloseBtn.addEventListener("click", () => kuantaraModal.classList.add("hidden"));

    // Chat manual
    sendBtn.addEventListener("click", () => {
      const txt = inputEl.value.trim();
      if (!txt || isStreaming) return;
      inputEl.value = "";
      startStreaming(txt, { userVisibleText: txt });
    });

    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendBtn.click();
      }
    });
  });
</script>
</body>
</html>
