<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Kuantara – 24/7 Headlines</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;700&display=swap">

  <style>
    :root{
      --bg-root:#000000;
      --bg-main:#111111;
      --border-soft:#2b2b2b;
      --text-main:#f5f5f5;
      --text-muted:#9b9b9b;
      --accent:#ffbf00;

      --fs-title:14px;
      --fs-subtitle:12px;
      --fs-body:11px;
      --fs-small:9.5px;
    }

    *{
      box-sizing:border-box; margin:0; padding:0;
      font-family:"Fira Code",monospace!important;
      scrollbar-width:thin; scrollbar-color:rgba(0,0,0,0.6) transparent;
    }

    *::-webkit-scrollbar{ width:6px; height:6px; }
    *::-webkit-scrollbar-track{ background:transparent; }
    *::-webkit-scrollbar-thumb{ background:rgba(0,0,0,0.7); border-radius:3px; }

    html,body{
      width:100%; height:100%;
      background:#000000; color:var(--text-main);
      overflow:hidden;
    }

    .kt-root{
      width:100%; height:100%; padding:16px;
      background:var(--bg-root);
      display:flex; flex-direction:column;
    }

    .kt-grid{
      flex:1;
      display:flex;
      flex-direction:column;
      width:100%;
      max-height:100%;
      min-height:0;
    }

    .kt-panel{
      background:var(--bg-main); border:1px solid var(--border-soft);
      border-radius:4px; padding:12px 14px;
      display:flex; flex-direction:column; min-width:0; min-height:0;
      flex:1;
    }

    .kt-panel-header{
      display:flex; align-items:center; justify-content:space-between;
      gap:8px; margin-bottom:8px;
    }

    .kt-panel-title-area{ display:flex; align-items:center; gap:8px; }

    .kt-panel-title{
      font-size:var(--fs-title); font-weight:600;
      color:var(--text-main); letter-spacing:0.02em;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .live-indicator{
      width:6px; height:6px; background-color:#22c55e;
      border-radius:50%; box-shadow:0 0 8px #22c55e;
      animation:pulse 2s infinite;
    }
    @keyframes pulse{
      0%{opacity:1; transform:scale(1);}
      50%{opacity:0.4; transform:scale(0.8);}
      100%{opacity:1; transform:scale(1);}
    }

    .kt-panel-controls{
      display:flex; align-items:center; gap:6px; min-width:0;
    }

    .kt-select{
      background:#000000; border:1px solid var(--border-soft);
      color:var(--text-main); font-size:var(--fs-small);
      padding:4px 6px; border-radius:3px; outline:none;
      max-width:180px; width:100%;
      appearance:none; -moz-appearance:none; -webkit-appearance:none;
    }
    .kt-select:focus{ border-color:var(--accent); box-shadow:0 0 0 1px rgba(255,191,0,0.25); }
    .kt-select optgroup{ font-style:normal; color:var(--accent); background:#1a1a1a; }
    .kt-select option{ color:var(--text-main); background:#000000; padding:4px; }

    .kt-btn{
      border:none; outline:none; cursor:pointer;
      font-size:var(--fs-small); padding:5px 10px;
      border-radius:3px; background:var(--accent); color:#000000;
      white-space:nowrap; display:inline-flex; align-items:center; gap:4px; flex-shrink:0;
    }
    .kt-btn:hover{ filter:brightness(1.05); }

    .kt-panel-body{
      border-top:1px solid var(--border-soft); margin-top:8px; padding-top:8px;
      display:flex; flex-direction:column; flex:1; min-height:0;
    }

    .kt-meta-row{
      display:flex; justify-content:space-between; align-items:center;
      gap:8px; margin-bottom:8px;
      font-size:var(--fs-small); color:var(--text-muted);
    }
    .kt-meta-left{ white-space:nowrap; }
    .kt-meta-right{ display:flex; align-items:center; gap:6px; }

    .kt-filter-btn{
      border:1px solid var(--border-soft);
      background:#050505;
      color:var(--text-muted);
      font-size:var(--fs-small);
      padding:4px 8px;
      border-radius:999px;
      cursor:pointer;
      white-space:nowrap;
      transition:background 0.15s ease,color 0.15s ease,border-color 0.15s ease;
    }
    .kt-filter-btn.active{
      background:var(--accent);
      color:#000000;
      border-color:var(--accent);
    }

    .kt-feed{
      list-style:none; margin:0; padding:0;
      display:flex; flex-direction:column; gap:6px;
      flex:1; min-height:0; overflow-y:auto;
    }
    #fastbull-feed{ max-height:100%; }

    .kt-item{
      border:1px solid var(--border-soft); border-radius:3px;
      padding:6px 6px; background:#111111; cursor:pointer;
      transition:border-color 0.2s ease, background 0.2s ease;
      display:flex; flex-direction:column; gap:4px;
    }
    .kt-item.selected{ border-color:var(--accent); background:#18120a; }

    .kt-item[data-important="true"] .kt-item-content{
      border:1px solid rgba(14,165,233,0.65);
      background:linear-gradient(140deg,rgba(5,10,20,0.95),rgba(8,47,73,0.85));
      box-shadow:0 0 18px rgba(14,165,233,0.18);
    }
    .kt-item[data-important="true"].selected .kt-item-content{ border-color:rgba(59,130,246,0.8); }

    .kt-item[data-medium="true"]:not([data-important="true"]) .kt-item-content{
      border-color:rgba(59,130,246,0.35);
      background:linear-gradient(135deg,rgba(30,64,175,0.16),rgba(6,8,12,0.96));
    }

    .kt-item .kt-item-content{
      background:rgba(255,255,255,0.01); border:1px solid rgba(255,255,255,0.06);
      border-radius:4px; padding:6px; display:flex; flex-direction:column; gap:4px;
    }

    .kt-item-header{ display:flex; align-items:center; justify-content:flex-end; gap:8px; }
    .kt-item-tag{ font-size:var(--fs-small); color:var(--accent); }

    .kt-tags{ display:flex; flex-wrap:wrap; gap:4px; margin-top:2px; }
    .kt-tag{
      font-size:9px; text-transform:uppercase; letter-spacing:0.08em;
      padding:2px 6px; border:1px solid rgba(255,255,255,0.2);
      border-radius:999px; color:var(--text-muted);
    }

    .kt-item-title{ font-size:var(--fs-body); color:var(--text-main); }
    .kt-item-desc{ font-size:var(--fs-small); color:var(--text-muted); line-height:1.4; }

    .kt-item-meta{
      display:flex; justify-content:space-between; align-items:center; gap:8px;
      font-size:var(--fs-small); color:var(--text-muted); margin-top:2px;
    }
    .kt-item-time{ white-space:nowrap; }

    .kt-copy-icon{
      border:1px solid rgba(255,255,255,0.2); background:rgba(0,0,0,0.3);
      color:var(--text-main); width:26px; height:22px;
      display:flex; align-items:center; justify-content:center;
      border-radius:4px; cursor:pointer; transition:all 0.2s ease;
      padding:0; flex-shrink:0;
    }
    .kt-copy-icon svg{ width:13px; height:13px; stroke:currentColor; }
    .kt-copy-icon:hover{ border-color:var(--accent); color:var(--accent); }
    .kt-copy-icon.copied{ border-color:#2ea043; color:#2ea043; }

    .kt-empty{
      font-size:var(--fs-small); color:var(--text-muted);
      padding:6px 2px; text-align:center;
    }

    /* Modal */
    .modal-overlay{
      position:fixed; inset:0; background:rgba(0,0,0,0.78);
      display:flex; align-items:center; justify-content:center;
      padding:16px; z-index:999;
    }
    .modal-card{
      width:min(960px,100%); max-height:min(520px,100%);
      background:#050505; border:1px solid rgba(255,255,255,0.08);
      box-shadow:0 30px 120px rgba(0,0,0,0.75); padding:16px;
      position:relative; overflow-y:auto;
    }
    .modal-close{
      border:1px solid rgba(255,255,255,0.18); background:transparent;
      color:#ffbf00; width:32px; height:32px; border-radius:999px;
      font-size:1rem; cursor:pointer;
    }
    .modal-close:hover{ background:rgba(255,255,255,0.06); }

    .kuantara-chat{
      border:1px solid rgba(255,255,255,0.08); background:rgba(0,0,0,0.55);
      padding:12px; min-height:200px; max-height:320px; overflow-y:auto;
      font-size:var(--fs-body); line-height:1.5; scrollbar-width:none; margin-top:10px;
    }
    .kuantara-chat::-webkit-scrollbar{ width:0; height:0; }
    .kuantara-chat .placeholder{
      font-size:10px; letter-spacing:0.08em; text-transform:uppercase;
      color:rgba(255,255,255,0.4); text-align:center;
    }
    .kuantara-message{ margin-bottom:10px; }
    .kuantara-label{
      font-size:9px; letter-spacing:0.14em; text-transform:uppercase;
      color:rgba(255,255,255,0.5);
    }
    .kuantara-message.user .kuantara-label{ color:#7dd3fc; }
    .kuantara-message.ai .kuantara-label{ color:#ffbf00; }
    .kuantara-block{
      margin-top:4px; border:1px solid rgba(255,255,255,0.08);
      border-radius:10px; padding:8px 10px; background:rgba(15,23,42,0.9);
    }
    .kuantara-message.ai .kuantara-block{
      border-radius:0; border:none; background:transparent; padding:6px 0;
    }
    .kuantara-block .md p{ margin:3px 0; }
    .kuantara-block .md ul,.kuantara-block .md ol{ padding-left:18px; margin:3px 0; }
    .kuantara-input{ margin-top:10px; display:flex; gap:8px; }
    .kuantara-input textarea{
      flex:1; min-height:44px; max-height:200px;
      border:1px solid rgba(255,255,255,0.14); background:rgba(0,0,0,0.4);
      color:#fff; padding:6px 8px; resize:none; font-size:var(--fs-small);
    }
    .kuantara-send-btn{
      width:52px; border:none; border-radius:10px; background:#ffffff;
      display:grid; place-items:center; color:#050505; cursor:pointer;
      transition:transform 0.12s ease;
    }
    .kuantara-send-btn:hover{ transform:translateY(-1px); }

    .flex{ display:flex; }
    .items-center{ align-items:center; }
    .justify-between{ justify-content:space-between; }
    .hidden{ display:none!important; }
  </style>
</head>
<body>
<div class="kt-root">
  <div class="kt-grid">
    <!-- PANEL: 24/7 HEADLINES (full page) -->
    <section class="kt-panel" id="panel-fastbull">
      <div class="kt-panel-header">
        <div class="kt-panel-title-area">
          <div class="live-indicator" title="Auto-refreshing every 60s"></div>
          <div class="kt-panel-title">24/7 Headlines</div>
        </div>
        <div class="kt-panel-controls">
          <select class="kt-select" id="fastbull-topic">
             <option value="all">Loading...</option>
          </select>
          <button class="kt-btn" id="fastbull-recap-btn">Recap AI</button>
        </div>
      </div>

      <div class="kt-panel-body">
        <div class="kt-meta-row">
          <div class="kt-meta-left" id="fastbull-count"></div>
          <div class="kt-meta-right">
            <button class="kt-filter-btn" id="fastbull-highimpact-btn">High Impact</button>
          </div>
        </div>

        <ul class="kt-feed" id="fastbull-feed">
          <li class="kt-item">
            <div class="kt-item-content">
              <div class="kt-item-header"><div class="kt-item-tag">Loading</div></div>
              <div class="kt-item-title">Initializing Feed...</div>
              <div class="kt-item-meta"><span class="kt-item-time">...</span></div>
            </div>
          </li>
        </ul>
      </div>
    </section>
  </div>
</div>

<div id="kuantaraModal" class="modal-overlay hidden">
  <div id="card" class="modal-card">
    <div class="flex items-center justify-between">
      <div>
        <p style="font-size:9px;letter-spacing:0.3em;text-transform:uppercase;color:#6b7280;">Kuantara AI</p>
        <h2 id="kuantaraTitle" style="font-size:14px;margin-top:4px;">Recap</h2>
      </div>
      <button id="kuantaraClose" type="button" class="modal-close">&times;</button>
    </div>
    <div class="kuantara-chat" id="chatList"></div>
    <div class="kuantara-input">
      <textarea id="input" placeholder="Tulis instruksi untuk Kuantara…"></textarea>
      <button id="send" type="button" class="kuantara-send-btn" aria-label="Kirim">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19V5"></path><path d="m5 12 7-7 7 7"></path></svg>
      </button>
    </div>
  </div>
</div>

<script>
  // ========== CONFIG ==========
  const SIDER_API_BASE = "https://sider.ai/api/chat/v1";
  const TIMEZONE = "Asia/Makassar";
  const SIDER_TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoyMTgzNzM0NiwicmVnaXN0ZXJfdHlwZSI6Im9hdXRoMiIsImFwcF9uYW1lIjoiQ2hpdENoYXRfQ2hyb21lX0V4dCIsInRva2VuX2lkIjoiZTZlOGIwZGUtN2Q3Zi00NTZkLTkxNGQtNzUwNDQ0ZjkyZTNjIiwiaXNzIjoic2lkZXIuYWkiLCJhdWQiOlsiIl0sImV4cCI6MTc4ODY5NjUxMCwibmJmIjoxNzU3NTkyNTEwLCJpYXQiOjE3NTc1OTI1MTB9.mcq86TwFwPtql3S77_vhnJRGj08878Ej5WGkvY3OxWI";

  const FASTBULL_NEWS_ENDPOINT = "https://api.fastbull.com/fastbull-news-service/api/getNewsPageByTagIds";
  const FASTBULL_HEADERS = { Accept: "application/json", "client-type": "4", clientversion: "latest", langid: "13" };
  const FASTBULL_CORS_PROXY = "https://api.allorigins.win/raw?url=";

  const MAX_RECAP_ITEMS = 15;
  const AUTO_REFRESH_INTERVAL = 60000;
  const FEED_DISPLAY_LIMIT = 120;

  // =======================================================================
  // DATA TAG FASTBULL
  // =======================================================================
  const FASTBULL_TAG_DATA = [
    {
      categoryName: "Highlights",
      tagList: [
        { id: 143, tagName: "Breaking/Top News" },
        { id: 174, tagName: "Corporate Announcements" }
      ]
    },
    {
      categoryName: "Macro & Central Banks",
      tagList: [
        { id: 100, tagName: "All Central Banks" },
        { id: 115, tagName: "Fed (USA)" },
        { id: 118, tagName: "ECB (Europe)" },
        { id: 120, tagName: "BOE (UK)" },
        { id: 123, tagName: "BOJ (Japan)" },
        { id: 124, tagName: "RBA (Australia)" },
        { id: 116, tagName: "BOC (Canada)" },
        { id: 114, tagName: "PBOC (China)" },
        { id: 132, tagName: "Central Banks Updates" },
        { id: 110, tagName: "Inflation" },
        { id: 111, tagName: "Interest Rates" },
        { id: 112, tagName: "Employment" },
        { id: 125, tagName: "Monetary Policy" },
        { id: 127, tagName: "Fiscal Policy" }
      ]
    },
    {
      categoryName: "Markets",
      tagList: [
        { id: 94, tagName: "Forex (FX)" },
        { id: 95, tagName: "Stocks (Equities)" },
        { id: 152, tagName: "Major Indices" },
        { id: 169, tagName: "Stock Ratings" },
        { id: 163, tagName: "Dividends" },
        { id: 97, tagName: "Commodities" },
        { id: 117, tagName: "Trade" }
      ]
    },
    {
      categoryName: "Crypto",
      tagList: [
        { id: 98, tagName: "Cryptocurrency" },
        { id: 155, tagName: "Bitcoin" },
        { id: 157, tagName: "Ethereum" },
        { id: 134, tagName: "Regulation (Crypto)" }
      ]
    },
    {
      categoryName: "Geopolitics & Events",
      tagList: [
        { id: 136, tagName: "National Security" },
        { id: 105, tagName: "Disasters/Accidents" },
        { id: 108, tagName: "Russia-Ukraine" },
        { id: 177, tagName: "Middle East" },
        { id: 176, tagName: "Trump Trade" },
        { id: 135, tagName: "Politics" }
      ]
    }
  ];

  const FASTBULL_ID_TO_LABEL = {};
  FASTBULL_TAG_DATA.forEach(cat => {
    cat.tagList.forEach(tag => {
      FASTBULL_ID_TO_LABEL[tag.id] = tag.tagName;
      FASTBULL_ID_TO_LABEL[String(tag.id)] = tag.tagName;
    });
  });

  const getAllFastbullIds = () => {
    const ids = [];
    FASTBULL_TAG_DATA.forEach(cat => {
      cat.tagList.forEach(tag => ids.push(tag.id));
    });
    // Tambahan ID long tail
    ids.push(109, 144, 119, 122, 129, 133, 137, 154, 156, 158, 162, 164);
    return [...new Set(ids)].join(",");
  };

  // ========== DOM ==========
  const fastbullFeedEl   = document.getElementById("fastbull-feed");
  const fastbullCountEl  = document.getElementById("fastbull-count");
  const fastbullTopicEl  = document.getElementById("fastbull-topic");
  const fastbullRecapBtn = document.getElementById("fastbull-recap-btn");
  const fastbullHighImpactBtn = document.getElementById("fastbull-highimpact-btn");

  const kuantaraModal    = document.getElementById("kuantaraModal");
  const kuantaraCloseBtn = document.getElementById("kuantaraClose");
  const kuantaraTitleEl  = document.getElementById("kuantaraTitle");
  const chatListEl       = document.getElementById("chatList");
  const inputEl          = document.getElementById("input");
  const sendBtn          = document.getElementById("send");
  const copyIconSvg      = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>';

  // ========== STATE ==========
  const fastbullCache = new Map();
  let fastbullProxyEnabled = false;

  let highImpactOnly = false;

  // AI State
  let isStreaming = false;
  let streamBuffer = "";
  const recapConversations = new Map();
  let messages = [];
  let selectedFastbullItemId = null;

  // ========== HELPERS ==========
  const escapeHtml = (value = "") => {
    const str = value == null ? "" : String(value);
    return str
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#39;");
  };

  const markdownToHtml = (md) => {
    if (!md) return "";
    let html = md.replace(/\n/g,"<br>");
    html = html.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>");
    return html;
  };

  const initFastbullDropdown = () => {
    fastbullTopicEl.innerHTML = "";
    const allOpt = document.createElement("option");
    allOpt.value = "all";
    allOpt.textContent = "All Topics";
    fastbullTopicEl.appendChild(allOpt);

    FASTBULL_TAG_DATA.forEach(cat => {
      const group = document.createElement("optgroup");
      group.label = cat.categoryName;
      cat.tagList.forEach(tag => {
        const opt = document.createElement("option");
        opt.value = tag.id;
        opt.textContent = tag.tagName;
        group.appendChild(opt);
      });
      fastbullTopicEl.appendChild(group);
    });
  };

  const resolveFastbullTagLabel = (rawTagsArray, currentTopicId) => {
    if (!Array.isArray(rawTagsArray)) return "News";

    if (currentTopicId && currentTopicId !== "all") {
      const targetId = String(currentTopicId);
      if (rawTagsArray.includes(targetId) && FASTBULL_ID_TO_LABEL[targetId]) {
        return FASTBULL_ID_TO_LABEL[targetId];
      }
    }

    for (const id of rawTagsArray) {
      const label = FASTBULL_ID_TO_LABEL[id];
      if (label && id !== "143") return label;
    }

    if (rawTagsArray.includes("143")) return "Breaking News";
    return "News";
  };

  const formatTimestamp = (value) => {
    if (!value) return "";
    const d = new Date(value);
    if (isNaN(d.getTime())) return value;
    return d.toLocaleTimeString("id-ID",{
      hour:"2-digit",
      minute:"2-digit",
      timeZone:"Asia/Jakarta"
    }) + " WIB";
  };

  const buildCategoryChips = (categories = []) => {
    const unique = [...new Set(categories.filter(Boolean))];
    if (!unique.length) return "";
    return `<div class="kt-tags">${unique.slice(0,4).map(c=>`<span class="kt-tag">${escapeHtml(c)}</span>`).join("")}</div>`;
  };

  const fallbackCopy = (text) => {
    const temp = document.createElement("textarea");
    temp.value = text;
    temp.style.position = "fixed";
    temp.style.opacity = "0";
    document.body.appendChild(temp);
    temp.focus();
    temp.select();
    try{ document.execCommand("copy"); }catch{}
    document.body.removeChild(temp);
  };

  const copyHeadlineText = async (text, buttonEl) => {
    if (!text || !buttonEl) return;
    const originalLabel = buttonEl.getAttribute("aria-label") || "Copy headline";

    const setState = (label, success=false) => {
      buttonEl.setAttribute("aria-label",label);
      buttonEl.classList.toggle("copied",success);
      clearTimeout(buttonEl._copyTimer);
      buttonEl._copyTimer = setTimeout(()=>{
        buttonEl.setAttribute("aria-label",originalLabel);
        buttonEl.classList.remove("copied");
      },1100);
    };

    try{
      if (navigator.clipboard?.writeText){
        await navigator.clipboard.writeText(text);
      }else{
        fallbackCopy(text);
      }
      setState("Copied!",true);
    }catch{
      setState("Copy failed",false);
    }
  };

  const bindCopyButton = (buttonEl, textProducer) => {
    if (!buttonEl || buttonEl.dataset.bound === "true") return;
    buttonEl.dataset.bound = "true";
    buttonEl.addEventListener("click",(event)=>{
      event.stopPropagation();
      const text = typeof textProducer === "function" ? textProducer() : textProducer;
      copyHeadlineText(text || "",buttonEl);
    });
  };

  const renderFeed = (
    listEl,
    countEl,
    items,
    sourceName,
    selectedId = null,
    { showSource = true, limit = FEED_DISPLAY_LIMIT } = {}
  ) => {
    if (!listEl) return;
    const prevScroll = listEl.scrollTop;
    listEl.innerHTML = "";

    if (!items || !items.length){
      listEl.innerHTML = '<li class="kt-empty">No items found.</li>';
      if (countEl) countEl.textContent = "0 items";
      return;
    }

    const itemsToRender = limit === Infinity ? [...items] : items.slice(0, limit);
    if (countEl) countEl.textContent = `${itemsToRender.length} items`;

    itemsToRender.forEach(item => {
      const li = document.createElement("li");
      li.className = "kt-item";
      li.dataset.id = String(item.id ?? "");
      li.dataset.important = item.isImportant ? "true" : "false";
      li.dataset.medium = item.isMedium ? "true" : "false";

      if (selectedId && String(item.id) === selectedId){
        li.classList.add("selected");
      }

      const src = showSource ? escapeHtml(item.source || sourceName) : "";

      li.innerHTML = `
        <div class="kt-item-content">
          <div class="kt-item-header">
            <div style="flex:1;font-size:9px;color:var(--text-muted);">${src}</div>
            <div class="kt-item-tag">${escapeHtml(item.tag || "General")}</div>
          </div>
          <div class="kt-item-title">${escapeHtml(item.title || "Untitled")}</div>
          ${item.content ? `<p class="kt-item-desc">${escapeHtml(item.content)}</p>` : ""}
          ${buildCategoryChips(item.categories || [])}
          <div class="kt-item-meta">
            <span class="kt-item-time">${escapeHtml(item.time || "")}</span>
            <button class="kt-copy-icon" type="button" aria-label="Copy headline">
              ${copyIconSvg}
            </button>
          </div>
        </div>`;

      const copyBtn = li.querySelector(".kt-copy-icon");
      bindCopyButton(copyBtn, () => item.title || "");
      listEl.appendChild(li);
    });

    listEl.scrollTop = prevScroll;
  };

  const normalizeFastbullItem = (item, currentTopicId) => {
    const rawTagsStr = typeof item.tags === "string" ? item.tags : "";
    const rawTagsArray = rawTagsStr.split(",").map(t => t.trim()).filter(Boolean);

    return {
      id: item.newsId,
      source: item.simWebsiteName || "FastBull",
      tag: resolveFastbullTagLabel(rawTagsArray, currentTopicId),
      rawTags: rawTagsArray,
      title: item.newsTitle || "Untitled Headline",
      time: formatTimestamp(item.releasedDate),
      isImportant: Number(item.important) === 1,
      isMedium: false,
      timestamp: item.releasedDate
    };
  };

  const getCurrentFastbullTopicKey = () => fastbullTopicEl.value || "all";

  const getFastbullItemsForTopic = (topicKey) => {
    return fastbullCache.get(topicKey) || [];
  };

  const getFastbullItemsForDisplay = () => {
    const topicKey = getCurrentFastbullTopicKey();
    let items = getFastbullItemsForTopic(topicKey);
    if (highImpactOnly){
      items = items.filter(item => item.isImportant);
    }
    return items;
  };

  const renderFastbull = () => {
    const items = getFastbullItemsForDisplay();
    renderFeed(
      fastbullFeedEl,
      fastbullCountEl,
      items,
      "FastBull",
      selectedFastbullItemId,
      { showSource:false }
    );
  };

  // ========== FETCHING ==========
  const fetchFastbullNews = async (topicId = "all", forceRefresh = false) => {
    const cacheKey = topicId;
    let tagIdsToSend = topicId === "all" ? getAllFastbullIds() : topicId;

    if (!forceRefresh && fastbullCache.has(cacheKey)){
      renderFastbull();
      return;
    }

    if (!forceRefresh){
      fastbullFeedEl.innerHTML = '<li class="kt-empty">Loading headlines...</li>';
      fastbullCountEl.textContent = "...";
    }

    try{
      const baseUrl = `${FASTBULL_NEWS_ENDPOINT}?checkImportant=0&pageSize=100&tagIds=${tagIdsToSend}`;
      let payload;

      try{
        const r = await fetch(baseUrl,{ headers:FASTBULL_HEADERS });
        if (!r.ok) throw new Error("HTTP " + r.status);
        payload = await r.json();
      }catch(err){
        if (fastbullProxyEnabled) throw err;
        fastbullProxyEnabled = true;
        const r = await fetch(FASTBULL_CORS_PROXY + encodeURIComponent(baseUrl));
        if (!r.ok) throw new Error("HTTP " + r.status);
        payload = await r.json();
      }

      const list = JSON.parse(payload.bodyMessage || "{}").pageDatas || [];
      let items = list.map(item => normalizeFastbullItem(item, topicId));

      if (topicId !== "all"){
        const requestedIds = topicId.split(",").map(s => s.trim()).filter(Boolean);
        items = items.filter(item => item.rawTags.some(rt => requestedIds.includes(rt)));
      }

      fastbullCache.set(cacheKey, items);
      renderFastbull();
    }catch(e){
      if (!forceRefresh){
        fastbullFeedEl.innerHTML = '<li class="kt-empty">Error loading data.</li>';
        fastbullCountEl.textContent = "0 items";
      }
    }
  };

  // ========= SELECTION UTILS ==========
  const resolveSelectedItems = (items, selectedId) => {
    if (!items || !items.length || !selectedId) return items;
    const filtered = items.filter((item) => String(item.id) === selectedId);
    return filtered.length ? filtered : items;
  };

  // ========== AI / CHAT ==========
  const addMessage = (sender, contentMD) => {
    messages.push({ sender, contentMD });
    renderChat();
    return messages.length - 1;
  };

  const updateMessage = (index, contentMD) => {
    if (index < 0 || index >= messages.length) return;
    messages[index].contentMD = contentMD;
    renderChat();
  };

  const renderChat = () => {
    if (!chatListEl) return;
    if (!messages.length){
      chatListEl.innerHTML = '<p class="placeholder">AI Ready to Recap.</p>';
    }else{
      chatListEl.innerHTML = messages.map(msg => `
        <div class="kuantara-message ${msg.sender === 'Anda' ? 'user' : 'ai'}">
          <p class="kuantara-label">${msg.sender === 'Anda' ? 'YOU' : 'AI'}</p>
          <div class="kuantara-block"><div class="md">${markdownToHtml(msg.contentMD)}</div></div>
        </div>
      `).join("");
    }
    chatListEl.scrollTop = chatListEl.scrollHeight;
  };

  const resetStreamFlags = () => {
    isStreaming = false;
    streamBuffer = "";
  };

  const handleSSEData = (dataStr) => {
    if (!dataStr || dataStr === "[DONE]") return false;
    try{
      const obj = JSON.parse(dataStr);
      const payload = obj?.data ?? obj;
      if (payload?.type === "credit_info") return false;
      if (payload?.type === "message_start") return false;

      if (typeof payload?.text === "string" && payload.text){
        streamBuffer += payload.text;
        return true;
      }

      const candidateKeys = ["token","content","output","message"];
      for (const key of candidateKeys){
        const value = payload?.[key];
        if (typeof value === "string" && value){
          streamBuffer += value;
          return true;
        }
      }

      const choices = payload?.choices;
      if (Array.isArray(choices)){
        let appended = false;
        choices.forEach(choice => {
          const delta = choice?.delta || choice;
          const text = delta?.content || delta?.text;
          if (typeof text === "string" && text){
            streamBuffer += text;
            appended = true;
          }
        });
        if (appended) return true;
      }
    }catch{
      streamBuffer += dataStr;
      return true;
    }
    return false;
  };

  async function startStreaming(promptText, { userVisibleText = null } = {}){
    if (isStreaming) return;
    isStreaming = true;
    streamBuffer = "";

    if (userVisibleText) addMessage("Anda", userVisibleText);
    const aiMessageIndex = addMessage("Kuantara","Thinking...");

    const payload = {
      model:"grok-4",
      from:"chat",
      client_prompt:{},
      multi_content:[{ type:"text", text:promptText, user_input_text:promptText }],
      stream:true,
      output_language:"id",
    };

    try{
      const resp = await fetch(SIDER_API_BASE + "/completions",{
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "Accept":"text/event-stream",
          "Authorization":"Bearer " + SIDER_TOKEN,
          "x-app-name":"ChitChat_Web",
          "x-time-zone":TIMEZONE,
        },
        body:JSON.stringify(payload),
      });

      if (!resp.ok || !resp.body){
        throw new Error("HTTP " + resp.status + " - " + resp.statusText);
      }

      const reader = resp.body.getReader();
      const decoder = new TextDecoder();
      let buffer = "";

      while (true){
        const { value, done } = await reader.read();
        if (done) break;

        buffer += decoder.decode(value,{ stream:true });
        let idx;
        let updated = false;

        while ((idx = buffer.indexOf("\n")) >= 0){
          const rawLine = buffer.slice(0, idx);
          buffer = buffer.slice(idx + 1);
          const line = (rawLine || "").trim();
          if (!line || line === "[DONE]") continue;

          let dataLine = line;
          if (line.startsWith("data:")){
            dataLine = line.slice(5).trim();
            if (!dataLine || dataLine === "[DONE]") continue;
          }

          if (handleSSEData(dataLine)) updated = true;
        }

        if (updated){
          updateMessage(aiMessageIndex, streamBuffer);
        }
      }
    }catch(err){
      updateMessage(aiMessageIndex, "**Connection Error:** " + err.message);
    }finally{
      updateMessage(aiMessageIndex, streamBuffer || "No response from AI.");
      resetStreamFlags();
    }
  }

  const buildRecapPrompt = (source, label, items) => {
    const headlines = items
      .slice(0, MAX_RECAP_ITEMS)
      .map((item,i)=>`${i+1}. [${item.time}] ${item.title}`)
      .join("\n");
    return `You are Kuantara AI. Summarize the following ${source} headlines for the '${label}' bucket into concise Indonesian bullet points. Highlight main macro/market themes, risks, and trading opportunities.\n\nData:\n${headlines}`;
  };

  const openKuantaraModal = ({ key, label, getItems }) => {
    if (!kuantaraModal) return;
    kuantaraModal.classList.remove("hidden");
    kuantaraTitleEl.textContent = label;

    if (!recapConversations.has(key)) recapConversations.set(key, []);
    messages = recapConversations.get(key);
    renderChat();

    if (isStreaming) return;

    try{
      const items = getItems();
      if (!items || !items.length){
        addMessage("Kuantara", `No data available for ${label} to recap.`);
        return;
      }
      const prompt = buildRecapPrompt("FastBull", label, items);
      startStreaming(prompt,{ userVisibleText:`Summarize ${label}` });
    }catch(error){
      addMessage("Kuantara", `Failed to prepare recap data: ${error.message}`);
    }
  };

  // ========== INIT ==========
  document.addEventListener("DOMContentLoaded", () => {
    initFastbullDropdown();

    fetchFastbullNews("all");
    setInterval(() => {
      fetchFastbullNews(getCurrentFastbullTopicKey(), true);
    }, AUTO_REFRESH_INTERVAL);

    fastbullTopicEl.addEventListener("change",(e)=>{
      selectedFastbullItemId = null;
      fetchFastbullNews(e.target.value);
    });

    // Selection
    const bindSelect = (el) => {
      el.addEventListener("click",(e)=>{
        if (e.target.closest(".kt-copy-icon")) return;
        const item = e.target.closest(".kt-item");
        if (!item || item.classList.contains("kt-empty")) return;

        const id = item.dataset.id;
        const isSel = item.classList.contains("selected");

        selectedFastbullItemId = isSel ? null : id;

        el.querySelectorAll(".kt-item").forEach(i => {
          const targetId = selectedFastbullItemId;
          i.classList.toggle("selected", i.dataset.id === targetId);
        });
      });
    };
    bindSelect(fastbullFeedEl);

    // High Impact filter button
    fastbullHighImpactBtn.addEventListener("click", () => {
      highImpactOnly = !highImpactOnly;
      fastbullHighImpactBtn.classList.toggle("active", highImpactOnly);
      renderFastbull();
    });

    // Recap
    fastbullRecapBtn.addEventListener("click", () => {
      const topic = getCurrentFastbullTopicKey();
      const topicLabel = fastbullTopicEl.options[fastbullTopicEl.selectedIndex]?.text || topic;
      const selectionActive = !!selectedFastbullItemId;

      openKuantaraModal({
        key: `fastbull-${topic}${selectionActive ? `-${selectedFastbullItemId}` : ""}${highImpactOnly ? "-high" : "-all"}`,
        label: `${selectionActive ? "Selected Headline" : (highImpactOnly ? "High Impact Headlines" : "Headlines")} (${topicLabel})`,
        getItems: () => {
          let items = getFastbullItemsForDisplay();
          return resolveSelectedItems(items, selectedFastbullItemId);
        }
      });
    });

    kuantaraCloseBtn.addEventListener("click", () => kuantaraModal.classList.add("hidden"));

    sendBtn.addEventListener("click", () => {
      const txt = inputEl.value.trim();
      if (!txt || isStreaming) return;
      inputEl.value = "";
      startStreaming(txt,{ userVisibleText:txt });
    });

    inputEl.addEventListener("keydown",(e)=>{
      if (e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        sendBtn.click();
      }
    });
  });
</script>
</body>
</html>
