<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Kuantara – Equities Market Snapshot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;700&display=swap">

  <style>
    :root {
      --amber:#ffbf00;
      --bg-root:#000000;
      --bg-main:#111111;
      --border-soft:#2b2b2b;
      --text-main:#f5f5f5;
      --text-muted:#9b9b9b;

      --fs-title:14px;
      --fs-subtitle:12px;
      --fs-body:11px;
      --fs-small:9.5px;

      --green:#22c55e;
      --red:#ef4444;
    }

    * {
      box-sizing:border-box;
      margin:0;
      padding:0;
      font-family:"Fira Code",monospace !important;
      scrollbar-width:thin;
      scrollbar-color:rgba(255,255,255,0.2) transparent;
    }

    html, body {
      width:100%;
      height:100%;
      background:var(--bg-root);
      color:var(--text-main);
      overflow:hidden;
    }

    ::-webkit-scrollbar {
      width:4px;
      height:4px;
    }
    ::-webkit-scrollbar-track {
      background:transparent;
    }
    ::-webkit-scrollbar-thumb {
      background:rgba(255,255,255,0.2);
      border-radius:999px;
    }

    .kt-page {
      height: 100%;
      display: flex;
      flex-direction: column;
      padding:16px;
      background:var(--bg-root);
      overflow: hidden;
    }

    .kt-page-tabs {
      display:flex;
      gap:8px;
      margin-bottom:10px;
      flex-shrink: 0;
      flex-wrap:wrap;
    }

    .kt-pill-page {
      border-radius:999px;
      border:1px solid var(--border-soft);
      padding:4px 12px;
      font-size:var(--fs-small);
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
      color:var(--text-muted);
      background:#050505;
      transition:background 0.15s ease, color 0.15s ease;
    }
    .kt-pill-page.active {
      border-color:var(--amber);
      color:#000;
      background:var(--amber);
      font-weight:700;
    }

    .kt-layout {
      display:flex;
      flex-direction:column;
      flex:1;
      min-height:0;
    }

    .kt-column {
      display:flex;
      flex-direction:column;
      flex:1;
      min-height:0;
    }

    .kt-card {
      background:var(--bg-main);
      border:1px solid var(--border-soft);
      border-radius:6px;
      padding:0;
      display:flex;
      flex-direction:column;
      flex:1;
      min-height:0;
      overflow:hidden;
    }

    .kt-card-header {
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      font-size:var(--fs-subtitle);
      color:var(--text-main);
      border-bottom:1px solid var(--border-soft);
      flex-shrink:0;
      background:var(--bg-main);
    }

    .kt-header-left {
      display:flex;
      flex-direction:column;
    }
    .kt-header-left #quotesTitle {
      font-weight:700;
      color:var(--amber);
    }

    .kt-toolbar {
      display:flex;
      align-items:center;
      gap:8px;
    }

    .kt-search {
      display:flex;
      align-items:center;
      border-radius:4px;
      border:1px solid var(--border-soft);
      padding:4px 8px;
      background:#000;
      width:180px;
    }

    .kt-search input {
      flex:1;
      border:none;
      outline:none;
      background:transparent;
      color:var(--text-main);
      font-size:var(--fs-small);
      min-width:0;
    }

    .kt-table-wrapper {
      flex:1;
      overflow-y:auto;
      overflow-x:hidden;
      background:var(--bg-main);
      position:relative;
    }

    .kt-table-scroller {
      width:100%;
      overflow-x:auto;
    }

    table {
      width:100%;
      border-collapse:collapse;
      font-size:var(--fs-body);
      min-width: 880px;
    }

    thead {
      position:sticky;
      top:0;
      background:#1a1a1a;
      z-index:10;
      box-shadow:0 1px 0 var(--border-soft);
    }

    th, td {
      padding:8px 8px;
      text-align:right;
      white-space:nowrap;
      border-bottom:1px solid #1f1f1f;
    }

    th {
      font-size:var(--fs-small);
      font-weight:500;
      color:var(--text-muted);
      text-transform:uppercase;
      letter-spacing:0.5px;
    }

    th:first-child, td:first-child {
      text-align:left;
      position:sticky;
      left:0;
      background:inherit;
      z-index:2;
    }
    th:nth-child(2), td:nth-child(2) {
      text-align:left;
    }

    tbody tr:nth-child(even) td:first-child { background:#0d0d0d; }
    tbody tr:nth-child(odd) td:first-child { background:#090909; }
    tbody tr:hover td:first-child { background:#151515; }

    tbody tr:nth-child(even) { background:#0d0d0d; }
    tbody tr:nth-child(odd) { background:#090909; }
    tbody tr:hover { background:#151515; }

    .text-up { color:var(--green); }
    .text-down { color:var(--red); }

    .copy-btn {
      border-radius:4px;
      border:1px solid var(--border-soft);
      background:transparent;
      color:var(--text-muted);
      font-size:9px;
      padding:2px 6px;
      cursor:pointer;
      transition:0.2s;
    }
    .copy-btn:hover {
      border-color:var(--amber);
      color:var(--amber);
    }

    .spark-cell svg { display:block; }

    @media (max-width:600px) {
      .kt-page { padding:8px; }
      .kt-page-tabs { margin-bottom:8px; gap:6px; }
      .kt-pill-page { padding:3px 10px; font-size:10px; }

      .kt-card-header {
        flex-direction:column;
        align-items:flex-start;
        gap:8px;
        padding:10px;
      }

      .kt-header-left {
        width:100%;
        flex-direction:row;
        justify-content:space-between;
        align-items:center;
      }

      .kt-toolbar { width:100%; }
      .kt-search { width:100%; }

      th, td {
        padding:6px 5px;
        font-size:10px;
      }
    }
  </style>
</head>
<body>
  <div class="kt-page">
    <div class="kt-page-tabs">
      <div class="kt-pill-page active" data-page="indices">Indices</div>
      <div class="kt-pill-page" data-page="etf">ETF</div>
      <div class="kt-pill-page" data-page="usstocks">US Stocks</div>
      <div class="kt-pill-page" data-page="idstocks">ID Stocks</div>
    </div>

    <div class="kt-layout">
      <div class="kt-column">
        <section class="kt-card">
          <header class="kt-card-header">
            <div class="kt-header-left">
              <div id="quotesTitle">Global Indices</div>
              <div id="tickerMeta" class="subtitle" style="font-size:9px; color:var(--text-muted); display:none;"></div>
            </div>
            <div class="kt-toolbar">
              <div class="kt-search">
                <input id="searchInput" type="text" placeholder="Search Symbol...">
              </div>
            </div>
          </header>

          <div class="kt-table-wrapper">
            <div class="kt-table-scroller">
              <table id="eqTable">
                <thead>
                  <tr>
                    <th>Sym</th>
                    <th>Name</th>
                    <th>Trend (30D)</th>
                    <th>Last</th>
                    <th>Chg</th>
                    <th>%Chg</th>
                    <th>Open</th>
                    <th>High</th>
                    <th>Low</th>
                    <th>%YTD</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <script>
    // ==========================
    //  CONFIG
    // ==========================
    const BASE_URL   = "https://cloudkuant-541614645905.us-central1.run.app";
    const INTERVAL   = "1D";
    const BARS_COUNT = 30;
    const MAX_CONCURRENT = 3;
    const REFRESH_MS = 3000;

    const EQ_CONFIG = {
      indices: [
        { symbol:"SPX",    name:"S&P 500",                   apiSymbol:"INDEX:SPX" },
        { symbol:"DJI",    name:"Dow Jones Industrial",      apiSymbol:"INDEX:DJI" },
        { symbol:"NDX",    name:"Nasdaq 100",                apiSymbol:"INDEX:NDX" },
        { symbol:"RUT",    name:"Russell 2000",              apiSymbol:"INDEX:RUT" },
        { symbol:"VIX",    name:"CBOE Volatility Index",     apiSymbol:"INDEX:VIX" },
        { symbol:"DAX",    name:"German DAX",                apiSymbol:"INDEX:DAX" },
        { symbol:"UKX",    name:"FTSE 100",                  apiSymbol:"INDEX:UKX" },
        { symbol:"CAC40",  name:"CAC 40",                    apiSymbol:"INDEX:CAC40" },
        { symbol:"STOXX50",name:"Euro Stoxx 50",             apiSymbol:"INDEX:STOXX50E" },
        { symbol:"NKY",    name:"Nikkei 225",                apiSymbol:"INDEX:NKY" },
        { symbol:"HSI",    name:"Hang Seng",                 apiSymbol:"INDEX:HSI" },
        { symbol:"CSI300", name:"CSI 300",                   apiSymbol:"INDEX:CSI300" },
        { symbol:"KOSPI",  name:"KOSPI",                     apiSymbol:"INDEX:KOSPI" },
        { symbol:"SENSEX", name:"India Sensex",              apiSymbol:"INDEX:SENSEX" },
        { symbol:"NIFTY",  name:"Nifty 50",                  apiSymbol:"INDEX:NIFTY" },
        { symbol:"AS51",   name:"ASX 200",                   apiSymbol:"INDEX:AS51" },
        { symbol:"SMI",    name:"Swiss SMI",                 apiSymbol:"INDEX:SMI" },
        { symbol:"IBEX",   name:"Spain IBEX 35",             apiSymbol:"INDEX:IBEX" },
        { symbol:"BVSP",   name:"Brazil Bovespa",            apiSymbol:"INDEX:BVSP" },
        { symbol:"RTSI",   name:"Russia RTS",                apiSymbol:"INDEX:RTSI" },
        { symbol:"JKSE",   name:"Indonesia IDX Composite",   apiSymbol:"INDEX:JKSE" },
        { symbol:"IDX30",  name:"IDX30",                     apiSymbol:"INDEX:IDX30" }
      ],
      etf: [
        { symbol:"SPY",    name:"SPDR S&P 500",              apiSymbol:"AMEX:SPY" },
        { symbol:"QQQ",    name:"Invesco QQQ",               apiSymbol:"NASDAQ:QQQ" },
        { symbol:"DIA",    name:"SPDR Dow Jones",            apiSymbol:"AMEX:DIA" },
        { symbol:"IWM",    name:"iShares Russell 2000",      apiSymbol:"NYSE:IWM" },
        { symbol:"VOO",    name:"Vanguard S&P 500",          apiSymbol:"NYSE:VOO" },
        { symbol:"VEA",    name:"Vanguard Dev. Markets",     apiSymbol:"NYSE:VEA" },
        { symbol:"EEM",    name:"iShares EM",                apiSymbol:"AMEX:EEM" },
        { symbol:"EFA",    name:"iShares EAFE",              apiSymbol:"AMEX:EFA" },
        { symbol:"HYG",    name:"iShares High Yield",        apiSymbol:"AMEX:HYG" },
        { symbol:"LQD",    name:"iShares Investment Grade",  apiSymbol:"NYSE:LQD" },
        { symbol:"TLT",    name:"iShares 20+Y Treasury",     apiSymbol:"NASDAQ:TLT" },
        { symbol:"SHY",    name:"iShares 1-3Y Treasury",     apiSymbol:"NASDAQ:SHY" },
        { symbol:"XLF",    name:"SPDR Financial",            apiSymbol:"AMEX:XLF" },
        { symbol:"XLE",    name:"SPDR Energy",               apiSymbol:"AMEX:XLE" },
        { symbol:"XLK",    name:"SPDR Technology",           apiSymbol:"AMEX:XLK" },
        { symbol:"XLV",    name:"SPDR Health Care",          apiSymbol:"AMEX:XLV" },
        { symbol:"XLY",    name:"SPDR Cons. Discretionary",  apiSymbol:"AMEX:XLY" },
        { symbol:"XLP",    name:"SPDR Cons. Staples",        apiSymbol:"AMEX:XLP" },
        { symbol:"XLI",    name:"SPDR Industrials",          apiSymbol:"AMEX:XLI" },
        { symbol:"XLU",    name:"SPDR Utilities",            apiSymbol:"AMEX:XLU" },
        { symbol:"XLRE",   name:"SPDR Real Estate",          apiSymbol:"AMEX:XLRE" },
        { symbol:"SMH",    name:"VanEck Semiconductor",      apiSymbol:"NASDAQ:SMH" },
        { symbol:"IBB",    name:"iShares Biotech",           apiSymbol:"NASDAQ:IBB" },
        { symbol:"ARKK",   name:"ARK Innovation",            apiSymbol:"AMEX:ARKK" }
      ],
      usstocks: [
        { symbol:"AAPL",   name:"Apple Inc.",                apiSymbol:"NASDAQ:AAPL" },
        { symbol:"MSFT",   name:"Microsoft Corp.",           apiSymbol:"NASDAQ:MSFT" },
        { symbol:"GOOGL",  name:"Alphabet Inc. A",           apiSymbol:"NASDAQ:GOOGL" },
        { symbol:"GOOG",   name:"Alphabet Inc. C",           apiSymbol:"NASDAQ:GOOG" },
        { symbol:"AMZN",   name:"Amazon.com Inc.",           apiSymbol:"NASDAQ:AMZN" },
        { symbol:"META",   name:"Meta Platforms Inc.",       apiSymbol:"NASDAQ:META" },
        { symbol:"TSLA",   name:"Tesla Inc.",                apiSymbol:"NASDAQ:TSLA" },
        { symbol:"NVDA",   name:"NVIDIA Corp.",              apiSymbol:"NASDAQ:NVDA" },
        { symbol:"AVGO",   name:"Broadcom Inc.",             apiSymbol:"NASDAQ:AVGO" },
        { symbol:"AMD",    name:"Advanced Micro Devices",    apiSymbol:"NASDAQ:AMD" },
        { symbol:"INTC",   name:"Intel Corp.",               apiSymbol:"NASDAQ:INTC" },
        { symbol:"ADBE",   name:"Adobe Inc.",                apiSymbol:"NASDAQ:ADBE" },
        { symbol:"NFLX",   name:"Netflix Inc.",              apiSymbol:"NASDAQ:NFLX" },
        { symbol:"CRM",    name:"Salesforce Inc.",           apiSymbol:"NYSE:CRM" },
        { symbol:"ORCL",   name:"Oracle Corp.",              apiSymbol:"NYSE:ORCL" },
        { symbol:"COST",   name:"Costco Wholesale",          apiSymbol:"NASDAQ:COST" },
        { symbol:"WMT",    name:"Walmart Inc.",              apiSymbol:"NYSE:WMT" },
        { symbol:"HD",     name:"Home Depot Inc.",           apiSymbol:"NYSE:HD" },
        { symbol:"MCD",    name:"McDonald's Corp.",          apiSymbol:"NYSE:MCD" },
        { symbol:"DIS",    name:"Walt Disney Co.",           apiSymbol:"NYSE:DIS" },
        { symbol:"JNJ",    name:"Johnson & Johnson",         apiSymbol:"NYSE:JNJ" },
        { symbol:"PG",     name:"Procter & Gamble",          apiSymbol:"NYSE:PG" },
        { symbol:"KO",     name:"Coca-Cola Co.",             apiSymbol:"NYSE:KO" },
        { symbol:"PEP",    name:"PepsiCo Inc.",              apiSymbol:"NASDAQ:PEP" },
        { symbol:"UNH",    name:"UnitedHealth Group",        apiSymbol:"NYSE:UNH" },
        { symbol:"JPM",    name:"JPMorgan Chase",            apiSymbol:"NYSE:JPM" },
        { symbol:"BAC",    name:"Bank of America",           apiSymbol:"NYSE:BAC" },
        { symbol:"WFC",    name:"Wells Fargo",               apiSymbol:"NYSE:WFC" },
        { symbol:"XOM",    name:"Exxon Mobil",               apiSymbol:"NYSE:XOM" },
        { symbol:"CVX",    name:"Chevron Corp.",             apiSymbol:"NYSE:CVX" },
        { symbol:"V",      name:"Visa Inc.",                 apiSymbol:"NYSE:V" },
        { symbol:"MA",     name:"Mastercard Inc.",           apiSymbol:"NYSE:MA" },
        { symbol:"BRK.B",  name:"Berkshire Hathaway B",      apiSymbol:"NYSE:BRK.B" },
        { symbol:"PFE",    name:"Pfizer Inc.",               apiSymbol:"NYSE:PFE" },
        { symbol:"MRK",    name:"Merck & Co.",               apiSymbol:"NYSE:MRK" },
        { symbol:"T",      name:"AT&T Inc.",                 apiSymbol:"NYSE:T" },
        { symbol:"VZ",     name:"Verizon Communications",    apiSymbol:"NYSE:VZ" }
      ],
      idstocks: [
        { symbol:"BBCA",   name:"Bank Central Asia",         apiSymbol:"IDX:BBCA" },
        { symbol:"BBRI",   name:"Bank Rakyat Indonesia",     apiSymbol:"IDX:BBRI" },
        { symbol:"BMRI",   name:"Bank Mandiri",              apiSymbol:"IDX:BMRI" },
        { symbol:"BBNI",   name:"Bank Negara Indonesia",     apiSymbol:"IDX:BBNI" },
        { symbol:"BBTN",   name:"Bank Tabungan Negara",      apiSymbol:"IDX:BBTN" },
        { symbol:"BRIS",   name:"Bank Syariah Indonesia",    apiSymbol:"IDX:BRIS" },
        { symbol:"TLKM",   name:"Telkom Indonesia",          apiSymbol:"IDX:TLKM" },
        { symbol:"EXCL",   name:"XL Axiata",                 apiSymbol:"IDX:EXCL" },
        { symbol:"ISAT",   name:"Indosat Ooredoo Hutchison", apiSymbol:"IDX:ISAT" },
        { symbol:"FREN",   name:"Smartfren Telecom",         apiSymbol:"IDX:FREN" },
        { symbol:"ASII",   name:"Astra International",       apiSymbol:"IDX:ASII" },
        { symbol:"UNVR",   name:"Unilever Indonesia",        apiSymbol:"IDX:UNVR" },
        { symbol:"ICBP",   name:"Indofood CBP",              apiSymbol:"IDX:ICBP" },
        { symbol:"INDF",   name:"Indofood Sukses Makmur",    apiSymbol:"IDX:INDF" },
        { symbol:"MYOR",   name:"Mayora Indah",              apiSymbol:"IDX:MYOR" },
        { symbol:"HMSP",   name:"HM Sampoerna",              apiSymbol:"IDX:HMSP" },
        { symbol:"GGRM",   name:"Gudang Garam",              apiSymbol:"IDX:GGRM" },
        { symbol:"INTP",   name:"Indocement",                apiSymbol:"IDX:INTP" },
        { symbol:"SMGR",   name:"Semen Indonesia",           apiSymbol:"IDX:SMGR" },
        { symbol:"INKP",   name:"Indah Kiat Pulp & Paper",   apiSymbol:"IDX:INKP" },
        { symbol:"TKIM",   name:"Pabrik Kertas Tjiwi Kimia", apiSymbol:"IDX:TKIM" },
        { symbol:"MEDC",   name:"Medco Energi",              apiSymbol:"IDX:MEDC" },
        { symbol:"PGAS",   name:"Perusahaan Gas Negara",     apiSymbol:"IDX:PGAS" },
        { symbol:"AKRA",   name:"AKR Corporindo",            apiSymbol:"IDX:AKRA" },
        { symbol:"ITMG",   name:"Indo Tambangraya Megah",    apiSymbol:"IDX:ITMG" },
        { symbol:"ADRO",   name:"Adaro Energy",              apiSymbol:"IDX:ADRO" },
        { symbol:"PTBA",   name:"Bukit Asam",                apiSymbol:"IDX:PTBA" },
        { symbol:"ANTM",   name:"Aneka Tambang",             apiSymbol:"IDX:ANTM" },
        { symbol:"TINS",   name:"Timah",                     apiSymbol:"IDX:TINS" },
        { symbol:"MDKA",   name:"Merdeka Copper Gold",       apiSymbol:"IDX:MDKA" },
        { symbol:"UNTR",   name:"United Tractors",           apiSymbol:"IDX:UNTR" },
        { symbol:"ERAA",   name:"Erajaya Swasembada",        apiSymbol:"IDX:ERAA" },
        { symbol:"MAPI",   name:"Mitra Adiperkasa",          apiSymbol:"IDX:MAPI" },
        { symbol:"SCMA",   name:"Surya Citra Media",         apiSymbol:"IDX:SCMA" },
        { symbol:"BRPT",   name:"Barito Pacific",            apiSymbol:"IDX:BRPT" }
      ]
    };

    // ==========================
    //  STATE
    // ==========================
    const tableBody   = document.querySelector("#eqTable tbody");
    const searchInput = document.getElementById("searchInput");
    const quotesTitleEl = document.getElementById("quotesTitle");
    const tickerMetaEl  = document.getElementById("tickerMeta");
    const pagePills     = document.querySelectorAll(".kt-pill-page");
    const tableWrapper  = document.querySelector(".kt-table-wrapper");

    let latestQuotes = [];
    let currentPage  = "indices";
    let isRefreshing = false;

    const datasets = { indices: [], etf: [], usstocks: [], idstocks: [] };

    // ==========================
    //  UTIL
    // ==========================
    function sleep(ms){ return new Promise(res => setTimeout(res, ms)); }

    function formatNumber(value){
      const num = Number(value);
      if (Number.isNaN(num)) return "-";
      if (Math.abs(num) >= 1000) return num.toFixed(0);
      if (Math.abs(num) >= 100)  return num.toFixed(1);
      return num.toFixed(2);
    }

    function formatSigned(value){
      const num = Number(value);
      if (Number.isNaN(num)) return "-";
      if (num === 0) return "0.00";
      return (num > 0 ? "+" : "") + num.toFixed(2);
    }

    function copyTextToClipboard(text){
      if (navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(text).catch(()=>{});
      } else {
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
      }
    }

    function updateTickerMeta(count){
      if (!tickerMetaEl) return;
      tickerMetaEl.style.display = "block";
      tickerMetaEl.textContent = `${count} Tickers`;
    }

    function drawSparkline(cell, values){
      if (!cell || !Array.isArray(values) || values.length < 2) return;
      cell.innerHTML = "";
      const w = 60, h = 20, pad = 2;
      const min = Math.min(...values);
      const max = Math.max(...values);
      const range = (max - min) || 1;

      const svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
      svg.setAttribute("width", w);
      svg.setAttribute("height", h);
      svg.setAttribute("viewBox", `0 0 ${w} ${h}`);

      let d = "";
      values.forEach((v,i)=>{
        const x = pad + (i/(values.length-1))*(w-2*pad);
        const norm = (v-min)/range;
        const y = h - pad - norm*(h-2*pad);
        d += (i===0?"M":"L") + x + " " + y + " ";
      });

      const path = document.createElementNS("http://www.w3.org/2000/svg","path");
      path.setAttribute("d", d.trim());

      const first = values[0];
      const last  = values[values.length-1];
      let color = "#9b9b9b";
      if (last > first) color = "#22c55e";
      else if (last < first) color = "#ef4444";

      path.setAttribute("fill","none");
      path.setAttribute("stroke",color);
      path.setAttribute("stroke-width","1.5");
      svg.appendChild(path);
      cell.appendChild(svg);
    }

    // ==========================
    //  API
    // ==========================
    async function fetchOhlcvWithRetry(apiSymbol){
      try{
        const url = `${BASE_URL}/api/tvohlc/ohlcv?symbol=${encodeURIComponent(apiSymbol)}&interval=${INTERVAL}&bars_count=${BARS_COUNT}`;
        const res = await fetch(url,{ cache:"no-store" });
        if (!res.ok) throw new Error("HTTP error");
        const json = await res.json();
        const r = (json.results || []).find(x => x.symbol === apiSymbol) || (json.results || [])[0];
        if (!r || !r.bars) throw new Error("No bars");
        return r.bars;
      }catch(e){
        return null;
      }
    }

    function buildRowFromBars(cfg, bars){
      if (!bars || !Array.isArray(bars) || bars.length < 2){
        return { ...cfg, error:true };
      }
      const last  = bars[bars.length-1];
      const prev  = bars[bars.length-2];
      const first = bars[0];

      const lastClose = Number(last.close);
      const prevClose = Number(prev.close);

      const chg    = lastClose - prevClose;
      const chgPct = (chg / prevClose) * 100;
      const ytdPct = ((lastClose / Number(first.open)) - 1) * 100;

      return {
        ...cfg,
        open:  Number(last.open),
        high:  Number(last.high),
        low:   Number(last.low),
        last:  lastClose,
        close: lastClose,
        change: chg,
        changePct: chgPct,
        ytdPct: ytdPct,
        closes: bars.map(b => Number(b.close)),
        error:false
      };
    }

    async function loadCategoryData(pageKey){
      const list = EQ_CONFIG[pageKey] || [];
      const resultRows = [];

      let idx = 0;
      while (idx < list.length){
        const slice = list.slice(idx, idx + MAX_CONCURRENT);
        const chunk = await Promise.all(
          slice.map(async item=>{
            const bars = await fetchOhlcvWithRetry(item.apiSymbol);
            return buildRowFromBars(item, bars);
          })
        );
        resultRows.push(...chunk);
        idx += MAX_CONCURRENT;
        if (idx < list.length) await sleep(100);
      }
      datasets[pageKey] = resultRows;
    }

    // ==========================
    //  RENDER
    // ==========================
    function renderQuotesTable(){
      const filter = (searchInput.value || "").trim().toLowerCase();
      const scrollTop = tableWrapper.scrollTop;

      tableBody.innerHTML = "";

      latestQuotes
        .filter(r=>{
          if (!filter) return true;
          return (
            r.symbol.toLowerCase().includes(filter) ||
            r.name.toLowerCase().includes(filter)
          );
        })
        .forEach(row=>{
          const tr = document.createElement("tr");

          const isUp      = !row.error && row.changePct > 0;
          const isDown    = !row.error && row.changePct < 0;
          const isYtdUp   = !row.error && row.ytdPct > 0;
          const isYtdDown = !row.error && row.ytdPct < 0;

          const lastText  = row.error ? "-" : formatNumber(row.last);
          const chgText   = row.error ? "-" : formatSigned(row.change);
          const chgPctTxt = row.error ? "-" : (formatSigned(row.changePct) + "%");
          const openText  = row.error ? "-" : formatNumber(row.open);
          const highText  = row.error ? "-" : formatNumber(row.high);
          const lowText   = row.error ? "-" : formatNumber(row.low);
          const ytdText   = row.error ? "-" : (formatSigned(row.ytdPct) + "%");

          tr.innerHTML = `
            <td><span style="font-weight:700; color:#fff;">${row.symbol}</span></td>
            <td style="color:var(--text-muted)">${row.name}${row.error ? " (no data)" : ""}</td>
            <td class="spark-cell"></td>
            <td>${lastText}</td>
            <td class="${isUp?"text-up":isDown?"text-down":""}">${chgText}</td>
            <td class="${isUp?"text-up":isDown?"text-down":""}">${chgPctTxt}</td>
            <td>${openText}</td>
            <td>${highText}</td>
            <td>${lowText}</td>
            <td class="${isYtdUp?"text-up":isYtdDown?"text-down":""}">${ytdText}</td>
            <td></td>
          `;

          if (!row.error && row.closes && row.closes.length > 1){
            drawSparkline(tr.querySelector(".spark-cell"), row.closes);
          }

          const btn = document.createElement("button");
          btn.className = "copy-btn";
          btn.textContent = "COPY";
          const copyVal = row.error ? "" : row.last;
          btn.onclick = () => copyTextToClipboard(`${row.symbol} Last: ${copyVal}`);
          tr.lastElementChild.appendChild(btn);

          tableBody.appendChild(tr);
        });

      tableWrapper.scrollTop = scrollTop;
    }

    async function refreshCurrentPage(){
      if (isRefreshing) return;
      isRefreshing = true;
      await loadCategoryData(currentPage);
      latestQuotes = datasets[currentPage] || [];
      renderQuotesTable();
      updateTickerMeta(latestQuotes.length);
      isRefreshing = false;
    }

    function switchPage(key){
      currentPage = key;
      pagePills.forEach(p=>{
        p.classList.toggle("active", p.dataset.page === key);
      });

      if (key === "indices")      quotesTitleEl.textContent = "Global Indices";
      else if (key === "etf")     quotesTitleEl.textContent = "Major ETFs";
      else if (key === "usstocks")quotesTitleEl.textContent = "US Stocks – Large & Mega Caps";
      else                        quotesTitleEl.textContent = "Indonesia Equities (IDX)";

      latestQuotes = datasets[key] || [];
      renderQuotesTable();
      updateTickerMeta(latestQuotes.length);
      refreshCurrentPage();
    }

    // INIT
    pagePills.forEach(p => p.onclick = () => switchPage(p.dataset.page));
    searchInput.oninput = renderQuotesTable;

    switchPage("indices");
    setInterval(refreshCurrentPage, REFRESH_MS);
  </script>
</body>
</html>
