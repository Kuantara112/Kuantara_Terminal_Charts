<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Kuantara – Quantitative Lab (Extended)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Fira Code (Kuantara Standard) -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;700&display=swap">

  <!-- ECharts -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

  <style>
    :root {
      /* Kuantara Terminal Palette */
      --bg-root:#000000;
      --bg-main:#111111;
      --bg-panel:#111111;
      --border-soft:#2b2b2b;
      --text-main:#f5f5f5;
      --text-muted:#9b9b9b;
      --accent:#ffbf00;
      --danger:#ff4d4f;
      --ok:#46c97f;
      --info:#3399ff;

      /* Font sizes 9–14px */
      --fs-title:14px;
      --fs-subtitle:12px;
      --fs-body:11px;
      --fs-small:9.5px;
    }

    *{
      box-sizing:border-box;
      margin:0;
      padding:0;
      font-family:"Fira Code",monospace!important;
    }

    html, body{
      width:100%;
      height:100%;
    }

    body{
      background:var(--bg-root);
      color:var(--text-main);
    }

    #app{
      width:100%;
      max-width:1360px;
      margin:0 auto;
      padding:16px;
      min-height:100vh;
    }

    /* QUANT LAB NAV */
    .quant-menu{
      margin-top:0;
      margin-bottom:8px;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .quant-menu-btn{
      border-radius:16px;
      border:1px solid var(--border-soft);
      padding:4px 10px;
      font-size:var(--fs-small);
      background:#050505;
      color:var(--text-muted);
      cursor:pointer;
      text-transform:uppercase;
      letter-spacing:0.06em;
      flex-shrink:0;
      transition: all 0.2s;
    }
    .quant-menu-btn:hover{
      border-color:#555;
      color:#ddd;
    }
    .quant-menu-btn.active{
      border-color:var(--accent);
      background:var(--accent);
      color:#111;
      font-weight:600;
    }

    .quant-description{
      font-size:var(--fs-small);
      color:var(--text-muted);
      margin-top:4px;
      margin-bottom:6px;
      border-left:2px solid var(--border-soft);
      padding-left:8px;
    }

    /* Control bar */
    .control-bar{
      margin-top:10px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:flex-end;
      background:var(--bg-main);
      border:1px solid var(--border-soft);
      border-radius:4px;
      padding:10px 12px;
    }

    .field-group{
      display:flex;
      flex-direction:column;
      gap:3px;
      min-width:120px;
      flex:1 1 120px;
    }

    .field-label{
      font-size:var(--fs-small);
      color:var(--text-muted);
    }

    .field-input,
    .field-select{
      background:#050505;
      border:1px solid #262626;
      border-radius:4px;
      padding:5px 8px;
      font-size:var(--fs-body);
      color:var(--text-main);
      outline:none;
    }
    .field-input:focus,
    .field-select:focus{
      border-color:var(--accent);
    }

    .field-inline{
      display:flex;
      align-items:center;
      gap:6px;
    }

    .btn-run{
      border:none;
      outline:none;
      border-radius:4px;
      padding:7px 16px;
      font-size:var(--fs-body);
      text-transform:uppercase;
      letter-spacing:0.08em;
      cursor:pointer;
      background:var(--accent);
      color:#111;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:6px;
      flex-shrink:0;
    }
    .btn-run:active{
      transform:translateY(1px);
    }
    .btn-run[disabled]{
      opacity:0.6;
      cursor:not-allowed;
    }

    .status-bar{
      margin-top:8px;
      font-size:var(--fs-small);
      color:var(--text-muted);
      display:flex;
      justify-content:space-between;
      gap:8px;
      flex-wrap:wrap;
    }

    .status-left,
    .status-right{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }

    .status-dot{
      width:6px;
      height:6px;
      border-radius:999px;
      background:#555;
    }
    .status-dot.live{ background:var(--ok); }
    .status-dot.error{ background:var(--danger); }
    .status-dot.processing{ background:var(--info); animation: blink 1s infinite; }

    @keyframes blink { 50% { opacity:0.4; } }

    /* Layout grid */
    .grid{
      margin-top:10px;
      display:grid;
      grid-template-columns:1fr;
      grid-auto-rows:minmax(240px, auto);
      gap:10px;
    }

    @media (min-width:900px){
      .grid{
        grid-template-columns:1fr 1fr;
      }
    }

    .panel{
      background:var(--bg-panel);
      border-radius:4px;
      border:1px solid var(--border-soft);
      padding:12px;
      display:flex;
      flex-direction:column;
      min-height:240px;
    }

    .panel-wide{
      min-height:220px;
    }
    @media (min-width:900px){
      .panel-wide{
        grid-column:1 / -1;
      }
    }

    .panel-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:4px;
      gap:8px;
    }

    .panel-title{
      font-size:var(--fs-subtitle);
      font-weight:500;
    }

    .panel-meta{
      font-size:var(--fs-small);
      color:var(--text-muted);
      display:flex;
      align-items:center;
      gap:6px;
      flex-wrap:wrap;
    }

    .badge{
      border-radius:999px;
      border:1px solid var(--border-soft);
      padding:1px 6px;
      font-size:var(--fs-small);
      color:var(--text-muted);
    }

    .badge-accent{
      border-color:var(--accent);
      color:var(--accent);
    }

    .chart-container{
      flex:1 1 auto;
      min-height:220px;
      width:100%;
    }

    .hint{
      font-size:var(--fs-small);
      color:var(--text-muted);
      margin-top:3px;
    }

    .report-body{
      margin-top:6px;
      padding:8px;
      background:#050505;
      border:1px solid #262626;
      border-radius:4px;
      font-size:var(--fs-small);
      color:var(--text-muted);
      line-height:1.5;
      white-space:pre-wrap;
      overflow-y:auto;
      max-height:260px;
    }

    .panel-body-text{
      font-size:var(--fs-small);
      color:var(--text-muted);
      line-height:1.5;
      white-space:pre-wrap;
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="quant-menu">
      <button class="quant-menu-btn active" data-tab="sentiment">Options Sentiment</button>
      <button class="quant-menu-btn" data-tab="forecast">Forecasting (ARIMA/LSTM)</button>
      <button class="quant-menu-btn" data-tab="montecarlo">Monte Carlo</button>
      <button class="quant-menu-btn" data-tab="portfolio">Portfolio Opt</button>
      <button class="quant-menu-btn" data-tab="perf">Performance Metrics</button>
      <button class="quant-menu-btn" data-tab="sigma">Sigma Deviation</button>
    </div>

    <div class="quant-description">
      <span id="desc-text">Analisa sentimen pasar options secara real-time.</span>
    </div>

    <!-- TAB: OPTIONS SENTIMENT -->
    <div id="tab-sentiment" style="display:block;">
      <div class="control-bar">
        <div class="field-group">
          <label class="field-label">Ticker</label>
          <input id="input-ticker" class="field-input" placeholder="SPY" value="SPY">
          <div class="hint">Contoh: SPY, QQQ, AAPL.</div>
        </div>

        <div class="field-group">
          <label class="field-label">Expiration (YYYY-MM-DD)</label>
          <input id="input-expiry" class="field-input" placeholder="2025-12-19">
          <div class="hint">Harus valid di Yahoo Finance.</div>
        </div>

        <div class="field-group">
          <label class="field-label">% OTM Range</label>
          <div class="field-inline">
            <input id="input-pct-otm" class="field-input" type="number" step="0.5" min="1" max="30" value="5" style="max-width:90px;">
            <span class="field-label">%</span>
          </div>
          <div class="hint">Default 5%.</div>
        </div>

        <button id="btn-run" class="btn-run">
          <span>RUN</span>
        </button>
      </div>

      <div class="status-bar">
        <div class="status-left">
          <span id="status-dot" class="status-dot error"></span>
          <span id="status-text">Expiration wajib diisi!</span>
        </div>
        <div class="status-right" id="status-summary"></div>
      </div>

      <div class="grid">
        <div class="panel panel-wide">
          <div class="panel-header">
            <div class="panel-title">Options Sentiment Narrative</div>
            <div class="panel-meta"><span class="badge-accent">Report</span></div>
          </div>
          <div id="text-report" class="report-body">Waiting for data...</div>
        </div>

        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">Composite Scores</div>
          </div>
          <div id="chart-sentiment" class="chart-container"></div>
        </div>

        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">Volume &amp; OI</div>
          </div>
          <div id="chart-volume" class="chart-container"></div>
        </div>

        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">IV Curve</div>
          </div>
          <div id="chart-ivcurve" class="chart-container"></div>
        </div>

        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">IV Heatmap</div>
          </div>
          <div id="chart-heatmap" class="chart-container"></div>
        </div>
      </div>
    </div>

    <!-- TAB: FORECAST -->
    <div id="tab-forecast" style="display:none;">
      <div class="control-bar">
        <div class="field-group">
          <label class="field-label">Ticker</label>
          <input id="fc-ticker" class="field-input" value="NVDA">
        </div>

        <div class="field-group">
          <label class="field-label">Model Type</label>
          <select id="fc-model" class="field-select">
            <option value="arima">ARIMA (Statistical)</option>
            <option value="lstm">LSTM (Deep Learning)</option>
          </select>
        </div>

        <div class="field-group">
          <label class="field-label">Lookback (Days)</label>
          <input id="fc-lookback" class="field-input" type="number" value="365">
          <div class="hint">Data latih historis.</div>
        </div>

        <div class="field-group">
          <label class="field-label">Horizon (Days)</label>
          <input id="fc-horizon" class="field-input" type="number" value="30">
          <div class="hint">Prediksi ke depan.</div>
        </div>

        <button id="btn-run-forecast" class="btn-run">
          <span>PREDICT</span>
        </button>
      </div>

      <div class="status-bar">
        <div class="status-left">
          <span id="fc-status-dot" class="status-dot"></span>
          <span id="fc-status-text">Ready to model.</span>
        </div>
      </div>

      <div class="grid">
        <div class="panel panel-wide">
          <div class="panel-header">
            <div class="panel-title">Price Forecast &amp; Confidence Intervals</div>
            <div class="panel-meta">
              <span class="badge" id="fc-badge-model">ARIMA</span>
              <span class="badge-accent" id="fc-badge-horizon">30 Days</span>
            </div>
          </div>
          <div id="chart-forecast-main" class="chart-container" style="min-height:350px;"></div>
        </div>

        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">Model Diagnostics</div>
            <div class="panel-meta"><span class="badge">Summary</span></div>
          </div>
          <div id="fc-report" class="report-body">
            Silakan jalankan prediksi untuk melihat detail model (AIC/BIC untuk ARIMA, Loss untuk LSTM).
          </div>
        </div>

        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">Training Loss / Residuals</div>
            <div class="panel-meta"><span class="badge">Error Metric</span></div>
          </div>
          <div id="chart-forecast-loss" class="chart-container"></div>
        </div>
      </div>
    </div>

    <!-- TAB: MONTE CARLO -->
    <div id="tab-montecarlo" style="display:none;">
      <div class="grid">
        <div class="panel panel-wide">
          <div class="panel-header">
            <div class="panel-title">Monte Carlo Simulation</div>
          </div>
          <div class="panel-body-text">
            Modul ini akan mensimulasikan ribuan path harga berdasarkan drift dan volatilitas historis
            untuk menghitung probabilitas harga mencapai strike tertentu (Probability of Touch).<br><br>
            <i>Backend endpoint required: /api/quant/monte-carlo</i>
          </div>
          <div id="chart-montecarlo" class="chart-container" style="margin-top:10px;"></div>
        </div>
      </div>
    </div>

    <!-- TAB: PORTFOLIO OPT -->
    <div id="tab-portfolio" style="display:none;">
      <div class="grid">
        <div class="panel panel-wide">
          <div class="panel-header">
            <div class="panel-title">Portfolio Optimisation</div>
          </div>
          <div class="panel-body-text">
            Menggunakan Modern Portfolio Theory (Markowitz) atau Risk Parity untuk menemukan alokasi aset yang optimal.<br><br>
            <i>Backend endpoint required: /api/quant/portfolio-opt</i>
          </div>
        </div>
      </div>
    </div>

    <!-- TAB: PERFORMANCE -->
    <div id="tab-perf" style="display:none;">
      <div class="grid">
        <div class="panel panel-wide">
          <div class="panel-header">
            <div class="panel-title">Performance Metrics</div>
          </div>
          <div class="panel-body-text">
            Analisis kinerja strategi: Sharpe Ratio, Sortino, Max Drawdown, Calmar Ratio,
            dan visualisasi Equity Curve.
          </div>
        </div>
      </div>
    </div>

    <!-- TAB: SIGMA -->
    <div id="tab-sigma" style="display:none;">
      <div class="grid">
        <div class="panel panel-wide">
          <div class="panel-header">
            <div class="panel-title">Sigma Deviation &amp; Tail Risk</div>
          </div>
          <div class="panel-body-text">
            Analisis Z-Score, Value at Risk (VaR), dan Expected Shortfall (ES) untuk mengukur risiko ekstrem pasar.
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
    const API_SENTIMENT = "/api/options-sentiment";
    const API_FORECAST  = "/api/quant/forecast"; 

    let chartSentiment, chartVolume, chartIvCurve, chartHeatmap;
    let chartForecastMain, chartForecastLoss, chartMonteCarlo;

    function setStatus(dotId, textId, type, text){
      const dot = document.getElementById(dotId);
      const txt = document.getElementById(textId);
      if(!dot || !txt) return;

      dot.className = "status-dot";
      if(type === "live") dot.classList.add("live");
      else if(type === "error") dot.classList.add("error");
      else if(type === "processing") dot.classList.add("processing");

      txt.textContent = text;
    }

    function initCharts(){
      const baseOption = {
        title: { text:"Waiting for data…", left:"center", top:"center", textStyle:{ fontSize:11, color:"#777" } },
        xAxis:{show:false}, yAxis:{show:false}, series:[]
      };

      chartSentiment = echarts.init(document.getElementById("chart-sentiment"));
      chartVolume    = echarts.init(document.getElementById("chart-volume"));
      chartIvCurve   = echarts.init(document.getElementById("chart-ivcurve"));
      chartHeatmap   = echarts.init(document.getElementById("chart-heatmap"));
      [chartSentiment, chartVolume, chartIvCurve, chartHeatmap].forEach(c => c.setOption(baseOption));

      chartForecastMain = echarts.init(document.getElementById("chart-forecast-main"));
      chartForecastLoss = echarts.init(document.getElementById("chart-forecast-loss"));
      [chartForecastMain, chartForecastLoss].forEach(c => c.setOption(baseOption));

      chartMonteCarlo = echarts.init(document.getElementById("chart-montecarlo"));
      chartMonteCarlo.setOption(baseOption);

      window.addEventListener("resize", () => {
        chartSentiment.resize();
        chartVolume.resize();
        chartIvCurve.resize();
        chartHeatmap.resize();
        chartForecastMain.resize();
        chartForecastLoss.resize();
        chartMonteCarlo.resize();
      });
    }

    async function runSentiment(){
      const btn = document.getElementById("btn-run");
      const ticker = document.getElementById("input-ticker").value.trim() || "SPY";
      const expiry = document.getElementById("input-expiry").value.trim();
      const pctOtm = document.getElementById("input-pct-otm").value.trim();

      if(!expiry){
        setStatus("status-dot", "status-text", "error", "Expiration wajib diisi!");
        return;
      }

      btn.disabled = true;
      setStatus("status-dot", "status-text", "processing", `Fetching options for ${ticker}...`);

      try {
        const url = new URL(API_SENTIMENT, window.location.origin);
        url.searchParams.set("ticker", ticker);
        url.searchParams.set("expiration", expiry);
        url.searchParams.set("pct_otm", pctOtm);

        await new Promise(r => setTimeout(r, 1000));
        const data = {
          pc_score: -10, iv_score: 20, vol_score: -5, composite: 1.5,
          interpretation: "Neutral Leaning Bullish", quality_score: 5,
          total_call_vol: 15000, total_put_vol: 12000,
          total_call_oi: 50000, total_put_oi: 45000,
          iv_curve_calls: [[100,20],[105,18],[110,19]],
          iv_curve_puts: [[100,22],[95,25],[90,30]],
          heatmap_strikes: ["90","95","100","105","110"],
          heatmap_iv: [[0,0,30],[0,1,0],[1,0,25],[1,1,0],[2,0,22],[2,1,0],[3,0,18],[3,1,0],[4,0,19],[4,1,0]],
          text_report: "Simulated Report: Data backend belum terkoneksi.\nNamun UI sudah siap menerima format JSON standar."
        };

        applySentimentData(data);
        setStatus("status-dot", "status-text", "live", "Data loaded successfully.");
        document.getElementById("status-summary").textContent =
          `Score: ${data.composite} · ${data.interpretation}`;

      } catch(err){
        console.error(err);
        setStatus("status-dot", "status-text", "error", "Error: " + err.message);
      } finally{
        btn.disabled = false;
      }
    }

    function applySentimentData(data){
      chartSentiment.setOption({
        title:{text:"Sentiment Component Scores", textStyle:{color:"#ddd", fontSize:12}, top:5, left:"center"},
        grid:{left:"15%", right:"10%", top:40, bottom:20},
        tooltip:{trigger:"axis"},
        xAxis:{type:"value", min:-100, max:100, splitLine:{lineStyle:{color:"#333"}}},
        yAxis:{type:"category", data:["P/C Ratio","IV Skew","Vol Bias","Composite"], axisLabel:{color:"#aaa"}},
        series:[{
          type:"bar",
          data:[data.pc_score, data.iv_score, data.vol_score, data.composite],
          itemStyle:{ color: p => p.value > 0 ? "#46c97f" : "#ff4d4f" }
        }]
      });

      chartVolume.setOption({
        title:{text:"Call vs Put Volume/OI", textStyle:{color:"#ddd", fontSize:12}, top:5, left:"center"},
        tooltip:{trigger:"axis"},
        legend:{top:25, textStyle:{color:"#aaa"}},
        grid:{left:"12%", right:"5%", bottom:25},
        xAxis:{type:"category", data:["Volume", "Open Interest"], axisLabel:{color:"#aaa"}},
        yAxis:{type:"value", splitLine:{lineStyle:{color:"#333"}}, axisLabel:{color:"#aaa"}},
        series:[
          {name:"Calls", type:"bar", data:[data.total_call_vol, data.total_call_oi], itemStyle:{color:"#46c97f"}},
          {name:"Puts", type:"bar", data:[data.total_put_vol, data.total_put_oi], itemStyle:{color:"#ff4d4f"}}
        ]
      });

      document.getElementById("text-report").textContent = data.text_report;
    }

    async function runForecast(){
      const btn = document.getElementById("btn-run-forecast");
      const ticker = document.getElementById("fc-ticker").value;
      const model = document.getElementById("fc-model").value;
      const lookback = document.getElementById("fc-lookback").value;
      const horizon = document.getElementById("fc-horizon").value;

      btn.disabled = true;
      setStatus("fc-status-dot", "fc-status-text", "processing", `Running ${model.toUpperCase()} on ${ticker}...`);

      try {
        const url = new URL(API_FORECAST, window.location.origin);
        await new Promise(r => setTimeout(r, 1500));

        let date = new Date();
        date.setDate(date.getDate() - parseInt(lookback));
        let price = 100;
        const historyDates = [];
        const historyPrices = [];
        for(let i=0; i<parseInt(lookback); i++){
          date.setDate(date.getDate() + 1);
          price = price + (Math.random() - 0.5) * 2;
          historyDates.push(date.toISOString().split('T')[0]);
          historyPrices.push(price.toFixed(2));
        }

        const forecastDates = [];
        const forecastPrices = [];
        const lowerBound = [];
        const upperBound = [];
        let fPrice = parseFloat(historyPrices[historyPrices.length-1]);
        
        for(let i=0; i<parseInt(horizon); i++){
          date.setDate(date.getDate() + 1);
          fPrice = fPrice + (Math.random() - 0.48) * 2;
          forecastDates.push(date.toISOString().split('T')[0]);
          forecastPrices.push(fPrice.toFixed(2));
          const spread = (i+1) * 0.5; 
          lowerBound.push((fPrice - spread).toFixed(2));
          upperBound.push((fPrice + spread).toFixed(2));
        }
        
        const mockResponse = {
          model: model,
          ticker: ticker,
          history_dates: historyDates,
          history_prices: historyPrices,
          forecast_dates: forecastDates,
          forecast_prices: forecastPrices,
          conf_lower: lowerBound,
          conf_upper: upperBound,
          metrics: {
             rmse: 1.25,
             mae: 0.98,
             details: model === 'arima'
               ? "ARIMA(5,1,0) AIC: 1240.5"
               : "LSTM (2 Layers, 50 Neurons) Epochs: 50"
          },
          loss_history: [0.5, 0.4, 0.35, 0.32, 0.30, 0.29, 0.28, 0.28]
        };

        applyForecastData(mockResponse);
        setStatus("fc-status-dot", "fc-status-text", "live", `Prediction complete.`);

      } catch(e){
        setStatus("fc-status-dot", "fc-status-text", "error", "Error: " + e.message);
      } finally {
        btn.disabled = false;
      }
    }

    function applyForecastData(data){
      document.getElementById("fc-badge-model").textContent = data.model.toUpperCase();
      document.getElementById("fc-badge-horizon").textContent =
        data.forecast_dates.length + " Days";
      document.getElementById("fc-report").textContent = 
        `Model: ${data.metrics.details}\n` +
        `RMSE: ${data.metrics.rmse}\n` +
        `MAE: ${data.metrics.mae}\n\n` +
        `Forecast Start: ${data.forecast_dates[0]}\n` +
        `Forecast End: ${data.forecast_dates[data.forecast_dates.length-1]}\n` +
        `Last Historical Price: ${data.history_prices[data.history_prices.length-1]}`;

      const fullDates = [...data.history_dates, ...data.forecast_dates];
      const plotHistory = data.history_prices.concat(new Array(data.forecast_dates.length).fill(null));
      
      const connectionNulls = new Array(data.history_dates.length - 1).fill(null);
      const lastHist = data.history_prices[data.history_prices.length-1];
      const plotForecast = [...connectionNulls, lastHist, ...data.forecast_prices];
      
      const nullsForBounds = new Array(data.history_dates.length).fill(null);
      const plotLower = [...nullsForBounds, ...data.conf_lower];
      const plotUpper = [...nullsForBounds, ...data.conf_upper];

      chartForecastMain.setOption({
        title: { text:`Forecast: ${data.ticker}`, textStyle:{ color:"#fff", fontSize:14 } },
        tooltip: { trigger:'axis' },
        legend: { data:['History','Forecast','Confidence'], textStyle:{color:"#aaa"}, top:25 },
        grid: { left:'3%', right:'4%', bottom:'3%', containLabel:true },
        xAxis: { type:'category', data:fullDates, boundaryGap:false },
        yAxis: { type:'value', scale:true, splitLine:{lineStyle:{color:"#333"}} },
        series: [
          {
            name:'History',
            type:'line',
            data:plotHistory,
            itemStyle:{ color:'#ccc' },
            showSymbol:false
          },
          {
            name:'Confidence',
            type:'line',
            data:plotUpper,
            lineStyle:{ opacity:0 },
            stack:'confidence-band',
            symbol:'none'
          },
          {
            name:'Confidence',
            type:'line',
            data:plotLower,
            lineStyle:{ opacity:0 },
            areaStyle:{ color:'#3399ff', opacity:0.2 },
            stack:'confidence-band',
            symbol:'none'
          },
          {
            name:'Forecast',
            type:'line',
            data:plotForecast,
            itemStyle:{ color:'#ffbf00' },
            lineStyle:{ type:'dashed' }
          }
        ]
      });

      if(data.model === 'lstm'){
        chartForecastLoss.setOption({
          title: { text:'Training Loss History', left:'center', textStyle:{color:'#aaa', fontSize:12} },
          tooltip: { trigger:'axis' },
          xAxis: { type:'category', data:data.loss_history.map((_,i)=> "Ep "+(i+1)) },
          yAxis: { type:'value', splitLine:{lineStyle:{color:"#333"}} },
          series: [{ type:'line', data:data.loss_history, smooth:true, lineStyle:{color:'#ff4d4f'} }]
        });
      } else {
        const residuals = data.history_prices.map(()=> (Math.random()-0.5).toFixed(3));
        chartForecastLoss.setOption({
           title: { text:'Model Residuals', left:'center', textStyle:{color:'#aaa', fontSize:12} },
           tooltip: { trigger:'axis' },
           xAxis: { type:'category', show:false },
           yAxis: { type:'value', splitLine:{lineStyle:{color:"#333"}} },
           series: [{ type:'bar', data:residuals, itemStyle:{color:'#3399ff'} }]
        });
      }
    }

    function switchTab(tabId){
      const contents = document.querySelectorAll("#app > div[id^='tab-']");
      contents.forEach(el => el.style.display = "none");
      
      const selected = document.getElementById("tab-" + tabId);
      if(selected) selected.style.display = "block";

      document.querySelectorAll(".quant-menu-btn").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.tab === tabId);
      });

      const descMap = {
        sentiment: "Analisa sentimen pasar options secara real-time.",
        forecast: "Prediksi harga time-series menggunakan Statistical (ARIMA) atau Deep Learning (LSTM).",
        montecarlo: "Simulasi ribuan skenario path harga untuk probability mapping.",
        portfolio: "Optimasi alokasi aset (Efficient Frontier).",
        perf: "Evaluasi kinerja strategi trading.",
        sigma: "Analisis distribusi risiko dan tail risk."
      };
      document.getElementById("desc-text").textContent = descMap[tabId] || "";

      setTimeout(() => {
        if(tabId === 'sentiment') {
          chartSentiment.resize();
          chartVolume.resize();
          chartIvCurve.resize();
          chartHeatmap.resize();
        }
        if(tabId === 'forecast') {
          chartForecastMain.resize();
          chartForecastLoss.resize();
        }
        if(tabId === 'montecarlo') {
          chartMonteCarlo.resize();
        }
      }, 100);
    }

    document.addEventListener("DOMContentLoaded", () => {
      initCharts();
      
      const btnSent = document.getElementById("btn-run");
      if(btnSent) btnSent.addEventListener("click", runSentiment);

      const btnFore = document.getElementById("btn-run-forecast");
      if(btnFore) btnFore.addEventListener("click", runForecast);

      document.querySelectorAll(".quant-menu-btn").forEach(btn => {
        btn.addEventListener("click", () => switchTab(btn.dataset.tab));
      });

      switchTab("sentiment");
    });
  </script>
</body>
</html>
