<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Kuantara – Insights · TV · X Feeds</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <meta name="theme-color" content="#000000">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="preconnect" href="https://cloudkuant-541614645905.us-central1.run.app">
  <link rel="preconnect" href="https://api.dataflash.news">
  <link rel="preconnect" href="https://liveprodusphoenixeast.global.ssl.fastly.net">

  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600&display=swap">

  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest" defer></script>

  <style>
    /* TOKENS KUANTARA TERMINAL */
    :root{
      --bg-root:#000000;
      --bg-main:#111111;
      --bg-panel:#111111;
      --border-soft:#2b2b2b;
      --text-main:#f5f5f5;
      --text-muted:#9b9b9b;
      --accent:#ffbf00;

      --fs-title:14px;
      --fs-subtitle:12px;
      --fs-body:11px;
      --fs-small:9.5px;

      --radius-card:4px;
      --pad-page:16px;
      --pad-card:12px;

      --gap-page:12px;
      --gap-inner:10px;
    }

    /* RESET */
    *{
      box-sizing:border-box;
      margin:0;
      padding:0;
      font-family:"Fira Code",monospace!important;
      scrollbar-width:thin;
      scrollbar-color:#000 transparent;
    }
    *::-webkit-scrollbar{width:6px;height:6px;}
    *::-webkit-scrollbar-track{background:transparent;}
    *::-webkit-scrollbar-thumb{background:#000;border-radius:3px;}

    html,body{
      height:100%;
      background:var(--bg-root);
      color:var(--text-main);
    }
    body{
      padding:var(--pad-page);
      overflow:hidden; /* desktop: full-screen app */
    }

    /* LAYOUT ROOT */
    .kt-shell{
      max-width:1440px;
      margin:0 auto;
      height:100%;
      display:flex;
      flex-direction:column;
      gap:var(--gap-page);
    }

    .kt-grid{
      flex:1;
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:var(--gap-page);
      min-height:0;
    }

    /* Kuantara terminal: mobile & tablet behaviour */
    @media (max-width:1024px){
      .kt-grid{
        grid-template-columns:1fr;
      }
    }
    @media (max-width:768px){
      body{
        overflow:auto; /* mobile: scroll page */
      }
      .kt-shell{
        height:auto;
        min-height:100vh;
      }
      .kt-grid{
        display:flex;
        flex-direction:column;
      }
      .panel{
        min-height:260px;
      }
    }

    /* PANEL / CARD */
    .panel{
      background:var(--bg-panel);
      border:1px solid var(--border-soft);
      border-radius:var(--radius-card);
      padding:var(--pad-card);
      display:flex;
      flex-direction:column;
      min-height:320px;
      gap:var(--gap-inner);
      transition:border-color 0.15s,background 0.15s,transform 0.15s;
    }
    .panel:hover{
      border-color:#353535;
      background:#141414;
    }

    .panel-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      min-height:24px;
      column-gap:8px;
    }
    .panel-title{
      font-size:var(--fs-title);
      font-weight:600;
      letter-spacing:0.04em;
      text-transform:uppercase;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .panel-meta{
      font-size:var(--fs-small);
      color:var(--text-muted);
      display:flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }

    @media (max-width:768px){
      .panel-header{
        flex-wrap:wrap;
        row-gap:4px;
        align-items:flex-start;
      }
      .panel-title{
        flex:1 1 100%;
      }
      .panel-meta{
        justify-content:flex-start;
      }
    }

    .panel-body{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:var(--gap-inner);
      min-height:0;
    }

    /* CONTROLS */
    .controls-row{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .field{
      flex:1;
      min-width:120px;
    }
    select{
      width:100%;
      background:#000;
      color:var(--text-main);
      border:1px solid var(--border-soft);
      border-radius:3px;
      padding:4px 8px;
      font-size:var(--fs-body);
      outline:none;
    }
    select:focus{
      border-color:var(--accent);
    }

    .btn{
      border-radius:3px;
      border:1px solid var(--border-soft);
      background:#000;
      color:var(--text-muted);
      font-size:var(--fs-small);
      padding:5px 10px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      transition:all 0.15s;
      white-space:nowrap;
    }
    .btn:hover{
      background:#181818;
      color:var(--text-main);
      border-color:var(--accent);
    }
    .btn.active{
      background:rgba(255,191,0,0.15);
      color:var(--accent);
      border-color:var(--accent);
    }
    .btn-ghost{
      border-style:dashed;
    }

    @media (max-width:768px){
      .controls-row{
        flex-direction:row;
        align-items:flex-start;
      }
    }

    /* LIST PANEL (RESEARCH & X FEEDS) */
    .list-shell{
      flex:1;
      min-height:0;
      border:1px solid var(--border-soft);
      background:#0b0b0b;
      padding:6px;
      overflow-y:auto;
      border-radius:3px;
      content-visibility:auto;
      contain-intrinsic-size:600px;
    }

    .item{
      padding:10px;
      border:1px solid rgba(255,255,255,0.06);
      border-radius:6px;
      background:rgba(15,15,17,0.6);
      margin-bottom:6px;
      cursor:pointer;
      transition:all 0.15s;
    }
    .item:hover{
      background:rgba(255,191,0,0.05);
      border-color:rgba(255,191,0,0.3);
    }
    .item-title{
      font-size:var(--fs-body);
      margin-bottom:4px;
      font-weight:500;
      line-height:1.4;
    }
    .item-meta{
      display:flex;
      gap:8px;
      font-size:var(--fs-small);
      color:var(--text-muted);
      flex-wrap:wrap;
    }
    .item-body{
      margin-top:6px;
      font-size:var(--fs-small);
      color:#cccccc;
      line-height:1.5;
    }

    /* LIVE TV */
    .live-tv-card{
      background:#000;
      padding:2px;
      border:1px solid var(--border-soft);
      border-radius:3px;
    }
    .live-video-shell{
      position:relative;
      padding-top:56.25%;
      background:#000;
      border-radius:2px;
      overflow:hidden;
    }
    .live-video-shell video{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
    }
    @media (max-width:768px){
      .live-video-shell{
        padding-top:58%;
      }
    }

    .badge-live{
      display:flex;
      align-items:center;
      gap:4px;
      color:var(--accent);
      border:1px solid rgba(255,191,0,0.3);
      padding:2px 6px;
      border-radius:99px;
      font-size:9px;
      text-transform:uppercase;
      letter-spacing:0.12em;
    }
    .dot-live{
      width:6px;
      height:6px;
      background:var(--accent);
      border-radius:50%;
      animation:blink 1.5s infinite;
    }
    @keyframes blink{
      0%,100%{opacity:0.3}
      50%{opacity:1}
    }

    /* CAPTION BUFFER (NON-AI) */
    .caption-feed{
      border:1px solid var(--border-soft);
      background:rgba(10,10,12,0.5);
      padding:10px;
      flex:1;
      min-height:0;
      overflow-y:auto;
      display:flex;
      flex-direction:column;
      gap:8px;
      font-size:var(--fs-small);
      border-radius:3px;
    }
    .caption-chunk{
      background:rgba(30,41,59,0.5);
      border:1px solid rgba(255,255,255,0.05);
      padding:8px;
      border-radius:3px;
      line-height:1.5;
    }
    .caption-chunk-header{
      font-size:9px;
      text-transform:uppercase;
      letter-spacing:0.12em;
      color:var(--text-muted);
      margin-bottom:4px;
    }

    /* X FEEDS */
    .x-feed-list{
      list-style:none;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .x-feed-card{
      background:rgba(10,10,12,0.8);
      border:1px solid var(--border-soft);
      padding:12px;
      border-radius:4px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .x-feed-header{
      display:flex;
      gap:10px;
      align-items:center;
      margin-bottom:4px;
    }
    .x-feed-avatar{
      width:28px;
      height:28px;
      border-radius:50%;
      object-fit:cover;
    }
    .x-feed-name{
      font-weight:600;
      font-size:var(--fs-body);
    }
    .x-feed-time{
      margin-left:auto;
      color:var(--text-muted);
      font-size:var(--fs-small);
      white-space:nowrap;
    }
    .x-feed-text{
      font-size:var(--fs-body);
      line-height:1.4;
      white-space:pre-line;
    }
    .x-feed-buttons{
      margin-top:6px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .x-feed-action{
      background:rgba(255,255,255,0.03);
      border:1px solid rgba(255,255,255,0.12);
      color:var(--text-muted);
      font-size:9px;
      padding:4px 8px;
      cursor:pointer;
      text-transform:uppercase;
      letter-spacing:0.08em;
      border-radius:3px;
    }
    .x-feed-action:hover{
      border-color:var(--accent);
      color:var(--accent);
    }

    /* MODAL READER (NON-AI) */
    .modal-overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.8);
      z-index:999;
      display:flex;
      align-items:center;
      justify-content:center;
      backdrop-filter:blur(2px);
    }
    .modal-card{
      width:90%;
      max-width:600px;
      max-height:85vh;
      background:#090909;
      border:1px solid var(--border-soft);
      display:flex;
      flex-direction:column;
      border-radius:var(--radius-card);
      box-shadow:0 20px 50px rgba(0,0,0,0.5);
    }
    .modal-header{
      padding:16px;
      border-bottom:1px solid var(--border-soft);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .modal-title{
      font-size:14px;
      font-weight:600;
      color:#ffffff;
    }
    .modal-close{
      background:none;
      border:none;
      color:var(--text-muted);
      font-size:20px;
      cursor:pointer;
      line-height:1;
    }
    .modal-close:hover{
      color:var(--accent);
    }
    .modal-body{
      flex:1;
      overflow-y:auto;
      padding:16px;
      font-size:11px;
      line-height:1.6;
      color:var(--text-main);
    }

    /* UTILS */
    .hidden{
      display:none!important;
    }
  </style>
</head>
<body>

  <div class="kt-shell">
    <div class="kt-grid">
      
      <!-- PANEL 1: RESEARCH STREAMS -->
      <section class="panel">
        <header class="panel-header">
          <div class="panel-title">Research Streams</div>
          <div class="panel-meta" id="researchStatus">Memuat...</div>
        </header>
        <div class="panel-body">
          <div class="controls-row" id="researchTabs">
            <button class="btn btn-ghost active" data-target="insights">Market Insights</button>
            <button class="btn btn-ghost" data-target="fxcmd">FX & CMD Analysis</button>
          </div>
          <div class="controls-row">
            <div class="field" id="sourceWrapper">
              <select id="researchSource"><option value="all">All Sources</option></select>
            </div>
          </div>
          <div class="list-shell" id="researchListInsights"></div>
          <div class="list-shell hidden" id="researchListFxcmd"></div>
        </div>
      </section>

      <!-- PANEL 2: BLOOMBERG TV + CAPTION BUFFER -->
      <section class="panel">
        <header class="panel-header">
          <div class="panel-title">Bloomberg TV+</div>
          <div class="panel-meta">
            <div class="badge-live"><div class="dot-live"></div>LIVE</div>
          </div>
        </header>
        <div class="panel-body">
          <div class="live-tv-card">
            <div class="live-video-shell">
              <video id="livePlayer" playsinline muted controls crossorigin="anonymous"></video>
            </div>
          </div>
          <div class="controls-row" style="justify-content:space-between;padding:0 4px;">
            <span class="panel-meta" id="ccWordCount">0 / 500 kata</span>
            <span class="panel-meta">Buffer caption otomatis dari subtitle</span>
          </div>
          <div class="caption-feed" id="captionFeed">
            <div style="font-size:10px;color:var(--text-muted);text-align:center;margin-top:8px;">
              Caption dari siaran LIVE akan dikumpulkan per ±500 kata dan ditampilkan di sini.
            </div>
          </div>
        </div>
      </section>

      <!-- PANEL 3: X FEEDS -->
      <section class="panel">
        <header class="panel-header">
          <div class="panel-title">X Feeds</div>
          <div class="panel-meta" id="xFeedStatus">Init...</div>
        </header>
        <div class="panel-body">
          <div class="list-shell" id="xFeedList"></div>
        </div>
      </section>

    </div>
  </div>

  <!-- READER MODAL SAJA (NON-AI) -->
  <div id="readerModal" class="modal-overlay hidden">
    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-title">Reader</div>
        <button class="modal-close" id="readerClose">&times;</button>
      </div>
      <div class="modal-body" id="readerBody" style="line-height:1.6; font-size:13px;"></div>
    </div>
  </div>

  <script>
    /** KONFIGURASI API (NON-AI) */
    const CONFIG = {
      API_PIQ: "https://cloudkuant-541614645905.us-central1.run.app/api/piq/insights",
      API_FX: "https://cloudkuant-541614645905.us-central1.run.app/api/efxdata/insights",
      API_REFRESH_CT: "https://cloudkuant-541614645905.us-central1.run.app/api/efxdata/refresh-ct",
      API_XFEED: "https://api.dataflash.news/api/headlines",
      API_XREADER: (id) => `https://api.dataflash.news/api/headlines/${id}`,
      STREAM_SRC: "https://liveprodusphoenixeast.global.ssl.fastly.net/USPhx-HD/Channel-TX-USPhx-AWS-virginia-1/Source-USPhx-16k-1-s6lk2-BP-07-02-81ykIWnsMsg_live.m3u8",
      IMG_DEFAULT: "https://images.unsplash.com/photo-1505843513577-22bb7d21e455?auto=format&fit=crop&w=1200&q=80",
      LIMITS: { PIQ: 50, FX: 100, CC: 500 }
    };

    /** STATE MANAGEMENT */
    const STATE = {
      research: { insights: [], fxcmd: [], mode: 'insights', loading: false },
      xfeed: { items: [], loading: false, fetched: false },
      tv: { words: [], processing: false }
    };

    /** DOM CACHE */
    const D = {
      resList: {
        insights: document.getElementById('researchListInsights'),
        fxcmd: document.getElementById('researchListFxcmd')
      },
      resStatus: document.getElementById('researchStatus'),
      resSource: document.getElementById('researchSource'),
      xList: document.getElementById('xFeedList'),
      xStatus: document.getElementById('xFeedStatus'),
      live: document.getElementById('livePlayer'),
      ccCount: document.getElementById('ccWordCount'),
      captionFeed: document.getElementById('captionFeed'),
      modals: { reader: document.getElementById('readerModal') },
      reader: { body: document.getElementById('readerBody') }
    };

    /** UTILS */
    const toLower = s => (s || '').toLowerCase();
    const fmtTime = t =>
      new Date(t).toLocaleTimeString('en-GB', { hour12:false, hour:'2-digit', minute:'2-digit' });
    const relTime = t => {
      const m = Math.floor((Date.now() - new Date(t)) / 60000);
      return m < 1 ? 'now'
           : m < 60 ? `${m}m`
           : m < 1440 ? `${Math.floor(m/60)}h`
           : `${Math.floor(m/1440)}d`;
    };

    /** MODULE 1: RESEARCH */
    async function fetchResearch(mode) {
      if (STATE.research.loading) return;
      STATE.research.loading = true;
      D.resStatus.textContent = 'Updating...';

      try {
        if (mode === 'fxcmd') {
          await fetch(CONFIG.API_REFRESH_CT);
        }
        const url = mode === 'fxcmd'
          ? `${CONFIG.API_FX}?limit=${CONFIG.LIMITS.FX}`
          : `${CONFIG.API_PIQ}?limit=${CONFIG.LIMITS.PIQ}`;
        const res = await fetch(url);
        const data = await res.json();

        let items = [];
        if (mode === 'fxcmd') {
          items = (data.items || []).map(i => ({
            title: i.title,
            body: Array.isArray(i.body) ? i.body.join(' ') : i.summary,
            source: 'FX Analysis',
            time: i.timestamp,
            url: i.url
          }));
        } else {
          items = (data.sources || []).flatMap(s =>
            (s.items || []).map(it => ({
              title: it.title,
              source: s.source,
              time: it.published_at,
              url: it.url
            }))
          );
          // Populate Source Dropdown
          if (D.resSource.options.length === 1) {
            [...new Set(items.map(i => i.source))]
              .sort()
              .forEach(s => {
                D.resSource.add(new Option(s, s));
              });
          }
        }
        STATE.research[mode] = items.sort((a,b) => new Date(b.time) - new Date(a.time));
        renderResearch(mode);
        D.resStatus.textContent = 'Updated ' + fmtTime(new Date());
      } catch (e) {
        console.error(e);
        D.resStatus.textContent = 'Failed';
      } finally {
        STATE.research.loading = false;
      }
    }

    function renderResearch(mode) {
      const list = STATE.research[mode];
      const src = D.resSource.value;
      const el = D.resList[mode];

      const filtered =
        (mode === 'insights' && src !== 'all')
          ? list.filter(i => i.source === src)
          : list;

      if (!filtered.length) {
        el.innerHTML = '<div style="color:#666; font-size:10px; padding:10px;">No data available.</div>';
        return;
      }

      const frag = document.createDocumentFragment();
      filtered.forEach(item => {
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `
          <div class="item-title">${item.title}</div>
          <div class="item-meta">
            <span>${item.source}</span>
            <span>${fmtTime(item.time)}</span>
          </div>
          ${mode === 'fxcmd' && item.body
            ? `<div class="item-body">${item.body.substring(0,180)}...</div>`
            : ''}
        `;
        div.onclick = () => window.open(item.url, '_blank');
        frag.appendChild(div);
      });
      el.innerHTML = '';
      el.appendChild(frag);
    }

    /** MODULE 2: X FEED & READER (NON-AI) */
    async function fetchXFeed() {
      if (STATE.xfeed.loading) return;
      STATE.xfeed.loading = true;
      try {
        const res = await fetch(CONFIG.API_XFEED);
        const data = await res.json();
        STATE.xfeed.items = (data.items || [])
          .map(i => ({
            id: i.id,
            name: i.name || i.screenName,
            avatar: i.avatar,
            text: i.text,
            time: i.ts || i.timestamp,
            link: i.link || i.url,
            titleUrl: i.titleUrl
          }))
          .filter(i => i.id);
        renderXFeed();
        D.xStatus.textContent = 'Live';
        STATE.xfeed.fetched = true;
      } catch (e) {
        console.error(e);
        D.xStatus.textContent = 'Error';
      } finally {
        STATE.xfeed.loading = false;
      }
    }

    function renderXFeed() {
      const frag = document.createDocumentFragment();
      STATE.xfeed.items.slice(0, 40).forEach(item => {
        const li = document.createElement('div');
        li.className = 'x-feed-card';
        li.innerHTML = `
          <div class="x-feed-header">
            <img class="x-feed-avatar" src="${item.avatar || CONFIG.IMG_DEFAULT}" loading="lazy">
            <div style="flex:1">
              <div class="x-feed-name">${item.name}</div>
            </div>
            <div class="x-feed-time">${relTime(item.time)}</div>
          </div>
          <div class="x-feed-text">${item.text || item.titleUrl}</div>
          <div class="x-feed-buttons">
            <button class="x-feed-action" onclick="openReader('${item.id}')">READ</button>
            <button class="x-feed-action" onclick="window.open('${item.link}','_blank')">LINK</button>
          </div>
        `;
        frag.appendChild(li);
      });
      D.xList.innerHTML = '';
      D.xList.appendChild(frag);
    }

    window.openReader = async (id) => {
      D.modals.reader.classList.remove('hidden');
      D.reader.body.innerHTML = 'Loading content...';
      try {
        const res = await fetch(CONFIG.API_XREADER(id));
        const json = await res.json();
        D.reader.body.innerHTML = json.reader || 'Konten tidak tersedia.';
      } catch (e) {
        console.error(e);
        D.reader.body.innerHTML = 'Error loading content.';
      }
    };

    /** MODULE 3: TV CAPTION BUFFER (NON-AI) */
    function initPlayer() {
      if (window.Hls && Hls.isSupported()) {
        const hls = new Hls();
        hls.loadSource(CONFIG.STREAM_SRC);
        hls.attachMedia(D.live);
      } else {
        D.live.src = CONFIG.STREAM_SRC;
      }

      // Subtitle -> Word Buffer
      D.live.textTracks.onaddtrack = (e) => {
        const track = e.track;
        track.mode = 'hidden';
        track.oncuechange = () => {
          const cue = track.activeCues && track.activeCues[0];
          if (cue && cue.text) {
            const words = cue.text.split(/\s+/).filter(Boolean);
            if (!words.length) return;

            STATE.tv.words.push(...words);
            const len = STATE.tv.words.length;
            D.ccCount.textContent = `${len} / ${CONFIG.LIMITS.CC} kata`;

            if (len >= CONFIG.LIMITS.CC) {
              flushCaptionChunk();
            }
          }
        };
      };
    }

    function flushCaptionChunk() {
      if (!STATE.tv.words.length) return;

      const chunkWords = STATE.tv.words.splice(0, CONFIG.LIMITS.CC);
      const text = chunkWords.join(' ');
      D.ccCount.textContent = `${STATE.tv.words.length} / ${CONFIG.LIMITS.CC} kata`;

      const div = document.createElement('div');
      div.className = 'caption-chunk';
      div.innerHTML = `
        <div class="caption-chunk-header">
          CAPTION • ${fmtTime(new Date())}
        </div>
        <div>${text}</div>
      `;

      // prepend agar yang terbaru di atas
      if (D.captionFeed.firstChild) {
        D.captionFeed.insertBefore(div, D.captionFeed.firstChild);
      } else {
        D.captionFeed.innerHTML = '';
        D.captionFeed.appendChild(div);
      }
    }

    /** EVENT BINDINGS & INIT */

    // Research Tabs
    document.querySelectorAll('#researchTabs button').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('#researchTabs button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        STATE.research.mode = btn.dataset.target;

        D.resList.insights.classList.toggle('hidden', STATE.research.mode !== 'insights');
        D.resList.fxcmd.classList.toggle('hidden', STATE.research.mode !== 'fxcmd');
        document.getElementById('sourceWrapper').style.visibility =
          STATE.research.mode === 'insights' ? 'visible' : 'hidden';

        if (!STATE.research[STATE.research.mode].length) {
          fetchResearch(STATE.research.mode);
        }
      };
    });

    D.resSource.onchange = () => renderResearch('insights');

    // Reader modal close
    document.getElementById('readerClose').onclick = () => {
      D.modals.reader.classList.add('hidden');
    };

    // Init Sequence
    setTimeout(() => {
      fetchResearch('insights');
      fetchXFeed();
      initPlayer();
      // Periodic refresh (non-AI)
      setInterval(() => fetchResearch(STATE.research.mode), 120000);
      setInterval(() => fetchXFeed(), 60000);
    }, 100);
  </script>
</body>
</html>
