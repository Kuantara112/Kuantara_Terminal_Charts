<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Kuantara – Insights · TV · X Feeds</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">

  <!-- Fira Code -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;700&display=swap">

  <style>
    :root{
      --bg-root:#000000;
      --bg-main:#111111;
      --border-soft:#2b2b2b;
      --text-main:#f5f5f5;
      --text-muted:#9b9b9b;
      --accent:#ffbf00;

      --fs-title:14px;
      --fs-subtitle:12px;
      --fs-body:11px;
      --fs-small:9.5px;
      --chat-h:360px;
    }

    *{
      box-sizing:border-box;
      margin:0;
      padding:0;
      font-family:"Fira Code",monospace!important;
      /* Firefox scrollbar */
      scrollbar-width:thin;
      scrollbar-color:rgba(0,0,0,0.7) transparent;
    }

    /* WebKit scrollbar (hitam transparan) */
    *::-webkit-scrollbar{
      width:6px;
      height:6px;
    }
    *::-webkit-scrollbar-track{
      background:transparent;
    }
    *::-webkit-scrollbar-thumb{
      background:rgba(0,0,0,0.7);
      border-radius:3px;
    }

    html,body{
      height:100%;
      background:var(--bg-root);
      color:var(--text-main);
    }

    body{
      padding:16px;
    }

    .kt-shell{
      max-width:1440px;
      margin:0 auto;
      height:100%;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .kt-grid{
      flex:1;
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:12px;
      min-height:0;
    }

    @media (max-width:1024px){
      .kt-grid{
        grid-template-columns:1fr;
      }
    }

    .panel{
      background:var(--bg-main);
      border:1px solid var(--border-soft);
      border-radius:4px;
      padding:12px 12px 10px;
      display:flex;
      flex-direction:column;
      min-height:320px;
      gap:8px;
    }

    .panel-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-bottom:2px;
    }

    .panel-title{
      font-size:var(--fs-title);
      font-weight:600;
      letter-spacing:0.03em;
      text-transform:uppercase;
    }

    .panel-meta{
      font-size:var(--fs-small);
      color:var(--text-muted);
      display:flex;
      align-items:center;
      gap:8px;
    }

    .badge{
      border-radius:999px;
      border:1px solid var(--border-soft);
      padding:2px 6px;
      font-size:var(--fs-small);
      color:var(--text-muted);
    }

    .badge-live{
      display:inline-flex;
      align-items:center;
      gap:4px;
      border-radius:999px;
      border:1px solid rgba(255,191,0,0.4);
      padding:2px 8px;
      font-size:var(--fs-small);
      color:var(--accent);
      text-transform:uppercase;
    }

    .dot-live{
      width:6px;
      height:6px;
      border-radius:999px;
      background:var(--accent);
      box-shadow:0 0 6px rgba(255,191,0,0.9);
      animation:blink 1.2s infinite ease-in-out;
    }

    @keyframes blink{
      0%,100%{opacity:0.25;transform:scale(0.9);}
      50%{opacity:1;transform:scale(1);}
    }

    .panel-body{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:8px;
      min-height:0;
    }

    .controls-row{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }

    .field{
      display:flex;
      flex-direction:column;
      gap:3px;
      flex:1;
      min-width:120px;
    }

    .field-label{
      font-size:var(--fs-small);
      color:var(--text-muted);
    }

    select{
      background:#000;
      color:var(--text-main);
      border:1px solid var(--border-soft);
      border-radius:3px;
      padding:4px 8px;
      font-size:var(--fs-body);
      outline:none;
    }

    select:focus{
      border-color:var(--accent);
    }

    .btn{
      border-radius:3px;
      border:1px solid var(--border-soft);
      background:#000000;
      color:var(--accent);
      font-size:var(--fs-small);
      padding:5px 10px;
      cursor:pointer;
      white-space:nowrap;
      display:inline-flex;
      align-items:center;
      gap:6px;
      transition:background 0.15s,border-color 0.15s,transform 0.1s;
    }

    .btn span{
      font-size:10px;
    }

    .btn:hover{
      background:#181818;
      border-color:var(--accent);
      transform:translateY(-0.5px);
    }

    .btn:active{
      transform:translateY(0.5px);
    }

    .btn-ghost{
      border-style:dashed;
    }

    .list-shell{
      flex:1;
      min-height:0;
      border-radius:3px;
      border:1px solid var(--border-soft);
      background:#0b0b0b;
      padding:6px;
      overflow-y:auto;
    }

    .item{
      padding:10px 10px;
      border:1px solid rgba(255,255,255,0.06);
      border-radius:8px;
      background:rgba(10,10,12,0.9);
      margin-bottom:8px;
      transition:all 0.15s ease;
      box-shadow:0 6px 18px rgba(0,0,0,0.35);
      cursor:pointer;
    }

    .item:last-child{
      margin-bottom:0;
    }

    .item:hover{
      border-color:rgba(255,191,0,0.45);
      background:rgba(255,191,0,0.1);
      box-shadow:0 10px 26px rgba(255,191,0,0.12);
    }

    .item.active{
      border-color:var(--accent);
      background:rgba(255,191,0,0.18);
      box-shadow:0 12px 32px rgba(255,191,0,0.18);
    }

    .item-title{
      font-size:var(--fs-body);
      margin-bottom:3px;
    }

    .item-meta{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      font-size:var(--fs-small);
      color:var(--text-muted);
    }

    .item-body{
      margin-top:6px;
      font-size:var(--fs-small);
      color:var(--text-main);
      line-height:1.45;
    }

    .item-body p{
      margin:4px 0;
    }

    .img-row{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(180px,1fr));
      gap:10px;
      margin-top:10px;
    }

    .img-row img{
      width:100%;
      border-radius:6px;
      border:1px solid rgba(255,255,255,0.08);
      object-fit:cover;
      background:#050505;
    }

    .copy-btn{
      background:transparent;
      border:1px solid rgba(255,255,255,0.12);
      color:var(--text-muted);
      padding:4px 6px;
      border-radius:6px;
      display:inline-flex;
      align-items:center;
      gap:4px;
      cursor:pointer;
      transition:all 0.15s ease;
      font-size:var(--fs-small);
    }

    .copy-btn:hover{
      border-color:var(--accent);
      color:var(--text-main);
      box-shadow:0 0 12px rgba(255,191,0,0.2);
    }

    .tag{
      border-radius:999px;
      border:1px solid var(--border-soft);
      padding:1px 6px;
      font-size:var(--fs-small);
      color:var(--text-muted);
    }

    .shimmer-line{
      position:relative;
      overflow:hidden;
      border-radius:3px;
      background:rgba(255,255,255,0.08);
    }

    .shimmer-line::after{
      content:"";
      position:absolute;
      inset:0;
      transform:translateX(-100%);
      background:linear-gradient(90deg,transparent,rgba(255,255,255,0.25),transparent);
      animation:shimmer-slide 1.5s infinite;
    }

    .live-tv-card{
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(5,5,6,0.96);
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .live-tv-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-size:var(--fs-small);
      letter-spacing:0.2em;
      text-transform:uppercase;
      color:var(--text-muted);
    }

    .live-video-shell{
      position:relative;
      padding-top:56.25%;
      background:#000;
      border-radius:6px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,0.08);
    }

    .live-video-shell video{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
      background:#000;
    }

    .live-cc-controls{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      font-size:var(--fs-small);
      color:var(--text-muted);
    }

    .live-control-group{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }

    .live-control-btn{
      border:1px solid rgba(255,255,255,0.15);
      background:rgba(0,0,0,0.6);
      color:var(--text-main);
      padding:6px 12px;
      font-size:var(--fs-small);
      letter-spacing:0.15em;
      text-transform:uppercase;
      cursor:pointer;
      border-radius:3px;
      transition:all 0.15s ease;
    }

    .live-control-btn[data-active="true"]{
      border-color:rgba(255,191,0,0.6);
      color:#ffbf00;
      box-shadow:0 0 20px rgba(255,191,0,0.2);
    }

    .live-control-btn[data-variant="blue"][data-active="true"]{
      border-color:rgba(59,130,246,0.7);
      color:#93c5fd;
      box-shadow:0 0 20px rgba(59,130,246,0.25);
    }

    .ai-summary-feed{
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(8,8,10,0.9);
      padding:12px;
      max-height:360px;
      overflow-y:auto;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .ai-summary-feed.hidden{
      display:none;
    }

    .summary-card{
      border:1px solid rgba(255,255,255,0.08);
      background:rgba(15,23,42,0.65);
      padding:12px;
    }

    .summary-card h4{
      font-size:var(--fs-small);
      letter-spacing:0.2em;
      text-transform:uppercase;
      color:#60a5fa;
      margin-bottom:6px;
    }

    .summary-card .md p{
      margin:4px 0;
    }

    .summary-card-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-bottom:6px;
    }

    .copy-btn{
      background:transparent;
      border:none;
      cursor:pointer;
      padding:4px;
      border-radius:4px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }

    .copy-btn svg{
      width:16px;
      height:16px;
      stroke:#8a8a8a;
    }

    .copy-btn:hover{
      background:rgba(255,255,255,0.08);
    }

    .copy-btn.copied svg{
      stroke:#ffbf00;
    }

    /* X Feeds */
    .x-feed-widget{
      border:none;
      background:transparent;
      padding:0;
      box-shadow:none;
      display:flex;
      flex-direction:column;
      gap:12px;
      flex:1;
      min-height:0;
    }

    .x-feed-widget .dropdown-wrapper{
      margin-top:12px;
    }

    .latest-recap-btn{
      width:100%;
      text-transform:uppercase;
      font-size:8.5px;
      letter-spacing:0.2em;
      padding:10px 12px;
      border-radius:0;
      border:1px solid rgba(255,255,255,0.15);
      background:linear-gradient(120deg,rgba(255,191,0,0.12),rgba(255,191,0,0.02));
      color:#ffbf00;
      box-shadow:0 0 18px rgba(255,191,0,0.15);
      cursor:pointer;
      transition:transform 0.15s ease,box-shadow 0.15s ease;
    }

    .latest-recap-btn:hover{
      transform:translateY(-1px);
      box-shadow:0 0 26px rgba(255,191,0,0.25);
    }

    .x-feed-ticker-container{
      margin-top:12px;
      flex:1;
      min-height:0;
      overflow-y:auto;
      max-height:100%;
      scrollbar-width:none;
    }

    .x-feed-ticker-container::-webkit-scrollbar{
      width:0;
      height:0;
    }

    .x-feed-list{
      list-style:none;
      margin:0;
      padding:0;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .x-feed-card{
      border:1px solid rgba(255,255,255,0.08);
      background:rgba(4,4,6,0.9);
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .x-feed-header{
      display:flex;
      align-items:center;
      gap:10px;
    }

    .x-feed-avatar{
      width:36px;
      height:36px;
      border-radius:50%;
      border:1px solid rgba(255,255,255,0.1);
      object-fit:cover;
    }

    .x-feed-author{
      display:flex;
      flex-direction:column;
      line-height:1.2;
    }

    .x-feed-name{
      font-weight:600;
      color:var(--text-main);
    }

    .x-feed-handle{
      font-size:var(--fs-small);
      color:var(--text-muted);
    }

    .x-feed-time{
      margin-left:auto;
      font-size:var(--fs-small);
      color:var(--text-muted);
      text-transform:uppercase;
    }

    .x-feed-text{
      font-size:var(--fs-body);
      color:var(--text-main);
      white-space:pre-line;
    }

    .x-feed-media{
      border-radius:10px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,0.08);
      background:#050505;
    }

    .x-feed-media img{
      width:100%;
      display:block;
    }

    .x-feed-preview{
      border:1px solid rgba(255,255,255,0.12);
      border-radius:10px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      text-decoration:none;
      background:rgba(8,8,10,0.9);
    }

    .x-feed-preview img{
      width:100%;
      height:150px;
      object-fit:cover;
    }

    .x-feed-preview-body{
      padding:10px;
    }

    .x-feed-preview-source{
      font-size:8px;
      letter-spacing:0.2em;
      text-transform:uppercase;
      color:var(--text-muted);
    }

    .x-feed-preview-title{
      font-weight:600;
      color:var(--text-main);
    }

    .x-feed-preview-desc{
      font-size:var(--fs-small);
      color:var(--text-muted);
      margin-top:4px;
    }

    .x-feed-buttons{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      letter-spacing:0.3em;
      text-transform:uppercase;
      font-size:var(--fs-small);
    }

    .x-feed-action{
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(15,15,17,0.85);
      padding:5px 12px;
      color:var(--text-main);
      display:inline-flex;
      gap:6px;
      align-items:center;
      cursor:pointer;
    }

    .x-feed-action.disabled{
      opacity:0.35;
      pointer-events:none;
    }

    .x-feed-action:not(.disabled):hover{
      border-color:rgba(255,191,0,0.5);
      color:#ffbf00;
    }

    .hint{
      font-size:var(--fs-small);
      color:var(--text-muted);
    }

    #panel-xfeeds .panel-body{
      display:flex;
      flex-direction:column;
      flex:1;
      min-height:0;
    }

    /* util */
    .hidden{
      display:none!important;
    }

    .modal-overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.75);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
      z-index:9999;
    }

    .modal-card{
      width:min(900px,100%);
      max-height:90vh;
      overflow-y:auto;
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(5,5,5,0.96);
      box-shadow:0 25px 120px rgba(0,0,0,0.65);
      padding:18px;
    }

    .modal-close{
      border:1px solid rgba(255,255,255,0.22);
      background:transparent;
      color:var(--accent);
      width:34px;
      height:34px;
      border-radius:50%;
      font-size:18px;
      cursor:pointer;
    }

    .kuantara-chat{
      border:1px solid rgba(255,255,255,0.08);
      background:rgba(0,0,0,0.45);
      min-height:220px;
      max-height:calc(var(--chat-h) - 40px);
      overflow-y:auto;
      padding:14px;
      font-size:12px;
      line-height:1.5;
      margin-top:12px;
    }

    .kuantara-message{
      margin-bottom:12px;
    }

    .kuantara-label{
      font-size:10px;
      letter-spacing:0.25em;
      text-transform:uppercase;
      color:var(--text-muted);
    }

    .kuantara-message.user .kuantara-label{
      color:#7dd3fc;
    }

    .kuantara-message.ai .kuantara-label{
      color:var(--accent);
    }

    .kuantara-block{
      margin-top:5px;
      border:1px solid rgba(255,255,255,0.08);
      border-radius:12px;
      padding:10px 12px;
      background:rgba(8,8,8,0.85);
    }

    .kuantara-message.ai .kuantara-block{
      background:transparent;
      border:none;
      padding:6px 0;
    }

    .kuantara-block .md p{
      margin:4px 0;
    }

    .kuantara-input{
      display:flex;
      gap:10px;
      margin-top:12px;
    }

    .kuantara-input textarea{
      flex:1;
      min-height:44px;
      max-height:220px;
      border:1px solid rgba(255,255,255,0.1);
      background:rgba(0,0,0,0.5);
      color:var(--text-main);
      padding:8px;
      resize:none;
    }

    .kuantara-send-btn{
      width:52px;
      border:none;
      border-radius:10px;
      background:var(--text-main);
      color:#050505;
      display:grid;
      place-items:center;
      cursor:pointer;
    }

    .kuantara-send-btn:disabled{
      opacity:0.5;
      cursor:not-allowed;
    }

    .reader-body{
      margin-top:12px;
      border:1px solid rgba(255,255,255,0.08);
      padding:14px;
      min-height:220px;
      font-size:var(--fs-body);
      color:var(--text-main);
      line-height:1.5;
    }

    .reader-text{
      font-size:var(--fs-body);
      color:var(--text-main);
      line-height:1.5;
      margin-bottom:8px;
    }

    .reader-link{
      display:inline-flex;
      align-items:center;
      gap:6px;
      text-transform:uppercase;
      letter-spacing:0.3em;
      font-size:var(--fs-small);
      color:#ffbf00;
    }

    @keyframes shimmer-slide{
      0%{transform:translateX(-100%);}
      100%{transform:translateX(100%);}
    }

    @media (max-width:600px){
      body{
        padding:10px;
      }
      .panel{
        padding:10px;
      }
      .controls-row{
        flex-direction:column;
        align-items:stretch;
      }
      .btn{
        width:100%;
        justify-content:center;
      }
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <div class="kt-shell">
    <div class="kt-grid">
      <!-- PANEL KIRI: Research Streams -->
      <section class="panel" id="panel-research">
        <header class="panel-header">
          <div class="panel-title">Research Streams</div>
          <div class="panel-meta" id="researchStatus">Memuat feed…</div>
        </header>

        <div class="panel-body">
          <!-- Tab switch -->
          <div class="controls-row" id="researchTabs">
            <button class="btn btn-ghost tab-btn active" data-target="insights">
              <span>Market Insights</span>
            </button>
            <button class="btn btn-ghost tab-btn" data-target="fxcmd">
              <span>FX &amp; CMD Analysis</span>
            </button>
          </div>

          <!-- Controls per tab -->
          <div class="controls-row" id="researchControls">
            <div class="field" id="sourceField">
              <select id="researchSource">
                <option value="all">All Sources</option>
              </select>
            </div>
            <button class="latest-recap-btn" id="btnResearchRecap" style="display:none;">
              Recap FX &amp; CMD by Kuantara AI
            </button>
          </div>

          <!-- List container -->
          <div class="list-shell" id="researchListInsights" data-role="market-insights-feed"></div>
          <div class="list-shell" id="researchListFxcmd" data-role="fxcmd-feed" style="display:none;"></div>

        </div>
      </section>

      <!-- PANEL TENGAH: Bloomberg TV+ + AI Summary -->
      <section class="panel" id="panel-tv">
        <header class="panel-header">
          <div class="panel-title">Bloomberg TV+</div>
          <div class="panel-meta">
            <span class="badge-live"><span class="dot-live"></span><span>Live</span></span>
          </div>
        </header>

        <div class="panel-body">
          <div class="live-tv-card">
            <div class="live-tv-header">
              <span>Live Newswire</span>
            </div>
            <div class="live-video-shell">
              <video id="livePlayer" playsinline muted controls crossorigin="anonymous"></video>
            </div>
            <div class="live-cc-controls">
              <div class="live-control-group">
                <button id="aiSummaryToggle" class="live-control-btn" data-active="false">AI Summary</button>
              </div>
              <span id="ccWordCount">0 / 500 kata</span>
            </div>
          </div>
          <div class="ai-summary-feed hidden" id="aiSummaryFeed" data-empty="true" data-enabled="false" style="margin-top:12px;">
            <p class="text-xs text-neutral-500 uppercase tracking-[0.25em]">AI SUMMARY FEED</p>
            <p class="mt-2 text-sm text-neutral-400">Aktifkan AI Summary untuk mulai mengumpulkan insight dari closed caption.</p>
          </div>
        </div>
      </section>

      <!-- PANEL KANAN: X Feeds -->
      <section class="panel" id="panel-xfeeds">
        <header class="panel-header">
          <div>
            <div class="panel-title">X Feeds</div>
            <div class="panel-meta">
              Macro · FX · Equities · Crypto
            </div>
          </div>
          <div class="panel-meta" id="xFeedStatus">Loading…</div>
        </header>

        <div class="panel-body">
          <div class="x-feed-widget">
            <div class="dropdown-wrapper">
              <button id="xFeedRecapBtn" type="button" class="latest-recap-btn">
                Recap X Feed By Kuantara AI
              </button>
            </div>
            <div class="x-feed-ticker-container">
              <ul id="xFeedList" class="x-feed-list">
                <li class="x-feed-card">
                  <div class="shimmer-line" style="height:14px;width:40%;margin-bottom:8px;"></div>
                  <div class="shimmer-line" style="height:12px;width:100%;margin-bottom:6px;"></div>
                  <div class="shimmer-line" style="height:80px;width:100%;"></div>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Kuantara AI Modal -->
  <div id="kuantaraModal" class="modal-overlay hidden">
    <div id="card" class="modal-card">
      <div class="flex items-center justify-between" style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
        <div>
          <p class="text-[10px] uppercase tracking-[0.3em] text-neutral-500" style="font-size:10px;letter-spacing:0.3em;color:#9b9b9b;text-transform:uppercase;">Kuantara AI</p>
          <h2 id="kuantaraTitle" class="text-2xl font-semibold text-white" style="font-size:20px;font-weight:600;">AI Recap</h2>
        </div>
        <button id="kuantaraClose" type="button" class="modal-close">&times;</button>
      </div>
      <div class="kuantara-chat mt-4" id="chatList"></div>
      <div class="kuantara-input">
        <textarea id="input" placeholder="Tulis instruksi untuk Kuantara…"></textarea>
        <button id="send" type="button" class="kuantara-send-btn" aria-label="Kirim">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 19V5"></path>
            <path d="m5 12 7-7 7 7"></path>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Reader Modal -->
  <div id="readerModal" class="modal-overlay hidden">
    <div class="modal-card">
      <div class="flex items-center justify-between" style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
        <div>
          <p class="text-[10px] uppercase tracking-[0.3em] text-neutral-500" style="font-size:10px;letter-spacing:0.3em;color:#9b9b9b;text-transform:uppercase;">Reader</p>
          <h2 id="readerTitle" class="text-2xl font-semibold text-white" style="font-size:20px;font-weight:600;">X Feed Reader</h2>
        </div>
        <button id="readerClose" type="button" class="modal-close">&times;</button>
      </div>
      <div id="readerBody" class="reader-body">
        <p class="text-sm text-neutral-500">Memuat konten…</p>
      </div>
    </div>
  </div>

  <script>
    const MARKET_INSIGHTS_API = "https://cloudkuant-541614645905.us-central1.run.app/api/piq/insights";
    const FXCMD_API = "https://cloudkuant-541614645905.us-central1.run.app/api/efxdata/insights";
    const REFRESH_CT_API = "https://cloudkuant-541614645905.us-central1.run.app/api/efxdata/refresh-ct";
    const X_FEED_API = "https://api.dataflash.news/api/headlines";
    const buildXFeedReaderUrl = (id) => `https://api.dataflash.news/api/headlines/${id}`;
    const DEFAULT_IMAGE = "https://images.unsplash.com/photo-1505843513577-22bb7d21e455?auto=format&fit=crop&w=1200&q=80";
    const LIVE_STREAM_SRC =
      "https://liveprodusphoenixeast.global.ssl.fastly.net/USPhx-HD/Channel-TX-USPhx-AWS-virginia-1/Source-USPhx-16k-1-s6lk2-BP-07-02-81ykIWnsMsg_live.m3u8";
    const LIVE_CC_THRESHOLD = 500;
    const MAX_RECAP_ITEMS = 30;

    const HF_API_TOKEN =
      "eyJhbGciOiJFZERTQSJ9.eyJyZWFkIjp0cnVlLCJwZXJtaXNzaW9ucyI6eyJyZXBvLmNvbnRlbnQucmVhZCI6dHJ1ZX0sIm9uQmVoYWxmT2YiOnsia2luZCI6InVzZXIiLCJfaWQiOiI2OGZlMzllMDcwNWJmOGFhNzYxNTI4YjciLCJ1c2VyIjoiS3VhbnRhcmEiLCJzZXNzaW9uSWQiOiI2OGZlMzllMDcwNWJmOGFhNzYxNTI4YmMifSwiaWF0IjoxNzYyNjc5NzE5LCJzdWIiOiIvc3BhY2VzL0t1YW50YXJhL25ld3NhcGkiLCJleHAiOjE3NjI3NjYxMTksImlzcyI6Imh0dHBzOi8vaHVnZ2luZ2ZhY2UuY28ifQ.TumyY_6mybtslQX6rlpqTnty0ri-tFWIfxBjMVKsGg2JGm99P3ES-7JKKF9xP2nLj1x5x1g2rXBVz1ztI_4jBg";
    let hfApiToken = HF_API_TOKEN;

    const API_BASE = "https://sider.ai/api/chat/v1";
    const TIMEZONE = "Asia/Makassar";
    const TOKEN =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoyMTgzNzM0NiwicmVnaXN0ZXJfdHlwZSI6Im9hdXRoMiIsImFwcF9uYW1lIjoiQ2hpdENoYXRfQ2hyb21lX0V4dCIsInRva2VuX2lkIjoiZTZlOGIwZGUtN2Q3Zi00NTZkLTkxNGQtNzUwNDQ0ZjkyZTNjIiwiaXNzIjoic2lkZXIuYWkiLCJhdWQiOlsiIl0sImV4cCI6MTc4ODY5NjUxMCwibmJmIjoxNzU3NTkyNTEwLCJpYXQiOjE3NTc1OTI1MTB9.mcq86TwFwPtql3S77_vhnJRGj08878Ej5WGkvY3OxWI";

    const COPY_ICON =
      '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>';

    const DEFAULT_PIQ_LIMIT = 50;
    const DEFAULT_FX_LIMIT = 100;

    const researchListEls = {
      insights: document.getElementById("researchListInsights"),
      fxcmd: document.getElementById("researchListFxcmd"),
    };
    const researchStatusEl = document.getElementById("researchStatus");
    const researchTabs = document.querySelectorAll("#researchTabs .tab-btn");
    const researchTopicSelect = null;
    const researchSourceSelect = document.getElementById("researchSource");
    const sourceField = document.getElementById("sourceField");
    const topicField = null;
    const researchRecapBtn = document.getElementById("btnResearchRecap");

    const liveVideoEl = document.getElementById("livePlayer");
    const aiSummaryToggleBtn = document.getElementById("aiSummaryToggle");
    const ccWordCountEl = document.getElementById("ccWordCount");
    const aiSummaryFeedEl = document.getElementById("aiSummaryFeed");

    const xFeedListEl = document.getElementById("xFeedList");
    const xFeedStatusEl = document.getElementById("xFeedStatus");
    const xFeedRecapBtn = document.getElementById("xFeedRecapBtn");

    const kuantaraModal = document.getElementById("kuantaraModal");
    const kuantaraTitleEl = document.getElementById("kuantaraTitle");
    const kuantaraCloseBtn = document.getElementById("kuantaraClose");
    const chatListEl = document.getElementById("chatList");
    const inputEl = document.getElementById("input");
    const sendBtn = document.getElementById("send");

    const readerModal = document.getElementById("readerModal");
    const readerTitleEl = document.getElementById("readerTitle");
    const readerBodyEl = document.getElementById("readerBody");
    const readerCloseBtn = document.getElementById("readerClose");

    const openReaderShell = (title = "Reader") => {
      if (!readerModal) return;
      readerModal.classList.remove("hidden");
      document.body.style.overflow = "hidden";
      if (readerTitleEl) readerTitleEl.textContent = title;
    };

    const closeReaderShell = () => {
      if (!readerModal) return;
      readerModal.classList.add("hidden");
      document.body.style.overflow = "";
    };

    const setReaderLoading = (loading) => {
      if (!readerBodyEl) return;
      readerBodyEl.innerHTML = loading ? '<p class="text-sm text-neutral-400">Memuat konten…</p>' : readerBodyEl.innerHTML;
    };

    readerCloseBtn?.addEventListener("click", closeReaderShell);

    const toLower = (value) => (value || "").toString().toLowerCase();

    const withAuthHeaders = (headers = {}) => {
      if (!hfApiToken) return { ...headers };
      return { ...headers, Authorization: `Bearer ${hfApiToken}` };
    };

    const fetchWithAuth = (url, options = {}) => {
      const headers = withAuthHeaders(options.headers || {});
      return fetch(url, { ...options, headers });
    };

    const formatDateTime = (value) => {
      if (!value) return "Unknown time";
      const dt = new Date(value);
      if (Number.isNaN(dt.getTime())) return value;
      return `${dt.toLocaleDateString("en-GB")} ${dt.toLocaleTimeString("en-GB", { hour12: false })}`;
    };

    const formatRelative = (value) => {
      if (!value) return "";
      const dt = new Date(value);
      if (Number.isNaN(dt.getTime())) return value;
      const diff = Date.now() - dt.getTime();
      const minutes = Math.round(diff / 60000);
      if (minutes < 1) return "just now";
      if (minutes < 60) return `${minutes}m ago`;
      const hours = Math.round(minutes / 60);
      if (hours < 24) return `${hours}h ago`;
      const days = Math.round(hours / 24);
      return `${days}d ago`;
    };

    const formatFastbullUTC = (value) => {
      if (!value) return "Unknown time";
      let timestamp = Number(value);
      if (Number.isNaN(timestamp)) {
        const parsed = Date.parse(value);
        if (!Number.isNaN(parsed)) timestamp = parsed;
        else return value;
      }
      const dt = new Date(timestamp);
      if (Number.isNaN(dt.getTime())) return value;
      return dt.toISOString().replace("T", " ").split(".")[0] + " UTC";
    };

    const wait = (ms) => new Promise((resolve) => setTimeout(resolve, ms));

    const refreshCt = async ({ maxAttempts = 8, backoffMs = 800 } = {}) => {
      for (let attempt = 1; attempt <= maxAttempts; attempt += 1) {
        try {
          const resp = await fetch(REFRESH_CT_API, { headers: { Accept: "application/json" } });
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          const payload = await resp.json().catch(() => ({}));
          if (payload?.ok) {
            console.info(`refresh-ct ok (attempt ${attempt})`);
            return true;
          }
          throw new Error(payload?.error || "Unknown refresh-ct error");
        } catch (error) {
          console.warn(`refresh-ct failed (attempt ${attempt}):`, error?.message || error);
          if (attempt < maxAttempts) {
            await wait(backoffMs * attempt);
            continue;
          }
          return false;
        }
      }
      return false;
    };

    // ===============================
    // Research Streams
    // ===============================

    const insightCache = { insights: [], fxcmd: [] };
    const researchLoading = { insights: false, fxcmd: false };
    let currentResearchMode = "insights";

    // Helper: coercion epoch detik/milis ke ms
    const coerceEpochMs = (val) => {
      if (typeof val === "number") {
        return val < 1e12 ? val * 1000 : val;
      }
      if (typeof val === "string") {
        const n = Number(val);
        if (!Number.isNaN(n)) {
          return n < 1e12 ? n * 1000 : n;
        }
      }
      return null;
    };

    // *** FIX: timestamp FX/CMD lebih robust, tidak "nempel" satu tanggal ***
    const normalizeEfxInsight = (entry = {}) => {
      const summary = Array.isArray(entry.body) ? entry.body.join(" • ") : entry.summary || "";

      let ts =
        entry.timestamp ??
        entry.date_display ??
        entry.date ??
        entry.published_at ??
        null;

      let dt;

      // Prioritaskan epoch numeric (detik / milidetik)
      const ms = coerceEpochMs(ts);
      if (ms !== null) {
        dt = new Date(ms);
      } else if (typeof ts === "string" && ts) {
        dt = new Date(ts);
      } else {
        dt = new Date();
      }

      if (Number.isNaN(dt.getTime())) {
        dt = new Date();
      }

      return {
        title: entry.title || "Untitled insight",
        source: "",
        assetClass: "FX/CMD",
        horizon: "",
        summary,
        topic: "fxcmd",
        url: entry.url || "",
        timestamp: dt.toISOString(), // sudah ISO granular
        body: Array.isArray(entry.body) ? entry.body : [],
        images: Array.isArray(entry.images) ? entry.images : [],
      };
    };

    // *** FIX: pemilihan timestamp Market Insights ***
    const pickInsightTimestamp = (entry = {}) => {
      // 1. Epoch / numeric string
      let ms = coerceEpochMs(entry.ts);
      if (ms === null) ms = coerceEpochMs(entry.timestamp);
      if (ms !== null) {
        const d = new Date(ms);
        if (!Number.isNaN(d.getTime())) return d.toISOString();
      }

      // 2. ISO dengan jam
      const isoFields = ["published_at", "publish_at"];
      for (const key of isoFields) {
        const v = entry[key];
        if (v) {
          const d = new Date(v);
          if (!Number.isNaN(d.getTime())) return d.toISOString();
        }
      }

      // 3. Fallback ke tanggal harian (publish_dt)
      if (entry.publish_dt) {
        const d = new Date(entry.publish_dt);
        if (!Number.isNaN(d.getTime())) return d.toISOString();
      }

      // 4. Kalau semua gagal, waktu sekarang
      return new Date().toISOString();
    };

    const normalizeInsight = (entry = {}) => {
      const tags = Array.isArray(entry.tags)
        ? entry.tags.map((tag) => (tag.text ? tag.text : tag)).filter(Boolean)
        : [];
      const bullets = Array.isArray(entry.bullets) ? entry.bullets.slice(0, 3).join(" • ") : "";
      const summary = entry.summary || bullets || tags.slice(0, 3).join(" • ");

      return {
        title: entry.title || entry.headline || "Untitled insight",
        source: entry._feed || entry.source || "Source",
        assetClass: entry.asset_class || entry.assetClass || entry.category || "",
        horizon: entry.horizon || entry.timeframe || "",
        summary,
        topic: toLower(entry.topic || entry.asset_class || entry.category || ""),
        url: entry.url || entry.link || "",
        timestamp: pickInsightTimestamp(entry), // sudah granular, tidak lagi hanya publish_dt
      };
    };

    const renderResearchSkeleton = (mode = "insights", rows = 4) => {
      const listEl = researchListEls[mode];
      if (!listEl) return;
      listEl.innerHTML = "";
      Array.from({ length: rows }).forEach(() => {
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div class="shimmer-line" style="height:12px;width:40%;margin-bottom:6px;"></div>
          <div class="shimmer-line" style="height:10px;width:80%;"></div>
          <div class="shimmer-line" style="height:8px;width:60%;margin-top:4px;"></div>`;
        listEl.appendChild(div);
      });
    };

    const copyText = async (text) => {
      if (!text) return;
      try {
        await navigator.clipboard.writeText(text);
      } catch (err) {
        console.warn("Copy failed", err);
      }
    };

    const renderResearchItems = (items, mode = "insights") => {
      const listEl = researchListEls[mode];
      if (!listEl) return;
      listEl.innerHTML = "";
      if (!items.length) {
        listEl.innerHTML = '<div class="hint">Tidak ada insight pada filter ini.</div>';
        return;
      }
      items.forEach((item) => {
        const div = document.createElement("div");
        div.className = "item";
        const metaParts = [item.source, item.assetClass, item.horizon, formatDateTime(item.timestamp)].filter(Boolean);
        const bodyText = Array.isArray(item.body) ? item.body.join("\n\n") : item.summary || item.title || "";
        const bodyHtml =
          mode === "fxcmd" && Array.isArray(item.body) && item.body.length
            ? `<div class="item-body">${item.body
                .slice(0, 3)
                .map((p) => `<p>${p}</p>`)
                .join("")}</div>`
            : "";
        const imagesHtml =
          mode === "fxcmd" && Array.isArray(item.images) && item.images.length
            ? `<div class="img-row">${item.images
                .slice(0, 3)
                .map(
                  (src) =>
                    `<img src="${src}" loading="lazy" alt="chart" onclick="window.open('${src}','_blank','noopener');event.stopPropagation();">`
                )
                .join("")}</div>`
            : "";
        div.innerHTML = `
          <div class="item-title">${item.title}</div>
          <div class="item-meta">${metaParts.map((m) => `<span>${m}</span>`).join("")}</div>
          <div class="controls-row" style="justify-content:flex-end;margin:4px 0 2px;">
            <button class="copy-btn" type="button" data-copy="${encodeURIComponent(bodyText)}" aria-label="Copy text">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
              Copy
            </button>
          </div>
          ${bodyHtml}
          ${imagesHtml}
        `;
        div.addEventListener("click", () => {
          listEl.querySelectorAll(".item.active").forEach((el) => el.classList.remove("active"));
          div.classList.add("active");
          if (mode === "insights" && item.url) {
            window.open(item.url, "_blank", "noopener");
          }
        });
        div.querySelectorAll(".copy-btn").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            e.stopPropagation();
            const payload = decodeURIComponent(btn.dataset.copy || "");
            copyText(payload);
          });
        });
        listEl.appendChild(div);
      });
    };

    const matchesSource = (item, source) => {
      if (!source || source === "all") return true;
      const a = toLower(item.source);
      const b = toLower(source);
      return a === b || a.includes(b) || b.includes(a);
    };

    const filterInsights = (mode = currentResearchMode) => {
      const cache = insightCache[mode] || [];
      if (mode === "fxcmd") return cache;
      const source = researchSourceSelect?.value || "all";
      return cache.filter((item) => matchesSource(item, source));
    };

    const refreshSourceOptions = (sources = []) => {
      if (!researchSourceSelect) return;
      const selected = researchSourceSelect.value || "all";
      const sourceSet = new Set(["all"]);
      sources.forEach((src) => {
        if (src) sourceSet.add(src);
      });
      researchSourceSelect.innerHTML = "";
      Array.from(sourceSet).forEach((val) => {
        const opt = document.createElement("option");
        opt.value = val;
        opt.textContent = val === "all" ? "All Sources" : val;
        researchSourceSelect.appendChild(opt);
      });
      researchSourceSelect.value = sourceSet.has(selected) ? selected : "all";
    };

    const setListVisibility = (mode) => {
      Object.entries(researchListEls).forEach(([key, el]) => {
        if (el) el.style.display = key === mode ? "" : "none";
      });
    };

    const refreshResearchView = () => {
      const filtered = filterInsights(currentResearchMode);
      const sorted = filtered.slice().sort((a, b) => {
        const ta = new Date(a.timestamp || 0).getTime();
        const tb = new Date(b.timestamp || 0).getTime();
        return tb - ta;
      });
      renderResearchItems(sorted, currentResearchMode);
    };

    const fetchInsights = async ({ silent = false } = {}) => {
      const mode = currentResearchMode;
      if (researchLoading[mode]) return;
      researchLoading[mode] = true;
      if (!silent) {
        renderResearchSkeleton(mode);
        if (researchStatusEl) researchStatusEl.textContent = "Memuat feed…";
      }
      try {
        const isFxCmd = mode === "fxcmd";
        const url = isFxCmd
          ? `${FXCMD_API}?limit=${DEFAULT_FX_LIMIT}`
          : `${MARKET_INSIGHTS_API}?limit=${DEFAULT_PIQ_LIMIT}`;

        const runFetch = async () => {
          const response = await fetch(url, { headers: { Accept: "application/json" } });
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const json = await response.json();
          if (isFxCmd && json && json.ok === false) {
            throw new Error(json.error || "FX feed error");
          }
          return json;
        };

        if (isFxCmd) {
          await refreshCt(); // ensure cookie fresh before hitting feed
        }

        let payload;
        try {
          payload = await runFetch();
        } catch (err) {
          if (isFxCmd) {
            const refreshed = await refreshCt();
            if (refreshed) {
              payload = await runFetch();
            } else {
              throw err;
            }
          } else {
            throw err;
          }
        }

        let availableSources = [];
        if (isFxCmd) {
          const items = Array.isArray(payload.items) ? payload.items : [];
          insightCache.fxcmd = items.map(normalizeEfxInsight).filter((item) => item.title);
          availableSources = [];
        } else {
          let items = Array.isArray(payload.items) ? payload.items : [];
          if (Array.isArray(payload.sources) && payload.sources.length) {
            items = payload.sources.flatMap((src) =>
              Array.isArray(src.items)
                ? src.items.map((it) => ({ ...it, _feed: src.source }))
                : []
            );
          }
          insightCache.insights = items.map(normalizeInsight).filter((item) => item.title);
          availableSources =
            (payload.sources && payload.sources.length && payload.sources.map((s) => s.source)) ||
            (payload.available_sources && payload.available_sources.length && payload.available_sources) ||
            Array.from(new Set(insightCache.insights.map((it) => it.source).filter(Boolean)));
        }

        if (!isFxCmd) {
          refreshSourceOptions(availableSources);
        }

        refreshResearchView();
        if (researchStatusEl)
          researchStatusEl.textContent = (insightCache[mode]?.length || 0)
            ? `Updated ${new Date().toLocaleTimeString("en-GB", { hour12: false })}`
            : "No data";
      } catch (error) {
        console.error("Research feed error", error);
        insightCache[mode] = [];
        refreshResearchView();
        if (researchStatusEl) researchStatusEl.textContent = `Feed error • ${error.message || "Network"}`;
      } finally {
        researchLoading[mode] = false;
      }
    };

    researchTabs.forEach((btn) => {
      btn.addEventListener("click", () => {
        researchTabs.forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        currentResearchMode = btn.dataset.target || "insights";
        setListVisibility(currentResearchMode);
        if (sourceField) sourceField.style.display = currentResearchMode === "insights" ? "" : "none";
        updateRecapVisibility();
        if (currentResearchMode === "insights" && researchSourceSelect) {
          researchSourceSelect.value = "all";
        }
        const cache = insightCache[currentResearchMode] || [];
        refreshResearchView();
        if (!cache.length) {
          fetchInsights();
        }
      });
    });

    researchSourceSelect?.addEventListener("change", () => {
      if (currentResearchMode !== "insights") return;
      refreshResearchView();
    });

    const updateRecapVisibility = () => {
      if (!researchRecapBtn) return;
      researchRecapBtn.style.display = currentResearchMode === "fxcmd" ? "" : "none";
    };

    // Initialize filter visibility
    if (sourceField) sourceField.style.display = currentResearchMode === "insights" ? "" : "none";
    if (topicField) topicField.style.display = currentResearchMode === "fxcmd" ? "" : "none";
    setListVisibility(currentResearchMode);
    updateRecapVisibility();

    const ensureResearchData = async () => {
      const mode = currentResearchMode;
      if (!(insightCache[mode] || []).length) await fetchInsights();
      return { items: filterInsights(mode) };
    };

    researchRecapBtn?.addEventListener("click", () => {
      if (currentResearchMode !== "fxcmd") return;
      const label = currentResearchMode === "fxcmd" ? "FX & Commodities" : "Market Insights";
      openKuantaraModal({
        label: `${label} Insight`,
        key: `research-${currentResearchMode}`,
        ensureData: ensureResearchData,
        buildPrompt: (items) => {
          if (!items.length) return "";
          const lines = items.slice(0, MAX_RECAP_ITEMS).map((item, idx) => {
            const meta = [item.source, item.assetClass, formatDateTime(item.timestamp)].filter(Boolean).join(" • ");
            return `${idx + 1}. [${meta}] ${item.title}${item.summary ? ` — ${item.summary}` : ""}`;
          });
          return `Anda adalah Kuantara AI. Ringkas ${label} menjadi maksimal 8 poin utama dan satu paragraf kesimpulan berbahasa Indonesia. Soroti katalis, risiko, dan peluang.
Data:
${lines.join("\n")}`;
        },
      });
    });

    // ===============================
    // X Feeds
    // ===============================

    let xFeedItems = [];
    let xFeedLoading = false;
    let xFeedFetched = false;

    const formatXFeedRelativeTime = (ts) => {
      if (!ts) return "now";
      const value = Number(ts);
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return "now";
      const diffMs = Date.now() - date.getTime();
      const diffMinutes = Math.floor(diffMs / 60000);
      if (diffMinutes < 1) return "now";
      if (diffMinutes < 60) return `${diffMinutes}m`;
      const diffHours = Math.floor(diffMinutes / 60);
      if (diffHours < 24) return `${diffHours}h`;
      const diffDays = Math.floor(diffHours / 24);
      return `${diffDays}d`;
    };

    const normalizeXFeedItem = (item = {}) => {
      if (!item) return null;
      return {
        id: item.id || item.statusId || "",
        timestamp: Number(item.ts || item.timestamp) || Date.now(),
        name: item.name || item.screenName || "X Feed",
        screenName: item.screenName || "",
        avatar: item.avatar || DEFAULT_IMAGE,
        text: item.text || "",
        media: item.media || "",
        tweetUrl: item.link || item.url || "",
        externalUrl: item.externalUrl || "",
        titleUrl: item.titleUrl || "",
        descriptionUrl: item.descriptionUrl || "",
        tts: item.tts || "",
      };
    };

    const renderXFeedSkeleton = (rows = 3) => {
      if (!xFeedListEl) return;
      xFeedListEl.innerHTML = "";
      Array.from({ length: rows }).forEach(() => {
        const li = document.createElement("li");
        li.className = "x-feed-card";
        li.innerHTML = `
          <div class="shimmer-line" style="height:12px;width:35%;margin-bottom:8px;"></div>
          <div class="shimmer-line" style="height:12px;width:100%;margin-bottom:6px;"></div>
          <div class="shimmer-line" style="height:80px;width:100%;"></div>
        `;
        xFeedListEl.appendChild(li);
      });
    };

    const openXFeedLink = (url) => {
      if (!url) return;
      window.open(url, "_blank", "noopener");
    };

    const setXFeedStatus = (text) => {
      if (xFeedStatusEl) xFeedStatusEl.textContent = text;
    };

    const createXFeedActionButton = (label, handler, disabled = false) => {
      const button = document.createElement("button");
      button.type = "button";
      button.className = "x-feed-action";
      button.textContent = label;
      if (disabled) {
        button.disabled = true;
        button.classList.add("disabled");
      } else if (typeof handler === "function") {
        button.addEventListener("click", handler);
      }
      return button;
    };

    const showXFeedInsight = (item) => {
      if (!item || !item.descriptionUrl) return;
      openReaderShell(item.titleUrl || "Insight");
      setReaderLoading(false);
      if (readerBodyEl) {
        const desc = document.createElement("p");
        desc.className = "reader-text";
        desc.textContent = item.descriptionUrl;
        readerBodyEl.innerHTML = "";
        readerBodyEl.appendChild(desc);
        if (item.externalUrl) {
          const link = document.createElement("a");
          link.href = item.externalUrl;
          link.target = "_blank";
          link.rel = "noopener";
          link.className = "reader-link";
          link.textContent = "Buka sumber";
          readerBodyEl.appendChild(link);
        }
      }
    };

    const openXFeedReader = async (item) => {
      if (!item || !item.id) return;
      openReaderShell(item.titleUrl || item.text || "X Feed Reader");
      setReaderLoading(true);
      if (readerBodyEl) readerBodyEl.innerHTML = "";

      let fallbackTriggered = false;
      let fallbackAttempted = false;

      const tryRedirectToFallbackLink = (reason = "HTTP 404") => {
        fallbackAttempted = true;
        if (fallbackTriggered) return true;
        const fallbackUrl = item.externalUrl || item.tweetUrl;
        if (!fallbackUrl) return false;
        fallbackTriggered = true;
        if (readerBodyEl) {
          readerBodyEl.innerHTML = `<p class="text-sm text-neutral-300">Reader tidak tersedia (${reason}). Membuka sumber asli…</p>`;
        }
        openXFeedLink(fallbackUrl);
        return true;
      };

      try {
        const response = await fetch(buildXFeedReaderUrl(item.id), {
          headers: { Accept: "application/json" },
        });
        if (!response.ok) {
          if (response.status === 404 && tryRedirectToFallbackLink("HTTP 404")) {
            return;
          }
          throw new Error(`HTTP ${response.status}`);
        }
        const payload = await response.json();
        const html = payload?.reader;
        if (readerBodyEl) {
          readerBodyEl.innerHTML = html || '<p class="text-sm text-neutral-400">Reader tidak tersedia.</p>';
        }
      } catch (error) {
        console.error("Reader error:", error);
        const message = error?.message || "Network error";
        if (/404/.test(message) && tryRedirectToFallbackLink("HTTP 404")) {
          return;
        }
        if (readerBodyEl) {
          readerBodyEl.innerHTML = `<p class="text-sm text-rose-300">Gagal memuat reader. ${message}${
            fallbackAttempted && !fallbackTriggered ? ". Tidak ada tautan sumber." : ""
          }</p>`;
        }
      } finally {
        setReaderLoading(false);
      }
    };

    const buildXFeedCard = (item) => {
      const li = document.createElement("li");
      li.className = "x-feed-card";

      const header = document.createElement("div");
      header.className = "x-feed-header";

      const avatar = document.createElement("img");
      avatar.className = "x-feed-avatar";
      avatar.src = item.avatar || DEFAULT_IMAGE;
      avatar.alt = item.name || item.screenName || "X Feed";
      header.appendChild(avatar);

      const author = document.createElement("div");
      author.className = "x-feed-author";
      const nameEl = document.createElement("span");
      nameEl.className = "x-feed-name";
      nameEl.textContent = item.name || "X Feed";
      author.appendChild(nameEl);
      if (item.screenName) {
        const handle = document.createElement("span");
        handle.className = "x-feed-handle";
        handle.textContent = `@${item.screenName}`;
        author.appendChild(handle);
      }
      header.appendChild(author);

      const timeEl = document.createElement("span");
      timeEl.className = "x-feed-time";
      timeEl.textContent = formatXFeedRelativeTime(item.timestamp);
      header.appendChild(timeEl);

      li.appendChild(header);

      if (item.text) {
        const text = document.createElement("p");
        text.className = "x-feed-text";
        text.textContent = item.text;
        li.appendChild(text);
      }

      const hasPreview = Boolean(item.externalUrl || item.titleUrl || item.descriptionUrl);

      if (item.media && !hasPreview) {
        const media = document.createElement("div");
        media.className = "x-feed-media";
        const img = document.createElement("img");
        img.src = item.media;
        img.alt = item.titleUrl || "X media";
        media.appendChild(img);
        li.appendChild(media);
      }

      if (hasPreview) {
        const preview = document.createElement("a");
        preview.className = "x-feed-preview";
        preview.href = item.externalUrl || item.tweetUrl || "#";
        preview.target = "_blank";
        preview.rel = "noopener";
        if (item.media) {
          const previewImg = document.createElement("img");
          previewImg.src = item.media;
          previewImg.alt = item.titleUrl || "Preview";
          preview.appendChild(previewImg);
        }
        const body = document.createElement("div");
        body.className = "x-feed-preview-body";
        if (item.externalUrl) {
          const source = document.createElement("p");
          source.className = "x-feed-preview-source";
          try {
            const hostname = new URL(item.externalUrl).hostname.replace("www.", "");
            source.textContent = hostname;
          } catch {
            source.textContent = "Source";
          }
          body.appendChild(source);
        }
        if (item.titleUrl) {
          const titleEl = document.createElement("p");
          titleEl.className = "x-feed-preview-title";
          titleEl.textContent = item.titleUrl;
          body.appendChild(titleEl);
        }
        if (item.descriptionUrl) {
          const descEl = document.createElement("p");
          descEl.className = "x-feed-preview-desc";
          descEl.textContent = item.descriptionUrl;
          body.appendChild(descEl);
        }
        preview.appendChild(body);
        li.appendChild(preview);
      }

      const buttons = document.createElement("div");
      buttons.className = "x-feed-buttons";
      const readBtn = createXFeedActionButton("READ", () => openXFeedReader(item), !item.id);
      const quickBtn = createXFeedActionButton(
        "QUICK",
        () => openXFeedLink(item.externalUrl || item.tweetUrl),
        !(item.externalUrl || item.titleUrl)
      );
      const insightBtn = createXFeedActionButton("INSIGHT", () => showXFeedInsight(item), !item.descriptionUrl);
      buttons.append(readBtn, quickBtn, insightBtn);
      li.appendChild(buttons);
      return li;
    };

    const renderXFeed = () => {
      if (!xFeedListEl) return;
      xFeedListEl.innerHTML = "";
      if (!xFeedItems.length) {
        xFeedListEl.innerHTML = '<li class="x-feed-card"><p class="x-feed-text">Tidak ada update dari X Feed.</p></li>';
        return;
      }
      xFeedItems.slice(0, 30).forEach((item) => {
        const card = buildXFeedCard(item);
        xFeedListEl.appendChild(card);
      });
    };

    const fetchXFeed = async ({ silent = false } = {}) => {
      if (!xFeedListEl || xFeedLoading) return;
      xFeedLoading = true;
      const needsInitialUi = !xFeedFetched || !xFeedItems.length;
      if (needsInitialUi) {
        renderXFeedSkeleton();
        setXFeedStatus("Loading feed…");
      } else if (!silent) {
        setXFeedStatus("Refreshing feed…");
      }
      try {
        const response = await fetch(X_FEED_API, { headers: { Accept: "application/json" } });
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const payload = await response.json();
        const list = Array.isArray(payload?.items) ? payload.items : [];
        xFeedItems = list.map(normalizeXFeedItem).filter((item) => item && item.id);
        xFeedFetched = true;
        renderXFeed();
        setXFeedStatus(xFeedItems.length > 0 ? "Live" : "No posts");
      } catch (error) {
        console.error("X feed error:", error);
        xFeedItems = [];
        renderXFeed();
        setXFeedStatus(`Feed error • ${error.message || "Network"}`);
        if (xFeedListEl)
          xFeedListEl.innerHTML = '<li class="x-feed-card"><p class="x-feed-text">Gagal memuat X Feed.</p></li>';
      } finally {
        xFeedLoading = false;
      }
    };

    const ensureXFeedData = async () => {
      if (!xFeedFetched) await fetchXFeed();
      return { items: xFeedItems };
    };

    const buildXFeedRecapPrompt = (label, items) => {
      if (!items.length) return "";
      const lines = items.slice(0, MAX_RECAP_ITEMS).map((item, idx) => {
        const text = item.text || item.titleUrl || "Tanpa teks";
        return `${idx + 1}. [${formatFastbullUTC(item.timestamp)}] ${item.name}: ${text}`;
      });
      return `Anda adalah Kuantara AI. Ringkas ${label} menjadi maksimal 5 poin headline dan 1 paragraf kesimpulan berbahasa Indonesia, soroti sentimen pasar, risiko, dan peluang.
Data:
${lines.join("\n")}`;
    };

    xFeedRecapBtn?.addEventListener("click", () => {
      openKuantaraModal({
        label: "X Feed",
        key: "x-feed",
        ensureData: ensureXFeedData,
        buildPrompt: (items) => buildXFeedRecapPrompt("X Feed", items),
      });
    });

    // ===============================
    // Bloomberg TV+ (HLS + AI summary)
    // ===============================

    let aiSummaryEnabled = false;
    let captionsEnabled = true;
    let liveSummaryInFlight = false;
    let liveHlsInstance = null;
    let liveCcWords = [];

    const updateCcCounter = () => {
      if (ccWordCountEl) ccWordCountEl.textContent = `${liveCcWords.length} / ${LIVE_CC_THRESHOLD} kata`;
    };

    const markdownToHtml = (md) =>
      window.marked ? window.marked.parse(md || "") : (md || "").replace(/\n/g, "<br>");

    const pushLiveSummaryCard = (markdown, status = "AI Catalyst Summary") => {
      if (!aiSummaryFeedEl || aiSummaryFeedEl.dataset.enabled !== "true") return;
      if (aiSummaryFeedEl.dataset.empty !== "false") {
        aiSummaryFeedEl.innerHTML =
          '<p class="text-xs text-neutral-500 uppercase tracking-[0.25em] mb-3">AI SUMMARY FEED</p><p class="text-xs text-neutral-500">Mengumpulkan ringkasan…</p>';
        aiSummaryFeedEl.dataset.empty = "false";
        aiSummaryFeedEl.classList.remove("hidden");
      }
      const card = document.createElement("article");
      card.className = "summary-card";
      card.innerHTML = `
        <div class="summary-card-header">
          <h4>${status} • ${new Date().toLocaleTimeString("en-GB", { hour12: false })}</h4>
          <button type="button" class="copy-btn" aria-label="Salin ringkasan">
            ${COPY_ICON}
          </button>
        </div>
        <div class="md">${markdownToHtml(markdown || "Tidak ada ringkasan.")}</div>
      `;
      aiSummaryFeedEl.prepend(card);
      while (aiSummaryFeedEl.childElementCount > 5) {
        aiSummaryFeedEl.removeChild(aiSummaryFeedEl.lastElementChild);
      }
    };

    const copyTextToClipboard = async (text) => {
      if (navigator.clipboard?.writeText) {
        await navigator.clipboard.writeText(text);
        return;
      }
      const textarea = document.createElement("textarea");
      textarea.value = text;
      textarea.style.position = "fixed";
      textarea.style.opacity = "0";
      document.body.appendChild(textarea);
      textarea.select();
      try {
        document.execCommand("copy");
      } finally {
        document.body.removeChild(textarea);
      }
    };

    const requestLiveSummary = async (chunk) => {
      const prompt = `Anda adalah editor realtime yang merangkum closed caption siaran berita. Buat ringkasan singkat (maks 4 kalimat) dan satu kalimat implikasi praktis. Gunakan bahasa Indonesia dan gaya lugas.\n\nTranskrip:\n"""${chunk}"""`;
      const payload = {
        model: "grok-4",
        from: "chat",
        client_prompt: {},
        multi_content: [{ type: "text", text: prompt, user_input_text: prompt }],
        prompt_templates: [],
        tools: { auto: [] },
        stream: true,
        output_language: "id",
        customize_instructions: { enable: true },
      };
      let summary = "";
      try {
        const resp = await fetch(`${API_BASE}/completions`, {
          method: "POST",
          headers: baseHeaders_chat(),
          body: JSON.stringify(payload),
        });
        if (!resp.ok || !resp.body) throw new Error(`HTTP ${resp.status}`);
        const reader = resp.body.getReader();
        const decoder = new TextDecoder();
        let buffer = "";
        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          buffer += decoder.decode(value, { stream: true });
          let idx;
          while ((idx = buffer.indexOf("\n")) >= 0) {
            const line = buffer.slice(0, idx).trim();
            buffer = buffer.slice(idx + 1);
            if (!line || line === "[DONE]") continue;
            if (line.startsWith("data:")) {
              const dataLine = line.slice(5).trim();
              if (dataLine === "[DONE]") continue;
              try {
                const json = JSON.parse(dataLine);
                const piece = json?.data?.text;
                if (typeof piece === "string") summary += piece;
              } catch {
                summary += dataLine;
              }
            } else {
              summary += line;
            }
          }
        }
        summary = summary.trim();
        if (!summary) summary = "AI belum menemukan ringkasan.";
        pushLiveSummaryCard(summary);
      } catch (error) {
        console.error("Live summary error:", error);
        pushLiveSummaryCard(`Gagal membuat ringkasan: ${error.message || error}`, "AI Summary Error");
      }
    };

    const maybeProcessLiveSummary = () => {
      if (!aiSummaryEnabled || liveSummaryInFlight) return;
      if (liveCcWords.length < LIVE_CC_THRESHOLD) return;
      const chunk = liveCcWords.splice(0, LIVE_CC_THRESHOLD).join(" ");
      liveSummaryInFlight = true;
      updateCcCounter();
      requestLiveSummary(chunk)
        .catch(() => {})
        .finally(() => {
          liveSummaryInFlight = false;
          updateCcCounter();
          maybeProcessLiveSummary();
        });
    };

    const appendLiveCaption = (text) => {
      if (!text) return;
      const words = text
        .trim()
        .split(/\s+/)
        .filter(Boolean);
      if (!words.length) return;
      liveCcWords.push(...words);
      if (liveCcWords.length > LIVE_CC_THRESHOLD * 2) {
        liveCcWords = liveCcWords.slice(-LIVE_CC_THRESHOLD * 2);
      }
      updateCcCounter();
      maybeProcessLiveSummary();
    };

    const setAiSummaryState = (enabled) => {
      aiSummaryEnabled = enabled;
      if (aiSummaryToggleBtn)
        aiSummaryToggleBtn.dataset.active = enabled ? "true" : "false";
      if (aiSummaryFeedEl) {
        aiSummaryFeedEl.dataset.enabled = enabled ? "true" : "false";
        if (!enabled) {
          aiSummaryFeedEl.classList.add("hidden");
          aiSummaryFeedEl.dataset.empty = "true";
          aiSummaryFeedEl.innerHTML =
            '<p class="text-xs text-neutral-500 uppercase tracking-[0.25em]">AI SUMMARY FEED</p><p class="mt-2 text-sm text-neutral-400">Belum ada ringkasan. Aktifkan AI auto-summary untuk mulai mengumpulkan insight.</p>';
        } else {
          aiSummaryFeedEl.classList.remove("hidden");
          if (aiSummaryFeedEl.dataset.empty === "true") {
            aiSummaryFeedEl.innerHTML =
              '<p class="text-xs text-neutral-500 uppercase tracking-[0.25em] mb-3">AI SUMMARY FEED</p><p class="text-xs text-neutral-500">Menunggu ringkasan pertama…</p>';
          }
        }
      }
      if (enabled) maybeProcessLiveSummary();
    };

    const handleCaptionCueChange = (event) => {
      const cues = event?.target?.activeCues || [];
      let text = "";
      for (let i = 0; i < cues.length; i += 1) {
        const cueText = cues[i]?.text;
        if (cueText) text += `${cueText} `;
      }
      appendLiveCaption(text.trim());
    };

    const attachCaptionHandlers = () => {
      if (!liveVideoEl || !liveVideoEl.textTracks) return;
      const tracks = liveVideoEl.textTracks;
      if (!tracks || !tracks.length) return;
      for (let i = 0; i < tracks.length; i += 1) {
        const track = tracks[i];
        track.removeEventListener?.("cuechange", handleCaptionCueChange);
        track.addEventListener?.("cuechange", handleCaptionCueChange);
        track.mode = captionsEnabled ? "showing" : "disabled";
      }
    };

    const updateHlsSubtitleState = () => {
      if (!liveHlsInstance) return;
      if (captionsEnabled) {
        const available = liveHlsInstance.subtitleTracks || [];
        if (available.length) {
          liveHlsInstance.subtitleDisplay = true;
          if (liveHlsInstance.subtitleTrack < 0) liveHlsInstance.subtitleTrack = 0;
        } else {
          liveHlsInstance.subtitleTrack = -1;
        }
      } else {
        liveHlsInstance.subtitleDisplay = false;
        liveHlsInstance.subtitleTrack = -1;
      }
    };

    const initializeLivePlayer = () => {
      if (!liveVideoEl || !LIVE_STREAM_SRC) return;
      liveVideoEl.crossOrigin = "anonymous";
      try {
        if (window.Hls && window.Hls.isSupported()) {
          if (liveHlsInstance) {
            liveHlsInstance.destroy();
            liveHlsInstance = null;
          }
          const hls = new window.Hls({ enableWorker: true, enableWebVTT: true });
          hls.loadSource(LIVE_STREAM_SRC);
          hls.attachMedia(liveVideoEl);
          hls.on(window.Hls.Events.SUBTITLE_TRACKS_UPDATED, updateHlsSubtitleState);
          hls.on(window.Hls.Events.MANIFEST_PARSED, updateHlsSubtitleState);
          liveHlsInstance = hls;
          updateHlsSubtitleState();
        } else if (liveVideoEl.canPlayType("application/vnd.apple.mpegurl")) {
          liveVideoEl.src = LIVE_STREAM_SRC;
        } else {
          console.warn("HLS not supported in this browser.");
        }
        liveVideoEl.muted = true;
      } catch (error) {
        console.error("Live player init error:", error);
      }
      liveVideoEl.addEventListener("loadedmetadata", attachCaptionHandlers);
      liveVideoEl.addEventListener("loadeddata", attachCaptionHandlers);
      if (liveVideoEl.textTracks?.addEventListener) {
        liveVideoEl.textTracks.addEventListener("addtrack", attachCaptionHandlers);
      }
    };

    window.pushLiveCaption = appendLiveCaption;

    aiSummaryToggleBtn?.addEventListener("click", () =>
      setAiSummaryState(!aiSummaryEnabled)
    );
    attachCaptionHandlers();
    setAiSummaryState(false);
    aiSummaryFeedEl?.addEventListener("click", (event) => {
      const button = event.target.closest(".copy-btn");
      if (!button) return;
      const card = button.closest(".summary-card");
      const mdEl = card?.querySelector(".md");
      if (!mdEl) return;
      const text = mdEl.textContent.trim();
      if (!text) return;
      copyTextToClipboard(text)
        .then(() => {
          button.classList.add("copied");
          setTimeout(() => button.classList.remove("copied"), 1500);
        })
        .catch((error) => console.error("Copy failed:", error));
    });

    // ===============================
    // Kuantara AI modal + streaming
    // ===============================

    let cid = null;
    let parentMessageId = null;
    let isStreaming = false;
    let streamBuffer = "";
    const recapConversations = new Map();
    let messages = [];
    let kuantaraContext = null;

    function setAdaptiveHeight() {
      const vh = window.innerHeight || 0;
      const isMobile = vh && window.matchMedia("(max-width: 820px)").matches;
      const base = isMobile ? Math.round(vh * 0.66) : Math.round(vh * 0.6);
      document.documentElement.style.setProperty("--chat-h", Math.max(260, base) + "px");
    }
    function syncChatHeight() {
      if (!chatListEl) return;
      const h = getComputedStyle(document.documentElement).getPropertyValue("--chat-h");
      chatListEl.style.maxHeight = `calc(${h.trim() || "360px"} - 40px)`;
    }
    setAdaptiveHeight();
    syncChatHeight();
    window.addEventListener("resize", () => {
      setAdaptiveHeight();
      syncChatHeight();
    });

    const renderChat = () => {
      if (!chatListEl) return;
      if (!messages.length) {
        chatListEl.innerHTML = '<p class="hint">Belum ada percakapan.</p>';
        return;
      }
      chatListEl.innerHTML = messages
        .map(
          (msg) => `
        <div class="kuantara-message ${msg.sender === "Anda" ? "user" : "ai"}">
          <p class="kuantara-label">${msg.sender === "Anda" ? "YOU" : "AI"}</p>
          <div class="kuantara-block">
            <div class="md">${markdownToHtml(msg.contentMD || "")}</div>
          </div>
        </div>`
        )
        .join("");
      chatListEl.scrollTop = chatListEl.scrollHeight;
    };

    const addMessage = (sender, contentMD) => {
      messages.push({ sender, contentMD });
      renderChat();
      return messages.length - 1;
    };

    const updateMessage = (index, contentMD) => {
      if (!messages[index]) return;
      messages[index].contentMD = contentMD;
      renderChat();
    };

    const openKuantaraModal = async (context = {}) => {
      if (!kuantaraModal) return;
      kuantaraContext = context;
      const { label = "AI Recap", key = label, ensureData, buildPrompt, autoRecap = true } = context;
      kuantaraModal.classList.remove("hidden");
      document.body.style.overflow = "hidden";
      if (!recapConversations.has(key)) recapConversations.set(key, []);
      messages = recapConversations.get(key);
      if (kuantaraTitleEl) kuantaraTitleEl.textContent = `${label} Recap`;
      renderChat();
      if (!autoRecap || isStreaming) return;
      try {
        const dataset = (await ensureData?.()) || { items: [] };
        const promptText = buildPrompt?.(dataset.items || [], label);
        if (!promptText) {
          addMessage("Kuantara", `Tidak ada data untuk ${label}.`);
          return;
        }
        startStreaming(promptText, { userVisibleText: null });
      } catch (error) {
        console.error("Recap modal error", error);
        addMessage("Kuantara", `Gagal menyiapkan recap: ${error.message || error}`);
      }
    };

    const closeKuantaraModal = () => {
      if (!kuantaraModal) return;
      kuantaraModal.classList.add("hidden");
      document.body.style.overflow = "";
      if (kuantaraContext && recapConversations.has(kuantaraContext.key)) {
        recapConversations.set(kuantaraContext.key, messages);
      }
    };

    kuantaraCloseBtn?.addEventListener("click", closeKuantaraModal);

    const safeText = async (response) => {
      try {
        return await response.text();
      } catch {
        return "";
      }
    };

    function baseHeaders_chat() {
      return {
        "User-Agent":
          "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/140.0.0.0 Safari/537.36",
        "Content-Type": "application/json",
        Accept: "text/event-stream",
        "Cache-Control": "no-cache",
        Connection: "keep-alive",
        authorization: `Bearer ${TOKEN}`,
        "x-app-name": "ChitChat_Web",
        "x-time-zone": TIMEZONE,
        origin: "https://sider.ai",
      };
    }
    function baseHeaders_list() {
      return {
        "User-Agent":
          "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/141.0.0.0 Safari/537.36",
        "Content-Type": "application/json",
        authorization: `Bearer ${TOKEN}`,
        "x-app-name": "ChitChat_Web",
        "x-time-zone": TIMEZONE,
        origin: "https://sider.ai",
      };
    }

    async function fetchCurrentLeaf(conversationId, limit = 100, timeoutMs = 15000) {
      const ctrl = new AbortController();
      const t = setTimeout(() => ctrl.abort(), timeoutMs);
      try {
        const resp = await fetch(`${API_BASE}/conversation/list`, {
          method: "POST",
          headers: baseHeaders_list(),
          body: JSON.stringify({ limit, client_type: "chat", sort_type: "desc" }),
          signal: ctrl.signal,
        });
        if (!resp.ok) return null;
        const data = await resp.json().catch(() => null);
        const convs = data?.data?.conversations || [];
        for (const c of convs) {
          if (c?.id === conversationId) return c.current_leaf_message_id || null;
        }
        return null;
      } catch {
        return null;
      } finally {
        clearTimeout(t);
      }
    }

    const handleSSEData = (dataStr) => {
      if (!dataStr || dataStr === "[DONE]") return;
      try {
        const obj = JSON.parse(dataStr);
        const payload = obj?.data || {};
        const type = payload?.type;
        if (type === "credit_info") return;
        if (type === "message_start") {
          const ms = payload?.message_start || {};
          if (ms?.cid) cid = ms.cid;
          if (ms?.assistant_message_id) parentMessageId = ms.assistant_message_id;
          return;
        }
        if (type === "text") {
          const piece = payload?.text;
          if (typeof piece === "string" && piece) {
            streamBuffer += piece;
          }
          return;
        }
        for (const key of ["text", "token", "content", "output", "message"]) {
          const value = payload?.[key];
          if (typeof value === "string" && value) {
            streamBuffer += value;
            return;
          }
        }
      } catch {
        streamBuffer += dataStr;
      }
    };

    const resetStreamFlags = () => {
      isStreaming = false;
      streamBuffer = "";
    };

    async function startStreaming(promptText, { userVisibleText = null } = {}) {
      if (isStreaming) return;
      if (cid) {
        const leaf = await fetchCurrentLeaf(cid);
        if (leaf) parentMessageId = leaf;
      }
      let aiMessageIndex = null;
      if (userVisibleText) addMessage("Anda", userVisibleText);
      aiMessageIndex = addMessage("Kuantara", "_Sedang berpikir…_");
      isStreaming = true;
      streamBuffer = "";

      const payload = {
        model: "grok-4",
        from: "chat",
        client_prompt: {},
        multi_content: [{ type: "text", text: promptText, user_input_text: promptText }],
        prompt_templates: [],
        tools: { auto: ["search"] },
        stream: true,
        output_language: "id",
        customize_instructions: { enable: true },
      };
      if (cid) payload.cid = cid;
      if (parentMessageId) payload.parent_message_id = parentMessageId;

      let resp;
      try {
        resp = await fetch(`${API_BASE}/completions`, {
          method: "POST",
          headers: baseHeaders_chat(),
          body: JSON.stringify(payload),
        });
      } catch (err) {
        updateMessage(aiMessageIndex, `**Error koneksi:** ${err?.message || err}`);
        resetStreamFlags();
        return;
      }

      if (!resp.ok || !resp.body) {
        const text = await safeText(resp);
        updateMessage(
          aiMessageIndex,
          `**HTTP ${resp.status} ${resp.statusText}**${text ? "\n\n" + text.slice(0, 300) : ""}`
        );
        resetStreamFlags();
        return;
      }

      const reader = resp.body.getReader();
      const decoder = new TextDecoder();
      let buffer = "";
      try {
        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          buffer += decoder.decode(value, { stream: true });
          let idx;
          while ((idx = buffer.indexOf("\n")) >= 0) {
            const rawLine = buffer.slice(0, idx);
            buffer = buffer.slice(idx + 1);
            const line = (rawLine || "").trim();
            if (!line) continue;
            if (line === "[DONE]") continue;
            if (line.startsWith("data:")) {
              const dataLine = line.slice(5).trim();
              if (dataLine === "[DONE]") continue;
              handleSSEData(dataLine);
            } else {
              handleSSEData(line);
            }
          }
          if (streamBuffer) {
            updateMessage(aiMessageIndex, streamBuffer);
          }
        }
      } catch (err) {
        updateMessage(aiMessageIndex, `**Stream error:** ${err?.message || err}`);
      } finally {
        if (streamBuffer) {
          updateMessage(aiMessageIndex, streamBuffer);
        } else {
          updateMessage(aiMessageIndex, "_Tidak ada respons._");
        }
        resetStreamFlags();
      }
    }

    const sendPromptFromInput = () => {
      if (!inputEl) return;
      const text = inputEl.value.trim();
      if (!text) return;
      inputEl.value = "";
      startStreaming(text, { userVisibleText: text });
    };

    sendBtn?.addEventListener("click", sendPromptFromInput);
    inputEl?.addEventListener("keydown", (ev) => {
      if (ev.key === "Enter" && !ev.shiftKey) {
        ev.preventDefault();
        sendPromptFromInput();
      }
    });

    document.addEventListener("keydown", (ev) => {
      if (ev.key === "Escape") {
        if (!kuantaraModal?.classList.contains("hidden")) closeKuantaraModal();
        if (!readerModal?.classList.contains("hidden")) closeReaderShell();
      }
    });

    kuantaraModal?.addEventListener("click", (ev) => {
      if (ev.target === kuantaraModal) closeKuantaraModal();
    });
    readerModal?.addEventListener("click", (ev) => {
      if (ev.target === readerModal) closeReaderShell();
    });

    const init = async () => {
      renderResearchSkeleton();
      renderXFeedSkeleton();
      updateCcCounter();
      await refreshCt();
      fetchInsights();
      fetchXFeed();
      initializeLivePlayer();
    };

    init().catch((error) => console.error("Init failed", error));
    setInterval(() => fetchXFeed({ silent: true }), 60000);
    setInterval(() => fetchInsights({ silent: true }), 180000);

    window.refreshResearchFeed = fetchInsights;
    window.refreshXFeed = fetchXFeed;
  </script>
</body>
</html>
