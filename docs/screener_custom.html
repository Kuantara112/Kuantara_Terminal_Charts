<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Kuantara – IDX Custom Screener</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Fira Code -->
  <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600&display=swap"/>

  <style>
    :root{
      --bg-root:#000000;
      --bg-main:#111111;
      --bg-panel:#161616;
      --bg-input:#151515;
      --border-soft:#2b2b2b;
      --text-main:#f5f5f5;
      --text-muted:#9b9b9b;
      --accent:#ffbf00;
      --accent-soft:rgba(255,191,0,0.12);
      --up:#22c55e;
      --down:#ef4444;
      --radius:10px;
    }

    *{
      box-sizing:border-box;
      margin:0;
      padding:0;
      font-family:"Fira Code",monospace;
    }

    body{
      background:var(--bg-root);
      color:var(--text-main);
    }

    .app{
      max-width:900px;
      margin:0 auto;
      min-height:100vh;
      display:flex;
      flex-direction:column;
      background:var(--bg-main);
    }

    /* Top bar */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 14px;
      background:#222;
      border-bottom:1px solid #333;
    }
    .topbar-left{
      display:flex;
      align-items:center;
      gap:10px;
      font-size:14px;
      font-weight:500;
    }
    .back-btn{
      width:20px;
      height:20px;
      border-radius:999px;
      border:1px solid var(--border-soft);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:12px;
      color:var(--text-muted);
    }
    .save-btn-top{
      font-size:11px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid var(--accent);
      color:var(--accent);
      background:transparent;
      cursor:pointer;
    }

    .content{
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .card{
      background:var(--bg-panel);
      border-radius:var(--radius);
      border:1px solid var(--border-soft);
      padding:12px;
    }

    .section-title{
      font-size:14px;
      margin-bottom:4px;
    }
    .section-subtitle{
      font-size:11px;
      color:var(--text-muted);
      margin-bottom:8px;
    }

    label{
      font-size:11px;
      color:var(--text-muted);
      margin-bottom:3px;
      display:block;
    }

    input,select,textarea{
      width:100%;
      padding:8px 10px;
      border-radius:var(--radius);
      border:1px solid var(--border-soft);
      background:var(--bg-input);
      color:var(--text-main);
      font-size:11px;
      outline:none;
    }

    textarea{
      min-height:120px;
      resize:vertical;
      white-space:pre-wrap;
    }

    .row{
      display:flex;
      gap:10px;
      margin-top:8px;
    }
    .row > div{flex:1;}

    .radio-group{
      display:flex;
      align-items:center;
      gap:10px;
      margin-top:4px;
      font-size:11px;
      color:var(--text-muted);
    }
    .radio-group label{
      display:flex;
      align-items:center;
      gap:4px;
      margin:0;
    }

    .btn-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:10px;
    }

    .btn{
      flex:1;
      min-width:120px;
      border:none;
      border-radius:var(--radius);
      padding:8px 10px;
      font-size:11px;
      cursor:pointer;
      font-weight:500;
      transition:0.15s;
    }
    .btn-template{
      background:#1f2933;
      color:var(--text-muted);
    }
    .btn-help{
      background:#1f2933;
      color:var(--text-muted);
    }
    .btn-test{
      background:#4ade80;
      color:#000;
    }
    .btn:hover{opacity:.85;}

    .status{
      font-size:11px;
      color:var(--text-muted);
      margin-top:6px;
      min-height:14px;
    }

    .results-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:11px;
      margin-bottom:6px;
    }
    .results-count{
      color:var(--accent);
      font-weight:600;
    }
    .results-tags{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }
    .tag{
      border-radius:999px;
      border:1px solid #374151;
      padding:2px 6px;
      font-size:9px;
      color:var(--text-muted);
    }

    .table-wrap{
      max-height:380px;
      overflow:auto;
      border-radius:var(--radius);
      border:1px solid var(--border-soft);
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
    }
    thead{
      position:sticky;
      top:0;
      background:#050505;
      z-index:1;
    }
    th,td{
      padding:6px 8px;
      border-bottom:1px solid #1f2933;
      white-space:nowrap;
    }
    th{
      text-align:left;
      color:var(--text-muted);
      font-weight:500;
      font-size:10px;
    }
    tr:nth-child(even){background:#101010;}

    @media(max-width:640px){
      .row{flex-direction:column;}
      .btn-row{flex-direction:column;}
    }
  </style>
</head>
<body>
<div class="app">

  <div class="topbar">
    <div class="topbar-left">
      <div class="back-btn"><</div>
      <div>Add/Edit Screener</div>
    </div>
    <button class="save-btn-top" id="btnSaveTop">SAVE</button>
  </div>

  <div class="content">
    <!-- FORM -->
    <div class="card">
      <div class="section-title">Buat Strategi Screener</div>
      <div class="section-subtitle">
        Custom screener Kuantara untuk saham Indonesia.
      </div>

      <label for="name">Screener Name</label>
      <input id="name" placeholder="KUANTARA 01" />

      <label for="score" style="margin-top:6px;">Score</label>
      <input id="score" value="0" type="number" />

      <label for="criteria" style="margin-top:8px;">Criteria</label>
      <textarea id="criteria" placeholder='Contoh:
volume > sma("volume", 20) * 5 &&
roc("close", 1) > 0 &&
price > 60'></textarea>

      <label style="margin-top:8px;">Sort & Limit</label>
      <div class="row">
        <div>
          <label for="sortBy">Sort By</label>
          <select id="sortBy">
            <option value="value">Value (price * volume)</option>
            <option value="price">Price</option>
            <option value="volume">Volume</option>
            <option value="symbol">Symbol</option>
          </select>
        </div>
        <div>
          <label>Order</label>
          <div class="radio-group">
            <label><input type="radio" name="order" value="asc" /> Asc</label>
            <label><input type="radio" name="order" value="desc" checked /> Desc</label>
          </div>
        </div>
        <div>
          <label for="limit">Limit Result</label>
          <select id="limit">
            <option value="0">No Limit</option>
            <option value="10">Top 10</option>
            <option value="20">Top 20</option>
            <option value="50">Top 50</option>
            <option value="100">Top 100</option>
          </select>
        </div>
      </div>

      <div class="btn-row">
        <button class="btn btn-template" id="btnTemplate">Criteria Template</button>
        <button class="btn btn-help" id="btnHelp">Help</button>
        <button class="btn btn-test" id="btnTest">Test Run</button>
      </div>

      <div class="status" id="status"></div>
    </div>

    <!-- RESULTS -->
    <div class="card">
      <div class="results-head">
        <div>Results</div>
        <div class="results-tags">
          <span class="results-count" id="resultCount">0</span>
          <span class="tag" id="runtimeTag">runtime: - ms</span>
        </div>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
          <tr>
            <th>Symbol</th>
            <th>Price</th>
            <th>Volume</th>
            <th>Value</th>
          </tr>
          </thead>
          <tbody id="resultBody">
          <!-- rows here -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  /* ==============================
   *  IDX UNIVERSE – FRONT-END
   * ============================== */
  const UNIVERSE = [
    "AALI","ABBA","ABDA","ABMM","ACES","ACST","ADES","ADHI","ADMF","ADMG","ADRO","AGII","AGRO","AGRS","AHAP","AIMS","AISA","AKKU","AKPI","AKRA","AKSI","ALDO","ALKA","ALMI","ALTO","AMAG","AMFG","AMIN","AMRT","ANJT","ANTM","APEX","APIC","APII","APLI","APLN","ARGO","ARII","ARNA","ARTA","ARTI","ARTO","ASBI","ASDM","ASGR","ASII","ASJT","ASMI","ASRI","ASRM","ASSA","ATIC","AUTO","BABP","BACA","BAJA","BALI","BAPA","BATA","BAYU","BBCA","BBHI","BBKP","BBLD","BBMD","BBNI","BBRI","BBRM","BBTN","BBYB","BCAP","BCIC","BCIP","BDMN","BEKS","BEST","BFIN","BGTG","BHIT","BIKA","BIMA","BINA","BIPI","BIPP","BIRD","BISI","BJBR","BJTM","BKDP","BKSL","BKSW","BLTA","BLTZ","BMAS","BMRI","BMSR","BMTR","BNBA","BNBR","BNGA","BNII","BNLI","BOLT","BPFI","BPII","BRAM","BRMS","BRNA","BRPT","BSDE","BSIM","BSSR","BSWD","BTEK","BTEL","BTON","BTPN","BUDI","BUKK","BULL","BUMI","BUVA","BVIC","BWPT","BYAN","CANI","CASS","CEKA","CENT","CFIN","CINT","CITA","CLPI","CMNP","CMPP","CNKO","CNTX","COWL","CPIN","CPRO","CSAP","CTBN","CTRA","CTTH","DART","DEFI","DEWA","DGIK","DILD","DKFT","DLTA","DMAS","DNAR","DNET","DOID","DPNS","DSFI","DSNG","DSSA","DUTI","DVLA","DYAN","ECII","EKAD","ELSA","ELTY","EMDE","EMTK","ENRG","EPMT","ERAA","ERTX","ESSA","ESTI","ETWA","EXCL","FAST","FASW","FISH","FMII","FORU","FPNI","GAMA","GDST","GDYR","GEMA","GEMS","GGRM","GIAA","GJTL","GLOB","GMTD","GOLD","GOLL","GPRA","GSMF","GTBO","GWSA","GZCO","HADE","HDFA","HERO","HEXA","HITS","HMSP","HOME","HOTL","HRUM","IATA","IBFN","IBST","ICBP","ICON","IGAR","IIKP","IKAI","IKBI","IMAS","IMJS","IMPC","INAF","INAI","INCI","INCO","INDF","INDR","INDS","INDX","INDY","INKP","INPC","INPP","INRU","INTA","INTD","INTP","IPOL","ISAT","ISSP","ITMA","ITMG","JAWA","JECC","JIHD","JKON","JPFA","JRPT","JSMR","JSPT","JTPE","KAEF","KARW","KBLI","KBLM","KBLV","KBRI","KDSI","KIAS","KICI","KIJA","KKGI","KLBF","KOBX","KOIN","KONI","KOPI","KPIG","KRAS","KREN","LAPD","LCGP","LEAD","LINK","LION","LMAS","LMPI","LMSH","LPCK","LPGI","LPIN","LPKR","LPLI","LPPF","LPPS","LRNA","LSIP","LTLS","MAGP","MAIN","MAPI","MAYA","MBAP","MBSS","MBTO","MCOR","MDIA","MDKA","MDLN","MDRN","MEDC","MEGA","MERK","META","MFMI","MGNA","MICE","MIDI","MIKA","MIRA","MITI","MKPI","MLBI","MLIA","MLPL","MLPT","MMLP","MNCN","MPMX","MPPA","MRAT","MREI","MSKY","MTDL","MTFN","MTLA","MTSM","MYOH","MYOR","MYTX","NELY","NIKL","NIRO","NISP","NOBU","NRCA","OCAP","OKAS","OMRE","PADI","PALM","PANR","PANS","PBRX","PDES","PEGE","PGAS","PGLI","PICO","PJAA","PKPK","PLAS","PLIN","PNBN","PNBS","PNIN","PNLF","PNSE","POLY","POOL","PPRO","PSAB","PSDN","PSKT","PTBA","PTIS","PTPP","PTRO","PTSN","PTSP","PUDP","PWON","PYFA","RAJA","RALS","RANC","RBMS","RDTX","RELI","RICY","RIGS","RIMO","RODA","ROTI","RUIS","SAFE","SAME","SCCO","SCMA","SCPI","SDMU","SDPC","SDRA","SGRO","SHID","SIDO","SILO","SIMA","SIMP","SIPD","SKBM","SKLT","SKYB","SMAR","SMBR","SMCB","SMDM","SMDR","SMGR","SMMA","SMMT","SMRA","SMRU","SMSM","SOCI","SONA","SPMA","SQMI","SRAJ","SRIL","SRSN","SRTG","SSIA","SSMS","SSTM","STAR","STTP","SUGI","SULI","SUPR","TALF","TARA","TAXI","TBIG","TBLA","TBMS","TCID","TELE","TFCO","TGKA","TIFA","TINS","TIRA","TIRT","TKIM","TLKM","TMAS","TMPO","TOBA","TOTL","TOTO","TOWR","TPIA","TPMA","TRAM","TRIL","TRIM","TRIO","TRIS","TRST","TRUS","TSPC","ULTJ","UNIC","UNIT","UNSP","UNTR","UNVR","VICO","VINS","VIVA","VOKS","VRNA","WAPO","WEHA","WICO","WIIM","WIKA","WINS","WOMF","WSKT","WTON","YPAS","YULE","ZBRA","SHIP","CASA","DAYA","DPUM","IDPR","JGLE","KINO","MARI","MKNT","MTRA","OASA","POWR","INCF","WSBP","PBSA","PRDA","BOGA","BRIS","PORT","CARS","MINA","CLEO","TAMU","CSIS","TGRA","FIRE","TOPS","KMTR","ARMY","MAPB","WOOD","HRTA","MABA","HOKI","MPOW","MARK","NASA","MDKI","BELL","KIOS","GMFI","MTWI","ZINC","MCAS","PPRE","WEGE","PSSI","MORA","DWGL","PBID","JMAS","CAMP","IPCM","PCAR","LCKM","BOSS","HELI","JSKY","INPS","GHON","TDPM","DFAM","NICK","BTPS","SPTO","PRIM","HEAL","TRUK","PZZA","TUGU","MSIN","SWAT","TNCA","MAPA","TCPI","IPCC","RISE","BPTR","POLL","NFCX","MGRO","NUSA","FILM","ANDI","LAND","MOLI","PANI","DIGI","CITY","SAPX","SURE","HKMU","MPRO","DUCK","GOOD","SKRN","YELO","CAKK","SATU","SOSS","DEAL","POLA","DIVA","LUCK","URBN","SOTS","ZONE","PEHA","FOOD","BEEF","POLI","CLAY","NATO","JAYA","COCO","MTPS","CPRI","HRME","POSA","JAST","FITT","BOLA","CCSI","SFAN","POLU","KJEN","KAYU","ITIC","PAMG","IPTV","BLUE","ENVY","EAST","LIFE","FUJI","KOTA","INOV","ARKA","SMKL","HDIT","KEEN","BAPI","TFAS","GGRP","OPMS","NZIA","SLIS","PURE","IRRA","DMMX","SINI","WOWS","ESIP","TEBE","KEJU","PSGO","AGAR","IFSH","REAL","IFII","PMJS","UCID","GLVA","PGJO","AMAR","CSRA","INDO","AMOR","TRIN","DMND","PURA","PTPW","TAMA","IKAN","SAMF","SBAT","KBAG","CBMF","RONY","CSMI","BBSS","BHAT","CASH","TECH","EPAC","UANG","PGUN","SOFA","PPGL","TOYS","SGER","TRJA","PNGO","SCNP","BBSI","KMDS","PURI","SOHO","HOMI","ROCK","ENZO","PLAN","PTDU","ATAP","VICI","PMMP","BANK","WMUU","EDGE","UNIQ","BEBS","SNLK","ZYRX","LFLO","FIMP","TAPG","NPGF","LUCY","ADCP","HOPE","MGLV","TRUE","LABA","ARCI","IPAC","MASB","BMHS","FLMC","NICL","UVCR","BUKA","HAIS","OILS","GPSO","MCOL","RSGK","RUNS","SBMA","CMNT","GTSI","IDEA","KUAS","BOBA","MTEL","DEPO","BINO","CMRY","WGSH","TAYS","WMPP","RMKE","OBMD","AVIA","IPPE","NASI","BSML","DRMA","ADMR","SEMA","ASLC","NETV","BAUT","ENAK","NTBK","SMKM","STAA","NANO","BIKE","WIRG","SICO","GOTO","TLDN","MTMH","WINR","IBOS","OLIV","ASHA","SWID","TRGU","ARKO","CHEM","DEWI","AXIO","KRYA","HATM","RCCC","GULA","JARR","AMMS","RAFI","KKES","ELPI","EURO","KLIN","TOOL","BUAH","CRAB","MEDS","COAL","PRAY","CBUT","BELI","MKTR","OMED","BSBK","PDPP","KDTN","ZATA","NINE","MMIX","PADA","ISAP","VTNY","SOUL","ELIT","BEER","CBPE","SUNI","CBRE","WINE","BMBL","PEVE","LAJU","FWCT","NAYZ","IRSX","PACK","VAST","CHIP","HALO","KING","PGEO","FUTR","HILL","BDKR","PTMP","SAGE","TRON","CUAN","NSSS","GTRA","HAJJ","JATI","TYRE","MPXL","SMIL","KLAS","MAXI","VKTR","RELF","AMMN","CRSN","GRPM","WIDI","TGUK","INET","MAHA","RMKO","CNMA","FOLK","HBAT","GRIA","PPRI","ERAL","CYBR","MUTU","LMAX","HUMI","MSIE","RSCH","BABY","AEGS","IOTF","KOCI","PTPS","BREN","STRK","KOKA","LOPI","UDNG","RGAS","MSTI","IKPM","AYAM","SURI","ASLI","GRPH","SMGA","UNTD","TOSK","MPIX","ALII","MKAP","MEJA","LIVE","HYGN","BAIK","VISI","AREA","MHKI","ATLA","DATA","SOLA","BATR","SPRE","PART","GOLF","ISEA","BLES","GUNA","LABS","DOSS","NEST","PTMR","VERN","DAAZ","BOAT","NAIK","AADI","MDIY","KSIX","RATU","YOII","HGII","BRRC","DGWG","CBDK","OBAT","MINE","ASPR","PSAT","COIN","CDIA","BLOG","MERI","CHEK","PMUI","EMAS","PJHB","KAQI","YUPI","FORE","MDLA","DKHH","AYLS","DADA","ASPI","ESTA","BESS","AMAN","CARE","PIPA","NCKL","MENN","AWAN","MBMA","RAAM","DOOH","CGAS","NICE","MSJA","SMLE","ACRO","MANG","WIFI","FAPA","DCII","KETR","DGNS","UFOE"
  ];

  /* ==============================
   *  BACKEND CONFIG
   * ============================== */
  const API_BASE = "https://kuancloud.loclx.io/api/tvohlc/ohlcv";
  const INTERVAL = 5;
  const BARS_COUNT = 25;

  var statusEl = document.getElementById("status");
  var resultBody = document.getElementById("resultBody");
  var resultCountEl = document.getElementById("resultCount");
  var runtimeTag = document.getElementById("runtimeTag");
  var screenerStorageKey = "kuantara_idx_screener_last";
  var isRunning = false;

  /* ========== OHLCV FETCHER ========== */
  async function fetchBars(symbol){
    var url = API_BASE +
      "?symbol=" + encodeURIComponent(symbol) +
      "&interval=" + INTERVAL +
      "&bars_count=" + BARS_COUNT;

    var res = await fetch(url);
    if (!res.ok) throw new Error("HTTP " + res.status);
    var json = await res.json();

    // kasus 1: array of bars {t,o,h,l,c,v} / {time,open,...}
    if (Array.isArray(json)) {
      var arr = [];
      for (var i = 0; i < json.length; i++) {
        var b = json[i];
        arr.push({
          time: b.time || b.t || 0,
          o: b.o != null ? b.o : b.open,
          h: b.h != null ? b.h : b.high,
          l: b.l != null ? b.l : b.low,
          c: b.c != null ? b.c : b.close,
          v: b.v != null ? b.v : b.volume
        });
      }
      return arr;
    }

    // kasus 2: object dengan array t,o,h,l,c,v
    if (json.t && json.c) {
      var bars = [];
      for (var j = 0; j < json.t.length; j++) {
        bars.push({
          time: json.t[j],
          o: json.o[j],
          h: json.h[j],
          l: json.l[j],
          c: json.c[j],
          v: json.v[j]
        });
      }
      return bars;
    }

    console.log("Unknown OHLCV structure:", json);
    return [];
  }

  /* ========== INDICATOR HELPERS ========== */

  function baseSma(bars, length, field){
    if (!bars || bars.length < length) return null;
    var sum = 0;
    for (var i = bars.length - length; i < bars.length; i++) {
      sum += bars[i][field];
    }
    return sum / length;
  }

  function baseRoc(bars, period, field){
    if (!bars || bars.length <= period) return null;
    var last = bars[bars.length - 1][field];
    var prev = bars[bars.length - 1 - period][field];
    if (!prev) return null;
    return ((last - prev) / prev) * 100;
  }

  function baseHhv(bars, length, field){
    if (!bars || bars.length < length) return null;
    var max = -Infinity;
    for (var i = bars.length - length; i < bars.length; i++) {
      if (bars[i][field] > max) max = bars[i][field];
    }
    return max;
  }

  function baseEma(bars, length, field){
    if (!bars || bars.length < length * 2) return null;
    var k = 2 / (length + 1);
    var ema = 0;
    var sum = 0;
    var i;

    for (i = 0; i < length; i++) sum += bars[i][field];
    ema = sum / length;

    for (i = length; i < bars.length; i++){
      ema = bars[i][field] * k + ema * (1 - k);
    }
    return ema;
  }

  function baseRsi(bars, length, field){
    if (!bars || bars.length <= length) return null;
    var gain = 0;
    var loss = 0;

    for (var i = bars.length - length; i < bars.length; i++){
      var diff = bars[i][field] - bars[i-1][field];
      if (diff > 0) gain += diff;
      else loss -= diff;
    }

    var avgGain = gain / length;
    var avgLoss = loss / length;
    if (avgLoss === 0) return 100;
    var rs = avgGain / avgLoss;
    return 100 - (100 / (1 + rs));
  }

  function baseMacd(bars, fastLen, slowLen, signalLen, field){
    if (!bars || bars.length < slowLen * 2) return null;

    var kFast = 2 / (fastLen + 1);
    var kSlow = 2 / (slowLen + 1);
    var kSignal = 2 / (signalLen + 1);

    var emaFast = bars[0][field];
    var emaSlow = bars[0][field];
    var macdLine = 0;
    var signal = 0;

    for (var i = 1; i < bars.length; i++){
      var price = bars[i][field];
      emaFast = price * kFast + emaFast * (1 - kFast);
      emaSlow = price * kSlow + emaSlow * (1 - kSlow);
      macdLine = emaFast - emaSlow;
      signal = signal + kSignal * (macdLine - signal);
    }

    var hist = macdLine - signal;
    return { macd: macdLine, signal: signal, hist: hist };
  }

  /* ========== EXPRESSION ENGINE ========== */

  function buildEvaluator(criteriaText){
    var body = ''
      + 'const price = last.c;'
      + 'const volume = last.v;'
      + 'const value  = price * volume;'
      + 'const prev   = bars[bars.length - 2] || last;'
      + 'const prevPrice = prev.c;'
      + 'const prevVolume = prev.v;'
      + 'const prevValue  = prevPrice * prevVolume;'

      + 'function sma(field, len){'
      + '  const f = (field === "volume") ? "v" : "c";'
      + '  return baseSma(bars, len, f);'
      + '}'

      + 'function roc(field, len){'
      + '  const f = (field === "volume") ? "v" : "c";'
      + '  return baseRoc(bars, len, f);'
      + '}'

      + 'function hhv(field, len){'
      + '  const f = (field === "volume") ? "v" : "c";'
      + '  return baseHhv(bars, len, f);'
      + '}'

      + 'function rsi(field, len){'
      + '  const f = (field === "volume") ? "v" : "c";'
      + '  return baseRsi(bars, len, f);'
      + '}'

      + 'function macd(field, fastLen, slowLen, signalLen){'
      + '  const f = (field === "volume") ? "v" : "c";'
      + '  return baseMacd(bars, fastLen, slowLen, signalLen, f);'
      + '}'

      + 'return (' + criteriaText + ');';

    return new Function(
      "bars",
      "last",
      "baseSma",
      "baseRoc",
      "baseHhv",
      "baseRsi",
      "baseMacd",
      body
    );
  }

  /* ========== RENDER & STORAGE ========== */

  function renderResults(rows){
    resultBody.innerHTML = "";
    for (var i = 0; i < rows.length; i++){
      var row = rows[i];
      var tr = document.createElement("tr");

      var price = row.price;
      if (typeof price === "number") price = price.toFixed(2);

      var volume = row.volume;
      if (typeof volume === "number") volume = String(volume);

      var value = row.value;
      if (typeof value === "number") value = String(Math.round(value));

      tr.innerHTML =
        "<td>" + row.symbol + "</td>" +
        "<td>" + price + "</td>" +
        "<td>" + volume + "</td>" +
        "<td>" + value + "</td>";

      resultBody.appendChild(tr);
    }
  }

  function getConfig(){
    var orderRadio = document.querySelector('input[name="order"]:checked');
    return {
      name: document.getElementById("name").value,
      score: document.getElementById("score").value,
      criteria: document.getElementById("criteria").value,
      sortBy: document.getElementById("sortBy").value,
      order: orderRadio ? orderRadio.value : "desc",
      limit: document.getElementById("limit").value
    };
  }

  function setConfig(cfg){
    if (!cfg) return;
    document.getElementById("name").value = cfg.name || "";
    document.getElementById("score").value = cfg.score || "0";
    document.getElementById("criteria").value = cfg.criteria || "";
    document.getElementById("sortBy").value = cfg.sortBy || "value";
    document.getElementById("limit").value = cfg.limit || "0";

    var val = cfg.order || "desc";
    var radio = document.querySelector('input[name="order"][value="' + val + '"]');
    if (radio) radio.checked = true;
  }

  function saveScreener(){
    var cfg = getConfig();
    try{
      localStorage.setItem(screenerStorageKey, JSON.stringify(cfg));
      statusEl.textContent = "Screener saved (localStorage).";
    }catch(e){
      statusEl.textContent = "Gagal menyimpan ke localStorage.";
    }
  }

  function loadScreener(){
    try{
      var raw = localStorage.getItem(screenerStorageKey);
      if (!raw){
        statusEl.textContent = "Belum ada screener tersimpan.";
        return;
      }
      setConfig(JSON.parse(raw));
      statusEl.textContent = "Loaded last saved screener.";
    }catch(e){
      statusEl.textContent = "Gagal load screener dari localStorage.";
    }
  }

  /* ========== MAIN SCREENER RUN ========== */

  async function runScreener(){
    if (isRunning) return;

    var cfg = getConfig();
    var criteriaText = (cfg.criteria || "").trim();

    if (!criteriaText){
      statusEl.textContent = "Isi dulu Criteria.";
      return;
    }

    statusEl.textContent = "Running screener…";
    isRunning = true;
    var t0 = performance.now();

    var evaluator;
    try{
      evaluator = buildEvaluator(criteriaText);
    }catch(e){
      console.error(e);
      statusEl.textContent = "Syntax error di Criteria (expression JS).";
      isRunning = false;
      return;
    }

    var results = [];
    var symbols = UNIVERSE.slice();
    var batchSize = 25;

    for (var i = 0; i < symbols.length; i += batchSize){
      var batch = symbols.slice(i, i + batchSize);

      await Promise.all(batch.map(async function(sym){
        try{
          var bars = await fetchBars(sym);
          if (!bars || bars.length < 5) return;
          var last = bars[bars.length - 1];

          var ok = evaluator(
            bars,
            last,
            baseSma,
            baseRoc,
            baseHhv,
            baseRsi,
            baseMacd
          );

          if (ok){
            var price = last.c;
            var volume = last.v;
            var value = price * volume;
            results.push({symbol:sym, price:price, volume:volume, value:value});
          }
        }catch(err){
          console.warn("Error symbol", sym, err);
        }
      }));
    }

    var dir = cfg.order === "asc" ? 1 : -1;
    results.sort(function(a,b){
      if (cfg.sortBy === "symbol"){
        return a.symbol.localeCompare(b.symbol) * dir;
      }
      return (a[cfg.sortBy] - b[cfg.sortBy]) * dir;
    });

    var limit = Number(cfg.limit || 0);
    var finalRows = limit > 0 ? results.slice(0, limit) : results;

    renderResults(finalRows);
    var t1 = performance.now();
    resultCountEl.textContent = String(finalRows.length);
    runtimeTag.textContent = "runtime: " + Math.round(t1 - t0) + " ms";
    statusEl.textContent = "Done.";
    isRunning = false;
  }

  /* ========== UI BUTTONS ========== */

  document.getElementById("btnTest").addEventListener("click", function(){
    runScreener().catch(function(e){
      console.error(e);
      statusEl.textContent = "Error saat menjalankan screener.";
      isRunning = false;
    });
  });

  document.getElementById("btnSaveTop").addEventListener("click", saveScreener);

  document.getElementById("btnTemplate").addEventListener("click", function(){
    var txt = [
      "// Volume breakout + momentum",
      'volume > sma("volume", 20) * 5 &&',
      'roc("close", 1) > 0 &&',
      "price > 60",
      "",
      "// Contoh lain (hapus komentar kalau mau dipakai):",
      "// const m = macd(\"close\", 12, 26, 9);",
      "// m.macd > m.signal &&",
      "// rsi(\"close\", 14) > 40"
    ].join("\n");
    document.getElementById("criteria").value = txt;
    statusEl.textContent = "Template criteria dimuat.";
  });

  document.getElementById("btnHelp").addEventListener("click", function(){
    alert(
"Variables:\n" +
"  price, volume, value\n" +
"  prevPrice, prevVolume, prevValue\n\n" +
"Functions:\n" +
"  sma(field, length)   // field: \"close\" | \"volume\"\n" +
"  roc(field, length)\n" +
"  hhv(field, length)\n" +
"  rsi(field, length)\n" +
"  macd(field, fast, slow, signal) -> {macd, signal, hist}\n\n" +
"Example:\n" +
"  volume > sma(\"volume\", 20) * 5 &&\n" +
"  roc(\"close\", 1) > 0 &&\n" +
"  price > 60"
    );
  });

  // auto load last screener kalau ada
  loadScreener();
</script>
</body>
</html>