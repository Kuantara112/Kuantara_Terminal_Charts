<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Kuantara Terminal v2.0</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600;700&display=swap"/>

  <style>
    :root {
      --amber: #ffbf00; 
      --amber-dim: rgba(255, 191, 0, 0.6);
      --amber-glow: rgba(255, 191, 0, 0.25);
      
      --bg-root: #000000; 
      
      /* Modern Glass Colors */
      --glass-base: rgba(12, 12, 12, 0.85);
      --glass-border: rgba(255, 255, 255, 0.08);
      --glass-highlight: rgba(255, 255, 255, 0.12);
      
      --text-main: #f0f0f0; 
      --text-muted: #888888; 
      
      --ease-out: cubic-bezier(0.2, 0.8, 0.2, 1);
      --shadow-high: 0 10px 40px -10px rgba(0,0,0,1);
    }

    /* GLOBAL RESET */
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: "Fira Code", monospace !important; -webkit-tap-highlight-color: transparent; }
    ::-webkit-scrollbar { width: 4px; height: 4px; }
    ::-webkit-scrollbar-track { background: #000; }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }
    
    body { background-color: var(--bg-root); color: var(--text-main); height: 100vh; overflow: hidden; }
    button { outline: none; border: none; background: none; cursor: pointer; color: inherit; }

    /* LAYOUT LAYERS */
    .kt-iframe-layer {
      position: absolute; inset: 0; z-index: 1; background: #050505;
      transition: filter 0.3s ease;
    }
    .kt-iframe-layer iframe { width: 100%; height: 100%; border: 0; display: block; }
    
    /* Vignette effect */
    .kt-iframe-layer::after {
      content:""; position:absolute; inset:0; pointer-events:none;
      box-shadow: inset 0 0 100px rgba(0,0,0,0.8);
    }

    /* LOADING SPINNER */
    .kt-loading {
      position: absolute; inset: 0; z-index: 2; background: #000;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      transition: opacity 0.4s ease; pointer-events: none;
    }
    .kt-loading.done { opacity: 0; }
    .kt-spinner {
      width: 40px; height: 40px; border: 2px solid rgba(255,191,0,0.1);
      border-top-color: var(--amber); border-radius: 50%;
      animation: spin 1s infinite linear;
      box-shadow: 0 0 15px var(--amber-glow);
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* === HEADER (Floating Island) === */
    .kt-header {
      position: fixed; top: 12px; left: 50%; transform: translateX(-50%);
      display: flex; align-items: center; gap: 16px;
      padding: 8px 16px; border-radius: 99px;
      background: rgba(15, 15, 15, 0.7);
      backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      border: 1px solid var(--glass-border);
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      z-index: 100; transition: all 0.3s ease;
    }
    .kt-header:hover { background: rgba(20, 20, 20, 0.9); border-color: var(--amber-dim); }

    .kt-logo {
      font-weight: 700; font-size: 12px; color: var(--amber); letter-spacing: 0.05em;
      text-shadow: 0 0 10px var(--amber-glow);
    }
    .kt-clocks { display: flex; gap: 12px; align-items: center; }
    .kt-clock-item { display: flex; flex-direction: column; align-items: center; line-height: 1; gap: 2px; opacity: 0.6; transition: opacity 0.3s; }
    .kt-clock-item.active { opacity: 1; }
    .kt-clock-label { font-size: 8px; color: var(--amber); font-weight: 600; }
    .kt-clock-time { font-size: 10px; font-weight: 500; }

    /* === DOCK SYSTEM (Bottom Left) === */
    .kt-dock-container {
      position: fixed; bottom: 20px; left: 20px;
      display: flex; align-items: center; gap: 12px;
      z-index: 2000;
    }

    /* FAB (Main Trigger) */
    .kt-fab {
      width: 48px; height: 48px; border-radius: 14px;
      background: linear-gradient(135deg, #ffbf00, #cc9900);
      color: #000; display: flex; align-items: center; justify-content: center;
      font-size: 20px; font-weight: 700; cursor: pointer;
      box-shadow: 0 8px 20px rgba(255, 191, 0, 0.3);
      border: 1px solid rgba(255,255,255,0.3);
      transition: transform 0.3s var(--ease-out), box-shadow 0.3s;
      z-index: 2002;
    }
    .kt-fab:hover { transform: scale(1.05); box-shadow: 0 10px 30px rgba(255, 191, 0, 0.5); }
    .kt-fab:active { transform: scale(0.95); }
    .kt-fab span { transition: transform 0.3s; }
    .kt-fab.active span { transform: rotate(45deg); }

    /* NAVIGATION BAR (Slides Right) */
    .kt-nav-bar {
      height: 44px; padding: 0 6px;
      background: var(--glass-base);
      backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      display: flex; align-items: center; gap: 4px;
      
      /* Animation State */
      opacity: 0; transform: translateX(-20px) scale(0.9); pointer-events: none;
      transition: all 0.3s var(--ease-out);
      z-index: 2001;
    }
    .kt-dock-container.expanded .kt-nav-bar {
      opacity: 1; transform: translateX(0) scale(1); pointer-events: auto;
    }

    .kt-nav-btn {
      padding: 6px 14px; border-radius: 8px; font-size: 11px;
      color: var(--text-muted); transition: all 0.2s;
      display: flex; align-items: center; gap: 6px; position: relative;
    }
    .kt-nav-btn:hover { background: rgba(255,255,255,0.05); color: var(--text-main); }
    .kt-nav-btn.active { background: rgba(255,191,0,0.15); color: var(--amber); font-weight: 600; }
    .kt-nav-btn.active::after {
      content: ''; position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%);
      width: 4px; height: 4px; background: var(--amber); border-radius: 50%; box-shadow: 0 0 5px var(--amber);
    }

    /* QUICK TOOLS (Slides Up) */
    .kt-tools-stack {
      position: absolute; bottom: 60px; left: 0; width: 48px;
      display: flex; flex-direction: column-reverse; gap: 8px;
      pointer-events: none; z-index: 2001;
    }
    .kt-tool-btn {
      width: 40px; height: 40px; margin: 0 auto;
      border-radius: 10px; background: rgba(20,20,20,0.9);
      border: 1px solid var(--glass-border);
      color: var(--text-muted); font-size: 14px; display: flex; align-items: center; justify-content: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.5);
      
      opacity: 0; transform: translateY(20px) scale(0.8);
      transition: all 0.3s var(--ease-out);
    }
    .kt-tool-btn:hover { border-color: var(--amber); color: var(--amber); transform: scale(1.1); }
    
    .kt-dock-container.expanded .kt-tools-stack .kt-tool-btn {
      opacity: 1; transform: translateY(0) scale(1); pointer-events: auto;
    }
    /* Stagger delay for effect */
    .kt-dock-container.expanded .kt-tools-stack .kt-tool-btn:nth-child(1) { transition-delay: 0.05s; }
    .kt-dock-container.expanded .kt-tools-stack .kt-tool-btn:nth-child(2) { transition-delay: 0.1s; }
    .kt-dock-container.expanded .kt-tools-stack .kt-tool-btn:nth-child(3) { transition-delay: 0.15s; }
    .kt-dock-container.expanded .kt-tools-stack .kt-tool-btn:nth-child(4) { transition-delay: 0.2s; }

    /* === LAUNCHER (Home Menu) === */
    .kt-launcher {
      position: fixed; bottom: 80px; left: 20px;
      width: min(600px, 90vw); max-height: 70vh;
      background: rgba(10, 10, 10, 0.95);
      backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      padding: 20px;
      display: flex; flex-direction: column; gap: 16px;
      box-shadow: var(--shadow-high);
      
      opacity: 0; transform: translateY(20px) scale(0.95); pointer-events: none;
      transition: all 0.3s var(--ease-out);
      z-index: 2500;
    }
    .kt-launcher.open { opacity: 1; transform: translateY(0) scale(1); pointer-events: auto; }

    .kt-launcher-header {
      font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.1em;
      border-bottom: 1px solid var(--glass-border); padding-bottom: 8px; margin-bottom: 4px;
    }
    
    .kt-menu-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px;
    }
    .kt-menu-card {
      background: rgba(255,255,255,0.03); border: 1px solid transparent;
      padding: 12px; border-radius: 8px; cursor: pointer;
      display: flex; flex-direction: column; gap: 6px;
      transition: all 0.2s;
    }
    .kt-menu-card:hover, .kt-menu-card.active {
      background: rgba(255,191,0,0.1); border-color: var(--amber-dim);
    }
    .kt-menu-num { font-size: 10px; color: var(--amber); opacity: 0.7; }
    .kt-menu-title { font-size: 11px; font-weight: 500; color: var(--text-main); }

    .kt-submenu-area {
      background: rgba(0,0,0,0.3); border-radius: 8px; padding: 12px;
      display: none; flex-wrap: wrap; gap: 8px;
      border-top: 1px solid var(--glass-border);
    }
    .kt-submenu-area.active { display: flex; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }

    .kt-sub-pill {
      padding: 6px 12px; font-size: 10px; border-radius: 99px;
      background: rgba(40,40,40,0.6); border: 1px solid var(--glass-border);
      color: var(--text-muted); transition: all 0.2s;
    }
    .kt-sub-pill:hover { border-color: var(--text-muted); color: var(--text-main); transform: translateY(-1px); }
    .kt-sub-pill.active { background: var(--amber); color: #000; border-color: var(--amber); box-shadow: 0 2px 8px var(--amber-glow); font-weight: 600; }

    /* === OTHER PANELS (Workspace, Profile, AI) === */
    .kt-panel-fs {
      position: fixed; inset: 0; background: #080808; z-index: 1500; display: none; padding-top: 60px;
    }
    .kt-panel-fs.active { display: block; animation: zoomIn 0.2s ease; }
    @keyframes zoomIn { from{transform:scale(0.98); opacity:0;} to{transform:scale(1); opacity:1;} }

    /* Helper styling similar to original for consistency */
    .kt-profile-inner, .kt-workspace-inner { padding: 20px; max-width: 800px; margin: 0 auto; color: var(--text-muted); font-size: 12px; }
    h2 { color: var(--amber); margin-bottom: 20px; font-size: 16px; border-bottom: 1px solid #333; padding-bottom: 10px; }
    .kt-info-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #222; }

    /* AI FLOAT PANEL */
    .kt-ai-panel {
      position: fixed; left: 80px; bottom: 80px; width: 340px; height: 400px;
      background: rgba(15,15,15,0.95); border: 1px solid var(--glass-border); border-radius: 12px;
      box-shadow: var(--shadow-high); z-index: 2600;
      display: none; flex-direction: column; overflow: hidden;
    }
    .kt-ai-panel.active { display: flex; animation: slideUp 0.3s var(--ease-out); }
    @keyframes slideUp { from{transform:translateY(20px);opacity:0;} to{transform:translateY(0);opacity:1;} }
    .kt-ai-header { padding: 10px 14px; background: #1a1a1a; border-bottom: 1px solid #333; display: flex; justify-content: space-between; font-size: 11px; color: var(--amber); }
    .kt-ai-body { flex: 1; background: #000; }
    .kt-ai-close { cursor: pointer; color: #666; } .kt-ai-close:hover { color: #fff; }

    /* BREADCRUMB (Overlay on View) */
    .kt-breadcrumbs {
      position: fixed; top: 60px; left: 20px; 
      font-size: 10px; color: var(--text-muted); z-index: 50;
      background: rgba(0,0,0,0.6); padding: 4px 10px; border-radius: 4px;
      border: 1px solid rgba(255,255,255,0.05);
      backdrop-filter: blur(4px);
      pointer-events: none; opacity: 0.7;
    }

    /* SEARCH OVERLAY */
    .kt-search-ovl {
      position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
      z-index: 3000; display: none; align-items: center; justify-content: center;
    }
    .kt-search-box {
      width: min(500px, 90vw); background: #111; border: 1px solid #333; border-radius: 12px;
      padding: 16px; box-shadow: 0 20px 50px rgba(0,0,0,1);
    }
    .kt-search-input {
      width: 100%; background: #000; border: 1px solid #333; color: #fff;
      padding: 12px; border-radius: 6px; outline: none; font-size: 14px;
    }
    .kt-search-input:focus { border-color: var(--amber); }

    /* RESPONSIVE */
    @media (max-width: 600px) {
      .kt-header { width: 90%; justify-content: space-between; top: 8px; }
      .kt-clocks { gap: 8px; }
      .kt-clock-item:nth-child(n+3) { display: none; } /* Show only 2 clocks on tiny screens */
      
      .kt-launcher { bottom: 80px; left: 10px; right: 10px; width: auto; max-height: 60vh; overflow-y: auto; }
      .kt-dock-container { bottom: 16px; left: 16px; right: 16px; }
      .kt-nav-bar { flex: 1; justify-content: space-around; }
      .kt-ai-panel { left: 10px; right: 10px; width: auto; bottom: 80px; }
    }
  </style>
</head>
<body>

  <div class="kt-iframe-layer" id="kt-iframe-layer"></div>
  <div class="kt-loading" id="kt-loading"><div class="kt-spinner"></div></div>

  <header class="kt-header">
    <div class="kt-logo">KUANTARA v2</div>
    <div class="kt-clocks">
      <div class="kt-clock-item" data-tz="Australia/Sydney" data-label="SYD">
        <span class="kt-clock-label">SYD</span><span class="kt-clock-time">--:--</span>
      </div>
      <div class="kt-clock-item" data-tz="Asia/Tokyo" data-label="TYO">
        <span class="kt-clock-label">TYO</span><span class="kt-clock-time">--:--</span>
      </div>
      <div class="kt-clock-item" data-tz="Europe/London" data-label="LDN">
        <span class="kt-clock-label">LDN</span><span class="kt-clock-time">--:--</span>
      </div>
      <div class="kt-clock-item" data-tz="America/New_York" data-label="NYC">
        <span class="kt-clock-label">NYC</span><span class="kt-clock-time">--:--</span>
      </div>
    </div>
  </header>

  <div class="kt-breadcrumbs" id="kt-breadcrumbs">0 ¬∑ Markets / Overview</div>

  <div class="kt-launcher" id="kt-launcher">
    <div class="kt-launcher-header">Select Module</div>
    <div class="kt-menu-grid" id="kt-menu-grid">
      </div>
    <div class="kt-launcher-header" style="margin-top:12px;">Sub Navigation</div>
    <div class="kt-submenu-area" id="kt-submenu-area">
      <span style="font-size:10px; color:#555;">Select a module above...</span>
    </div>
  </div>

  <div class="kt-panel-fs" id="kt-page-workspace">
    <div class="kt-workspace-inner">
      <h2>Workspace</h2>
      <p>Drag and drop windows will appear here.</p>
      <button style="padding:8px 16px; background:#222; border-radius:4px; margin-top:10px;" id="kt-ws-close">Back to View</button>
    </div>
  </div>

  <div class="kt-panel-fs" id="kt-page-profile">
    <div class="kt-profile-inner">
      <h2>User Profile</h2>
      <div class="kt-info-row"><span>Account</span><span style="color:#fff">Guest User</span></div>
      <div class="kt-info-row"><span>Plan</span><span style="color:var(--amber)">Kuantara Pro</span></div>
      <div class="kt-info-row"><span>Status</span><span>Active</span></div>
      <button style="padding:8px 16px; background:var(--amber); color:#000; border-radius:4px; margin-top:20px; font-weight:600;" id="kt-profile-close">Close Profile</button>
    </div>
  </div>

  <div class="kt-ai-panel" id="kt-ai-panel">
    <div class="kt-ai-header">
      <span id="kt-ai-title">Utility</span>
      <span class="kt-ai-close" id="kt-ai-close">‚úï</span>
    </div>
    <div class="kt-ai-body" id="kt-ai-body">
      </div>
  </div>

  <div class="kt-search-ovl" id="kt-search-ovl">
    <div class="kt-search-box">
      <input type="text" class="kt-search-input" placeholder="Search markets, data, or news... (Esc to close)">
    </div>
  </div>

  <div class="kt-dock-container" id="kt-dock">
    
    <div class="kt-tools-stack">
      <button class="kt-tool-btn" data-tool="search" title="Search">üîç</button>
      <button class="kt-tool-btn" data-tool="ai" title="AI Assistant">ü§ñ</button>
      <button class="kt-tool-btn" data-tool="mini" title="Mini Chart">üìâ</button>
      <button class="kt-tool-btn" data-tool="notes" title="Notes">üìù</button>
    </div>

    <button class="kt-fab" id="kt-fab">
      <span>+</span>
    </button>

    <div class="kt-nav-bar">
      <button class="kt-nav-btn active" data-nav="home">
        <span>Home</span>
      </button>
      <button class="kt-nav-btn" data-nav="workspace">
        <span>Workspace</span>
      </button>
      <button class="kt-nav-btn" data-nav="profile">
        <span>Profile</span>
      </button>
    </div>
  </div>

<script>
  /* === DATA DEFINITIONS === */
  const MENU_DATA = [
    { id:0, label:"Markets", subs:["Overview","Forex","Fixed","Commodities","Equities","Crypto"] },
    { id:1, label:"News", subs:["24/7","Insights","Calendar","Global","Channel","Indonesia"] },
    { id:2, label:"Macro", subs:["Central Bank","G10+","All Countries"] },
    { id:3, label:"Geo-Econ", subs:["Geo Risk","Trade & Shipping","Resources"] },
    { id:4, label:"Metrics", subs:["Macro","Liquidity","Sentiment","Seasonality","COT","Curve","Breadth","Flows","Volatility"] },
    { id:5, label:"Companies", subs:["S&P500","LQ45","Blockchain"] },
    { id:6, label:"Charts", subs:["Technical","Fundamental","Economy","Real-Time"] },
    { id:7, label:"Screener", subs:["Stocks","Crypto","Custom"] },
    { id:8, label:"Research", subs:["Institutions","Quantitative","Reports"] },
    { id:9, label:"Tools", subs:["Journal","Calculator","Education","Others"] }
  ];

  const IFRAME_MAP = {
    // Basic mapping example (expand based on your original URLs)
    "0:0": "https://kuantara112.github.io/Kuantara_Terminal_Charts/overview_markets.html",
    "0:1": "https://kuantara112.github.io/Kuantara_Terminal_Charts/markets_forex.html",
    "6:3": "https://kuantara112.github.io/Kuantara_Terminal_Charts/charts_realtime.html",
    "1:0": "https://kuantara112.github.io/Kuantara_Terminal_Charts/news_feeds_247.html",
    // Fallback for demo
    "default": "https://kuantara112.github.io/Kuantara_Terminal_Charts/overview_markets.html"
  };

  /* === STATE === */
  let isDockExpanded = false;
  let activeMenuId = 0;
  let activeSubId = 0;

  /* === ELEMENTS === */
  const el = {
    dock: document.getElementById('kt-dock'),
    fab: document.getElementById('kt-fab'),
    launcher: document.getElementById('kt-launcher'),
    menuGrid: document.getElementById('kt-menu-grid'),
    subMenuArea: document.getElementById('kt-submenu-area'),
    iframeLayer: document.getElementById('kt-iframe-layer'),
    loading: document.getElementById('kt-loading'),
    breadcrumbs: document.getElementById('kt-breadcrumbs'),
    navBtns: document.querySelectorAll('.kt-nav-btn'),
    toolBtns: document.querySelectorAll('.kt-tool-btn'),
    aiPanel: document.getElementById('kt-ai-panel'),
    aiBody: document.getElementById('kt-ai-body'),
    aiTitle: document.getElementById('kt-ai-title'),
    searchOvl: document.getElementById('kt-search-ovl')
  };

  /* === INITIALIZATION === */
  function init() {
    renderLauncher();
    startClock();
    loadView(0, 0); // Default view
    
    // FAB Click
    el.fab.addEventListener('click', toggleDock);

    // Nav Click (Home, Workspace, Profile)
    el.navBtns.forEach(btn => {
      btn.addEventListener('click', (e) => handleNav(e.currentTarget));
    });

    // Tool Click
    el.toolBtns.forEach(btn => {
      btn.addEventListener('click', (e) => handleTool(e.currentTarget.dataset.tool));
    });

    // Close overlays when clicking outside
    document.addEventListener('click', (e) => {
      if (!el.dock.contains(e.target) && !el.launcher.contains(e.target)) {
        if(el.launcher.classList.contains('open')) toggleLauncher(false);
      }
      if (!el.dock.contains(e.target)) {
        if(isDockExpanded) toggleDock();
      }
    });

    // Close AI Panel
    document.getElementById('kt-ai-close').addEventListener('click', () => {
      el.aiPanel.classList.remove('active');
      el.aiBody.innerHTML = '';
    });
    
    // Close Search
    el.searchOvl.addEventListener('click', (e) => {
      if(e.target === el.searchOvl) el.searchOvl.style.display = 'none';
    });

    // Page Closers
    document.getElementById('kt-profile-close').addEventListener('click', ()=>document.getElementById('kt-page-profile').classList.remove('active'));
    document.getElementById('kt-ws-close').addEventListener('click', ()=>document.getElementById('kt-page-workspace').classList.remove('active'));
  }

  /* === CORE LOGIC === */

  function toggleDock() {
    isDockExpanded = !isDockExpanded;
    el.dock.classList.toggle('expanded', isDockExpanded);
    el.fab.classList.toggle('active', isDockExpanded);
    
    // Auto open launcher if expanding dock? No, let user click Home.
  }

  function handleNav(btn) {
    // Visual Active State
    el.navBtns.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    const target = btn.dataset.nav;

    if (target === 'home') {
      // Toggle Launcher Menu
      const isOpen = el.launcher.classList.contains('open');
      toggleLauncher(!isOpen);
      // Close other fullpages
      document.getElementById('kt-page-profile').classList.remove('active');
      document.getElementById('kt-page-workspace').classList.remove('active');
    } 
    else if (target === 'workspace') {
      toggleLauncher(false);
      document.getElementById('kt-page-workspace').classList.add('active');
      document.getElementById('kt-page-profile').classList.remove('active');
    }
    else if (target === 'profile') {
      toggleLauncher(false);
      document.getElementById('kt-page-profile').classList.add('active');
      document.getElementById('kt-page-workspace').classList.remove('active');
    }
  }

  function toggleLauncher(show) {
    if(show) {
      el.launcher.classList.add('open');
      renderSubMenu(activeMenuId); // Show last active subs
    } else {
      el.launcher.classList.remove('open');
    }
  }

  function renderLauncher() {
    el.menuGrid.innerHTML = '';
    MENU_DATA.forEach(menu => {
      const card = document.createElement('div');
      card.className = `kt-menu-card ${menu.id === activeMenuId ? 'active' : ''}`;
      card.innerHTML = `<span class="kt-menu-num">${menu.id}</span><span class="kt-menu-title">${menu.label}</span>`;
      card.onclick = (e) => {
        e.stopPropagation();
        activeMenuId = menu.id;
        document.querySelectorAll('.kt-menu-card').forEach(c => c.classList.remove('active'));
        card.classList.add('active');
        renderSubMenu(menu.id);
      };
      el.menuGrid.appendChild(card);
    });
  }

  function renderSubMenu(menuId) {
    const data = MENU_DATA.find(m => m.id === menuId);
    el.subMenuArea.innerHTML = '';
    el.subMenuArea.classList.add('active');
    
    if(data) {
      data.subs.forEach((sub, idx) => {
        const btn = document.createElement('button');
        btn.className = `kt-sub-pill ${(menuId === activeMenuId && idx === activeSubId) ? 'active' : ''}`;
        btn.textContent = sub;
        btn.onclick = () => {
          activeSubId = idx;
          loadView(menuId, idx);
          toggleLauncher(false); // Close menu on selection
        };
        el.subMenuArea.appendChild(btn);
      });
    }
  }

  function loadView(menuId, subId) {
    // Show Loading
    el.loading.classList.remove('done');
    
    const key = `${menuId}:${subId}`;
    let url = IFRAME_MAP[key];
    
    // Construct default URL logic if not in map (for fallback)
    if (!url) {
        // Fallback logic from original code or default
        const menuObj = MENU_DATA.find(m=>m.id===menuId);
        if(menuObj && menuObj.subs[subId]){
            // Just loading default for demo if link missing
            url = IFRAME_MAP["default"]; 
        }
    }

    // Update Breadcrumbs
    const mLabel = MENU_DATA.find(m=>m.id===menuId)?.label;
    const sLabel = MENU_DATA.find(m=>m.id===menuId)?.subs[subId];
    el.breadcrumbs.textContent = `${menuId} ¬∑ ${mLabel} / ${sLabel}`;

    // Inject Iframe
    el.iframeLayer.innerHTML = '';
    const iframe = document.createElement('iframe');
    iframe.src = url;
    iframe.onload = () => {
      setTimeout(() => el.loading.classList.add('done'), 500);
    };
    el.iframeLayer.appendChild(iframe);
  }

  function handleTool(tool) {
    if(tool === 'search') {
      el.searchOvl.style.display = 'flex';
      el.searchOvl.querySelector('input').focus();
    } else {
      el.aiPanel.classList.add('active');
      let src = "";
      let title = "";
      
      if(tool === 'ai') { title = "Kuantara AI"; src = "https://kuantara112.github.io/Kuantara_Terminal_Charts/kuantara_ai.html"; }
      if(tool === 'mini') { title = "Mini Chart (XAUUSD)"; src = "https://kuantara112.github.io/Kuantara_Terminal_Charts/xauusd_tradingview.html"; }
      if(tool === 'notes') { title = "Notes"; src = ""; /* Implement custom note logic here */ }

      el.aiTitle.textContent = title;
      el.aiBody.innerHTML = `<iframe src="${src}" style="width:100%;height:100%;border:0;"></iframe>`;
      
      // Close dock after tool selection for cleaner view
      toggleDock(); 
    }
  }

  /* === CLOCK UTILS === */
  function startClock() {
    const update = () => {
      const now = new Date();
      document.querySelectorAll('.kt-clock-item').forEach(item => {
        const tz = item.dataset.tz;
        const timeStr = new Intl.DateTimeFormat('en-GB', {
          hour: '2-digit', minute: '2-digit', timeZone: tz
        }).format(now);
        item.querySelector('.kt-clock-time').textContent = timeStr;
        
        // Highlight logic (Market Open 8-17)
        const parts = new Intl.DateTimeFormat('en-GB', {
          hour:'numeric', hour12:false, timeZone:tz
        }).format(now);
        const h = parseInt(parts);
        if(h >= 8 && h < 17) item.classList.add('active');
        else item.classList.remove('active');
      });
    };
    update();
    setInterval(update, 1000);
  }

  init();
</script>
</body>
</html>