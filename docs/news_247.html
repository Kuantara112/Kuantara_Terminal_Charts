<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Kuantara â€“ Latest 24/7 & Catalyst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Fira Code -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;700&display=swap"/>

  <style>
    :root {
      --bg-root:#000000;
      --bg-main:#111111;
      --border-soft:#2b2b2b;
      --text-main:#f5f5f5;
      --text-muted:#9b9b9b;
      --accent:#ffbf00;

      --fs-title:14px;
      --fs-subtitle:12px;
      --fs-body:11px;
      --fs-small:9.5px;
    }

    * {
      box-sizing:border-box;
      margin:0;
      padding:0;
      font-family:"Fira Code",monospace !important;
      scrollbar-width:thin;
      scrollbar-color:#00000088 #000000;
    }

    *::-webkit-scrollbar {
      width:6px;
      height:6px;
    }
    *::-webkit-scrollbar-track {
      background:#000000;
    }
    *::-webkit-scrollbar-thumb {
      background:#00000088;
      border-radius:3px;
    }

    html,body {
      height:100%;
    }

    body {
      background:var(--bg-root);
      color:var(--text-main);
      overflow:hidden;
    }

    .kt-shell {
      padding:16px;
      height:100vh;
      display:flex;
      flex-direction:column;
      gap:12px;
      background:var(--bg-root);
    }

    .kt-title {
      font-size:var(--fs-title);
      letter-spacing:0.16em;
      text-transform:uppercase;
      color:var(--text-main);
    }

    .kt-sub {
      font-size:var(--fs-small);
      color:var(--text-muted);
      margin-top:4px;
    }

    .kt-card {
      background:var(--bg-main);
      border:1px solid var(--border-soft);
      border-radius:4px;
      padding:14px 16px;
    }

    .kt-row {
      display:flex;
      flex-direction:row;
      align-items:flex-start;
      gap:12px;
      height:calc(100vh - 56px);
    }

    .kt-col {
      flex:1;
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    @media (max-width:768px) {
      body {
        overflow:auto;
      }
      .kt-row {
        flex-direction:column;
        height:auto;
      }
    }

    .card-header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-bottom:10px;
    }

    .card-header-left {
      display:flex;
      flex-direction:column;
      gap:2px;
    }

    .card-label {
      font-size:var(--fs-subtitle);
      text-transform:uppercase;
      letter-spacing:0.18em;
      color:var(--accent);
    }

    .card-meta {
      font-size:var(--fs-small);
      color:var(--text-muted);
    }

    .card-header-right {
      font-size:var(--fs-small);
      color:var(--text-muted);
      display:flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
    }

    .dot-live {
      width:7px;
      height:7px;
      border-radius:999px;
      background:var(--accent);
      box-shadow:0 0 12px var(--accent);
      animation:pulse 1.4s ease-out infinite;
    }

    @keyframes pulse {
      0% { transform:scale(1); opacity:1; }
      60% { transform:scale(1.8); opacity:0; }
      100% { transform:scale(1.8); opacity:0; }
    }

    .tab-bar {
      display:flex;
      align-items:center;
      gap:6px;
      margin-bottom:10px;
      flex-wrap:wrap;
    }

    .tab-btn {
      border-radius:999px;
      padding:4px 10px;
      font-size:var(--fs-small);
      text-transform:uppercase;
      letter-spacing:0.14em;
      border:1px solid var(--border-soft);
      background:#000;
      color:var(--text-muted);
      cursor:pointer;
      transition:background .15s ease, color .15s ease, border-color .15s ease;
    }

    .tab-btn.active {
      background:var(--accent);
      color:#000;
      border-color:var(--accent);
    }

    .panel {
      display:none;
      flex:1;
      min-height:0;
      flex-direction:column;
      gap:10px;
    }

    .panel.active {
      display:flex;
    }

    .filter-row {
      display:flex;
      flex-direction:row;
      gap:8px;
      align-items:flex-start;
      flex-wrap:wrap;
    }

    .filter-group {
      flex:1 1 220px;
      min-width:0;
    }

    .filter-label {
      font-size:var(--fs-small);
      color:var(--text-muted);
      margin-bottom:3px;
    }

    select.category-select {
      width:100%;
      background:#000;
      color:var(--text-main);
      border:1px solid var(--border-soft);
      padding:5px 8px;
      font-size:var(--fs-small);
      text-transform:uppercase;
      letter-spacing:0.12em;
    }

    .btn-recap {
      flex:0 0 auto;
      white-space:nowrap;
      border-radius:3px;
      border:1px solid var(--accent);
      background:#000;
      color:var(--accent);
      padding:6px 10px;
      font-size:var(--fs-small);
      text-transform:uppercase;
      letter-spacing:0.12em;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }

    .btn-recap span.icon {
      font-size:11px;
    }

    .status-row {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      font-size:var(--fs-small);
      color:var(--text-muted);
      margin-top:4px;
    }

    .status-left {
      display:flex;
      align-items:center;
      gap:6px;
    }

    .status-dot {
      width:6px;
      height:6px;
      border-radius:999px;
      background:#555;
    }

    .feed-container {
      margin-top:8px;
      border-radius:4px;
      border:1px solid var(--border-soft);
      background:#080808;
      padding:8px;
      flex:1;
      min-height:0;
      overflow:auto;
    }

    .feed-list {
      list-style:none;
      margin:0;
      padding:0;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .feed-card {
      border:1px solid var(--border-soft);
      border-radius:3px;
      padding:8px 9px;
      background:#111111;
      display:flex;
      flex-direction:column;
      gap:4px;
      font-size:var(--fs-body);
    }

    .feed-card.important {
      border-color:var(--accent);
      box-shadow:0 0 18px rgba(255,191,0,0.18);
    }

    .feed-header-row {
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:8px;
    }

    .feed-headline-wrap {
      display:flex;
      align-items:flex-start;
      gap:6px;
      flex:1;
      min-width:0;
    }

    .head-dot {
      width:6px;
      height:6px;
      border-radius:999px;
      background:var(--accent);
      box-shadow:0 0 10px rgba(255,191,0,0.6);
      margin-top:3px;
      flex-shrink:0;
    }

    .headline {
      font-size:var(--fs-body);
      color:var(--text-main);
    }

    .headline span.source {
      color:var(--text-muted);
      font-size:var(--fs-small);
    }

    .copy-btn {
      border:none;
      outline:none;
      cursor:pointer;
      padding:4px 6px;
      border-radius:3px;
      font-size:var(--fs-small);
      background:#000000;
      color:var(--text-muted);
      border:1px solid var(--border-soft);
      flex-shrink:0;
    }

    .copy-btn.copied {
      background:var(--accent);
      color:#000;
      border-color:var(--accent);
    }

    .feed-meta {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:6px;
      font-size:var(--fs-small);
      color:var(--text-muted);
    }

    .feed-time {
      font-size:var(--fs-small);
      color:var(--text-muted);
    }

    .feed-tags {
      display:flex;
      flex-wrap:wrap;
      gap:4px;
      margin-top:2px;
    }

    .chip {
      border-radius:999px;
      padding:2px 6px;
      border:1px solid var(--border-soft);
      font-size:var(--fs-small);
      color:var(--text-muted);
      background:#000000;
    }

    .impact-badge {
      font-size:var(--fs-small);
      padding:2px 6px;
      border-radius:999px;
      border:1px solid var(--border-soft);
      background:#000;
      color:var(--text-muted);
    }

    .impact-high {
      border-color:var(--accent);
      color:var(--accent);
    }

    .impact-medium {
      border-color:#f97316;
      color:#f97316;
    }

    .impact-row {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-top:6px;
    }

    .feed-body {
      font-size:var(--fs-body);
      color:var(--text-main);
      margin-top:2px;
    }

    .shimmer-line {
      position:relative;
      overflow:hidden;
      background:#1b1b1b;
      border-radius:3px;
    }

    .shimmer-line::after {
      content:"";
      position:absolute;
      inset:0;
      transform:translateX(-100%);
      background-image:linear-gradient(
        90deg,
        transparent,
        rgba(255,255,255,0.10),
        transparent
      );
      animation:shimmer 1.3s infinite;
    }

    @keyframes shimmer {
      0% { transform:translateX(-100%); }
      100% { transform:translateX(100%); }
    }

    .skeleton-title {
      height:11px;
      width:72%;
      margin-bottom:4px;
    }

    .skeleton-sub {
      height:9px;
      width:40%;
    }

    .skeleton-body {
      height:9px;
      width:100%;
      margin-top:2px;
    }

    .skeleton-tags {
      margin-top:4px;
      display:flex;
      gap:4px;
    }

    .skeleton-tag {
      height:9px;
      width:50px;
    }

    .modal-overlay {
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.78);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:40;
    }

    .modal-overlay.active {
      display:flex;
    }

    .modal-card {
      background:#111;
      border:1px solid var(--border-soft);
      border-radius:4px;
      padding:14px 16px;
      width:min(640px,100% - 32px);
      max-height:80vh;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .modal-header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-bottom:4px;
    }

    .modal-title {
      font-size:var(--fs-subtitle);
      text-transform:uppercase;
      letter-spacing:0.16em;
      color:var(--accent);
    }

    .modal-close {
      border:none;
      background:#000;
      color:var(--text-muted);
      border-radius:3px;
      padding:3px 7px;
      font-size:var(--fs-small);
      cursor:pointer;
    }

    .modal-body {
      font-size:var(--fs-body);
      color:var(--text-main);
      overflow:auto;
      padding-top:4px;
    }

    .modal-body p + p {
      margin-top:4px;
    }

    .modal-status {
      font-size:var(--fs-small);
      color:var(--text-muted);
    }
  </style>
</head>
<body>
  <div class="kt-shell">
    <header>
      <div class="kt-title">Latest 24/7 & Catalyst</div>
      <div class="kt-sub">Realtime headline feed & catalyst monitor Â· siap dihubungkan WebSocket/API Kuantara</div>
    </header>

    <main class="kt-row">
      <section class="kt-col">
        <article class="kt-card" id="latestCatalystCard">
          <div class="card-header">
            <div class="card-header-left">
              <div class="card-label">Global Macro Newswire</div>
              <div class="card-meta">FastBull Â· Catalyst Google Script Â· Kuantara AI Recap</div>
            </div>
            <div class="card-header-right">
              <div class="dot-live"></div>
              <span id="globalStatusText">Live 24/7 feed</span>
            </div>
          </div>

          <div class="tab-bar" id="tabBar">
            <button class="tab-btn active" data-target="latestPanel">Latest 24/7</button>
            <button class="tab-btn" data-target="catalystPanel">Catalyst</button>
          </div>

          <!-- LATEST 24/7 -->
          <div class="panel active" id="latestPanel">
            <div class="filter-row">
              <div class="filter-group">
                <div class="filter-label">Filter kategori</div>
                <select id="latestCategoryDropdown" class="category-select">
                  <option value="-1">Semua</option>
                  <option value="central_banks">Central Banks</option>
                  <option value="crypto">Cryptocurrencies</option>
                  <option value="equities">Equities</option>
                  <option value="macro">Macro & Data</option>
                  <option value="topics">Themes & Geopolitik</option>
                </select>
              </div>
              <button id="latestRecapBtn" class="btn-recap">
                <span class="icon">âš¡</span>
                <span>Recap Semua Catalyst by Kuantara AI</span>
              </button>
            </div>

            <div class="status-row">
              <div class="status-left">
                <div class="status-dot"></div>
                <span>HEADLINE 24/7</span>
              </div>
              <div id="latestStatus">Waiting feedâ€¦</div>
            </div>

            <div class="feed-container">
              <ul id="latestTicker" class="feed-list"></ul>
            </div>
          </div>

          <!-- CATALYST -->
          <div class="panel" id="catalystPanel">
            <div class="filter-row">
              <div class="filter-group">
                <div class="filter-label">Filter kategori catalyst</div>
                <select id="catalystCategoryDropdown" class="category-select">
                  <option value="all">Semua</option>
                </select>
              </div>
              <button id="catalystRecapBtn" class="btn-recap">
                <span class="icon">ðŸ§ </span>
                <span>Recap Catalyst Terpilih</span>
              </button>
            </div>

            <div class="status-row">
              <div class="status-left">
                <div class="status-dot"></div>
                <span>Catalyst Feed</span>
              </div>
              <div id="catalystStatus">Waiting feedâ€¦</div>
            </div>

            <div class="feed-container">
              <ul id="catalystList" class="feed-list"></ul>
            </div>
          </div>
        </article>
      </section>
    </main>
  </div>

  <!-- Modal Kuantara AI -->
  <div id="kuantaraModal" class="modal-overlay">
    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-title" id="kuantaraTitle">Kuantara AI Recap</div>
        <button class="modal-close" id="kuantaraClose">CLOSE</button>
      </div>
      <div class="modal-status" id="kuantaraStatus">Menyiapkan ringkasanâ€¦</div>
      <div class="modal-body" id="kuantaraBody">
        <p>Stub recap untuk demo. Hubungkan ke backend AI (OpenAI / HF / internal) untuk menghasilkan insight otomatis.</p>
      </div>
    </div>
  </div>

  <script>
    // ====== KONFIG REALTIME (ISI DENGAN ENDPOINT ASLI KAMU) ======
    var AUTO_REFRESH_INTERVAL = 15000; // 15 detik

    // endpoint FastBull (sesuai html source original)
    var FASTBULL_NEWS_ENDPOINT =
      "https://api.fastbull.com/fastbull-news-service/api/getNewsPageByTagIds";

    var FASTBULL_HEADERS = {
      Accept: "application/json",
      "client-type": "4",
      clientversion: "latest",
      langid: "13"
    };

    // endpoint Google Script catalyst (GANTI dengan URL penuh punyamu)
    var CATALYST_FEED_API =
      "https://script.google.com/macros/s/YOUR_GOOGLE_SCRIPT_ID/exec";

    // mapping kategori -> tagIds (disederhanakan)
    var LATEST_CATEGORY_TAGS = {
      "-1": "-1",
      "central_banks": "100,132,125,115,118,116,120,121,114,124,126",
      "crypto": "137,134,166,164,162,160,159,157,155",
      "equities": "142,133,143",
      "macro": "109,110,111,112,119,117,127,129,122",
      "topics": "108,177,176,140,135,136"
    };

    // ====== DOM ======
    var tabBar = document.getElementById("tabBar");
    var latestPanel = document.getElementById("latestPanel");
    var catalystPanel = document.getElementById("catalystPanel");

    var latestListEl = document.getElementById("latestTicker");
    var latestStatusEl = document.getElementById("latestStatus");
    var latestDropdownEl = document.getElementById("latestCategoryDropdown");
    var latestRecapBtn = document.getElementById("latestRecapBtn");

    var catalystListEl = document.getElementById("catalystList");
    var catalystStatusEl = document.getElementById("catalystStatus");
    var catalystDropdownEl = document.getElementById("catalystCategoryDropdown");
    var catalystRecapBtn = document.getElementById("catalystRecapBtn");

    var kuantaraModal = document.getElementById("kuantaraModal");
    var kuantaraClose = document.getElementById("kuantaraClose");
    var kuantaraTitle = document.getElementById("kuantaraTitle");
    var kuantaraStatus = document.getElementById("kuantaraStatus");
    var kuantaraBody = document.getElementById("kuantaraBody");

    // ====== STATE ======
    var latestCache = {};
    var latestFetchToken = 0;
    var latestCurrentTagIds = "-1";

    var catalystItems = [];
    var catalystFetched = false;
    var catalystLoading = false;
    var catalystSelected = "all";

    var autoRefreshTimer = null;
    var autoRefreshInProgress = false;

    var COPY_TEXT = "Copy";
    var COPIED_TEXT = "Copied";

    // ====== UTIL ======
    function clearList(el) {
      if (!el) return;
      while (el.firstChild) el.removeChild(el.firstChild);
    }

    function formatUTC(value) {
      if (!value) return "Unknown time";
      var timestamp = Number(value);
      if (isNaN(timestamp)) {
        var parsed = new Date(value);
        timestamp = parsed.getTime();
      }
      if (!timestamp) return "Unknown time";
      var date = new Date(timestamp);
      if (isNaN(date.getTime())) return "Unknown time";
      var iso = date.toISOString();
      return iso.slice(0, 16).replace("T", " ") + " UTC";
    }

    function copyTextToClipboard(text, button) {
      if (!text || !button) return;
      var original = button.textContent;

      function markCopied() {
        button.classList.add("copied");
        button.textContent = COPIED_TEXT;
        setTimeout(function() {
          button.classList.remove("copied");
          button.textContent = original;
        }, 1400);
      }

      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(markCopied).catch(fallbackCopy);
      } else {
        fallbackCopy();
      }

      function fallbackCopy() {
        var ta = document.createElement("textarea");
        ta.value = text;
        ta.style.position = "fixed";
        ta.style.opacity = "0";
        document.body.appendChild(ta);
        ta.select();
        try { document.execCommand("copy"); } catch (e) {}
        document.body.removeChild(ta);
        markCopied();
      }
    }

    // ====== LATEST 24/7 ======
    function setLatestStatus(text) {
      if (latestStatusEl) latestStatusEl.textContent = text;
    }

    function createLatestSkeletonCard() {
      var li = document.createElement("li");
      li.className = "feed-card";
      li.innerHTML =
        '<div class="skeleton-title shimmer-line"></div>' +
        '<div class="skeleton-sub shimmer-line"></div>' +
        '<div class="skeleton-body shimmer-line"></div>' +
        '<div class="skeleton-tags">' +
          '<div class="skeleton-tag shimmer-line"></div>' +
          '<div class="skeleton-tag shimmer-line"></div>' +
        '</div>';
      return li;
    }

    function renderLatestSkeleton() {
      if (!latestListEl) return;
      clearList(latestListEl);
      for (var i = 0; i < 3; i++) {
        latestListEl.appendChild(createLatestSkeletonCard());
      }
    }

    function normalizeFastbullItem(item) {
      if (!item) return null;
      var title = (item.newsTitle || "").trim();
      var tagsStr = typeof item.tags === "string" ? item.tags : "";
      var tagNames = [];
      if (tagsStr) {
        var parts = tagsStr.split(",");
        for (var i = 0; i < parts.length; i++) {
          var t = parts[i].trim();
          if (t) tagNames.push(t);
        }
      }
      return {
        id: item.newsId || item.path || title || String(item.releasedDate || Math.random()),
        title: title || "Untitled headline",
        tagNames: tagNames,
        timestamp: item.releasedDate || Date.now(),
        important: Number(item.important) === 1,
        source: item.simWebsiteName || item.simWebsite || "FastBull"
      };
    }

    function createLatestCardElement(item) {
      var li = document.createElement("li");
      li.className = "feed-card";
      if (item.important) li.classList.add("important");

      var headerRow = document.createElement("div");
      headerRow.className = "feed-header-row";

      var wrap = document.createElement("div");
      wrap.className = "feed-headline-wrap";

      if (item.important) {
        var dot = document.createElement("div");
        dot.className = "head-dot";
        wrap.appendChild(dot);
      }

      var box = document.createElement("div");
      var headline = document.createElement("div");
      headline.className = "headline";
      headline.textContent = item.title;

      var src = document.createElement("span");
      src.className = "source";
      src.textContent = " Â· " + (item.source || "FastBull");

      headline.appendChild(src);
      box.appendChild(headline);
      wrap.appendChild(box);

      var btn = document.createElement("button");
      btn.className = "copy-btn";
      btn.type = "button";
      btn.textContent = COPY_TEXT;
      btn.setAttribute("aria-label", "Salin headline");
      btn.addEventListener("click", function() {
        copyTextToClipboard(item.title, btn);
      });

      headerRow.appendChild(wrap);
      headerRow.appendChild(btn);

      var metaRow = document.createElement("div");
      metaRow.className = "feed-meta";

      var timeEl = document.createElement("span");
      timeEl.className = "feed-time";
      timeEl.textContent = formatUTC(item.timestamp);
      metaRow.appendChild(timeEl);

      var tagsRow = document.createElement("div");
      tagsRow.className = "feed-tags";
      var tags = item.tagNames && item.tagNames.length ? item.tagNames : ["News"];
      for (var i = 0; i < tags.length && i < 4; i++) {
        var chip = document.createElement("span");
        chip.className = "chip";
        chip.textContent = tags[i];
        tagsRow.appendChild(chip);
      }

      li.appendChild(headerRow);
      li.appendChild(metaRow);
      li.appendChild(tagsRow);
      return li;
    }

    function renderLatestFeed(items) {
      if (!latestListEl) return;
      clearList(latestListEl);

      if (!items || !items.length) {
        var li = document.createElement("li");
        li.className = "feed-card";
        li.innerHTML =
          '<div class="feed-body" style="color:var(--text-muted)">Belum ada headline untuk kategori ini.</div>';
        latestListEl.appendChild(li);
        return;
      }

      for (var i = 0; i < items.length; i++) {
        latestListEl.appendChild(createLatestCardElement(items[i]));
      }
    }

    function mapCategoryToTagIds(value) {
      if (!value) return "-1";
      if (LATEST_CATEGORY_TAGS.hasOwnProperty(value)) return LATEST_CATEGORY_TAGS[value];
      return "-1";
    }

    function buildFastbullUrl(tagIds) {
      var url = FASTBULL_NEWS_ENDPOINT;
      var u = url + "?checkImportant=0&pageSize=20&timestamp=&includeCalendar=0&tagIds=" +
        encodeURIComponent(tagIds || "-1");
      return u;
    }

    function fetchFastbullNews(tagIds, options) {
      options = options || {};
      var silent = options.silent === true;
      if (!latestListEl) return;

      var cache = latestCache[tagIds];
      if (!silent || !cache || !cache.items || !cache.items.length) {
        if (cache && cache.items && cache.items.length) {
          renderLatestFeed(cache.items);
          setLatestStatus("Cached feed");
        } else {
          renderLatestSkeleton();
          setLatestStatus("Loading feedâ€¦");
        }
      }

      var token = ++latestFetchToken;
      fetch(buildFastbullUrl(tagIds), { headers: FASTBULL_HEADERS })
        .then(function(response) {
          if (!response.ok) throw new Error("HTTP " + response.status);
          return response.json();
        })
        .then(function(payload) {
          var body;
          if (typeof payload.bodyMessage === "string") {
            try {
              body = JSON.parse(payload.bodyMessage);
            } catch (e) {
              body = {};
            }
          } else {
            body = payload.bodyMessage || {};
          }

          var list = body && body.pageDatas && body.pageDatas.length ? body.pageDatas : [];
          var normalized = [];
          for (var i = 0; i < list.length; i++) {
            var norm = normalizeFastbullItem(list[i]);
            if (norm) normalized.push(norm);
          }

          latestCache[tagIds] = {
            items: normalized,
            updatedIso: new Date().toISOString()
          };

          if (token !== latestFetchToken) return;
          renderLatestFeed(normalized);
          setLatestStatus("Updated just now");
        })
        .catch(function(err) {
          console.error("FastBull feed error:", err);
          if (token !== latestFetchToken) return;
          setLatestStatus("Feed error Â· " + (err && err.message ? err.message : "Network error"));
        });
    }

    // ====== CATALYST ======
    function normalizeCatalystItem(item) {
      if (!item) return null;
      var rawContent = item.content != null ? item.content : item.summary;
      var contentValue;
      if (rawContent == null) {
        contentValue = "";
      } else if (typeof rawContent === "string") {
        contentValue = rawContent.trim();
      } else {
        contentValue = String(rawContent);
      }

      return {
        timestamp: item.timestamp || item.time || "",
        headline: item.headline || item.title || "Untitled catalyst",
        content: contentValue,
        impact: item.impact || "Low Impact",
        category1: item.category1 || "",
        category2: item.category2 || ""
      };
    }

    function impactClass(impact) {
      impact = impact || "";
      if (/high/i.test(impact)) return "impact-high";
      if (/medium/i.test(impact)) return "impact-medium";
      return "";
    }

    function catalystCategories() {
      var map = {};
      for (var i = 0; i < catalystItems.length; i++) {
        var key = catalystItems[i].category1 || "Lainnya";
        map[key] = true;
      }
      var out = [];
      for (var k in map) if (map.hasOwnProperty(k)) out.push(k);
      out.sort();
      return out;
    }

    function renderCatalystSkeleton() {
      if (!catalystListEl) return;
      clearList(catalystListEl);
      for (var i = 0; i < 3; i++) {
        var li = document.createElement("li");
        li.className = "feed-card";
        li.innerHTML =
          '<div class="skeleton-title shimmer-line"></div>' +
          '<div class="skeleton-body shimmer-line"></div>' +
          '<div class="skeleton-body shimmer-line"></div>';
        catalystListEl.appendChild(li);
      }
    }

    function filterCatalystItems() {
      if (catalystSelected === "all") return catalystItems;
      var out = [];
      for (var i = 0; i < catalystItems.length; i++) {
        if ((catalystItems[i].category1 || "") === catalystSelected) {
          out.push(catalystItems[i]);
        }
      }
      return out;
    }

    function buildCatalystCard(item) {
      var li = document.createElement("li");
      li.className = "feed-card";

      var headerRow = document.createElement("div");
      headerRow.className = "feed-header-row";

      var wrap = document.createElement("div");
      wrap.className = "feed-headline-wrap";

      var dot = document.createElement("div");
      dot.className = "head-dot";
      wrap.appendChild(dot);

      var box = document.createElement("div");
      var titleEl = document.createElement("div");
      titleEl.className = "headline";
      titleEl.textContent = item.headline;
      box.appendChild(titleEl);
      wrap.appendChild(box);

      var btn = document.createElement("button");
      btn.className = "copy-btn";
      btn.type = "button";
      btn.textContent = COPY_TEXT;
      btn.setAttribute("aria-label", "Salin catalyst");
      btn.addEventListener("click", function() {
        copyTextToClipboard(item.headline, btn);
      });

      headerRow.appendChild(wrap);
      headerRow.appendChild(btn);

      var metaRow = document.createElement("div");
      metaRow.className = "feed-meta";
      var timeEl = document.createElement("span");
      timeEl.className = "feed-time";
      timeEl.textContent = formatUTC(item.timestamp);
      metaRow.appendChild(timeEl);

      var bodyEl = document.createElement("div");
      bodyEl.className = "feed-body";
      bodyEl.textContent = item.content || "";

      var tagsRow = document.createElement("div");
      tagsRow.className = "feed-tags";
      var cats = [];
      if (item.category1) cats.push(item.category1);
      if (item.category2) cats.push(item.category2);
      for (var i = 0; i < cats.length; i++) {
        var chip = document.createElement("span");
        chip.className = "chip";
        chip.textContent = cats[i];
        tagsRow.appendChild(chip);
      }

      var impactRow = document.createElement("div");
      impactRow.className = "impact-row";
      var impactBadge = document.createElement("span");
      impactBadge.className = "impact-badge " + impactClass(item.impact);
      impactBadge.textContent = item.impact || "Impact";
      impactRow.appendChild(impactBadge);

      li.appendChild(headerRow);
      li.appendChild(metaRow);
      li.appendChild(bodyEl);
      if (cats.length) li.appendChild(tagsRow);
      li.appendChild(impactRow);

      return li;
    }

    function renderCatalystFeed() {
      if (!catalystListEl) return;
      var items = filterCatalystItems();
      clearList(catalystListEl);

      if (!items.length) {
        var li = document.createElement("li");
        li.className = "feed-card";
        li.innerHTML =
          '<div class="feed-body" style="color:var(--text-muted)">Tidak ada catalyst untuk kategori ini.</div>';
        catalystListEl.appendChild(li);
        return;
      }

      for (var i = 0; i < items.length; i++) {
        catalystListEl.appendChild(buildCatalystCard(items[i]));
      }
    }

    function populateCatalystDropdown() {
      if (!catalystDropdownEl) return;
      var selected = catalystDropdownEl.value || "all";
      var cats = catalystCategories();

      catalystDropdownEl.innerHTML = "";
      var allOpt = document.createElement("option");
      allOpt.value = "all";
      allOpt.textContent = "Semua";
      catalystDropdownEl.appendChild(allOpt);

      for (var i = 0; i < cats.length; i++) {
        var opt = document.createElement("option");
        opt.value = cats[i];
        opt.textContent = cats[i];
        catalystDropdownEl.appendChild(opt);
      }

      var found = false;
      for (var j = 0; j < catalystDropdownEl.options.length; j++) {
        if (catalystDropdownEl.options[j].value === selected) {
          found = true;
          break;
        }
      }
      if (found) {
        catalystDropdownEl.value = selected;
        catalystSelected = selected;
      } else {
        catalystDropdownEl.value = "all";
        catalystSelected = "all";
      }

      updateCatalystRecapButton();
    }

    function updateCatalystRecapButton() {
      if (!catalystRecapBtn || !catalystDropdownEl) return;
      var value = catalystDropdownEl.value;
      var label;
      if (value === "all") {
        label = "Semua";
      } else {
        var idx = catalystDropdownEl.selectedIndex;
        label = idx >= 0 ? catalystDropdownEl.options[idx].textContent : "Semua";
      }
      catalystRecapBtn.textContent = "Recap " + label + " Catalyst By Kuantara AI";
    }

    function fetchCatalystFeed(options) {
      options = options || {};
      var force = options.force === true;
      var silent = options.silent === true;

      if (catalystLoading) return;
      if (!force && catalystFetched) return;
      catalystLoading = true;

      var needsInitialUi = !catalystFetched || !catalystItems.length;
      if (needsInitialUi) {
        if (catalystStatusEl) catalystStatusEl.textContent = "Loading feedâ€¦";
        renderCatalystSkeleton();
      } else if (!silent && catalystStatusEl) {
        catalystStatusEl.textContent = "Refreshingâ€¦";
      }

      fetch(CATALYST_FEED_API, { headers: { Accept: "application/json" } })
        .then(function(response) {
          if (!response.ok) throw new Error("HTTP " + response.status);
          return response.json();
        })
        .then(function(data) {
          var list;
          if (Object.prototype.toString.call(data) === "[object Array]") {
            list = data;
          } else if (data && data.items && data.items.length) {
            list = data.items;
          } else {
            list = [];
          }

          var out = [];
          for (var i = 0; i < list.length; i++) {
            var norm = normalizeCatalystItem(list[i]);
            if (norm) out.push(norm);
          }
          catalystItems = out;
          catalystFetched = true;

          populateCatalystDropdown();
          renderCatalystFeed();
          if (catalystStatusEl) catalystStatusEl.textContent = "Updated";
        })
        .catch(function(err) {
          console.error("Catalyst feed error:", err);
          if (catalystStatusEl) {
            catalystStatusEl.textContent =
              "Feed error â€¢ " + (err && err.message ? err.message : "Network error");
          }
        })
        .finally(function() {
          catalystLoading = false;
        });
    }

    // ====== MODAL / AI ======
    function openRecapModal(context) {
      if (!kuantaraModal) return;
      var title = context && context.title ? context.title : "Kuantara AI Recap";
      var desc = context && context.description
        ? context.description
        : "Contoh prompt: 'Ringkas semua catalyst penting, jelaskan implikasi ke USD, saham, dan komoditas.'";

      kuantaraModal.classList.add("active");
      document.body.style.overflow = "hidden";

      if (kuantaraTitle) kuantaraTitle.textContent = title;
      if (kuantaraStatus) {
        kuantaraStatus.textContent =
          "Ini masih demo. Hubungkan ke backend AI untuk ringkasan otomatis berbasis feed real-time.";
      }
      if (kuantaraBody) {
        kuantaraBody.innerHTML = "";
        var p1 = document.createElement("p");
        p1.textContent = desc;
        var p2 = document.createElement("p");
        p2.textContent =
          "Di production, tombol ini bisa memanggil endpoint AI (misalnya /api/ai/recap) dengan payload headline/catalyst terbaru.";
        kuantaraBody.appendChild(p1);
        kuantaraBody.appendChild(p2);
      }
    }

    function closeRecapModal() {
      if (!kuantaraModal) return;
      kuantaraModal.classList.remove("active");
      document.body.style.overflow = "";
    }

    // ====== AUTO REFRESH ======
    function stopAutoRefreshLoop() {
      if (autoRefreshTimer) {
        clearInterval(autoRefreshTimer);
        autoRefreshTimer = null;
      }
    }

    function runAutoRefreshCycle() {
      if (autoRefreshInProgress || document.hidden) return;
      autoRefreshInProgress = true;
      var tagIds = latestCurrentTagIds || "-1";
      Promise.allSettled([
        new Promise(function(resolve) {
          fetchFastbullNews(tagIds, { silent: true });
          resolve(true);
        }),
        new Promise(function(resolve) {
          fetchCatalystFeed({ silent: true, force: true });
          resolve(true);
        })
      ]).finally = function() {}; // no-op for older browsers

      autoRefreshInProgress = false;
    }

    function startAutoRefreshLoop() {
      stopAutoRefreshLoop();
      if (AUTO_REFRESH_INTERVAL > 0) {
        autoRefreshTimer = setInterval(runAutoRefreshCycle, AUTO_REFRESH_INTERVAL);
      }
    }

    // ====== INIT ======
    function initTabs() {
      if (!tabBar) return;
      var buttons = tabBar.querySelectorAll(".tab-btn");
      for (var i = 0; i < buttons.length; i++) {
        (function(btn) {
          btn.addEventListener("click", function() {
            var target = btn.getAttribute("data-target");
            for (var j = 0; j < buttons.length; j++) {
              buttons[j].classList.remove("active");
            }
            btn.classList.add("active");

            if (latestPanel && catalystPanel) {
              if (latestPanel.id === target) {
                latestPanel.classList.add("active");
                catalystPanel.classList.remove("active");
              } else {
                catalystPanel.classList.add("active");
                latestPanel.classList.remove("active");
              }
            }
          });
        })(buttons[i]);
      }
    }

    function initLatestPanel() {
      if (!latestListEl) return;
      renderLatestSkeleton();
      var initialValue = latestDropdownEl ? (latestDropdownEl.value || "-1") : "-1";
      latestCurrentTagIds = mapCategoryToTagIds(initialValue);
      fetchFastbullNews(latestCurrentTagIds, { silent: false });

      if (latestDropdownEl) {
        latestDropdownEl.addEventListener("change", function(e) {
          var value = e.target.value || "-1";
          latestCurrentTagIds = mapCategoryToTagIds(value);
          fetchFastbullNews(latestCurrentTagIds, { silent: false });
        });
      }

      if (latestRecapBtn) {
        latestRecapBtn.addEventListener("click", function() {
          openRecapModal({
            title: "Kuantara AI â€“ Latest 24/7 Recap",
            description:
              "Gunakan headline 24/7 di panel ini untuk membuat narasi makro harian dan bias cross-asset."
          });
        });
      }
    }

    function initCatalystPanel() {
      if (!catalystListEl) return;
      renderCatalystSkeleton();
      fetchCatalystFeed({ force: true });

      if (catalystDropdownEl) {
        catalystDropdownEl.addEventListener("change", function(e) {
          catalystSelected = e.target.value || "all";
          renderCatalystFeed();
          updateCatalystRecapButton();
        });
      }

      if (catalystRecapBtn) {
        catalystRecapBtn.addEventListener("click", function() {
          openRecapModal({
            title: "Kuantara AI â€“ Catalyst Recap",
            description:
              "Gabungkan catalyst terfilter untuk menyusun skenario base, bull, dan bear market."
          });
        });
      }
    }

    function initModal() {
      if (kuantaraClose) {
        kuantaraClose.addEventListener("click", closeRecapModal);
      }
      if (kuantaraModal) {
        kuantaraModal.addEventListener("click", function(e) {
          if (e.target === kuantaraModal) closeRecapModal();
        });
      }
    }

    function initAutoRefresh() {
      if (AUTO_REFRESH_INTERVAL <= 0) return;
      startAutoRefreshLoop();
      document.addEventListener("visibilitychange", function() {
        if (document.hidden) {
          stopAutoRefreshLoop();
        } else {
          runAutoRefreshCycle();
          startAutoRefreshLoop();
        }
      });
      window.addEventListener("beforeunload", stopAutoRefreshLoop);
    }

    function initPage() {
      initTabs();
      initLatestPanel();
      initCatalystPanel();
      initModal();
      initAutoRefresh();
    }

    window.addEventListener("load", initPage);
  </script>
</body>
</html>