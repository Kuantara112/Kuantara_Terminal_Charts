<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Kuantara – Economic & Earnings Calendar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;700&display=swap">

  <style>
    :root {
      /* KUANTARA TERMINAL THEME */
      --bg-root:#000000;
      --bg-main:#111111;
      --bg-card:#151515;
      --bg-soft:#101010;
      --border-soft:#2b2b2b;
      --border-subtle:#1c1c1c;
      --text-main:#f5f5f5;
      --text-muted:#9b9b9b;
      --accent:#ffbf00;
      --accent-soft:rgba(255,191,0,0.18);
      --danger:#ef4444;
      --green:#22c55e;
      --row-hover:#1c1c1c;
    }

    * {
      box-sizing:border-box;
      margin:0;
      padding:0;
      font-family:"Fira Code",monospace;
    }

    html, body {
      width:100%;
      height:100%;
      background:radial-gradient(circle at top, #141414 0, #020202 55%, #000000 100%);
      color:var(--text-main);
      -webkit-font-smoothing:antialiased;
    }

    body {
      display:flex;
      min-height:100vh;
    }

    .page {
      display:flex;
      flex-direction:row;
      width:100%;
      height:100vh;
      padding:10px 12px;
      gap:10px;
    }

    .panel {
      flex:1 1 50%;
      display:flex;
      flex-direction:column;
      min-width:0;
      background:linear-gradient(135deg, #111111 0%, #090909 60%, #111111 100%);
      border-radius:16px;
      border:1px solid var(--border-soft);
      box-shadow:
        0 0 0 1px #000 inset,
        0 20px 45px rgba(0,0,0,0.85);
      overflow:hidden;
    }

    .right-panel {
      border-left:1px solid var(--border-soft);
    }

    .panel-header {
      padding:10px 14px 9px;
      border-bottom:1px solid var(--border-subtle);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background:linear-gradient(90deg, rgba(255,191,0,0.06), rgba(255,191,0,0.01));
    }

    .panel-header-main {
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }

    .panel-eyebrow {
      font-size:10px;
      letter-spacing:0.04em;
      text-transform:uppercase;
      color:var(--text-muted);
    }

    .panel-title {
      font-size:13.5px;
      color:var(--accent);
      white-space:nowrap;
      text-overflow:ellipsis;
      overflow:hidden;
    }

    .panel-body {
      flex:1 1 auto;
      display:flex;
      flex-direction:column;
      min-height:0;
      padding:10px 12px 12px;
      gap:8px;
    }

    /* Economic Calendar widget layout */
    #economicCalendarWidget {
      flex:1 1 auto;
      width:100%;
      min-height:0;
    }

    .tradingview-widget-container {
      width:100%;
      height:100%;
      position:relative;
      overflow:hidden;
      border-radius:10px;
      background:#050505;
      border:1px solid var(--border-subtle);
    }

    .tradingview-widget-container__widget {
      width:100%;
      height:100%;
    }

    .tradingview-widget-copyright {
      display:none !important;
    }

    /* Earnings layout – LIST STYLE */
    .earnings-header-extra {
      font-size:10px;
      color:var(--text-muted);
    }

    .earnings-controls-row {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      flex-wrap:wrap;
    }

    .earnings-controls {
      display:flex;
      align-items:center;
      gap:6px;
      flex-wrap:wrap;
    }

    #searchInput {
      padding:7px 9px;
      width:230px;
      font-size:10.5px;
      background:var(--bg-soft);
      border:1px solid var(--border-soft);
      color:#ffffff;
      border-radius:8px;
      outline:none;
      transition:border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    #searchInput::placeholder {
      color:var(--text-muted);
    }

    #searchInput:focus {
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(255,191,0,0.35);
      background:#0d0d0d;
    }

    .earnings-table-wrapper {
      flex:1 1 auto;
      min-height:0;
      display:flex;
      flex-direction:column;
    }

    .earnings-scroll {
      flex:1 1 auto;
      min-height:0;
      overflow:auto;
      border:1px solid var(--border-subtle);
      border-radius:10px;
      background:radial-gradient(circle at top, #111111 0, #050505 55%, #000000 100%);
      /* Scrollbar (Firefox) */
      scrollbar-width:thin;
      scrollbar-color:rgba(0,0,0,0.6) transparent;
    }

    /* Scrollbar hitam transparan (WebKit) */
    .earnings-scroll::-webkit-scrollbar {
      width:8px;
      height:8px;
    }

    .earnings-scroll::-webkit-scrollbar-track {
      background:transparent;
    }

    .earnings-scroll::-webkit-scrollbar-thumb {
      background:rgba(0,0,0,0.6);
      border-radius:4px;
    }

    .earnings-scroll::-webkit-scrollbar-thumb:hover {
      background:rgba(0,0,0,0.85);
    }

    /* LIST */
    .earnings-list {
      display:flex;
      flex-direction:column;
      gap:6px;
      padding:6px;
    }

    .earnings-item {
      border-radius:8px;
      border:1px solid rgba(43,43,43,0.9);
      background:rgba(0,0,0,0.9);
      padding:7px 8px;
      display:flex;
      flex-direction:column;
      gap:4px;
      transition:background 0.15s ease, border-color 0.15s ease, transform 0.05s ease;
    }

    .earnings-item:hover {
      background:var(--row-hover);
      border-color:var(--accent-soft);
      transform:translateY(-0.5px);
    }

    .earnings-item-main {
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:8px;
    }

    .earnings-main-left {
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }

    .earnings-main-line1 {
      display:flex;
      align-items:center;
      gap:6px;
      flex-wrap:wrap;
    }

    .earnings-ticker {
      font-size:11.5px;
      font-weight:600;
      color:var(--accent);
    }

    .earnings-company {
      font-size:11px;
      color:var(--text-main);
      opacity:0.9;
      white-space:nowrap;
      text-overflow:ellipsis;
      overflow:hidden;
      max-width:220px;
    }

    .earnings-main-line2 {
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      font-size:10px;
      color:var(--text-muted);
    }

    .earnings-date-pill {
      padding:2px 6px;
      border-radius:999px;
      border:1px solid var(--border-subtle);
      background:rgba(0,0,0,0.85);
      font-size:10px;
    }

    .earnings-time-pill {
      padding:2px 6px;
      border-radius:999px;
      border:1px dashed var(--border-subtle);
      font-size:10px;
    }

    .earnings-side-badge {
      font-size:10px;
      color:var(--text-muted);
      padding:2px 6px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.3);
      background:rgba(15,23,42,0.6);
      white-space:nowrap;
    }

    .earnings-extra {
      display:flex;
      flex-wrap:wrap;
      gap:4px;
      margin-top:2px;
    }

    .earnings-tag {
      font-size:9.5px;
      border-radius:999px;
      background:rgba(15,15,15,0.9);
      border:1px solid rgba(51,65,85,0.7);
      padding:2px 6px;
      display:inline-flex;
      align-items:center;
      gap:3px;
      color:var(--text-muted);
    }

    .earnings-tag-label {
      opacity:0.75;
    }

    .earnings-tag-value {
      color:var(--text-main);
      opacity:0.9;
    }

    .positive {
      color:var(--green);
      font-weight:bold;
    }

    .negative {
      color:var(--danger);
      font-weight:bold;
    }

    .earnings-footer {
      font-size:10px;
      color:var(--text-muted);
      margin-top:5px;
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:6px;
      flex-wrap:wrap;
    }

    .today-pill {
      font-size:10px;
      padding:3px 8px;
      border-radius:999px;
      background:rgba(255,255,255,0.02);
      border:1px solid var(--border-subtle);
      color:var(--text-muted);
    }

    @media (max-width: 900px) {
      .page {
        flex-direction:column;
        height:auto;
      }
      .panel {
        height:52vh;
      }
      .right-panel {
        border-left:1px solid var(--border-soft);
      }
      .panel-header {
        align-items:flex-start;
        flex-direction:column;
      }
      .earnings-controls-row {
        align-items:flex-start;
        flex-direction:column;
      }
      #searchInput {
        width:100%;
      }
      .earnings-company {
        max-width:160px;
      }
    }
  </style>
</head>
<body>

<div class="page">
  <!-- LEFT: ECONOMIC CALENDAR (TRADINGVIEW, DARK) -->
  <div class="panel left-panel">
    <div class="panel-header">
      <div class="panel-header-main">
        <div class="panel-eyebrow">MACRO · EVENTS</div>
        <div class="panel-title">Economic Calendar</div>
      </div>
    </div>

    <div class="panel-body">
      <div id="economicCalendarWidget">
        <div class="tradingview-widget-container">
          <div class="tradingview-widget-container__widget"></div>
          <script
            type="text/javascript"
            src="https://s3.tradingview.com/external-embedding/embed-widget-events.js"
            async>
          {
            "colorTheme": "dark",
            "isTransparent": true,
            "locale": "id",
            "countryFilter": "ar,au,br,ca,cn,fr,de,in,id,it,jp,kr,mx,ru,sa,za,tr,gb,us,eu",
            "importanceFilter": "-1,0,1",
            "width": "100%",
            "height": "100%"
          }
          </script>
        </div>
      </div>
    </div>
  </div>

  <!-- RIGHT: EARNINGS CALENDAR (CSV → LIST, ALWAYS SHOW ALL) -->
  <div class="panel right-panel">
    <div class="panel-header">
      <div class="panel-header-main">
        <div class="panel-eyebrow">EQUITIES · MICRO CATALYSTS</div>
        <div class="panel-title">Earnings Calendar</div>
      </div>
    </div>

    <div class="panel-body">
      <div class="earnings-controls-row">
        <div class="earnings-controls">
          <input id="searchInput" placeholder="Search ticker or company..." />
        </div>
        <div class="today-pill" id="todayInfo"></div>
      </div>

      <div id="earningsTable" class="earnings-table-wrapper">
        <div style="font-size:11px;color:var(--text-muted);padding:8px 2px;">
          Loading earnings data from Kuantara Database…
        </div>
      </div>

      <div class="earnings-footer">
        <span style="opacity:0.8;font-size:9.5px;">Kuantara Terminal · Earnings Radar</span>
      </div>
    </div>
  </div>
</div>

<script>
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRDc2WUdEFucZDJdEuYXtF9GVGv1cxKxNQqJv9lXPx10KHE98mUyVDoW14K6TglVINbKeF9hx1BwqWz/pub?gid=0&single=true&output=csv";

  let fullRows = [];      // semua baris data
  let tableData = [];     // baris yang sedang ditampilkan (setelah search + sort)
  let tableHeaders = [];
  let dateColIndex = -1;
  let timeColIndex = -1;

  function setTodayBadge() {
    const el = document.getElementById("todayInfo");
    if (!el) return;
    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth() + 1).padStart(2, "0");
    const d = String(now.getDate()).padStart(2, "0");
    el.textContent = `Today: ${y}-${m}-${d}`;
  }

  setTodayBadge();

  async function loadCSV() {
    try {
      const res = await fetch(CSV_URL);
      if (!res.ok) {
        throw new Error("HTTP " + res.status);
      }
      const rawText = await res.text();
      const parsed = parseCSV(rawText);

      if (!parsed || !parsed.length) {
        throw new Error("CSV kosong atau tidak terbaca");
      }

      tableHeaders = parsed[0];
      dateColIndex = detectDateColumn(tableHeaders);
      timeColIndex = detectTimeColumn(tableHeaders);

      fullRows = parsed.slice(1);

      recomputeTableData(); // always Show All

      const searchInput = document.getElementById("searchInput");
      if (searchInput) {
        searchInput.addEventListener("input", () => {
          recomputeTableData();
        });
      }
    } catch (err) {
      console.error("Gagal memuat CSV:", err);
      const el = document.getElementById("earningsTable");
      if (el) {
        el.innerHTML = `
          <div class="earnings-scroll">
            <div style="font-size:11px;color:#ef4444;padding:10px 8px;">
              Failed to load earnings data (CSV error / network issue). Please check the sheet or connection.
            </div>
          </div>
        `;
      }
    }
  }

  // Rebuild tableData based on global data + search query + sort by nearest release date
  function recomputeTableData() {
    const tableContainer = document.getElementById("earningsTable");

    if (!fullRows || fullRows.length === 0) {
      if (tableContainer) {
        tableContainer.innerHTML = `
          <div class="earnings-scroll">
            <div style="padding:10px;font-size:11px;color:var(--text-muted);">
              No earnings data available.
            </div>
          </div>
        `;
      }
      return;
    }

    const searchInput = document.getElementById("searchInput");
    const q = searchInput ? searchInput.value.trim().toLowerCase() : "";

    let rows = fullRows;

    if (q) {
      rows = fullRows.filter(row =>
        row.some(cell =>
          (cell ?? "").toString().toLowerCase().includes(q)
        )
      );
    }

    // Clone before sort
    rows = [...rows];

    // Sort by release date (nearest first), then time if available
    if (dateColIndex !== -1) {
      rows.sort((a, b) => {
        const dateA = parseDateFlexible((a[dateColIndex] ?? "").toString());
        const dateB = parseDateFlexible((b[dateColIndex] ?? "").toString());

        if (!dateA && !dateB) return 0;
        if (!dateA) return 1;
        if (!dateB) return -1;

        const diff = dateA.getTime() - dateB.getTime();
        if (diff !== 0) return diff;

        // same date → sort by time if available
        if (timeColIndex !== -1) {
          const timeA = parseTimeFlexible((a[timeColIndex] ?? "").toString());
          const timeB = parseTimeFlexible((b[timeColIndex] ?? "").toString());
          if (timeA !== null && timeB !== null) {
            return timeA - timeB;
          }
        }

        return 0;
      });
    }

    tableData = rows;
    renderList(tableHeaders, tableData);
  }

  // Robust CSV parser, aman untuk commas & quotes
  function parseCSV(text) {
    const rows = [];
    let current = "";
    let row = [];
    let inQuotes = false;

    for (let i = 0; i < text.length; i++) {
      const char = text[i];

      if (char === '"') {
        // handle double quotes ("") inside quoted field
        if (inQuotes && text[i + 1] === '"') {
          current += '"';
          i++;
        } else {
          inQuotes = !inQuotes;
        }
      } else if (char === "," && !inQuotes) {
        row.push(current);
        current = "";
      } else if ((char === "\n" || char === "\r") && !inQuotes) {
        if (current !== "" || row.length) {
          row.push(current);
          rows.push(row);
          row = [];
          current = "";
        }
        // handle CRLF
        if (char === "\r" && text[i + 1] === "\n") {
          i++;
        }
      } else {
        current += char;
      }
    }

    if (current !== "" || row.length) {
      row.push(current);
      rows.push(row);
    }

    // trim setiap cell
    return rows.map(r => r.map(v => v.trim()));
  }

  function detectDateColumn(headers) {
    if (!headers) return -1;
    const candidates = [
      "date",
      "earnings date",
      "report date",
      "release date",
      "release_day",
      "day"
    ];
    const lower = headers.map(h => (h ?? "").toString().trim().toLowerCase());

    let idx = lower.findIndex(h => candidates.includes(h));
    if (idx !== -1) return idx;

    // fallback: cari header yang mengandung "date"
    idx = lower.findIndex(h => h.includes("date"));
    return idx !== -1 ? idx : -1;
  }

  function detectTimeColumn(headers) {
    if (!headers) return -1;
    const candidates = [
      "time",
      "time (local)",
      "time_et",
      "time est",
      "time utc"
    ];
    const lower = headers.map(h => (h ?? "").toString().trim().toLowerCase());

    let idx = lower.findIndex(h => candidates.includes(h));
    if (idx !== -1) return idx;

    idx = lower.findIndex(h => h.includes("time"));
    return idx !== -1 ? idx : -1;
  }

  function detectTickerColumn(headers) {
    if (!headers) return -1;
    const candidates = ["ticker", "symbol", "code"];
    const lower = headers.map(h => (h ?? "").toString().trim().toLowerCase());
    let idx = lower.findIndex(h => candidates.includes(h));
    if (idx !== -1) return idx;
    return 0; // fallback kolom pertama
  }

  function detectCompanyColumn(headers) {
    if (!headers) return -1;
    const candidates = ["company", "name", "company name", "issuer"];
    const lower = headers.map(h => (h ?? "").toString().trim().toLowerCase());
    let idx = lower.findIndex(h => candidates.includes(h));
    if (idx !== -1) return idx;
    return headers.length > 1 ? 1 : -1;
  }

  function parseDateFlexible(str) {
    if (!str) return null;
    const s = str.trim();
    if (!s) return null;

    // coba native Date dulu (mendukung format ISO, "24 Nov 2025", dsb)
    const d1 = new Date(s);
    if (!isNaN(d1.getTime())) return d1;

    // dd/mm/yyyy atau dd-mm-yyyy
    const m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
    if (m) {
      let day = parseInt(m[1], 10);
      let month = parseInt(m[2], 10) - 1;
      let year = parseInt(m[3], 10);
      if (year < 100) year += 2000;
      const d2 = new Date(year, month, day);
      if (!isNaN(d2.getTime())) return d2;
    }

    return null;
  }

  function parseTimeFlexible(str) {
    if (!str) return null;
    const s = str.trim().toUpperCase();
    if (!s) return null;

    // HH:MM or HH:MM:SS (24h)
    let m = s.match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?$/);
    if (m) {
      const h = parseInt(m[1], 10);
      const min = parseInt(m[2], 10);
      const sec = m[3] ? parseInt(m[3], 10) : 0;
      if (!isNaN(h) && !isNaN(min) && !isNaN(sec)) {
        return h * 3600 + min * 60 + sec;
      }
    }

    // HH:MM AM/PM
    m = s.match(/^(\d{1,2}):(\d{2})\s*(AM|PM)$/);
    if (m) {
      let h = parseInt(m[1], 10);
      const min = parseInt(m[2], 10);
      const period = m[3];
      if (period === "PM" && h < 12) h += 12;
      if (period === "AM" && h === 12) h = 0;
      return h * 3600 + min * 60;
    }

    return null;
  }

  function escapeHTML(str) {
    return (str ?? "").toString()
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;");
  }

  function renderList(headers, rows) {
    const tableContainer = document.getElementById("earningsTable");
    if (!tableContainer) return;

    if (!rows.length) {
      tableContainer.innerHTML = `
        <div class="earnings-scroll">
          <div style="padding:10px;font-size:11px;color:var(--text-muted);">
            No earnings match the current filters.
          </div>
        </div>
      `;
      return;
    }

    const tickerIdx = detectTickerColumn(headers);
    const companyIdx = detectCompanyColumn(headers);
    const usedIdx = new Set();
    if (tickerIdx >= 0) usedIdx.add(tickerIdx);
    if (companyIdx >= 0) usedIdx.add(companyIdx);
    if (dateColIndex >= 0) usedIdx.add(dateColIndex);
    if (timeColIndex >= 0) usedIdx.add(timeColIndex);

    const itemsHTML = rows.map(r => {
      const ticker = tickerIdx >= 0 ? (r[tickerIdx] ?? "") : (r[0] ?? "");
      const company = companyIdx >= 0 ? (r[companyIdx] ?? "") : (headers[1] ? (r[1] ?? "") : "");

      const dateStr = dateColIndex >= 0 ? (r[dateColIndex] ?? "") : "";
      const timeStr = timeColIndex >= 0 ? (r[timeColIndex] ?? "") : "";

      // build extra tags from remaining columns
      const tags = [];
      headers.forEach((h, i) => {
        if (usedIdx.has(i)) return;
        const v = (r[i] ?? "").toString();
        if (!v) return;
        const hLower = (h ?? "").toString().trim().toLowerCase();

        let valueHTML = escapeHTML(v);
        // highlight numeric EPS/estimate as positive/negative color
        if ((hLower.includes("estimate") || hLower.includes("eps")) && v !== "") {
          const num = parseFloat(v.replace(/,/g, ""));
          if (!isNaN(num)) {
            const cls = num >= 0 ? "positive" : "negative";
            valueHTML = `<span class="${cls}">${escapeHTML(v)}</span>`;
          }
        }

        tags.push(`
          <span class="earnings-tag">
            <span class="earnings-tag-label">${escapeHTML(h)}:</span>
            <span class="earnings-tag-value">${valueHTML}</span>
          </span>
        `);
      });

      const datePill = dateStr
        ? `<span class="earnings-date-pill">${escapeHTML(dateStr)}</span>`
        : "";
      const timePill = timeStr
        ? `<span class="earnings-time-pill">${escapeHTML(timeStr)}</span>`
        : "";

      return `
        <div class="earnings-item">
          <div class="earnings-item-main">
            <div class="earnings-main-left">
              <div class="earnings-main-line1">
                <span class="earnings-ticker">${escapeHTML(ticker)}</span>
                ${company ? `<span class="earnings-company">${escapeHTML(company)}</span>` : ""}
              </div>
              <div class="earnings-main-line2">
                ${datePill}
                ${timePill}
              </div>
            </div>
            <div class="earnings-side-badge">
              Earnings event
            </div>
          </div>
          ${tags.length ? `<div class="earnings-extra">${tags.join("")}</div>` : ""}
        </div>
      `;
    }).join("");

    tableContainer.innerHTML = `
      <div class="earnings-scroll">
        <div class="earnings-list">
          ${itemsHTML}
        </div>
      </div>
    `;
  }

  loadCSV();
</script>

</body>
</html>
