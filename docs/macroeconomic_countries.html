<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Kuantara â€“ Economic Atlas (Multi-Country v3)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  body {
    font-family: "Fira Code", monospace;
    background:#000;
    color:#f5f5f5;
    padding:20px;
  }

  h1 {
    font-size: 20px;
    margin-bottom: 14px;
    color:#ffbf00;
  }

  #top-bar {
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    align-items:center;
    margin-bottom:10px;
  }

  #status {
    font-size: 12px;
    margin-top:4px;
    margin-bottom: 10px;
    color:#9b9b9b;
  }

  select, input[type="text"] {
    background:#111;
    color:#f5f5f5;
    padding:6px 10px;
    border:1px solid #2b2b2b;
    border-radius:4px;
    font-family:"Fira Code", monospace;
    font-size:11px;
  }

  input[type="text"] {
    min-width:220px;
  }

  table {
    width:100%;
    border-collapse: collapse;
    font-size: 11px;
    margin-top:6px;
  }

  th {
    background:#111;
    color:#ffbf00;
    padding:8px;
    border-bottom:1px solid #2b2b2b;
    text-align:left;
    cursor:pointer;
    user-select:none;
  }

  th[data-sort-key="none"] {
    cursor:default;
  }

  td {
    padding:6px 8px;
    border-bottom:1px solid #1f1f1f;
    color:#ddd;
    white-space:nowrap;
  }

  tr:nth-child(even){ background:#090909; }
  tr:hover { background:#1b1b1b; }

  .num { text-align:right; }
  .up  { color:#22c55e; font-weight:600; }
  .down{ color:#ef4444; font-weight:600; }
  .flat{ color:#9b9b9b; }
</style>
</head>
<body>

<h1>Kuantara â€“ Economic Atlas (Multi-Country v3)</h1>

<div id="top-bar">
  <select id="countrySelect">
    <option value="32">ðŸ‡ºðŸ‡¸ United States (32)</option>
    <option value="6">ðŸ‡¨ðŸ‡³ China (6)</option>
    <option value="11">ðŸ‡¨ðŸ‡¦ Canada (11)</option>
  </select>

  <input
    type="text"
    id="searchInput"
    placeholder="Search (CPI, PCE, GDP, NFP, keyword...)"/>
</div>

<div id="status">Loadingâ€¦</div>

<table>
  <thead>
    <tr>
      <th data-sort-key="category" data-label="Category">Category</th>
      <th data-sort-key="indicator" data-label="Indicator">Indicator</th>
      <th data-sort-key="current" data-label="Current" class="num">Current</th>
      <th data-sort-key="currentTime" data-label="Current Time">Current Time</th>
      <th data-sort-key="previous" data-label="Previous" class="num">Previous</th>
      <th data-sort-key="previousTime" data-label="Previous Time">Previous Time</th>
      <th data-sort-key="delta" data-label="Î”" class="num">Î”</th>
      <th data-sort-key="description" data-label="Description">Description</th>
    </tr>
  </thead>
  <tbody id="atlas-body"></tbody>
</table>

<script>
const CATEGORIES = {
  1: "Prices",
  2: "Population & Labor",
  3: "National Accounts",
  4: "Commodities",
  5: "Government Sector",
  6: "External Sector",
  7: "Industry Sector",
  8: "Money & Finance"
};

// DATA GLOBAL
let ALL_ROWS = [];
let sortKey = null;      // 'category' | 'indicator' | ...
let sortDir = 'asc';     // 'asc' | 'desc'

function API(country, col) {
  return `https://api.fastbull.com/fastbull-macro-data-service/api/getWebIndicatorList?countryId=${country}&pageIndex=1&columnId=${col}&pageSize=50`;
}

async function fetchCategory(countryId, columnId) {
  const res = await fetch(API(countryId, columnId), {
    headers: {
      "b-token": "cf44ae1f585e1ddf806333e4e6e5f905",
      "client-type": "Web",
      "lang": "en",
      "accept": "application/json"
    }
  });

  const outer = await res.json();
  const inner = JSON.parse(outer.bodyMessage || "{}");
  return inner.pageDatas || [];
}

function cleanDescription(desc) {
  if (!desc) return "";
  const pattern = /,\s[A-Za-z]{3}\s\d{4}\s~\s[A-Za-z]{3}\s\d{4}$/;
  return desc.replace(pattern, "");
}

function computeDelta(curr, prev) {
  const c = parseFloat(curr);
  const p = parseFloat(prev);
  if (isNaN(c) || isNaN(p)) return null;
  return (c - p).toFixed(3);
}

// ===== SORTING LOGIC =====
function getSortValue(row, key) {
  switch (key) {
    case 'category':
      return (row.__category || '').toLowerCase();
    case 'indicator':
      return (row.metricsName || '').toLowerCase();
    case 'current':
      return parseFloat(row.current);
    case 'previous':
      return parseFloat(row.last);
    case 'currentTime':
      return (row.currentTime || '').toLowerCase();
    case 'previousTime':
      return (row.lastTime || '').toLowerCase();
    case 'description':
      return (row.description || '').toLowerCase();
    case 'delta':
      const d = computeDelta(row.current, row.last);
      return d === null ? NaN : parseFloat(d);
    default:
      return null;
  }
}

function compareRows(a, b) {
  const va = getSortValue(a, sortKey);
  const vb = getSortValue(b, sortKey);

  const dir = sortDir === 'asc' ? 1 : -1;

  // numeric sort
  if (['current','previous','delta'].includes(sortKey)) {
    const na = isNaN(va);
    const nb = isNaN(vb);

    if (na && nb) return 0;
    if (na) return 1;   // NaN ke bawah
    if (nb) return -1;

    if (va < vb) return -1 * dir;
    if (va > vb) return 1 * dir;
    return 0;
  }

  // string sort
  const sa = (va || '').toString();
  const sb = (vb || '').toString();

  return sa.localeCompare(sb) * dir;
}

function updateHeaderLabels() {
  const ths = document.querySelectorAll('thead th');
  ths.forEach(th => {
    const key = th.dataset.sortKey;
    const base = th.dataset.label || th.textContent;
    if (!key || key === 'none') {
      th.textContent = base;
      return;
    }
    if (key === sortKey) {
      const arrow = sortDir === 'asc' ? ' â†‘' : ' â†“';
      th.textContent = base + arrow;
    } else {
      th.textContent = base;
    }
  });
}

// ===== RENDER TABLE (FILTER + SORT) =====
function renderTable() {
  const tbody = document.getElementById("atlas-body");
  const status = document.getElementById("status");
  const q = document.getElementById("searchInput").value.trim().toLowerCase();

  tbody.innerHTML = "";

  // Filter
  let filtered = ALL_ROWS.filter(row => {
    if (!q) return true;
    const haystack = (
      row.__category + " " +
      (row.metricsName || "") + " " +
      (row.description || "")
    ).toLowerCase();
    return haystack.includes(q);
  });

  // Sort
  if (sortKey) {
    filtered.sort(compareRows);
  }

  // Render
  filtered.forEach(item => {
    const current = item.current ?? "";
    const previous = item.last ?? "";
    const delta = computeDelta(current, previous);
    let deltaClass = "flat";
    let deltaText = delta;

    if (delta === null) {
      deltaText = "";
      deltaClass = "flat";
    } else if (delta > 0) {
      deltaText = "+" + delta;
      deltaClass = "up";
    } else if (delta < 0) {
      deltaClass = "down";
    }

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${item.__category}</td>
      <td>${item.metricsName}</td>
      <td class="num">${current}</td>
      <td>${item.currentTime}</td>
      <td class="num">${previous}</td>
      <td>${item.lastTime}</td>
      <td class="num ${deltaClass}">${deltaText ?? ""}</td>
      <td>${cleanDescription(item.description || "")}</td>
    `;
    tbody.appendChild(tr);
  });

  status.textContent =
    `Loaded ${ALL_ROWS.length} indicators, showing ${filtered.length} matching "${q || "all"}".`;

  updateHeaderLabels();
}

// ===== LOAD DATA DARI API =====
async function loadAtlas() {
  const status = document.getElementById("status");
  const countryId = document.getElementById("countrySelect").value;

  ALL_ROWS = [];
  sortKey = null;
  sortDir = 'asc';
  updateHeaderLabels();

  status.textContent = `Loading indicators for countryId=${countryId}â€¦`;

  for (const colId in CATEGORIES) {
    status.textContent = `Fetching ${CATEGORIES[colId]} for countryId=${countryId}â€¦`;
    const rows = await fetchCategory(countryId, colId);
    rows.forEach(x => x.__category = CATEGORIES[colId]);
    ALL_ROWS.push(...rows);
  }

  renderTable();
}

// ===== EVENT HANDLERS =====
document.getElementById("countrySelect").addEventListener("change", loadAtlas);
document.getElementById("searchInput").addEventListener("input", renderTable);

document.querySelectorAll('thead th').forEach(th => {
  const key = th.dataset.sortKey;
  if (!key || key === 'none') return;

  th.addEventListener('click', () => {
    if (sortKey === key) {
      // toggle direction
      sortDir = sortDir === 'asc' ? 'desc' : 'asc';
    } else {
      sortKey = key;
      sortDir = 'asc';
    }
    renderTable();
  });
});

// initial load
loadAtlas();
</script>

</body>
</html>
