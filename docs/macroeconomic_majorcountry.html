<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Global Macro Matrix</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Fira Code -->
  <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;700&display=swap"/>

  <style>
    :root {
      --bg-root:#000000;
      --bg-main:#111111;
      --border-soft:#2b2b2b;
      --text-main:#f5f5f5;
      --text-muted:#9b9b9b;
      --accent:#ffbf00;
      --row-hover:#181818;
    }

    * {
      box-sizing:border-box;
      margin:0;
      padding:0;
      font-family:"Fira Code", monospace;
    }

    html, body {
      width:100%;
      height:100%;
      background:var(--bg-root);
      color:var(--text-main);
      overflow:hidden;
    }

    .page {
      position:fixed;
      inset:0;
      width:100%;
      height:100%;
      display:flex;
    }

    .table-wrapper {
      flex:1;
      background:var(--bg-main);
      border:1px solid var(--border-soft);
      border-radius:0;
      overflow:auto;
    }

    table {
      width:100%;
      border-collapse:collapse;
      font-size:11px;
      table-layout:auto;
    }

    thead {
      background:#151515;
      position:sticky;
      top:0;
      z-index:1;
    }

    th, td {
      padding:6px 8px;
      border-bottom:1px solid #1f1f1f;
      white-space:nowrap;
    }

    th {
      text-align:left;
      font-weight:500;
      font-size:11px;
      color:var(--text-muted);
    }

    tbody tr:hover {
      background:var(--row-hover);
    }

    a.matrix-country {
      color:var(--text-main);
      text-decoration:none;
    }

    a.matrix-country:hover {
      color:var(--accent);
    }

    td a {
      text-decoration:none;
    }

    /* Scrollbar halus */
    .table-wrapper::-webkit-scrollbar {
      height:6px;
      width:6px;
    }
    .table-wrapper::-webkit-scrollbar-track {
      background:#111;
    }
    .table-wrapper::-webkit-scrollbar-thumb {
      background:#333;
      border-radius:999px;
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="table-wrapper">
      <table id="matrix" class="table table-hover sortable-theme-minimal table-heatmap"
             data-sortable="" data-sortable-initialized="true">
        <thead class="te-sort">
          <tr>
            <th><span class="matrix-country">Country</span></th>
            <th data-heatmap="1" data-heatmap-limit="20000" data-heatmap-dncolor="#78c1ff">GDP</th>
            <th data-heatmap="1" data-heatmap-limit="5">GDP Growth</th>
            <th data-heatmap="1" data-heatmap-limit="10" data-heatmap-dncolor="#78c1ff">Interest Rate</th>
            <th data-heatmap="1" data-heatmap-limit="20">Inflation Rate</th>
            <th data-heatmap="1" data-heatmap-limit="20">Jobless Rate</th>
            <th data-heatmap="1" data-heatmap-limit="20">Gov. Budget</th>
            <th data-heatmap="1" data-heatmap-limit="200" data-heatmap-dncolor="#78c1ff">Debt/GDP</th>
            <th data-heatmap="1" data-heatmap-limit="10">Current Account</th>
            <th data-heatmap="1" data-heatmap-limit="1000" data-heatmap-dncolor="#78c1ff">Population</th>
          </tr>
        </thead>

        <!-- tbody akan diisi otomatis dari CSV -->
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    // URL CSV dari Google Sheets kamu
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSIG55fz-H8EXFTb5JU0j9-i4ETOhzYGoyjeVQJdUxpmT_dEsG_c5ggZRdMtA9MkwSrPN1TEDzsd49n/pub?gid=0&single=true&output=csv";

    // Mapping path indikator (kalau mau pakai seperti TradingEconomics)
    const INDICATOR_PATHS = {
      gdp: "gdp",
      gdpGrowth: "gdp-growth",
      interestRate: "interest-rate",
      inflation: "inflation-cpi",
      jobless: "unemployment-rate",
      budget: "government-budget",
      debt: "government-debt-to-gdp",
      currentAccount: "current-account-to-gdp",
      population: "population"
    };

    // EXPECTED HEADER DI CSV:
    // Country,Slug,GDP,GDP_Growth,Interest_Rate,Inflation_Rate,
    // Jobless_Rate,Gov_Budget,Debt_GDP,Current_Account,Population

    function parseCSV(text) {
      const lines = text.trim().split(/\r?\n/).filter(Boolean);
      if (lines.length <= 1) return [];

      const headers = lines[0].split(",").map(h => h.trim());

      return lines.slice(1).map(line => {
        const cols = line.split(",").map(c => c.trim());
        const row = {};
        headers.forEach((h, i) => {
          row[h] = (cols[i] !== undefined ? cols[i] : "");
        });
        return row;
      });
    }

    function buildTable(rows) {
      const tbody = document.querySelector("#matrix tbody");
      if (!tbody) return;
      tbody.innerHTML = "";

      rows.forEach(row => {
        const slug = row.Slug || "";
        const tr = document.createElement("tr");

        // Country cell
        const countryTd = document.createElement("td");
        const countryA = document.createElement("a");
        countryA.className = "matrix-country";
        countryA.textContent = row.Country || "";
        countryA.href = slug ? ("/" + slug + "/indicators") : "#";
        countryTd.appendChild(countryA);
        tr.appendChild(countryTd);

        function addCell(value, indicatorPath) {
          const td = document.createElement("td");

          if (value !== undefined && value !== null && String(value).trim() !== "") {
            const numeric = Number(value);
            if (!Number.isNaN(numeric)) {
              td.dataset.heatmapValue = numeric.toString();
            }

            const a = document.createElement("a");
            a.textContent = value;
            a.href = slug && indicatorPath ? ("/" + slug + "/" + indicatorPath) : "#";
            td.appendChild(a);
          } else {
            td.textContent = "-";
          }

          tr.appendChild(td);
        }

        addCell(row.GDP,             INDICATOR_PATHS.gdp);
        addCell(row.GDP_Growth,      INDICATOR_PATHS.gdpGrowth);
        addCell(row.Interest_Rate,   INDICATOR_PATHS.interestRate);
        addCell(row.Inflation_Rate,  INDICATOR_PATHS.inflation);
        addCell(row.Jobless_Rate,    INDICATOR_PATHS.jobless);
        addCell(row.Gov_Budget,      INDICATOR_PATHS.budget);
        addCell(row.Debt_GDP,        INDICATOR_PATHS.debt);
        addCell(row.Current_Account, INDICATOR_PATHS.currentAccount);
        addCell(row.Population,      INDICATOR_PATHS.population);

        tbody.appendChild(tr);
      });
    }

    // ====== HEATMAP COLORING ======

    // helper: konversi hex -> {r,g,b}
    function hexToRgb(hex) {
      hex = hex.replace("#", "");
      if (hex.length === 3) {
        hex = hex.split("").map(c => c + c).join("");
      }
      const num = parseInt(hex, 16);
      return {
        r: (num >> 16) & 255,
        g: (num >> 8) & 255,
        b: num & 255
      };
    }

    // helper: interpolate warna antara c1 & c2 (0..1)
    function lerpColor(c1, c2, t) {
      const rgb1 = hexToRgb(c1);
      const rgb2 = hexToRgb(c2);
      const r = Math.round(rgb1.r + (rgb2.r - rgb1.r) * t);
      const g = Math.round(rgb1.g + (rgb2.g - rgb1.g) * t);
      const b = Math.round(rgb1.b + (rgb2.b - rgb1.b) * t);
      return `rgb(${r}, ${g}, ${b})`;
    }

    function applyHeatmap() {
      const table = document.getElementById("matrix");
      if (!table) return;

      const theadRow = table.querySelector("thead tr");
      if (!theadRow) return;

      const ths = Array.from(theadRow.children);

      const neutralColor = "#ffffff";
      const defaultPosColor = "#71e28f"; // hijau lembut
      const defaultNegColor = "#f3b4b4"; // merah lembut

      ths.forEach((th, colIndex) => {
        if (th.dataset.heatmap !== "1") return;

        const limit = parseFloat(th.dataset.heatmapLimit || "0") || null;
        const dnColor = th.dataset.heatmapDncolor || null; // misal biru untuk GDP
        const colCells = Array.from(table.querySelectorAll(`tbody tr td:nth-child(${colIndex + 1})`));

        colCells.forEach(td => {
          const valStr = td.dataset.heatmapValue;
          if (valStr === undefined) return;

          const val = parseFloat(valStr);
          if (isNaN(val)) return;

          let intensity;
          if (limit) {
            intensity = Math.min(Math.abs(val) / limit, 1);
          } else {
            intensity = 0.7; // fallback
          }

          let targetColor;
          if (val >= 0) {
            // kalau punya dncolor (misal GDP pakai biru), pakai itu
            targetColor = dnColor || defaultPosColor;
          } else {
            targetColor = defaultNegColor;
          }

          const finalColor = lerpColor(neutralColor, targetColor, intensity);

          const link = td.querySelector("a");
          if (link) {
            link.style.color = finalColor;
          } else {
            td.style.color = finalColor;
          }
        });
      });
    }

    // Load CSV & render + heatmap
    fetch(CSV_URL)
      .then(res => {
        if (!res.ok) throw new Error("Failed to load CSV");
        return res.text();
      })
      .then(text => {
        const rows = parseCSV(text);
        buildTable(rows);
        applyHeatmap(); // aktifkan heatmap sesudah data masuk
      })
      .catch(err => {
        console.error("Error loading macro matrix CSV:", err);
      });
  </script>
</body>
</html>
