<!DOCTYPE html> 
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Kuantara – Global Risk & Strength Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Fira Code -->
  <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;700&display=swap"/>

  <!-- ECharts -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

  <style>
    :root{
      --bg-root:#000000;
      --bg-main:#111111;
      --bg-panel:#111111;
      --bg-panel-soft:#151515;
      --border-soft:#2b2b2b;
      --text-main:#f5f5f5;
      --text-muted:#9b9b9b;
      --accent:#ffbf00;
      --danger:#ef4444;
      --success:#22c55e;

      --fs-title:16px;
      --fs-subtitle:12px;
      --fs-body:11px;
      --fs-small:10px;
    }

    *{
      box-sizing:border-box;
      margin:0;
      padding:0;
      font-family:"Fira Code",monospace;
    }

    body{
      min-height:100vh;
      background:radial-gradient(circle at top, #111111 0, #000000 55%, #000000 100%);
      color:var(--text-main);
      padding:16px;
      overflow-y:auto;
    }

    /* Scrollbar hitam transparan */
    body::-webkit-scrollbar{
      width:8px;
    }
    body::-webkit-scrollbar-track{
      background:transparent;
    }
    body::-webkit-scrollbar-thumb{
      background:rgba(0,0,0,0.6);
      border-radius:999px;
    }
    body{
      scrollbar-width:thin;
      scrollbar-color:rgba(0,0,0,0.6) transparent;
    }

    .page{
      max-width:1400px;
      margin:0 auto;
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .grid{
      display:grid;
      grid-template-columns:1.1fr 1.1fr;
      gap:14px;
    }

    .panel{
      background:linear-gradient(145deg, rgba(15,15,15,0.98), rgba(8,8,8,0.98));
      border-radius:14px;
      border:1px solid var(--border-soft);
      padding:10px 10px 6px;
      display:flex;
      flex-direction:column;
      gap:6px;
      box-shadow:0 18px 45px rgba(0,0,0,0.55);
      min-height:320px;
    }

    .panel-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
      margin-bottom:2px;
    }

    .panel-title{
      font-size:var(--fs-subtitle);
      font-weight:600;
      letter-spacing:0.12em;
      text-transform:uppercase;
    }

    .chart-holder{
      position:relative;
      width:100%;
      flex:1;
      min-height:260px;
    }

    .chart{
      width:100%;
      height:100%;
    }

    .error-msg{
      font-size:var(--fs-body);
      color:#fecaca;
      padding:4px 6px;
      border-radius:6px;
      background:rgba(127,29,29,0.35);
      border:1px solid rgba(248,113,113,0.6);
      margin-top:4px;
    }

    .loading{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:var(--fs-body);
      color:var(--text-muted);
      background:radial-gradient(circle at top, rgba(31,31,31,0.9), rgba(3,3,3,0.9));
      z-index:2;
    }

    .spinner{
      width:16px;
      height:16px;
      border-radius:999px;
      border:2px solid rgba(148,163,184,0.4);
      border-top-color:var(--accent);
      margin-right:8px;
      animation:spin 0.8s linear infinite;
    }

    @keyframes spin{
      to{transform:rotate(360deg);}
    }

    .controls{
      display:flex;
      gap:6px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
      margin-bottom:2px;
    }

    .control-label{
      font-size:var(--fs-small);
      color:var(--text-muted);
    }

    .control-select{
      background:#111111;
      color:var(--text-main);
      border-radius:6px;
      border:1px solid var(--border-soft);
      font-size:var(--fs-small);
      padding:2px 6px;
      outline:none;
    }

    @media(max-width:1100px){
      .grid{
        grid-template-columns:1fr;
      }
    }

    @media(max-width:640px){
      body{padding:10px;}
      .panel{padding:8px 8px 5px;}
    }
  </style>
</head>
<body>
<div class="page">

  <!-- TOP ROW -->
  <section class="grid">
    <!-- Panel 1: Gauge -->
    <section class="panel">
      <div class="panel-header">
        <div>
          <div class="panel-title">RISK-ON / RISK-OFF GAUGE</div>
        </div>
      </div>
      <div class="chart-holder">
        <div class="loading" id="gauge-loading">
          <div class="spinner"></div>
          <span>Menunggu stream Safe & Risk Assets…</span>
        </div>
        <div id="gauge-chart" class="chart"></div>
      </div>
      <div id="gauge-error" class="error-msg" style="display:none;"></div>
    </section>

    <!-- Panel 2: Risk/Safe Netflow -->
    <section class="panel">
      <div class="panel-header">
        <div>
          <div class="panel-title">RISK / SAFE NETFLOW PROXY</div>
        </div>
      </div>
      <div class="chart-holder">
        <div class="loading" id="bars-loading">
          <div class="spinner"></div>
          <span>Menunggu update basket ETF…</span>
        </div>
        <div id="bars-chart" class="chart"></div>
      </div>
      <div id="bars-error" class="error-msg" style="display:none;"></div>
    </section>
  </section>

  <!-- MIDDLE ROW -->
  <section class="grid">
    <!-- Panel 3: Market Phase Dynamics -->
    <section class="panel">
      <div class="panel-header">
        <div>
          <div class="panel-title">MARKET PHASE DYNAMICS</div>
        </div>
      </div>
      <div class="chart-holder">
        <div class="loading" id="phase-loading">
          <div class="spinner"></div>
          <span>Menunggu stream Market Phase…</span>
        </div>
        <div id="phase-chart" class="chart"></div>
      </div>
      <div id="phase-error" class="error-msg" style="display:none;"></div>
    </section>

    <!-- Panel 4: Sector Capital-Flow Snapshot -->
    <section class="panel">
      <div class="panel-header">
        <div>
          <div class="panel-title">US SECTORS</div>
        </div>
      </div>
      <div class="chart-holder">
        <div class="loading" id="sector-loading">
          <div class="spinner"></div>
          <span>Menunggu stream sektor & macro ETFs…</span>
        </div>
        <div id="sector-chart" class="chart"></div>
      </div>
      <div id="sector-error" class="error-msg" style="display:none;"></div>
    </section>
  </section>

  <!-- THIRD ROW: Relative change & DM/EM -->
  <section class="grid">
    <!-- Panel 5: Relative Change — Bench / Macro only -->
    <section class="panel">
      <div class="panel-header">
        <div>
          <div class="panel-title">BENCHMARK / MACRO</div>
        </div>
        <div class="controls">
          <span class="control-label">Group:</span>
          <!-- Sectors dihapus dari dropdown -->
          <select id="rel-select" class="control-select">
            <option value="Benchmarks">Benchmarks</option>
            <option value="Macro">Macro</option>
          </select>
        </div>
      </div>
      <div class="chart-holder">
        <div class="loading" id="rel-loading">
          <div class="spinner"></div>
          <span>Menunggu data kelompok terpilih…</span>
        </div>
        <div id="rel-chart" class="chart"></div>
      </div>
      <div id="rel-error" class="error-msg" style="display:none;"></div>
    </section>

    <!-- Panel 6: DM vs EM Hourly % Change -->
    <section class="panel">
      <div class="panel-header">
        <div>
          <div class="panel-title">DM vs EM</div>
        </div>
        <div class="controls">
          <span class="control-label">Group:</span>
          <select id="dm-group" class="control-select">
            <option value="ALL">ALL</option>
            <option value="DM">DM only</option>
            <option value="EM">EM only</option>
          </select>
          <span class="control-label">Sort:</span>
          <select id="dm-order" class="control-select">
            <option value="DESC">Top ↓</option>
            <option value="ASC">Bottom ↑</option>
          </select>
        </div>
      </div>
      <div class="chart-holder">
        <div class="loading" id="dm-loading">
          <div class="spinner"></div>
          <span>Menunggu stream Developed & Emerging Markets…</span>
        </div>
        <div id="dm-chart" class="chart"></div>
      </div>
      <div id="dm-error" class="error-msg" style="display:none;"></div>
    </section>
  </section>

  <!-- FOURTH ROW: FOREX / COMMODITIES (2 panels) -->
  <section class="grid">
    <!-- Panel 7: Forex Strength Meter -->
    <section class="panel">
      <div class="panel-header">
        <div>
          <div class="panel-title">FOREX STRENGTH METER</div>
        </div>
      </div>
      <div class="chart-holder">
        <div class="loading" id="fx-loading">
          <div class="spinner"></div>
          <span>Menunggu stream FX indices…</span>
        </div>
        <div id="fx-chart" class="chart"></div>
      </div>
      <div id="fx-error" class="error-msg" style="display:none;"></div>
    </section>

    <!-- Panel 8: Commodities Strength Meter -->
    <section class="panel">
      <div class="panel-header">
        <div>
          <div class="panel-title">COMMODITIES STRENGTH METER</div>
        </div>
      </div>
      <div class="chart-holder">
        <div class="loading" id="comdt-loading">
          <div class="spinner"></div>
          <span>Menunggu stream futures komoditas…</span>
        </div>
        <div id="comdt-chart" class="chart"></div>
      </div>
      <div id="comdt-error" class="error-msg" style="display:none;"></div>
    </section>
  </section>
</div>

<script>
// ================== WEBSOCKET ENDPOINTS ==================
const WS_ENDPOINTS = {
  safe_haven:        "ws://kuancloud.loclx.io/api/tv_stream/stream/trades/safe_haven",
  risk_assets:       "ws://kuancloud.loclx.io/api/tv_stream/stream/trades/risk_assets",
  market_phase:      "ws://kuancloud.loclx.io/api/tv_stream/stream/trades/market_phase",
  us_sectors:        "ws://kuancloud.loclx.io/api/tv_stream/stream/trades/us_sectors",
  benchmarks:        "ws://kuancloud.loclx.io/api/tv_stream/stream/trades/benchmarks",
  macro:             "ws://kuancloud.loclx.io/api/tv_stream/stream/trades/macro",
  developed_markets: "ws://kuancloud.loclx.io/api/tv_stream/stream/trades/developed_markets",
  emerging_markets:  "ws://kuancloud.loclx.io/api/tv_stream/stream/trades/emerging_markets",
  fx_indices:        "ws://kuancloud.loclx.io/api/tv_stream/stream/trades/fx_indices",
  commodities:       "ws://kuancloud.loclx.io/api/tv_stream/stream/trades/commodities_futures"
};

// ================== CONFIG MAPS (SAMA DENGAN YANG KAMU PAKAI) ==================

// Risk gauge / netflow basket
const SAFE_HAVEN  = ["GLD","FXY","FXF","UUP"];
const RISK_ASSETS = ["IBIT","QQQ","SPY","EEM"];

// Market Phase assets
const PHASE_ASSETS = {
  "Cash (UUP)":"UUP",
  "Bonds (BND)":"BND",
  "Stocks (QQQ)":"QQQ",
  "Commodities (DBC)":"DBC"
};

// Sector / Bench / Macro
const SECTORS = {
  "XLB":"Materials","XLE":"Energy","XLF":"Financials","XLI":"Industrials","XLK":"Technology",
  "XLP":"Consumer Staples","XLU":"Utilities","XLV":"Health Care","XLY":"Consumer Discretionary",
  "XLRE":"Real Estate","XLC":"Communication Services"
};
const BENCH = {
  "SPY":"S&P 500","QQQ":"Nasdaq 100","IWM":"Russell 2000","IWF":"Russell 1000 Growth","IWD":"Russell 1000 Value"
};
const MACRO = {
  "HYG":"High Yield Credit","LQD":"IG Credit","TLT":"US 20Y+ Treasury","UUP":"US Dollar Index ETF",
  "GLD":"Gold","USO":"WTI Oil","XOP":"Oil & Gas E&P","ARKK":"High Beta Innovation"
};

// DM vs EM meta (hourly % change)
const DMEM_META = {
  // DM
  "SPY": {name:"S&P 500 (SPY)",       cls:"DM"},
  "QQQ": {name:"NASDAQ 100 (QQQ)",    cls:"DM"},
  "DIA": {name:"Dow Jones (DIA)",     cls:"DM"},
  "VGK": {name:"Europe (VGK)",        cls:"DM"},
  "EWG": {name:"Germany (EWG)",       cls:"DM"},
  "EWQ": {name:"France (EWQ)",        cls:"DM"},
  "EWU": {name:"UK (EWU)",            cls:"DM"},
  "EWL": {name:"Switzerland (EWL)",   cls:"DM"},
  "EWJ": {name:"Japan (EWJ)",         cls:"DM"},
  "EWA": {name:"Australia (EWA)",     cls:"DM"},
  "EWC": {name:"Canada (EWC)",        cls:"DM"},
  "EWS": {name:"Singapore (EWS)",     cls:"DM"},
  // EM
  "EEM":  {name:"EM Broad (EEM)",         cls:"EM"},
  "VWO":  {name:"EM Broad (VWO)",         cls:"EM"},
  "FXI":  {name:"China Large (FXI)",      cls:"EM"},
  "MCHI": {name:"China Broad (MCHI)",     cls:"EM"},
  "KWEB": {name:"China Internet (KWEB)",  cls:"EM"},
  "INDA": {name:"India (INDA)",           cls:"EM"},
  "EWT":  {name:"Taiwan (EWT)",           cls:"EM"},
  "EWZ":  {name:"Brazil (EWZ)",           cls:"EM"},
  "EWW":  {name:"Mexico (EWW)",           cls:"EM"},
  "EZA":  {name:"South Africa (EZA)",     cls:"EM"},
  "THD":  {name:"Thailand (THD)",         cls:"EM"},
  "EIDO": {name:"Indonesia (EIDO)",       cls:"EM"},
  "EWM":  {name:"Malaysia (EWM)",         cls:"EM"}
};

// Forex indices
const FX_INDEX_TV = {
  "USD":"TVC:DXY",
  "EUR":"TVC:EXY",
  "JPY":"TVC:JXY",
  "GBP":"TVC:BXY",
  "AUD":"TVC:AXY",
  "NZD":"TVC:ZXY",
  "CAD":"TVC:CXY",
  "CHF":"TVC:SXY"
};

// Commodities futures
const COMDT_TV = {
  "Gold":"COMEX:GC1!",
  "Silver":"COMEX:SI1!",
  "Copper":"COMEX:HG1!",
  "WTI Crude":"NYMEX:CL1!",
  "Brent Crude":"ICEEUR:BRN1!",
  "NatGas":"NYMEX:NG1!",
  "Gasoline":"NYMEX:RB1!",
  "HeatingOil":"NYMEX:HO1!",
  "Platinum":"NYMEX:PL1!",
  "Palladium":"NYMEX:PA1!",
  "Corn":"CBOT:ZC1!",
  "Wheat":"CBOT:ZW1!",
  "Soybeans":"CBOT:ZS1!",
  "Sugar":"ICEUS:SB1!",
  "Coffee":"ICEUS:KC1!",
  "Cotton":"ICEUS:CT1!"
};

const FX_AXIS_MIN = -2;
const FX_AXIS_MAX =  2;
const CLIP_PCT = 0.05;

// DM/EM color palettes
const DM_COLORS = ["#60a5fa","#3b82f6","#2563eb","#1d4ed8","#1e40af"];
const EM_COLORS = ["#fb7185","#f97316","#22c55e","#eab308","#ec4899"];

// ================== GLOBAL STATE ==================
const state = {
  safe: {},   // GLD, FXY, FXF, UUP
  risk: {},   // IBIT, QQQ, SPY, EEM
  phase: {},  // UUP,BND,QQQ,DBC
  sectors: {},
  bench: {},
  macro: {},
  dmem: {},   // ticker -> {chg, cls, name}
  fxByCcy: {}, // ccy -> change
  comdt: {}   // symbol -> change
};

// Chart instances
let gaugeChartInstance   = null;
let barsChartInstance    = null;
let phaseChartInstance   = null;
let sectorChartInstance  = null;
let relChartInstance     = null;
let dmChartInstance      = null;
let fxChartInstance      = null;
let comdtChartInstance   = null;

// ================== HELPERS ==================
function formatWIB() {
  const now = new Date();
  const opts = {
    timeZone: "Asia/Jakarta",
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
    hour: "2-digit",
    minute: "2-digit",
    hour12: false
  };
  const s = now.toLocaleString("en-GB", opts); // 28/11/2025, 17:09
  const [d, m, yTime] = s.split("/");
  const [y, timePart] = yTime.split(", ");
  return `${y}-${m}-${d} ${timePart} WIB`;
}

function avg(arr) {
  if (!arr.length) return NaN;
  return arr.reduce((a,b)=>a+b,0)/arr.length;
}

// normalisasi simbol dari WS
function normalizeSymbol(symbol) {
  if (!symbol) return null;
  // TVC & futures: keep full
  if (/^(TVC|COMEX|NYMEX|CBOT|ICEUS|ICEEUR):/.test(symbol)) {
    return symbol;
  }
  if (symbol.includes(":")) {
    return symbol.split(":")[1];
  }
  return symbol;
}

// parse payload dari WS (JSON atau string log)
function parseWsPayload(raw) {
  if (raw == null) return null;

  if (typeof raw === "string") {
    const text = raw.trim();
    // coba JSON dulu
    if (text.startsWith("{") || text.startsWith("[")) {
      try {
        const obj = JSON.parse(text);
        if (obj && obj.symbol && typeof obj.change !== "undefined") {
          return {symbol: obj.symbol, change: Number(obj.change)};
        }
      } catch {}
    }
    // fallback parsing log string
    // contoh: [ts] fx TVC:CXY change=+0.160
    const re = /([A-Z]{2,6}:[A-Z0-9!]+|[A-Z0-9!]+)\s+change=([+\-]?\d+(\.\d+)?)/;
    const m = text.match(re);
    if (m) {
      return {symbol: m[1], change: parseFloat(m[2])};
    }
    return null;
  }

  // kalau server kirim object langsung
  try {
    if (raw.symbol && typeof raw.change !== "undefined") {
      return {symbol: raw.symbol, change: Number(raw.change)};
    }
  } catch {}
  return null;
}

// risk score (0–100) dari map {ticker -> change%}
function computeRiskScoreFromMaps() {
  const riskVals = RISK_ASSETS
    .map(t => state.risk[t])
    .filter(v => typeof v === "number" && !Number.isNaN(v));
  const safeVals = SAFE_HAVEN
    .map(t => state.safe[t])
    .filter(v => typeof v === "number" && !Number.isNaN(v));

  if (!riskVals.length || !safeVals.length) return null;

  const riskMean = avg(riskVals);
  const safeMean = avg(safeVals);

  let rawScore = (riskMean - safeMean)/100.0;
  rawScore = Math.max(-CLIP_PCT, Math.min(CLIP_PCT, rawScore));
  const scaled_pm100 = (rawScore / CLIP_PCT) * 100.0;
  const riskScore = (scaled_pm100 + 100.0)/2.0;

  return { riskScore, riskMean, safeMean };
}

function statusFromScore(score) {
  if (score >= 70) {
    return {text:"RISK-ON",  color:"#22c55e"};
  } else if (score <= 30) {
    return {text:"RISK-OFF", color:"#ef4444"};
  } else {
    return {text:"NEUTRAL",  color:"#facc15"};
  }
}

function hideLoading(id) {
  const el = document.getElementById(id);
  if (el) el.style.display = "none";
}

function showError(id, msg) {
  const el = document.getElementById(id);
  if (el) {
    el.style.display = "block";
    el.textContent = msg;
  }
}

// ================== ECHARTS RENDERERS ==================
function renderGaugeAndBars() {
  const metrics = computeRiskScoreFromMaps();
  const gaugeLoadingId = "gauge-loading";
  const barsLoadingId  = "bars-loading";

  if (!metrics) {
    // belum cukup data
    return;
  }
  hideLoading(gaugeLoadingId);
  hideLoading(barsLoadingId);

  const {riskScore, riskMean, safeMean} = metrics;
  const {text:statusText, color:statusColor} = statusFromScore(riskScore);

  // Gauge
  const gaugeDom = document.getElementById("gauge-chart");
  if (!gaugeChartInstance) {
    gaugeChartInstance = echarts.init(gaugeDom);
    window.addEventListener("resize", ()=>gaugeChartInstance && gaugeChartInstance.resize());
  }

  const gaugeOption = {
    backgroundColor:"#111111",
    title:{
      text:"Sentiment Gauge",
      subtext:`Risk basket: ${riskMean.toFixed(2)}% | Safe basket: ${safeMean.toFixed(2)}%`,
      left:"center",
      top:6,
      textStyle:{color:"#f5f5f5", fontSize:14},
      subtextStyle:{color:"#9b9b9b", fontSize:11}
    },
    tooltip:{formatter:(p)=>`Score: ${p.value.toFixed(1)}`},
    series:[{
      type:"gauge",
      startAngle:180,
      endAngle:0,
      min:0,
      max:100,
      radius:"90%",
      center:["50%","60%"],
      axisLine:{
        lineStyle:{
          width:14,
          color:[
            [0.3,"#4b1f1f"],
            [0.7,"#3b3b3b"],
            [1.0,"#1f3b1f"]
          ]
        }
      },
      splitLine:{show:false},
      axisTick:{show:false},
      axisLabel:{color:"#e5e5e5"},
      pointer:{
        length:"60%",
        width:4,
        itemStyle:{color:statusColor}
      },
      detail:{
        formatter:(v)=>`Score: ${v.toFixed(1)}/100`,
        color:"#f5f5f5",
        fontSize:12,
        offsetCenter:[0,"65%"]
      },
      itemStyle:{color:statusColor},
      data:[{value:riskScore, name:statusText}]
    }],
    graphic:[
      {
        type:"text",
        left:"center",
        top:"68%",
        style:{
          text:statusText,
          fill:statusColor,
          fontSize:28,
          fontWeight:700
        }
      },
      {
        type:"text",
        left:"center",
        top:"82%",
        style:{
          text:`Updated: ${formatWIB()}`,
          fill:"#9b9b9b",
          fontSize:11
        }
      }
    ]
  };
  gaugeChartInstance.setOption(gaugeOption, true);

  // Bars (Risk/Safe)
  const dom = document.getElementById("bars-chart");
  if (!barsChartInstance) {
    barsChartInstance = echarts.init(dom);
    window.addEventListener("resize", ()=>barsChartInstance && barsChartInstance.resize());
  }

  const categories = [...SAFE_HAVEN, ...RISK_ASSETS];
  const safeData = categories.map(t => SAFE_HAVEN.includes(t) ? (typeof state.safe[t]==="number"?state.safe[t]:null) : null);
  const riskData = categories.map(t => RISK_ASSETS.includes(t) ? (typeof state.risk[t]==="number"?state.risk[t]:null) : null);
  const riskVals = RISK_ASSETS.map(t=>state.risk[t]).filter(v=>typeof v==="number" && !Number.isNaN(v));
  const safeVals = SAFE_HAVEN.map(t=>state.safe[t]).filter(v=>typeof v==="number" && !Number.isNaN(v));
  const delta = riskVals.length && safeVals.length ? (avg(riskVals)-avg(safeVals)) : NaN;

  const barsOption = {
    backgroundColor:"#111111",
    tooltip:{trigger:"axis"},
    legend:{
      data:["Safe Haven","Risk Asset"],
      top:6,
      textStyle:{color:"#f5f5f5", fontSize:11}
    },
    grid:{left:70,right:16,top:40,bottom:40},
    xAxis:{
      type:"value",
      name:"1H Return (%)",
      axisLine:{lineStyle:{color:"#a3a3a3"}},
      axisLabel:{color:"#e5e5e5"},
      splitLine:{lineStyle:{color:"rgba(255,255,255,0.08)"}}
    },
    yAxis:{
      type:"category",
      data:categories,
      axisLine:{lineStyle:{color:"#a3a3a3"}},
      axisLabel:{color:"#e5e5e5"}
    },
    series:[
      {
        name:"Safe Haven",
        type:"bar",
        data:safeData,
        itemStyle:{color:"#60a5fa"}
      },
      {
        name:"Risk Asset",
        type:"bar",
        data:riskData,
        itemStyle:{color:"#fb7185"}
      }
    ],
    graphic:[{
      type:"text",
      left:"right",
      top:6,
      style:{
        text:`ΔRisk − Safe: ${Number.isFinite(delta) ? delta.toFixed(2) : "NaN"} pts · ${formatWIB()}`,
        fill:"#9b9b9b",
        fontSize:10
      }
    }]
  };

  barsChartInstance.setOption(barsOption, true);
}

function renderPhaseSnapshot() {
  const elLoading = "phase-loading";
  const elError   = "phase-error";

  // Ambil data dari state.phase sesuai PHASE_ASSETS
  const entries = Object.entries(PHASE_ASSETS).map(([label, tkr]) => {
    const val = state.phase[tkr];
    return { label, value: typeof val === "number" ? val : null };
  }).filter(r => r.value !== null);

  if (!entries.length) return;

  hideLoading(elLoading);

  const dom = document.getElementById("phase-chart");
  if (!phaseChartInstance) {
    phaseChartInstance = echarts.init(dom);
    window.addEventListener("resize", ()=>phaseChartInstance && phaseChartInstance.resize());
  }

  const labels = entries.map(e => e.label);
  const values = entries.map(e => e.value);

  // Cari range untuk radar (symmetrical min/max biar visual balance)
  const maxAbs = Math.max(
    1,
    Math.ceil(Math.max(...values.map(v => Math.abs(v))) || 1)
  );

  const option = {
    backgroundColor: "#111111",
    title: {
      text: "Market Phase Radar",
      subtext: "Cash vs Bonds vs Stocks vs Commodities – 1H Δ %",
      left: "center",
      top: 4,
      textStyle: { color: "#f5f5f5", fontSize: 13 },
      subtextStyle: { color: "#9b9b9b", fontSize: 11 }
    },
    tooltip: {
      trigger: "item",
      formatter: () => {
        const lines = entries.map((e, i) =>
          `${e.label}: ${values[i].toFixed(2)}%`
        );
        return `Market Phase 1H Change<br/>` + lines.join("<br/>");
      }
    },
    radar: {
      shape: "circle",
      radius: "70%",
      splitNumber: 4,
      center: ["50%", "55%"],
      axisNameGap: 8,
      indicator: labels.map(l => ({
        name: l,
        max: maxAbs,
        min: -maxAbs
      })),
      axisName: {
        color: "#e5e5e5",
        fontSize: 11
      },
      splitArea: {
        areaStyle: {
          color: [
            "rgba(148,163,184,0.02)",
            "rgba(148,163,184,0.04)",
            "rgba(148,163,184,0.06)",
            "rgba(148,163,184,0.08)"
          ]
        }
      },
      splitLine: {
        lineStyle: {
          color: "rgba(148,163,184,0.25)"
        }
      },
      axisLine: {
        lineStyle: {
          color: "rgba(148,163,184,0.3)"
        }
      }
    },
    series: [
      {
        name: "Market Phase 1H",
        type: "radar",
        data: [
          {
            value: values,
            areaStyle: {
              color: "rgba(255,191,0,0.20)"
            },
            lineStyle: {
              color: "#ffbf00",
              width: 2
            },
            itemStyle: {
              color: "#ffbf00",
              borderColor: "#000000",
              borderWidth: 1.5
            },
            label: {
              show: true,
              formatter: (p) => `${p.value.toFixed(2)}%`,
              color: "#f5f5f5",
              fontSize: 9
            }
          }
        ]
      }
    ],
    graphic: [
      {
        type: "text",
        left: "right",
        top: 6,
        style: {
          text: `Updated: ${formatWIB()}`,
          fill: "#9b9b9b",
          fontSize: 10
        }
      }
    ]
  };

  phaseChartInstance.setOption(option, true);
}

function renderSectorSnapshot() {
  const elLoading = "sector-loading";

  // Ambil hanya SECTORS (tanpa bench & macro)
  const rows = [];
  Object.keys(SECTORS).forEach(ticker => {
    const v = state.sectors[ticker];
    if (typeof v === "number" && !Number.isNaN(v)) {
      rows.push({
        ticker,
        name: SECTORS[ticker],
        val: v
      });
    }
  });

  if (!rows.length) return;

  hideLoading(elLoading);

  // Sort dari paling kuat ke paling lemah (optional, biar enak dibaca)
  rows.sort((a, b) => b.val - a.val);

  const dom = document.getElementById("sector-chart");
  if (!sectorChartInstance) {
    sectorChartInstance = echarts.init(dom);
    window.addEventListener("resize", () => sectorChartInstance && sectorChartInstance.resize());
  }

  const tickers = rows.map(r => r.ticker);
  const labels  = rows.map(r => `${r.ticker} – ${r.name}`);
  const values  = rows.map(r => r.val);

  // Ambil benchmark SPY kalau ada
  const benchRet = (typeof state.bench["SPY"] === "number" && !Number.isNaN(state.bench["SPY"]))
    ? state.bench["SPY"]
    : null;

  const maxAbs = Math.max(
    1,
    Math.ceil(Math.max(...values.map(v => Math.abs(v))) || 1)
  );

  const subtitle = benchRet != null
    ? `Sector 1H change vs SPY (${benchRet.toFixed(2)}%)`
    : "Sector 1H change (SPY benchmark not available)";

  const option = {
    backgroundColor: "#111111",
    title: {
      text: "US Sectors – Bullet View",
      subtext: subtitle,
      left: "center",
      top: 4,
      textStyle: { color: "#f5f5f5", fontSize: 13 },
      subtextStyle: { color: "#9b9b9b", fontSize: 11 }
    },
    tooltip: {
      trigger: "axis",
      axisPointer: { type: "shadow" },
      formatter: (params) => {
        const bar = params.find(p => p.seriesName === "Sector") || params[0];
        const idx = bar.dataIndex;
        const row = rows[idx];
        let text = `<b>${row.ticker} – ${row.name}</b><br/>Δ 1H: ${row.val.toFixed(2)}%`;
        if (benchRet != null) {
          const spread = row.val - benchRet;
          text += `<br/>SPY: ${benchRet.toFixed(2)}%<br/>Spread vs SPY: ${spread.toFixed(2)} pts`;
        }
        return text;
      }
    },
    grid: { left: 110, right: 24, top: 50, bottom: 40 },
    xAxis: {
      type: "value",
      name: "1H Change (%)",
      min: -maxAbs,
      max: maxAbs,
      axisLine: { lineStyle: { color: "#a3a3a3" } },
      axisLabel: { color: "#e5e5e5" },
      splitLine: { lineStyle: { color: "rgba(255,255,255,0.08)" } }
    },
    yAxis: {
      type: "category",
      data: labels,
      axisLine: { lineStyle: { color: "#a3a3a3" } },
      axisLabel: { color: "#e5e5e5" }
    },
    series: [
      // MAIN BULLET BAR
      {
        name: "Sector",
        type: "bar",
        data: values,
        barWidth: 8,
        itemStyle: {
          color: (p) => p.value >= 0 ? "#22c55e" : "#ef4444"
        },
        label: {
          show: true,
          position: "right",
          formatter: (p) => `${p.value.toFixed(2)}%`,
          color: "#f5f5f5",
          fontSize: 10
        },
        z: 1
      },
      // BENCHMARK MARKER (SPY) – VERTICAL BULLET
      benchRet != null ? {
        name: "SPY Benchmark",
        type: "scatter",
        data: rows.map((r) => ({
          value: [benchRet, `${r.ticker} – ${r.name}`]
        })),
        symbol: "rect",
        symbolSize: [4, 16],
        itemStyle: {
          color: "#ffbf00",
          borderColor: "#000000",
          borderWidth: 1
        },
        z: 2
      } : {}
    ].filter(Boolean),
    graphic: [
      {
        type: "text",
        left: "right",
        top: 6,
        style: {
          text: `Updated: ${formatWIB()} · Bullet vs SPY`,
          fill: "#9b9b9b",
          fontSize: 10
        }
      }
    ]
  };

  sectorChartInstance.setOption(option, true);
}

function renderRelGroup() {
  const groupKey = document.getElementById("rel-select").value;
  const elLoading = "rel-loading";
  const elError   = "rel-error";

  let mapping;
  let valuesMap;

  if (groupKey === "Benchmarks") {
    mapping  = BENCH;
    valuesMap = state.bench;
  } else if (groupKey === "Macro") {
    mapping  = MACRO;
    valuesMap = state.macro;
  } else {
    // fallback default: Benchmarks (Sectors dihapus supaya tidak double)
    mapping  = BENCH;
    valuesMap = state.bench;
  }

  const rows = [];
  Object.entries(mapping).forEach(([ticker, label])=>{
    const v = valuesMap[ticker];
    if (typeof v === "number") {
      rows.push({ticker, label, val:v});
    }
  });

  if (!rows.length) {
    return;
  }

  hideLoading(elLoading);

  rows.sort((a,b)=>a.val - b.val); // bottom to top

  const names = rows.map(r=>`${r.ticker} – ${r.label}`);
  const vals  = rows.map(r=>r.val);

  const dom = document.getElementById("rel-chart");
  if (!relChartInstance) {
    relChartInstance = echarts.init(dom);
    window.addEventListener("resize", ()=>relChartInstance && relChartInstance.resize());
  }

  const option = {
    backgroundColor:"#111111",
    tooltip:{
      trigger:"axis",
      axisPointer:{type:"shadow"},
      formatter:(params)=>{
        const p = params[0];
        return `${p.name}<br/>1H Δ: ${p.value.toFixed(2)}%`;
      }
    },
    grid:{left:140,right:16,top:30,bottom:35},
    xAxis:{
      type:"value",
      name:"1H Change (%)",
      axisLine:{lineStyle:{color:"#a3a3a3"}},
      axisLabel:{color:"#e5e5e5"},
      splitLine:{lineStyle:{color:"rgba(255,255,255,0.08)"}}
    },
    yAxis:{
      type:"category",
      data:names,
      axisLine:{lineStyle:{color:"#a3a3a3"}},
      axisLabel:{color:"#e5e5e5"}
    },
    series:[{
      type:"bar",
      data:vals,
      itemStyle:{
        color:(p)=> p.value >= 0 ? "#22c55e" : "#ef4444"
      }
    }],
    graphic:[{
      type:"text",
      left:"right",
      top:6,
      style:{
        text:`Updated: ${formatWIB()} · Group: ${groupKey}`,
        fill:"#9b9b9b",
        fontSize:10
      }
    }]
  };

  relChartInstance.setOption(option, true);
}

function renderDMEM() {
  const elLoading = "dm-loading";
  const groupSel = document.getElementById("dm-group").value;
  const orderSel = document.getElementById("dm-order").value;

  let rows = Object.entries(state.dmem).map(([ticker, info])=>({
    ticker,
    name:info.name,
    cls:info.cls,
    chg:info.chg
  }));

  if (groupSel === "DM") {
    rows = rows.filter(r=>r.cls === "DM");
  } else if (groupSel === "EM") {
    rows = rows.filter(r=>r.cls === "EM");
  }

  if (!rows.length) return;

  hideLoading(elLoading);

  rows.sort((a,b)=> orderSel === "ASC" ? a.chg - b.chg : b.chg - a.chg);

  let dmIdx=0, emIdx=0;
  rows.forEach(r=>{
    if (r.cls === "DM") {
      r.color = DM_COLORS[dmIdx % DM_COLORS.length];
      dmIdx++;
    } else {
      r.color = EM_COLORS[emIdx % EM_COLORS.length];
      emIdx++;
    }
  });

  const names = rows.map(r=>r.name);
  const dataItems = rows.map(r=>({
    value:r.chg,
    name:r.name,
    itemStyle:{color:r.color}
  }));

  const dom = document.getElementById("dm-chart");
  if (!dmChartInstance) {
    dmChartInstance = echarts.init(dom);
    window.addEventListener("resize", ()=>dmChartInstance && dmChartInstance.resize());
  }

  const option = {
    backgroundColor:"#111111",
    tooltip:{
      trigger:"axis",
      axisPointer:{type:"shadow"},
      formatter:(params)=>{
        const p = params[0];
        const idx = p.dataIndex;
        const row = rows[idx];
        return `<b>${row.name}</b><br/>Δ 1H: ${row.chg.toFixed(2)}%<br/>Ticker: ${row.ticker}<br/>Class: ${row.cls}`;
      }
    },
    grid:{left:180,right:16,top:40,bottom:40},
    xAxis:{
      type:"value",
      name:"1H Change (%)",
      axisLine:{lineStyle:{color:"#a3a3a3"}},
      axisLabel:{color:"#e5e5e5"},
      splitLine:{lineStyle:{color:"rgba(255,255,255,0.08)"}}
    },
    yAxis:{
      type:"category",
      data:names,
      axisLine:{lineStyle:{color:"#a3a3a3"}},
      axisLabel:{color:"#e5e5e5"}
    },
    series:[{
      type:"bar",
      data:dataItems,
      label:{
        show:true,
        position:"right",
        formatter:(p)=> `${p.value.toFixed(2)}%`,
        color:"#f5f5f5",
        fontSize:10
      }
    }],
    graphic:[{
      type:"text",
      left:"right",
      top:6,
      style:{
        text:`Updated: ${formatWIB()} · 1H change`,
        fill:"#9b9b9b",
        fontSize:10
      }
    }]
  };

  dmChartInstance.setOption(option, true);
}

function renderForex() {
  const elLoading = "fx-loading";
  const rows = Object.entries(FX_INDEX_TV).map(([ccy, symbol])=>{
    const val = state.fxByCcy[ccy];
    if (typeof val !== "number") return null;
    return {ccy, ret:val};
  }).filter(Boolean);

  if (!rows.length) return;

  hideLoading(elLoading);

  const dom = document.getElementById("fx-chart");
  if (!fxChartInstance) {
    fxChartInstance = echarts.init(dom);
    window.addEventListener("resize", ()=>fxChartInstance && fxChartInstance.resize());
  }

  const sorted = rows.slice().sort((a,b)=>a.ret - b.ret);
  const vals = sorted.map(r=>r.ret);
  const labs = sorted.map(r=>r.ccy);
  const asof = formatWIB();

  const option = {
    backgroundColor:"#111111",
    title:{
      text:"Forex Strength Meter",
      subtext:`1H % change vs prior close · as of ${asof}`,
      left:"center",
      top:4,
      textStyle:{color:"#f5f5f5", fontSize:13},
      subtextStyle:{color:"#9b9b9b", fontSize:11}
    },
    tooltip:{
      trigger:"axis",
      axisPointer:{type:"shadow"},
      formatter:(params)=>{
        const p = params[0];
        return `${p.name}<br/>Return 1H: ${p.value.toFixed(2)}%`;
      }
    },
    grid:{left:60,right:20,top:52,bottom:30},
    xAxis:{
      type:"value",
      name:"Return 1H (%)",
      min:FX_AXIS_MIN,
      max:FX_AXIS_MAX,
      axisLine:{lineStyle:{color:"#a3a3a3"}},
      axisLabel:{color:"#e5e5e5"},
      splitLine:{lineStyle:{color:"rgba(255,255,255,0.08)"}}
    },
    yAxis:{
      type:"category",
      data:labs,
      axisLine:{lineStyle:{color:"#a3a3a3"}},
      axisLabel:{color:"#e5e5e5"}
    },
    visualMap:{
      show:false,
      min:FX_AXIS_MIN,
      max:FX_AXIS_MAX,
      dimension:0,
      inRange:{
        color:["#b91c1c","#f97316","#fde68a","#4ade80","#16a34a"]
      }
    },
    series:[{
      type:"bar",
      data:vals,
      label:{
        show:true,
        position:"right",
        formatter:(p)=>`${p.value.toFixed(2)}%`,
        color:"#f5f5f5",
        fontSize:10
      }
    }]
  };

  fxChartInstance.setOption(option, true);
}

function renderCommodities() {
  const elLoading = "comdt-loading";
  const rows = [];
  Object.entries(COMDT_TV).forEach(([name, symbol])=>{
    const v = state.comdt[symbol];
    if (typeof v === "number") {
      rows.push({name, ret:v});
    }
  });

  if (!rows.length) return;

  hideLoading(elLoading);

  const dom = document.getElementById("comdt-chart");
  if (!comdtChartInstance) {
    comdtChartInstance = echarts.init(dom);
    window.addEventListener("resize", ()=>comdtChartInstance && comdtChartInstance.resize());
  }

  const sorted = rows.slice().sort((a,b)=>a.ret - b.ret);
  const vals = sorted.map(r=>r.ret);
  const labs = sorted.map(r=>r.name);
  const maxAbs = Math.max(5, Math.ceil(Math.max(...vals.map(v=>Math.abs(v)) || [5])));
  const asof = formatWIB();

  const option = {
    backgroundColor:"#111111",
    title:{
      text:"Commodities Strength Meter",
      subtext:`1H % change vs prior close · as of ${asof}`,
      left:"center",
      top:4,
      textStyle:{color:"#f5f5f5", fontSize:13},
      subtextStyle:{color:"#9b9b9b", fontSize:11}
    },
    tooltip:{
      trigger:"axis",
      axisPointer:{type:"shadow"},
      formatter:(params)=>{
        const p = params[0];
        return `${p.name}<br/>Return 1H: ${p.value.toFixed(2)}%`;
      }
    },
    grid:{left:90,right:20,top:52,bottom:30},
    xAxis:{
      type:"value",
      name:"Return 1H (%)",
      min:-maxAbs,
      max:maxAbs,
      axisLine:{lineStyle:{color:"#a3a3a3"}},
      axisLabel:{color:"#e5e5e5"},
      splitLine:{lineStyle:{color:"rgba(255,255,255,0.08)"}}
    },
    yAxis:{
      type:"category",
      data:labs,
      axisLine:{lineStyle:{color:"#a3a3a3"}},
      axisLabel:{color:"#e5e5e5"}
    },
    visualMap:{
      show:false,
      min:-maxAbs,
      max:maxAbs,
      dimension:0,
      inRange:{
        color:["#b91c1c","#f97316","#fde68a","#4ade80","#16a34a"]
      }
    },
    series:[{
      type:"bar",
      data:vals,
      label:{
        show:true,
        position:"right",
        formatter:(p)=>`${p.value.toFixed(2)}%`,
        color:"#f5f5f5",
        fontSize:10
      }
    }]
  };

  comdtChartInstance.setOption(option, true);
}

// ================== WEBSOCKET SETUP ==================
function createWS(key, onPayload, errorId) {
  const url = WS_ENDPOINTS[key];
  if (!url) return;

  let ws = null;

  function connect() {
    try {
      ws = new WebSocket(url);
    } catch (e) {
      console.error("WS create error", key, e);
      if (errorId) showError(errorId, `WS error (${key}): ${e.message || e}`);
      return;
    }

    ws.onopen = () => {
      console.log("WS opened:", key);
    };

    ws.onmessage = (event) => {
      const payload = parseWsPayload(event.data);
      if (!payload) return;
      onPayload(payload);
    };

    ws.onerror = (err) => {
      console.error("WS error", key, err);
      if (errorId) showError(errorId, `WS error (${key}) – lihat console log.`);
    };

    ws.onclose = () => {
      console.warn("WS closed, reconnecting:", key);
      setTimeout(connect, 5000);
    };
  }

  connect();
}

// ================== STREAM HANDLERS ==================
function setupSafeRiskWS() {
  // safe
  createWS("safe_haven", (pl)=>{
    const norm = normalizeSymbol(pl.symbol);
    if (!norm) return;
    if (!SAFE_HAVEN.includes(norm)) return;
    state.safe[norm] = pl.change;
    renderGaugeAndBars();
  }, "gauge-error");

  // risk
  createWS("risk_assets", (pl)=>{
    const norm = normalizeSymbol(pl.symbol);
    if (!norm) return;
    if (!RISK_ASSETS.includes(norm)) return;
    state.risk[norm] = pl.change;
    renderGaugeAndBars();
  }, "gauge-error");
}

function setupMarketPhaseWS() {
  createWS("market_phase", (pl)=>{
    const norm = normalizeSymbol(pl.symbol);
    if (!norm) return;
    // cari apakah simbol ini dipakai di PHASE_ASSETS
    const used = Object.values(PHASE_ASSETS);
    if (!used.includes(norm)) return;
    state.phase[norm] = pl.change;
    renderPhaseSnapshot();
  }, "phase-error");
}

function setupSectorBenchMacroWS() {
  createWS("us_sectors", (pl)=>{
    const norm = normalizeSymbol(pl.symbol);
    if (!norm || !(norm in SECTORS)) return;
    state.sectors[norm] = pl.change;
    renderSectorSnapshot();
    renderRelGroup();
  }, "sector-error");

  createWS("benchmarks", (pl)=>{
    const norm = normalizeSymbol(pl.symbol);
    if (!norm || !(norm in BENCH)) return;
    state.bench[norm] = pl.change;
    renderSectorSnapshot();
    renderRelGroup();
  }, "sector-error");

  createWS("macro", (pl)=>{
    const norm = normalizeSymbol(pl.symbol);
    if (!norm || !(norm in MACRO)) return;
    state.macro[norm] = pl.change;
    renderSectorSnapshot();
    renderRelGroup();
  }, "sector-error");
}

function setupDMEMWS() {
  createWS("developed_markets", (pl)=>{
    const norm = normalizeSymbol(pl.symbol);
    const meta = DMEM_META[norm];
    if (!meta || meta.cls !== "DM") return;
    state.dmem[norm] = {chg:pl.change, cls:meta.cls, name:meta.name};
    renderDMEM();
  }, "dm-error");

  createWS("emerging_markets", (pl)=>{
    const norm = normalizeSymbol(pl.symbol);
    const meta = DMEM_META[norm];
    if (!meta || meta.cls !== "EM") return;
    state.dmem[norm] = {chg:pl.change, cls:meta.cls, name:meta.name};
    renderDMEM();
  }, "dm-error");
}

function setupFXWS() {
  createWS("fx_indices", (pl)=>{
    const symbol = normalizeSymbol(pl.symbol); // untuk TVC kita keep full
    // mapping balik: symbol -> currency
    let foundCcy = null;
    Object.entries(FX_INDEX_TV).forEach(([ccy, s])=>{
      if (s === symbol) foundCcy = ccy;
    });
    if (!foundCcy) return;
    state.fxByCcy[foundCcy] = pl.change;
    renderForex();
  }, "fx-error");
}

function setupComdtWS() {
  createWS("commodities", (pl)=>{
    const symbol = normalizeSymbol(pl.symbol); // futures pakai full COMEX:GC1! dsb
    // hanya simpan kalau ada di mapping
    const exists = Object.values(COMDT_TV).includes(symbol);
    if (!exists) return;
    state.comdt[symbol] = pl.change;
    renderCommodities();
  }, "comdt-error");
}

// ================== INIT ==================
function initDashboardWS() {
  // attach listeners untuk panel rel & DM/EM
  document.getElementById("rel-select").addEventListener("change", ()=> {
    renderRelGroup();
  });
  document.getElementById("dm-group").addEventListener("change", ()=> {
    renderDMEM();
  });
  document.getElementById("dm-order").addEventListener("change", ()=> {
    renderDMEM();
  });

  setupSafeRiskWS();
  setupMarketPhaseWS();
  setupSectorBenchMacroWS();
  setupDMEMWS();
  setupFXWS();
  setupComdtWS();
}

initDashboardWS();
</script>
</body>
</html>
