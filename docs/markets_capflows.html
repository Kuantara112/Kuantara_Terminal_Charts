<!DOCTYPE html> 
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Kuantara – Global Risk & Strength Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Fira Code -->
  <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;700&display=swap"/>

  <!-- ECharts -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

  <style>
    :root{
      --bg-root:#000000;
      --bg-main:#111111;
      --bg-panel:#111111;
      --bg-panel-soft:#151515;
      --border-soft:#2b2b2b;
      --text-main:#f5f5f5;
      --text-muted:#9b9b9b;
      --accent:#ffbf00;
      --danger:#ef4444;
      --success:#22c55e;

      --fs-title:16px;
      --fs-subtitle:12px;
      --fs-body:11px;
      --fs-small:10px;
    }

    *{
      box-sizing:border-box;
      margin:0;
      padding:0;
      font-family:"Fira Code",monospace;
      /* GLOBAL SCROLLBAR: hitam transparan */
      scrollbar-width:thin;
      scrollbar-color:rgba(0,0,0,0.45) transparent;
    }

    /* Chrome / Edge / Safari – global scrollbar */
    *::-webkit-scrollbar{
      width:8px;
    }
    *::-webkit-scrollbar-track{
      background:transparent;
    }
    *::-webkit-scrollbar-thumb{
      background:rgba(0,0,0,0.45); /* hitam transparan */
      border-radius:999px;
    }
    *::-webkit-scrollbar-thumb:hover{
      background:rgba(0,0,0,0.65); /* sedikit lebih solid saat hover */
    }

    body{
      min-height:100vh;
      background:radial-gradient(circle at top, #111111 0, #000000 55%, #000000 100%);
      color:var(--text-main);
      padding:16px;
      overflow-y:auto;
    }

    .page{
      max-width:1400px;
      margin:0 auto;
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .grid{
      display:grid;
      grid-template-columns:1.1fr 1.1fr;
      gap:14px;
    }

    .panel{
      background:linear-gradient(145deg, rgba(15,15,15,0.98), rgba(8,8,8,0.98));
      border-radius:14px;
      border:1px solid var(--border-soft);
      padding:10px 10px 6px;
      display:flex;
      flex-direction:column;
      gap:6px;
      box-shadow:0 18px 45px rgba(0,0,0,0.55);
      min-height:320px;
    }

    .panel-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
      margin-bottom:2px;
    }

    .panel-title{
      font-size:var(--fs-subtitle);
      font-weight:600;
      letter-spacing:0.08em;
      /* tidak lagi uppercase */
      /* text-transform:uppercase; */
      color:var(--accent);
    }

    .chart-holder{
      position:relative;
      width:100%;
      flex:1;
      min-height:260px;
    }

    .chart{
      width:100%;
      height:100%;
    }

    .error-msg{
      font-size:var(--fs-body);
      color:#fecaca;
      padding:4px 6px;
      border-radius:6px;
      background:rgba(127,29,29,0.35);
      border:1px solid rgba(248,113,113,0.6);
      margin-top:4px;
    }

    .loading{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:var(--fs-body);
      color:var(--text-muted);
      background:radial-gradient(circle at top, rgba(31,31,31,0.9), rgba(3,3,3,0.9));
      z-index:2;
    }

    .spinner{
      width:16px;
      height:16px;
      border-radius:999px;
      border:2px solid rgba(148,163,184,0.4);
      border-top-color:var(--accent);
      margin-right:8px;
      animation:spin 0.8s linear infinite;
    }

    @keyframes spin{
      to{transform:rotate(360deg);}
    }

    .controls{
      display:flex;
      gap:6px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
      margin-bottom:2px;
    }

    .control-label{
      font-size:var(--fs-small);
      color:var(--text-muted);
    }

    .control-select{
      background:#111111;
      color:var(--text-main);
      border-radius:6px;
      border:1px solid var(--border-soft);
      font-size:var(--fs-small);
      padding:2px 6px;
      outline:none;
    }

    /* Info summary (dipakai FX & Commodities) */
    .fx-info{
      display:flex;
      flex-wrap:wrap;
      gap:8px 16px;
      font-size:var(--fs-small);
      color:var(--text-muted);
      margin-top:4px;
    }
    .fx-info strong{
      color:var(--text-main);
    }

    @media(max-width:1100px){
      .grid{
        grid-template-columns:1fr;
      }
    }

    @media(max-width:640px){
      body{padding:10px;}
      .panel{padding:8px 8px 5px;}
    }
  </style>
</head>
<body>
<div class="page">

  <!-- TOP ROW -->
  <section class="grid">
    <!-- Panel 1: Gauge -->
    <section class="panel">
      <div class="panel-header">
        <div>
          <div class="panel-title">Risk-On / Risk-Off Gauge</div>
        </div>
      </div>
      <div class="chart-holder">
        <div class="loading" id="gauge-loading">
          <div class="spinner"></div>
          <span>Menunggu stream Safe & Risk Assets…</span>
        </div>
        <div id="gauge-chart" class="chart"></div>
      </div>
      <div id="gauge-error" class="error-msg" style="display:none;"></div>
    </section>

    <!-- Panel 2: Risk/Safe Netflow -->
    <section class="panel">
      <div class="panel-header">
        <div>
          <div class="panel-title">Risk / Safe Netflow Proxy</div>
        </div>
      </div>
      <div class="chart-holder">
        <div class="loading" id="bars-loading">
          <div class="spinner"></div>
          <span>Menunggu update basket ETF…</span>
        </div>
        <div id="bars-chart" class="chart"></div>
      </div>
      <div id="bars-error" class="error-msg" style="display:none;"></div>
    </section>
  </section>

  <!-- MIDDLE ROW -->
  <section class="grid">
    <!-- Panel 3: Market Phase Dynamics -->
    <section class="panel">
      <div class="panel-header">
        <div>
          <div class="panel-title">Market Phase Dynamics</div>
        </div>
      </div>
      <div class="chart-holder">
        <div class="loading" id="phase-loading">
          <div class="spinner"></div>
          <span>Menunggu stream Market Phase…</span>
        </div>
        <div id="phase-chart" class="chart"></div>
      </div>
      <div id="phase-error" class="error-msg" style="display:none;"></div>
    </section>

    <!-- Panel 4: Sector Capital-Flow Snapshot -->
    <section class="panel">
      <div class="panel-header">
        <div>
          <div class="panel-title">US Sectors</div>
        </div>
      </div>
      <div class="chart-holder">
        <div class="loading" id="sector-loading">
          <div class="spinner"></div>
          <span>Menunggu stream sektor & macro ETFs…</span>
        </div>
        <div id="sector-chart" class="chart"></div>
      </div>
      <div id="sector-error" class="error-msg" style="display:none;"></div>
    </section>
  </section>

  <!-- THIRD ROW: Relative change & DM/EM -->
  <section class="grid">
    <!-- Panel 5: Relative Change — Bench / Macro only -->
    <section class="panel">
      <div class="panel-header">
        <div>
          <div class="panel-title">Benchmark / Macro</div>
        </div>
        <div class="controls">
          <span class="control-label">Group:</span>
          <select id="rel-select" class="control-select">
            <option value="Benchmarks">Benchmarks</option>
            <option value="Macro">Macro</option>
          </select>
        </div>
      </div>
      <div class="chart-holder">
        <div class="loading" id="rel-loading">
          <div class="spinner"></div>
          <span>Menunggu data kelompok terpilih…</span>
        </div>
        <div id="rel-chart" class="chart"></div>
      </div>
      <div id="rel-error" class="error-msg" style="display:none;"></div>
    </section>

    <!-- Panel 6: DM vs EM -->
    <section class="panel">
      <div class="panel-header">
        <div>
          <div class="panel-title">DM vs EM</div>
        </div>
        <div class="controls">
          <span class="control-label">Group:</span>
          <select id="dm-group" class="control-select">
            <option value="ALL">ALL</option>
            <option value="DM">DM only</option>
            <option value="EM">EM only</option>
          </select>
          <span class="control-label">Sort:</span>
          <select id="dm-order" class="control-select">
            <option value="DESC">Top ↓</option>
            <option value="ASC">Bottom ↑</option>
          </select>
        </div>
      </div>
      <div class="chart-holder">
        <div class="loading" id="dm-loading">
          <div class="spinner"></div>
          <span>Menunggu stream Developed & Emerging Markets…</span>
        </div>
        <div id="dm-chart" class="chart"></div>
      </div>
      <div id="dm-error" class="error-msg" style="display:none;"></div>
    </section>
  </section>

  <!-- FOURTH ROW: FOREX / COMMODITIES (2 panels) -->
  <section class="grid">
    <!-- Panel 7: Forex Strength Histogram (dedicated WS) -->
    <section class="panel">
      <div class="panel-header">
        <div>
          <div class="panel-title">Forex Strength – Change Histogram</div>
        </div>
      </div>
      <div class="chart-holder">
        <div id="fxChart" class="chart"></div>
      </div>
      <div class="fx-info">
        <div>Strongest: <strong id="fxStrongest">—</strong></div>
        <div>Weakest: <strong id="fxWeakest">—</strong></div>
        <div>Bias: <strong id="fxBias">waiting…</strong></div>
        <div>Count: <strong id="fxCount">0</strong></div>
      </div>
    </section>

    <!-- Panel 8: Commodities Strength Meter -->
    <section class="panel">
      <div class="panel-header">
        <div>
          <div class="panel-title">Commodities Strength Meter</div>
        </div>
      </div>
      <div class="chart-holder">
        <div class="loading" id="comdt-loading">
          <div class="spinner"></div>
          <span>Menunggu stream futures komoditas…</span>
        </div>
        <div id="comdt-chart" class="chart"></div>
      </div>
      <div class="fx-info">
        <div>Strongest: <strong id="comStrongest">—</strong></div>
        <div>Weakest: <strong id="comWeakest">—</strong></div>
        <div>Bias: <strong id="comBias">waiting…</strong></div>
        <div>Count: <strong id="comCount">0</strong></div>
      </div>
      <div id="comdt-error" class="error-msg" style="display:none;"></div>
    </section>
  </section>
</div>

<script>
// ================== MULTI-WEBSOCKET ENDPOINTS ==================
const WS_SAFE   = "ws://kuancloud.loclx.io/api/tv_stream/stream/trades/safe_haven";
const WS_RISK   = "ws://kuancloud.loclx.io/api/tv_stream/stream/trades/risk_assets";
const WS_PHASE  = "ws://kuancloud.loclx.io/api/tv_stream/stream/trades/market_phase";
const WS_SECTOR = "ws://kuancloud.loclx.io/api/tv_stream/stream/trades/us_sectors";
const WS_BENCH  = "ws://kuancloud.loclx.io/api/tv_stream/stream/trades/benchmarks";
const WS_MACRO  = "ws://kuancloud.loclx.io/api/tv_stream/stream/trades/macro";
const WS_DM     = "ws://kuancloud.loclx.io/api/tv_stream/stream/trades/developed_markets";
const WS_EM     = "ws://kuancloud.loclx.io/api/tv_stream/stream/trades/emerging_markets";
const WS_COMDT  = "ws://kuancloud.loclx.io/api/tv_stream/stream/trades/commodities_futures";

// ================== CONFIG MAPS ==================

const SAFE_HAVEN  = ["GLD","FXY","FXF","UUP"];
const RISK_ASSETS = ["IBIT","QQQ","SPY","EEM"];

const PHASE_ASSETS = {
  "Cash (UUP)":"UUP",
  "Bonds (BND)":"BND",
  "Stocks (QQQ)":"QQQ",
  "Commodities (DBC)":"DBC"
};

const SECTORS = {
  "XLB":"Materials","XLE":"Energy","XLF":"Financials","XLI":"Industrials","XLK":"Technology",
  "XLP":"Consumer Staples","XLU":"Utilities","XLV":"Health Care","XLY":"Consumer Discretionary",
  "XLRE":"Real Estate","XLC":"Communication Services"
};
const BENCH = {
  "SPY":"S&P 500","QQQ":"Nasdaq 100","IWM":"Russell 2000","IWF":"Russell 1000 Growth","IWD":"Russell 1000 Value"
};
const MACRO = {
  "HYG":"High Yield Credit","LQD":"IG Credit","TLT":"US 20Y+ Treasury","UUP":"US Dollar Index ETF",
  "GLD":"Gold","USO":"WTI Oil","XOP":"Oil & Gas E&P","ARKK":"High Beta Innovation"
};

const DMEM_META = {
  // DM
  "SPY": {name:"S&P 500 (SPY)",       cls:"DM"},
  "QQQ": {name:"NASDAQ 100 (QQQ)",    cls:"DM"},
  "DIA": {name:"Dow Jones (DIA)",     cls:"DM"},
  "VGK": {name:"Europe (VGK)",        cls:"DM"},
  "EWG": {name:"Germany (EWG)",       cls:"DM"},
  "EWQ": {name:"France (EWQ)",        cls:"DM"},
  "EWU": {name:"UK (EWU)",            cls:"DM"},
  "EWL": {name:"Switzerland (EWL)",   cls:"DM"},
  "EWJ": {name:"Japan (EWJ)",         cls:"DM"},
  "EWA": {name:"Australia (EWA)",     cls:"DM"},
  "EWC": {name:"Canada (EWC)",        cls:"DM"},
  "EWS": {name:"Singapore (EWS)",     cls:"DM"},
  // EM
  "EEM":  {name:"EM Broad (EEM)",         cls:"EM"},
  "VWO":  {name:"EM Broad (VWO)",         cls:"EM"},
  "FXI":  {name:"China Large (FXI)",      cls:"EM"},
  "MCHI": {name:"China Broad (MCHI)",     cls:"EM"},
  "KWEB": {name:"China Internet (KWEB)",  cls:"EM"},
  "INDA": {name:"India (INDA)",           cls:"EM"},
  "EWT":  {name:"Taiwan (EWT)",           cls:"EM"},
  "EWZ":  {name:"Brazil (EWZ)",           cls:"EM"},
  "EWW":  {name:"Mexico (EWW)",           cls:"EM"},
  "EZA":  {name:"South Africa (EZA)",     cls:"EM"},
  "THD":  {name:"Thailand (THD)",         cls:"EM"},
  "EIDO": {name:"Indonesia (EIDO)",       cls:"EM"},
  "EWM":  {name:"Malaysia (EWM)",         cls:"EM"}
};

const COMDT_TV = {
  "Gold":"COMEX:GC1!",
  "Silver":"COMEX:SI1!",
  "Copper":"COMEX:HG1!",
  "WTI Crude":"NYMEX:CL1!",
  "Brent Crude":"ICEEUR:BRN1!",
  "NatGas":"NYMEX:NG1!",
  "Gasoline":"NYMEX:RB1!",
  "HeatingOil":"NYMEX:HO1!",
  "Platinum":"NYMEX:PL1!",
  "Palladium":"NYMEX:PA1!",
  "Corn":"CBOT:ZC1!",
  "Wheat":"CBOT:ZW1!",
  "Soybeans":"CBOT:ZS1!",
  "Sugar":"ICEUS:SB1!",
  "Coffee":"ICEUS:KC1!",
  "Cotton":"ICEUS:CT1!"
};

const CLIP_PCT = 0.05;

const DM_COLORS = ["#60a5fa","#3b82f6","#2563eb","#1d4ed8","#1e40af"];
const EM_COLORS = ["#fb7185","#f97316","#22c55e","#eab308","#ec4899"];

// ================== GLOBAL STATE ==================
const state = {
  safe: {},
  risk: {},
  phase: {},
  sectors: {},
  bench: {},
  macro: {},
  dmem: {},
  comdt: {}
};

let gaugeChartInstance   = null;
let barsChartInstance    = null;
let phaseChartInstance   = null;
let sectorChartInstance  = null;
let relChartInstance     = null;
let dmChartInstance      = null;
let comdtChartInstance   = null;

// Commodities info DOM
let comStrongestEl, comWeakestEl, comBiasEl, comCountEl;

// ================== HELPERS ==================
function formatWIB() {
  const now = new Date();
  const opts = {
    timeZone: "Asia/Jakarta",
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
    hour: "2-digit",
    minute: "2-digit",
    hour12: false
  };
  const s = now.toLocaleString("en-GB", opts);
  const [d, m, yTime] = s.split("/");
  const [y, timePart] = yTime.split(", ");
  return `${y}-${m}-${d} ${timePart} WIB`;
}

function avg(arr) {
  if (!arr.length) return NaN;
  return arr.reduce((a,b)=>a+b,0)/arr.length;
}

function normalizeSymbol(symbol) {
  if (!symbol) return null;
  if (/^(TVC|COMEX|NYMEX|CBOT|ICEUS|ICEEUR|CME):/.test(symbol)) {
    return symbol;
  }
  if (symbol.includes(":")) {
    return symbol.split(":")[1];
  }
  return symbol;
}

// === PARSER: samakan logika dgn FX (change_pct / chp / change) ===
function parseWsPayload(raw) {
  if (raw == null) return null;

  if (typeof raw === "string") {
    const text = raw.trim();
    if (text.startsWith("{") || text.startsWith("[")) {
      try {
        const obj = JSON.parse(text);
        if (obj && obj.symbol) {
          let change = null;
          if (obj.change_pct !== undefined) change = Number(obj.change_pct);
          else if (obj.chp !== undefined) change = Number(obj.chp);
          else if (obj.change !== undefined) change = Number(obj.change);

          if (change != null && Number.isFinite(change)) {
            return {symbol: obj.symbol, change};
          }
        }
      } catch {}
    }
    const re = /([A-Z]{2,6}:[A-Z0-9!]+|[A-Z0-9!]+)\s+change=([+\-]?\d+(\.\d+)?)/;
    const m = text.match(re);
    if (m) {
      return {symbol: m[1], change: parseFloat(m[2])};
    }
    return null;
  }

  try {
    if (raw.symbol) {
      let change = null;
      if (raw.change_pct !== undefined) change = Number(raw.change_pct);
      else if (raw.chp !== undefined) change = Number(raw.chp);
      else if (raw.change !== undefined) change = Number(raw.change);

      if (change != null && Number.isFinite(change)) {
        return {symbol: raw.symbol, change};
      }
    }
  } catch {}
  return null;
}

function computeRiskScoreFromMaps() {
  const riskVals = RISK_ASSETS
    .map(t => state.risk[t])
    .filter(v => typeof v === "number" && !Number.isNaN(v));
  const safeVals = SAFE_HAVEN
    .map(t => state.safe[t])
    .filter(v => typeof v === "number" && !Number.isNaN(v));

  if (!riskVals.length || !safeVals.length) return null;

  const riskMean = avg(riskVals);
  const safeMean = avg(safeVals);

  let rawScore = (riskMean - safeMean)/100.0;
  rawScore = Math.max(-CLIP_PCT, Math.min(CLIP_PCT, rawScore));
  const scaled_pm100 = (rawScore / CLIP_PCT) * 100.0;
  const riskScore = (scaled_pm100 + 100.0)/2.0;

  return { riskScore, riskMean, safeMean };
}

function statusFromScore(score) {
  if (score >= 70) {
    return {text:"RISK-ON",  color:"#22c55e"};
  } else if (score <= 30) {
    return {text:"RISK-OFF", color:"#ef4444"};
  } else {
    return {text:"NEUTRAL",  color:"#facc15"};
  }
}

function hideLoading(id) {
  const el = document.getElementById(id);
  if (el) el.style.display = "none";
}

function showError(id, msg) {
  const el = document.getElementById(id);
  if (el) {
    el.style.display = "block";
    el.textContent = msg;
  }
}

// broadcast error ke semua panel – pesan user-friendly
function broadcastError(detail) {
  const ids = [
    "gauge-error","bars-error","phase-error","sector-error",
    "rel-error","dm-error","comdt-error"
  ];
  const userMsg = "Koneksi data dashboard sedang bermasalah. Coba muat ulang halaman atau hubungi admin jika masalah terus berlanjut.";
  ids.forEach(id => showError(id, userMsg));
}

// ================== ECHARTS RENDERERS ==================
function renderGaugeAndBars() {
  const metrics = computeRiskScoreFromMaps();
  const gaugeLoadingId = "gauge-loading";
  const barsLoadingId  = "bars-loading";

  if (!metrics) return;

  hideLoading(gaugeLoadingId);
  hideLoading(barsLoadingId);

  const {riskScore} = metrics;
  const {text:statusText, color:statusColor} = statusFromScore(riskScore);

  // Gauge
  const gaugeDom = document.getElementById("gauge-chart");
  if (!gaugeChartInstance) {
    gaugeChartInstance = echarts.init(gaugeDom);
    window.addEventListener("resize", ()=>gaugeChartInstance && gaugeChartInstance.resize());
  }

  const gaugeOption = {
    backgroundColor:"#111111",
    title:{
      text:"Sentiment Gauge",
      subtext:"Basket snapshot",
      left:"center",
      top:6,
      textStyle:{color:"#f5f5f5", fontSize:14},
      subtextStyle:{color:"#9b9b9b", fontSize:11}
    },
    tooltip:{show:false},
    series:[{
      type:"gauge",
      startAngle:180,
      endAngle:0,
      min:0,
      max:100,
      radius:"90%",
      center:["50%","60%"],
      axisLine:{
        lineStyle:{
          width:14,
          color:[
            [0.3,"#4b1f1f"],
            [0.7,"#3b3b3b"],
            [1.0,"#1f3b1f"]
          ]
        }
      },
      splitLine:{show:false},
      axisTick:{show:false},
      axisLabel:{show:false},
      pointer:{
        length:"60%",
        width:4,
        itemStyle:{color:statusColor}
      },
      detail:{ show:false },
      itemStyle:{color:statusColor},
      data:[{value:riskScore, name:statusText}]
    }],
    graphic:[
      {
        type:"text",
        left:"center",
        top:"66%",
        style:{
          text:statusText,
          fill:statusColor,
          fontSize:26,
          fontWeight:700
        }
      },
      {
        type:"text",
        left:"center",
        top:"82%",
        style:{
          text:`Updated: ${formatWIB()}`,
          fill:"#9b9b9b",
          fontSize:11
        }
      }
    ]
  };
  gaugeChartInstance.setOption(gaugeOption, true);

  // Bars (Risk/Safe)
  const dom = document.getElementById("bars-chart");
  if (!barsChartInstance) {
    barsChartInstance = echarts.init(dom);
    window.addEventListener("resize", ()=>barsChartInstance && barsChartInstance.resize());
  }

  const categories = [...SAFE_HAVEN, ...RISK_ASSETS];
  const safeData = categories.map(t => SAFE_HAVEN.includes(t) ? (typeof state.safe[t]==="number"?state.safe[t]:null) : null);
  const riskData = categories.map(t => RISK_ASSETS.includes(t) ? (typeof state.risk[t]==="number"?state.risk[t]:null) : null);

  const barsOption = {
    backgroundColor:"#111111",
    tooltip:{
      trigger:"item",
      triggerOn:"click",
      formatter:function(params){
        return params.name;
      }
    },
    legend:{
      data:["Safe Haven","Risk Asset"],
      top:6,
      textStyle:{color:"#f5f5f5", fontSize:11}
    },
    grid:{left:70,right:16,top:40,bottom:40},
    xAxis:{
      type:"value",
      axisLine:{lineStyle:{color:"#a3a3a3"}},
      axisLabel:{show:false},
      splitLine:{lineStyle:{color:"rgba(255,255,255,0.08)"}}
    },
    yAxis:{
      type:"category",
      data:categories,
      axisLine:{lineStyle:{color:"#a3a3a3"}},
      axisLabel:{color:"#e5e5e5"}
    },
    series:[
      {
        name:"Safe Haven",
        type:"bar",
        data:safeData,
        itemStyle:{color:"#60a5fa"},
        label:{show:false}
      },
      {
        name:"Risk Asset",
        type:"bar",
        data:riskData,
        itemStyle:{color:"#fb7185"},
        label:{show:false}
      }
    ],
    graphic:[{
      type:"text",
      left:"right",
      top:6,
      style:{
        text:`Updated: ${formatWIB()}`,
        fill:"#9b9b9b",
        fontSize:10
      }
    }]
  };

  barsChartInstance.setOption(barsOption, true);
}

function renderPhaseSnapshot() {
  const elLoading = "phase-loading";

  const entries = Object.entries(PHASE_ASSETS).map(([label, tkr]) => {
    const val = state.phase[tkr];
    return { label, value: typeof val === "number" ? val : null };
  }).filter(r => r.value !== null);

  if (!entries.length) return;

  hideLoading(elLoading);

  const dom = document.getElementById("phase-chart");
  if (!phaseChartInstance) {
    phaseChartInstance = echarts.init(dom);
    window.addEventListener("resize", ()=>phaseChartInstance && phaseChartInstance.resize());
  }

  const labels = entries.map(e => e.label);
  const values = entries.map(e => e.value);

  const maxAbs = Math.max(
    1,
    Math.ceil(Math.max(...values.map(v => Math.abs(v))) || 1)
  );

  const option = {
    backgroundColor: "#111111",
    title: {
      text: "Market Phase Radar",
      subtext: "Intraday phase snapshot",
      left: "center",
      top: 4,
      textStyle: { color: "#f5f5f5", fontSize: 13 },
      subtextStyle: { color: "#9b9b9b", fontSize: 11 }
    },
    tooltip: { show:false },
    radar: {
      shape: "circle",
      radius: "70%",
      splitNumber: 4,
      center: ["50%", "55%"],
      axisNameGap: 8,
      indicator: labels.map(l => ({
        name: l,
        max: maxAbs,
        min: -maxAbs
      })),
      axisName: {
        color: "#e5e5e5",
        fontSize: 11
      },
      splitArea: {
        areaStyle: {
          color: [
            "rgba(148,163,184,0.02)",
            "rgba(148,163,184,0.04)",
            "rgba(148,163,184,0.06)",
            "rgba(148,163,184,0.08)"
          ]
        }
      },
      splitLine: {
        lineStyle: {
          color: "rgba(148,163,184,0.25)"
        }
      },
      axisLine: {
        lineStyle: {
          color: "rgba(148,163,184,0.3)"
        }
      }
    },
    series: [
      {
        name: "Market Phase",
        type: "radar",
        data: [
          {
            value: values,
            areaStyle: {
              color: "rgba(255,191,0,0.20)"
            },
            lineStyle: {
              color: "#ffbf00",
              width: 2
            },
            itemStyle: {
              color: "#ffbf00",
              borderColor: "#000000",
              borderWidth: 1.5
            },
            label: { show: false }
          }
        ]
      }
    ],
    graphic: [
      {
        type: "text",
        left: "right",
        top: 6,
        style: {
          text: `Updated: ${formatWIB()}`,
          fill: "#9b9b9b",
          fontSize: 10
        }
      }
    ]
  };

  phaseChartInstance.setOption(option, true);
}

function renderSectorSnapshot() {
  const elLoading = "sector-loading";

  const rows = [];
  Object.keys(SECTORS).forEach(ticker => {
    const v = state.sectors[ticker];
    if (typeof v === "number" && !Number.isNaN(v)) {
      rows.push({
        ticker,
        name: SECTORS[ticker],
        val: v
      });
    }
  });

  if (!rows.length) return;

  hideLoading(elLoading);

  rows.sort((a, b) => b.val - a.val);

  const dom = document.getElementById("sector-chart");
  if (!sectorChartInstance) {
    sectorChartInstance = echarts.init(dom);
    window.addEventListener("resize", () => sectorChartInstance && sectorChartInstance.resize());
  }

  const labels  = rows.map(r => `${r.ticker} – ${r.name}`);
  const values  = rows.map(r => r.val);

  const benchRet = (typeof state.bench["SPY"] === "number" && !Number.isNaN(state.bench["SPY"]))
    ? state.bench["SPY"]
    : null;

  const maxAbs = Math.max(
    1,
    Math.ceil(Math.max(...values.map(v => Math.abs(v))) || 1)
  );

  const option = {
    backgroundColor: "#111111",
    title: {
      text: "US Sectors – Bullet View",
      subtext: "Relative intraday strength",
      left: "center",
      top: 4,
      textStyle: { color: "#f5f5f5", fontSize: 13 },
      subtextStyle: { color: "#9b9b9b", fontSize: 11 }
    },
    tooltip:{
      trigger:"item",
      triggerOn:"click",
      formatter:function(params){
        return params.name;
      }
    },
    grid: { left: 110, right: 24, top: 50, bottom: 40 },
    xAxis: {
      type: "value",
      min: -maxAbs,
      max: maxAbs,
      axisLine: { lineStyle: { color: "#a3a3a3" } },
      axisLabel: { show:false },
      splitLine: { lineStyle: { color: "rgba(255,255,255,0.08)" } }
    },
    yAxis: {
      type: "category",
      data: labels,
      axisLine: { lineStyle: { color: "#a3a3a3" } },
      axisLabel: { color: "#e5e5e5" }
    },
    series: [
      {
        name: "Sector",
        type: "bar",
        data: values,
        barWidth: 8,
        itemStyle: {
          color: (p) => p.value >= 0 ? "#22c55e" : "#ef4444"
        },
        label: { show:false },
        z: 1
      },
      benchRet != null ? {
        name: "SPY Benchmark",
        type: "scatter",
        data: rows.map((r) => ({
          value: [benchRet, `${r.ticker} – ${r.name}`]
        })),
        symbol: "rect",
        symbolSize: [4, 16],
        itemStyle: {
          color: "#ffbf00",
          borderColor: "#000000",
          borderWidth: 1
        },
        z: 2
      } : {}
    ].filter(Boolean),
    graphic: [
      {
        type: "text",
        left: "right",
        top: 6,
        style: {
          text: `Updated: ${formatWIB()}`,
          fill: "#9b9b9b",
          fontSize: 10
        }
      }
    ]
  };

  sectorChartInstance.setOption(option, true);
}

function renderRelGroup() {
  const groupKey = document.getElementById("rel-select").value;
  const elLoading = "rel-loading";

  let mapping;
  let valuesMap;

  if (groupKey === "Benchmarks") {
    mapping  = BENCH;
    valuesMap = state.bench;
  } else if (groupKey === "Macro") {
    mapping  = MACRO;
    valuesMap = state.macro;
  } else {
    mapping  = BENCH;
    valuesMap = state.bench;
  }

  const rows = [];
  Object.entries(mapping).forEach(([ticker, label])=>{
    const v = valuesMap[ticker];
    if (typeof v === "number") {
      rows.push({ticker, label, val:v});
    }
  });

  if (!rows.length) return;

  hideLoading(elLoading);

  rows.sort((a,b)=>a.val - b.val);

  const names = rows.map(r=>`${r.ticker} – ${r.label}`);
  const vals  = rows.map(r=>r.val);

  const dom = document.getElementById("rel-chart");
  if (!relChartInstance) {
    relChartInstance = echarts.init(dom);
    window.addEventListener("resize", ()=>relChartInstance && relChartInstance.resize());
  }

  const option = {
    backgroundColor:"#111111",
    tooltip:{
      trigger:"item",
      triggerOn:"click",
      formatter:function(params){
        return params.name;
      }
    },
    grid:{left:140,right:16,top:30,bottom:35},
    xAxis:{
      type:"value",
      axisLine:{lineStyle:{color:"#a3a3a3"}},
      axisLabel:{show:false},
      splitLine:{lineStyle:{color:"rgba(255,255,255,0.08)"}}
    },
    yAxis:{
      type:"category",
      data:names,
      axisLine:{lineStyle:{color:"#a3a3a3"}},
      axisLabel:{color:"#e5e5e5"}
    },
    series:[{
      type:"bar",
      data:vals,
      itemStyle:{
        color:(p)=> p.value >= 0 ? "#22c55e" : "#ef4444"
      },
      label:{show:false}
    }],
    graphic:[{
      type:"text",
      left:"right",
      top:6,
      style:{
        text:`Updated: ${formatWIB()} · Group: ${groupKey}`,
        fill:"#9b9b9b",
        fontSize:10
      }
    }]
  };

  relChartInstance.setOption(option, true);
}

function renderDMEM() {
  const elLoading = "dm-loading";
  const groupSel = document.getElementById("dm-group").value;
  const orderSel = document.getElementById("dm-order").value;

  let rows = Object.entries(state.dmem).map(([ticker, info])=>({
    ticker,
    name:info.name,
    cls:info.cls,
    chg:info.chg
  }));

  if (groupSel === "DM") {
    rows = rows.filter(r=>r.cls === "DM");
  } else if (groupSel === "EM") {
    rows = rows.filter(r=>r.cls === "EM");
  }

  if (!rows.length) return;

  hideLoading(elLoading);

  rows.sort((a,b)=> orderSel === "ASC" ? a.chg - b.chg : b.chg - a.chg);

  let dmIdx=0, emIdx=0;
  rows.forEach(r=>{
    if (r.cls === "DM") {
      r.color = DM_COLORS[dmIdx % DM_COLORS.length];
      dmIdx++;
    } else {
      r.color = EM_COLORS[emIdx % EM_COLORS.length];
      emIdx++;
    }
  });

  const names = rows.map(r=>r.name);
  const dataItems = rows.map(r=>({
    value:r.chg,
    name:r.name,
    itemStyle:{color:r.color}
  }));

  const dom = document.getElementById("dm-chart");
  if (!dmChartInstance) {
    dmChartInstance = echarts.init(dom);
    window.addEventListener("resize", ()=>dmChartInstance && dmChartInstance.resize());
  }

  const option = {
    backgroundColor:"#111111",
    tooltip:{
      trigger:"item",
      triggerOn:"click",
      formatter:function(params){
        return params.name;
      }
    },
    grid:{left:180,right:16,top:40,bottom:40},
    xAxis:{
      type:"value",
      axisLine:{lineStyle:{color:"#a3a3a3"}},
      axisLabel:{show:false},
      splitLine:{lineStyle:{color:"rgba(255,255,255,0.08)"}}
    },
    yAxis:{
      type:"category",
      data:names,
      axisLine:{lineStyle:{color:"#a3a3a3"}},
      axisLabel:{color:"#e5e5e5"}
    },
    series:[{
      type:"bar",
      data:dataItems,
      label:{show:false}
    }],
    graphic:[{
      type:"text",
      left:"right",
      top:6,
      style:{
        text:`Updated: ${formatWIB()}`,
        fill:"#9b9b9b",
        fontSize:10
      }
    }]
  };

  dmChartInstance.setOption(option, true);
}

function renderCommodities() {
  const elLoading = "comdt-loading";
  const rows = [];
  Object.entries(COMDT_TV).forEach(([name, symbol])=>{
    const v = state.comdt[symbol];
    if (typeof v === "number") {
      rows.push({name, symbol, ret:v});
    }
  });

  if (!rows.length) return;

  hideLoading(elLoading);

  const dom = document.getElementById("comdt-chart");
  if (!comdtChartInstance) {
    comdtChartInstance = echarts.init(dom);
    window.addEventListener("resize", ()=>comdtChartInstance && comdtChartInstance.resize());
  }

  const sorted = rows.slice().sort((a,b)=>a.ret - b.ret);
  const vals = sorted.map(r=>r.ret);
  const labs = sorted.map(r=>r.name);
  const maxAbs = Math.max(5, Math.ceil(Math.max(...vals.map(v=>Math.abs(v)) || [5])));
  const asof = formatWIB();

  const option = {
    backgroundColor:"#111111",
    title:{
      text:"Commodities Strength Meter",
      subtext:`Intraday snapshot · ${asof}`,
      left:"center",
      top:4,
      textStyle:{color:"#f5f5f5", fontSize:13},
      subtextStyle:{color:"#9b9b9b", fontSize:11}
    },
    tooltip:{
      trigger:"item",
      triggerOn:"click",
      formatter:function(params){
        return params.name;
      }
    },
    grid:{left:90,right:20,top:52,bottom:30},
    xAxis:{
      type:"value",
      min:-maxAbs,
      max:maxAbs,
      axisLine:{lineStyle:{color:"#a3a3a3"}},
      axisLabel:{show:false},
      splitLine:{lineStyle:{color:"rgba(255,255,255,0.08)"}}
    },
    yAxis:{
      type:"category",
      data:labs,
      axisLine:{lineStyle:{color:"#a3a3a3"}},
      axisLabel:{color:"#e5e5e5"}
    },
    visualMap:{
      show:false,
      min:-maxAbs,
      max:maxAbs,
      dimension:0,
      inRange:{
        color:["#b91c1c","#f97316","#fde68a","#4ade80","#16a34a"]
      }
    },
    series:[{
      type:"bar",
      data:vals,
      label:{show:false}
    }]
  };

  comdtChartInstance.setOption(option, true);

  // === Kesimpulan otomatis untuk Commodities (Strongest/Weakest/Bias/Count) ===
  if (sorted.length && comStrongestEl && comWeakestEl && comBiasEl && comCountEl) {
    const weakest  = sorted[0];
    const strongest= sorted[sorted.length - 1];

    const fmt = (v) => {
      const fixed = Math.abs(v) >= 1 ? v.toFixed(2) : v.toPrecision(3);
      return `${v >= 0 ? "+" : "-"}${fixed.replace("-","")}`;
    };

    comStrongestEl.textContent = `${strongest.name} (${fmt(strongest.ret)})`;
    comWeakestEl.textContent  = `${weakest.name} (${fmt(weakest.ret)})`;

    const spread = strongest.ret - weakest.ret;
    comBiasEl.textContent = spread > 0.25
      ? `${strongest.name} bid / ${weakest.name} offered`
      : "Board mixed – belum ada dominasi jelas";

    comCountEl.textContent = String(sorted.length);
  }
}

// ================== ROUTING PAYLOAD ==================
function routePayload(payload) {
  const norm = normalizeSymbol(payload.symbol);
  if (!norm) return;

  const chg = payload.change;

  // SAFE / RISK GAUGE
  if (SAFE_HAVEN.includes(norm)) {
    state.safe[norm] = chg;
    renderGaugeAndBars();
  }
  if (RISK_ASSETS.includes(norm)) {
    state.risk[norm] = chg;
    renderGaugeAndBars();
  }

  // MARKET PHASE
  const usedPhase = Object.values(PHASE_ASSETS);
  if (usedPhase.includes(norm)) {
    state.phase[norm] = chg;
    renderPhaseSnapshot();
  }

  // SECTORS
  if (norm in SECTORS) {
    state.sectors[norm] = chg;
    renderSectorSnapshot();
    renderRelGroup();
  }

  // BENCHMARKS
  if (norm in BENCH) {
    state.bench[norm] = chg;
    renderSectorSnapshot();
    renderRelGroup();
  }

  // MACRO
  if (norm in MACRO) {
    state.macro[norm] = chg;
    renderSectorSnapshot();
    renderRelGroup();
  }

  // DM / EM
  const meta = DMEM_META[norm];
  if (meta) {
    state.dmem[norm] = { chg, cls: meta.cls, name: meta.name };
    renderDMEM();
  }

  // COMMODITIES FUTURES
  const isComdt = Object.values(COMDT_TV).includes(norm);
  if (isComdt) {
    state.comdt[norm] = chg;
    renderCommodities();
  }
}

// ================== WS SETUP (MAIN DASHBOARD – PER BUCKET) ==================
function createStreamWS(url, label){
  let ws = null;

  function connect(){
    try {
      ws = new WebSocket(url);
    } catch(e) {
      console.error(`${label} WS create error`, e);
      broadcastError(`WS error (${label}): ${e.message || e}`);
      return;
    }

    ws.onopen = () => {
      console.log(`${label} WS opened`);
    };

    ws.onmessage = (event) => {
      const payload = parseWsPayload(event.data);
      if (!payload) return;
      routePayload(payload);
    };

    ws.onerror = (err) => {
      console.error(`${label} WS error`, err);
      broadcastError(`WS error (${label}) – lihat console log.`);
    };

    ws.onclose = () => {
      console.warn(`${label} WS closed, reconnecting...`);
      setTimeout(connect, 5005);
    };
  }

  connect();
}

function setupMainWS() {
  createStreamWS(WS_SAFE,   "safe_haven");
  createStreamWS(WS_RISK,   "risk_assets");
  createStreamWS(WS_PHASE,  "market_phase");
  createStreamWS(WS_SECTOR, "us_sectors");
  createStreamWS(WS_BENCH,  "benchmarks");
  createStreamWS(WS_MACRO,  "macro");
  createStreamWS(WS_DM,     "developed_markets");
  createStreamWS(WS_EM,     "emerging_markets");
  createStreamWS(WS_COMDT,  "commodities_futures");
}

// ================== FX HISTOGRAM (DEDICATED WS) ==================
const FX_WS_URL = "ws://kuancloud.loclx.io/api/tv_stream/stream/trades/fx_indices";

// Futures mapping:
// "EUR":"CME:6E1!", "JPY":"CME:6J1!", "GBP":"CME:6B1!",
// "AUD":"CME:6A1!", "NZD":"CME:6N1!", "CAD":"CME:6C1!", "CHF":"CME:6S1!", "USD":"ICEUS:DX1!"
const FX_LABELS = {
  "ICEUS:DX1!":"USD",
  "CME:6E1!":"EUR",
  "CME:6J1!":"JPY",
  "CME:6B1!":"GBP",
  "CME:6A1!":"AUD",
  "CME:6N1!":"NZD",
  "CME:6C1!":"CAD",
  "CME:6S1!":"CHF"
};

let fxWs = null;
let fxChart = null;
const fxChanges = new Map();
let fxRedrawTimer = null;

// FX DOM
let fxStrongestEl, fxWeakestEl, fxBiasEl, fxCountEl;

function fxToNumber(v){
  const n = Number(v);
  return Number.isFinite(n) ? n : null;
}

function fxChangeFromPayload(p){
  if(p.change_pct !== undefined) return fxToNumber(p.change_pct);
  if(p.chp !== undefined) return fxToNumber(p.chp);
  if(p.change !== undefined) return fxToNumber(p.change);
  return null;
}

function fxChangeText(val){
  if(val === null) return "—";
  const fixed = Math.abs(val) >= 1 ? val.toFixed(2) : val.toPrecision(3);
  return `${val >= 0 ? "+" : "-"}${fixed.replace("-","")}`;
}

function scheduleFxRedraw(){
  if(fxRedrawTimer) clearTimeout(fxRedrawTimer);
  fxRedrawTimer = setTimeout(updateFxChart,160);
}

function updateFxChart(){
  const entries = Array.from(fxChanges.entries())
    .filter(([,v]) => Number.isFinite(v))
    .sort((a,b) => a[1] - b[1]);

  const names  = entries.map(d => d[0]);
  const values = entries.map(d => d[1]);

  fxChart.setOption({
    backgroundColor:"transparent",
    animationDurationUpdate:350,
    animationEasingUpdate:"cubicOut",
    grid:{
      left:70,
      right:24,
      top:10,
      bottom:26,
    },
    tooltip:{
      trigger:"axis",
      axisPointer:{ type:"shadow" },
      formatter:(params)=>{
        const p = Array.isArray(params) ? params[0] : params;
        return `${p.name}: ${fxChangeText(p.value)}`;
      }
    },
    xAxis:{
      type:"value",
      axisLabel:{ color:"#d4d4d4" },
      splitLine:{ show:false },
    },
    yAxis:{
      type:"category",
      data:names,
      axisLabel:{ color:"#d4d4d4" },
    },
    series:[
      {
        type:"bar",
        data:values,
        barWidth:18,
        itemStyle:{
          color:(p)=> p.value >= 0 ? "#22c55e" : "#ef4444",
          borderRadius:4
        },
        markLine:{
          data:[{ xAxis:0 }],
          symbol:"none",
          lineStyle:{
            type:"dashed",
            color:"rgba(148,163,184,0.8)"
          }
        }
      }
    ]
  });

  fxCountEl.textContent = String(entries.length);

  if(entries.length){
    const weakest  = entries[0];
    const strongest= entries[entries.length-1];
    fxStrongestEl.textContent = `${strongest[0]} (${fxChangeText(strongest[1])})`;
    fxWeakestEl.textContent  = `${weakest[0]} (${fxChangeText(weakest[1])})`;

    const spread = strongest[1] - weakest[1];
    fxBiasEl.textContent = spread > 0.25
      ? `${strongest[0]} bid / ${weakest[0]} offered`
      : "Board mixed – belum ada dominasi jelas";
  }

  fxChart.resize();
}

function connectFx(){
  if(fxWs && fxWs.readyState === WebSocket.OPEN) return;
  try{
    fxWs = new WebSocket(FX_WS_URL);
  }catch(err){
    console.error("FX WebSocket ctor error:", err);
    return;
  }

  console.log("FX stream connecting…");

  fxWs.onopen = () => {
    console.log("FX stream live");
  };

  fxWs.onerror = (e) => {
    console.error("FX WebSocket error:", e);
  };

  fxWs.onclose = () => {
    console.warn("FX WebSocket closed, reconnecting…");
    setTimeout(connectFx, 5000);
  };

  fxWs.onmessage = (evt) => {
    let payload;
    try{
      payload = JSON.parse(evt.data);
    }catch(e){
      console.warn("FX unparsed message:", evt.data);
      return;
    }
    if(!payload || !payload.symbol) return;

    const rawSym = String(payload.symbol).toUpperCase();
    const label = FX_LABELS[rawSym] || rawSym;
    const change = fxChangeFromPayload(payload);
    if(change === null) return;

    fxChanges.set(label,change);
    scheduleFxRedraw();
  };
}

function initFxBoard(){
  fxStrongestEl  = document.getElementById("fxStrongest");
  fxWeakestEl    = document.getElementById("fxWeakest");
  fxBiasEl       = document.getElementById("fxBias");
  fxCountEl      = document.getElementById("fxCount");

  fxChart = echarts.init(document.getElementById("fxChart"));

  window.addEventListener("resize",() => {
    fxChart && fxChart.resize();
  });

  // Auto-connect on load
  connectFx();
}

// ================== INIT ==================
function initDashboardWS() {
  document.getElementById("rel-select").addEventListener("change", ()=> {
    renderRelGroup();
  });
  document.getElementById("dm-group").addEventListener("change", ()=> {
    renderDMEM();
  });
  document.getElementById("dm-order").addEventListener("change", ()=> {
    renderDMEM();
  });

  // Commodities summary DOM
  comStrongestEl = document.getElementById("comStrongest");
  comWeakestEl   = document.getElementById("comWeakest");
  comBiasEl      = document.getElementById("comBias");
  comCountEl     = document.getElementById("comCount");

  setupMainWS();
  initFxBoard();
}

initDashboardWS();
</script>
</body>
</html>
