<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Kuantara | Pro Analyst Terminal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Fira Code (Kuantara Standard) -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;700&display=swap">

  <!-- ECharts -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

  <style>
    :root {
      /* Kuantara Terminal Palette (Wajib) */
      --bg-root:#000000;
      --bg-main:#111111;
      --border-soft:#2b2b2b;
      --text-main:#f5f5f5;
      --text-muted:#9b9b9b;
      --accent:#ffbf00;

      --up:#22c55e;
      --down:#ef4444;
      --info:#38bdf8;

      /* Font sizes (Kuantara Spec) */
      --fs-title:14px;
      --fs-subtitle:12px;
      --fs-body:10.5px;
      --fs-small:9.5px;
    }

    * {
      box-sizing:border-box;
      margin:0;
      padding:0;
      font-family:"Fira Code",monospace;
    }

    /* Scrollbar – dark & minimal */
    *::-webkit-scrollbar{
      width:6px;
      height:6px;
    }
    *::-webkit-scrollbar-track{
      background:#000000;
    }
    *::-webkit-scrollbar-thumb{
      background:#2b2b2b;
      border-radius:3px;
    }
    *::-webkit-scrollbar-thumb:hover{
      background:#3b3b3b;
    }
    *{
      scrollbar-width:thin;
      scrollbar-color:#2b2b2b #000000;
    }

    html, body {
      width:100%;
      height:100%;
      background-color:var(--bg-root);
      color:var(--text-main);
    }

    body {
      display:flex;
      flex-direction:column;
    }

    .page-root{
      flex:1 1 auto;
      display:flex;
      flex-direction:column;
      padding:16px;
      gap:8px;
      min-height:0;
    }

    .main-grid {
      flex:1 1 auto;
      display:grid;
      grid-template-columns:340px 1fr;
      grid-template-rows:60% 40%;
      gap:8px;
      min-height:0;
      margin-top:4px;
    }

    .panel {
      background:var(--bg-main);
      border:1px solid var(--border-soft);
      border-radius:4px;
      overflow:hidden;
      position:relative;
      min-width:0;
      min-height:0;
    }

    /* LEFT PANEL */
    .panel-stats {
      grid-column:1 / 2;
      grid-row:1 / 2;
      display:flex;
      flex-direction:column;
      padding:16px;
      gap:12px;
      overflow:hidden;
    }

    .panel-stats-inner{
      flex:1 1 auto;
      display:flex;
      flex-direction:column;
      gap:12px;
      overflow-y:auto;
      padding-right:4px;
    }

    .control-group {
      display:grid;
      gap:8px;
    }

    .control-label {
      font-size:var(--fs-small);
      color:var(--text-muted);
      text-transform:uppercase;
      letter-spacing:0.4px;
    }

    select, button {
      background:#000000;
      border:1px solid var(--border-soft);
      color:var(--text-main);
      padding:6px 8px;
      border-radius:4px;
      font-size:var(--fs-body);
      outline:none;
      cursor:pointer;
    }

    select:focus, button:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(255,191,0,0.3);
    }

    button.btn-update {
      background:var(--accent);
      color:#000000;
      border:none;
      font-weight:600;
      font-size:var(--fs-body);
    }
    button.btn-update:hover { opacity:0.9; }

    .price-display {
      border-top:1px solid var(--border-soft);
      border-bottom:1px solid var(--border-soft);
      padding:10px 0;
      margin:4px 0;
    }
    .big-price {
      font-size:22px;
      font-weight:700;
    }
    .price-change {
      font-size:var(--fs-body);
      margin-top:2px;
    }

    .data-grid {
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px 12px;
    }
    .data-item {
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .data-val {
      font-size:var(--fs-body);
    }

    .pivot-table {
      width:100%;
      font-size:var(--fs-small);
      margin-top:4px;
      border-collapse:collapse;
    }
    .pivot-table td {
      padding:3px 0;
      color:var(--text-muted);
    }
    .pivot-table td.val {
      text-align:right;
      color:var(--text-main);
    }

    .panel-chart {
      grid-column:2 / 3;
      grid-row:1 / 2;
      display:flex;
      flex-direction:column;
      min-height:0;
    }

    .chart-header {
      padding:8px 12px;
      font-size:var(--fs-small);
      color:var(--text-muted);
      border-bottom:1px solid var(--border-soft);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      background:#111111;
    }

    .chart-header-left{
      display:flex;
      align-items:center;
      gap:8px;
    }

    .chart-title-main{
      font-size:var(--fs-body);
      color:var(--text-main);
    }

    .chart-badge{
      font-size:var(--fs-small);
      padding:2px 6px;
      border-radius:999px;
      background:#000000;
      border:1px solid var(--border-soft);
      color:var(--text-muted);
    }

    #mainChart {
      width:100%;
      height:100%;
    }

    .panel-tech {
      grid-column:1 / 3;
      grid-row:2 / 3;
      border-top:1px solid var(--border-soft);
      display:grid;
      grid-template-columns:260px 1fr;
      min-height:0;
    }

    .gauge-section {
      border-right:1px solid var(--border-soft);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      padding:12px;
      position:relative;
      min-width:0;
      min-height:0;
    }
    #gaugeChart { width:100%; height:100%; }
    .gauge-label {
      position:absolute;
      bottom:10px;
      font-size:var(--fs-subtitle);
      font-weight:600;
    }

    .gauge-caption{
      position:absolute;
      top:8px;
      left:10px;
      font-size:var(--fs-small);
      color:var(--text-muted);
    }

    .tech-table-container {
      padding:0;
      overflow:auto;
      min-width:0;
      min-height:0;
    }
    
    .tech-matrix {
      width:100%;
      border-collapse:collapse;
      font-size:var(--fs-body);
      text-align:center;
    }
    .tech-matrix th {
      background:#000000;
      color:var(--text-muted);
      padding:8px 6px;
      font-weight:500;
      position:sticky;
      top:0;
      z-index:10;
      border-bottom:1px solid var(--border-soft);
    }
    .tech-matrix td {
      padding:7px 6px;
      border-bottom:1px solid var(--border-soft);
    }
    .tech-matrix tr:hover td { background:#191919; }

    .tech-matrix td:first-child {
      text-align:left;
      padding-left:14px;
      color:var(--text-main);
    }

    .c-up { color:var(--up); }
    .c-down { color:var(--down); }
    .c-neutral { color:var(--text-muted); }

    .bg-buy {
      background:rgba(34,197,94,0.12);
      color:var(--up);
      border-radius:4px;
      padding:1px 6px;
      font-size:var(--fs-small);
    }
    .bg-sell {
      background:rgba(239,68,68,0.12);
      color:var(--down);
      border-radius:4px;
      padding:1px 6px;
      font-size:var(--fs-small);
    }
    .bg-neu {
      background:rgba(155,155,155,0.12);
      color:var(--text-muted);
      border-radius:4px;
      padding:1px 6px;
      font-size:var(--fs-small);
    }

    .divider{
      border:0;
      border-top:1px solid var(--border-soft);
      margin:4px 0;
    }

    @media (max-width:900px){
      .page-root{
        padding:12px;
      }
      .main-grid{
        grid-template-columns:1fr;
        grid-template-rows:auto auto auto;
        height:auto;
      }
      .panel-stats{
        grid-column:1 / 2;
        grid-row:1 / 2;
        max-height:260px;
      }
      .panel-chart{
        grid-column:1 / 2;
        grid-row:2 / 3;
        height:260px;
      }
      .panel-tech{
        grid-column:1 / 2;
        grid-row:3 / 4;
        grid-template-columns:1fr;
        height:260px;
      }
      .gauge-section{
        border-right:none;
        border-bottom:1px solid var(--border-soft);
        height:140px;
      }
      .tech-table-container{
        height:120px;
      }
    }
  </style>
</head>
<body>

<div class="page-root">
  <div class="main-grid">
    <!-- PANEL 1: LEFT – CONTROLS & STATS -->
    <div class="panel panel-stats">
      <div class="panel-stats-inner">

        <div class="control-group">
          <label class="control-label">Asset / Ticker</label>
          <select id="assetSelect">
            <!-- FOREX (15 pairs) -->
            <optgroup label="Forex Majors">
              <option value="EURUSD">EUR/USD</option>
              <option value="GBPUSD">GBP/USD</option>
              <option value="USDJPY">USD/JPY</option>
              <option value="USDCHF">USD/CHF</option>
              <option value="USDCAD">USD/CAD</option>
              <option value="AUDUSD">AUD/USD</option>
              <option value="NZDUSD">NZD/USD</option>
            </optgroup>
            <optgroup label="Forex Crosses">
              <option value="EURJPY">EUR/JPY</option>
              <option value="EURGBP">EUR/GBP</option>
              <option value="EURAUD">EUR/AUD</option>
              <option value="EURCAD">EUR/CAD</option>
              <option value="GBPJPY">GBP/JPY</option>
              <option value="AUDJPY">AUD/JPY</option>
              <option value="NZDJPY">NZD/JPY</option>
              <option value="USDSEK">USD/SEK</option>
            </optgroup>

            <!-- COMMODITIES (7) -->
            <optgroup label="Commodities">
              <option value="XAUUSD" selected>Gold (XAU/USD)</option>
              <option value="XAGUSD">Silver (XAG/USD)</option>
              <option value="XTIUSD">WTI Crude (XTI/USD)</option>
              <option value="XBRUSD">Brent Crude (XBR/USD)</option>
              <option value="XCUUSD">Copper (XCU/USD)</option>
              <option value="XPTUSD">Platinum (XPT/USD)</option>
              <option value="XPDUSD">Palladium (XPD/USD)</option>
            </optgroup>

            <!-- INDICES (5) -->
            <optgroup label="Indices">
              <option value="US500">S&amp;P 500</option>
              <option value="US100">Nasdaq 100</option>
              <option value="US30">Dow Jones 30</option>
              <option value="GER40">DAX 40</option>
              <option value="UK100">FTSE 100</option>
            </optgroup>

            <!-- US STOCKS (10) -->
            <optgroup label="US Stocks">
              <option value="AAPL">Apple (AAPL)</option>
              <option value="MSFT">Microsoft (MSFT)</option>
              <option value="AMZN">Amazon (AMZN)</option>
              <option value="META">Meta (META)</option>
              <option value="GOOGL">Alphabet (GOOGL)</option>
              <option value="TSLA">Tesla (TSLA)</option>
              <option value="NVDA">Nvidia (NVDA)</option>
              <option value="NFLX">Netflix (NFLX)</option>
              <option value="JPM">JPMorgan (JPM)</option>
              <option value="AMD">AMD (AMD)</option>
            </optgroup>

            <!-- INDONESIA STOCKS (5) -->
            <optgroup label="Indonesia Stocks">
              <option value="BBCA">BBCA</option>
              <option value="BBRI">BBRI</option>
              <option value="BBNI">BBNI</option>
              <option value="BMRI">BMRI</option>
              <option value="TLKM">TLKM</option>
            </optgroup>

            <!-- CRYPTO (5) -->
            <optgroup label="Crypto">
              <option value="BTCUSDT">BTC/USDT</option>
              <option value="ETHUSDT">ETH/USDT</option>
              <option value="SOLUSDT">SOL/USDT</option>
              <option value="XRPUSDT">XRP/USDT</option>
              <option value="BNBUSDT">BNB/USDT</option>
            </optgroup>
          </select>
          
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
            <div>
              <label class="control-label">Timeframe</label>
              <select id="tfSelect" style="width:100%; margin-top:4px;">
                <option value="1h">1H</option>
                <option value="4h" selected>4H</option>
                <option value="1d">1D</option>
              </select>
            </div>
            <div style="display:flex; align-items:flex-end;">
              <button class="btn-update" id="updateBtn" style="width:100%;">UPDATE</button>
            </div>
          </div>
        </div>

        <div class="price-display">
          <div class="control-label">Last Price</div>
          <div class="big-price" id="lblPrice">-</div>
          <div class="price-change c-neutral" id="lblChange">-</div>
        </div>

        <div>
          <div class="control-label">Session OHLC</div>
          <div class="data-grid" style="margin-top:4px;">
            <div class="data-item">
              <span class="control-label">Open</span>
              <span class="data-val" id="valOpen">-</span>
            </div>
            <div class="data-item">
              <span class="control-label">High</span>
              <span class="data-val c-up" id="valHigh">-</span>
            </div>
            <div class="data-item">
              <span class="control-label">Low</span>
              <span class="data-val c-down" id="valLow">-</span>
            </div>
            <div class="data-item">
              <span class="control-label">Vol</span>
              <span class="data-val" id="valVol">-</span>
            </div>
          </div>
        </div>

        <hr class="divider">

        <div>
          <div class="control-label">Performance (Approx)</div>
          <div class="data-grid" style="margin-top:4px;">
            <div class="data-item">
              <span class="control-label">Weekly</span>
              <span class="data-val" id="perfW">-</span>
            </div>
            <div class="data-item">
              <span class="control-label">Monthly</span>
              <span class="data-val" id="perfM">-</span>
            </div>
            <div class="data-item">
              <span class="control-label">YoY</span>
              <span class="data-val" id="perfY">-</span>
            </div>
            <div class="data-item">
              <span class="control-label">YTD</span>
              <span class="data-val" id="perfYTD">-</span>
            </div>
          </div>
        </div>

        <div style="margin-top:6px;">
          <div class="control-label">Fibonacci Pivot (Daily – approx)</div>
          <table class="pivot-table">
            <tbody>
              <tr><td>R3</td><td class="val" id="ppR3">-</td></tr>
              <tr><td>R2</td><td class="val" id="ppR2">-</td></tr>
              <tr><td>R1</td><td class="val" id="ppR1">-</td></tr>
              <tr>
                <td style="color:var(--accent)">Pivot</td>
                <td class="val" id="ppP" style="color:var(--accent)">-</td>
              </tr>
              <tr><td>S1</td><td class="val" id="ppS1">-</td></tr>
              <tr><td>S2</td><td class="val" id="ppS2">-</td></tr>
            </tbody>
          </table>
        </div>

      </div>
    </div>

    <!-- PANEL 2: RIGHT – CHART -->
    <div class="panel panel-chart">
      <div class="chart-header">
        <div class="chart-header-left">
          <span>CHART:</span>
          <span class="chart-title-main" id="chartTitle">XAUUSD</span>
        </div>
        <div style="display:flex; gap:6px; align-items:center;">
          <span class="chart-badge">MA(20)</span>
          <span class="chart-badge">MA(50)</span>
          <span class="chart-badge">VOL</span>
        </div>
      </div>
      <div id="mainChart"></div>
    </div>

    <!-- PANEL 3: BOTTOM – TECH SUMMARY -->
    <div class="panel panel-tech">
      <div class="gauge-section">
        <div class="gauge-caption">OVERALL SUMMARY</div>
        <div id="gaugeChart"></div>
        <div class="gauge-label" id="gaugeText" style="color:var(--text-muted);">NEUTRAL</div>
      </div>

      <div class="tech-table-container">
        <table class="tech-matrix">
          <thead>
            <tr>
              <th style="text-align:left; padding-left:14px;">Indicator (Current TF)</th>
              <th>Signal</th>
              <th>Value</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>RSI (14)</td>
              <td><span id="sigRSI" class="bg-neu">Neut</span></td>
              <td id="valRSI">-</td>
            </tr>
            <tr>
              <td>MACD (12,26,9)</td>
              <td><span id="sigMACD" class="bg-neu">Neut</span></td>
              <td id="valMACD">-</td>
            </tr>
            <tr>
              <td>SMA (50)</td>
              <td><span id="sigSMA" class="bg-neu">Neut</span></td>
              <td id="valSMA">-</td>
            </tr>
            <tr>
              <td>EMA (200)</td>
              <td><span id="sigEMA" class="bg-neu">Neut</span></td>
              <td id="valEMA">-</td>
            </tr>
            <tr>
              <td>ATR (14)</td>
              <td><span id="sigATR" class="bg-neu">Neut</span></td>
              <td id="valATR">-</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<script>
  // =====================================
  // 0. CONFIG: BACKEND TRADINGVIEW PROXY
  // =====================================
  const BASE_URL = "https://cloudkuant-541614645905.us-central1.run.app";

  // Mapping dropdown -> TradingView symbol (sesuaikan kalau beda di backend)
  const SYMBOL_MAP = {
    // Forex majors
    "EURUSD": "OANDA:EURUSD",
    "GBPUSD": "OANDA:GBPUSD",
    "USDJPY": "OANDA:USDJPY",
    "USDCHF": "OANDA:USDCHF",
    "USDCAD": "OANDA:USDCAD",
    "AUDUSD": "OANDA:AUDUSD",
    "NZDUSD": "OANDA:NZDUSD",

    // Forex crosses
    "EURJPY": "OANDA:EURJPY",
    "EURGBP": "OANDA:EURGBP",
    "EURAUD": "OANDA:EURAUD",
    "EURCAD": "OANDA:EURCAD",
    "GBPJPY": "OANDA:GBPJPY",
    "AUDJPY": "OANDA:AUDJPY",
    "NZDJPY": "OANDA:NZDJPY",
    "USDSEK": "OANDA:USDSEK",

    // Commodities
    "XAUUSD": "OANDA:XAUUSD",
    "XAGUSD": "OANDA:XAGUSD",
    "XTIUSD": "OANDA:WTICOUSD", // WTI
    "XBRUSD": "OANDA:BCOUSD",   // Brent
    "XCUUSD": "OANDA:XCUUSD",
    "XPTUSD": "OANDA:XPTUSD",
    "XPDUSD": "OANDA:XPDUSD",

    // Indices
    "US500": "OANDA:SPX500USD",
    "US100": "OANDA:NAS100USD",
    "US30":  "OANDA:US30USD",
    "GER40": "OANDA:DE30EUR",
    "UK100": "OANDA:UK100GBP",

    // US Stocks
    "AAPL": "NASDAQ:AAPL",
    "MSFT": "NASDAQ:MSFT",
    "AMZN": "NASDAQ:AMZN",
    "META": "NASDAQ:META",
    "GOOGL":"NASDAQ:GOOGL",
    "TSLA": "NASDAQ:TSLA",
    "NVDA": "NASDAQ:NVDA",
    "NFLX": "NASDAQ:NFLX",
    "JPM":  "NYSE:JPM",
    "AMD":  "NASDAQ:AMD",

    // Indonesia stocks
    "BBCA": "IDX:BBCA",
    "BBRI": "IDX:BBRI",
    "BBNI": "IDX:BBNI",
    "BMRI": "IDX:BMRI",
    "TLKM": "IDX:TLKM",

    // Crypto (Binance)
    "BTCUSDT": "BINANCE:BTCUSDT",
    "ETHUSDT": "BINANCE:ETHUSDT",
    "SOLUSDT": "BINANCE:SOLUSDT",
    "XRPUSDT": "BINANCE:XRPUSDT",
    "BNBUSDT": "BINANCE:BNBUSDT"
  };

  // Mapping timeframe dropdown -> interval param di /api/tvohlc/ohlcv
  const TF_MAP = {
    "1h": "60",
    "4h": "240",
    "1d": "1D"
  };

  const BARS_COUNT = 300;

  // ===== UTILS NUMERIK & INDIKATOR =====
  function sma(values, period) {
    if (values.length < period) return null;
    let sum = 0;
    for (let i = values.length - period; i < values.length; i++) sum += values[i];
    return sum / period;
  }

  function ema(values, period) {
    if (values.length < period) return null;
    const k = 2 / (period + 1);
    let emaPrev = values[0];
    for (let i = 1; i < values.length; i++) {
      emaPrev = values[i] * k + emaPrev * (1 - k);
    }
    return emaPrev;
  }

  // MA untuk chart: rolling window, null sebelum data cukup
  function calcMA(period, values) {
    const result = new Array(values.length).fill(null);
    let sum = 0;
    for (let i = 0; i < values.length; i++) {
      const v = Number(values[i]);
      if (Number.isNaN(v)) {
        result[i] = null;
        continue;
      }
      sum += v;
      if (i >= period) {
        sum -= Number(values[i - period]);
      }
      if (i >= period - 1) {
        result[i] = sum / period;
      }
    }
    return result;
  }

  function rsi(values, period = 14) {
    if (values.length <= period) return null;
    let gains = 0;
    let losses = 0;
    for (let i = values.length - period; i < values.length; i++) {
      const diff = values[i] - values[i-1];
      if (diff > 0) gains += diff;
      else losses -= diff;
    }
    if (gains === 0 && losses === 0) return 50;
    if (losses === 0) return 100;
    const rs = gains / losses;
    return 100 - (100 / (1 + rs));
  }

  function macd(values, fast = 12, slow = 26, signalPeriod = 9) {
    if (values.length < slow + signalPeriod) return null;
    function emaSeries(vals, period) {
      const k = 2 / (period + 1);
      const out = [];
      let emaPrev = vals[0];
      out.push(emaPrev);
      for (let i = 1; i < vals.length; i++) {
        emaPrev = vals[i] * k + emaPrev * (1 - k);
        out.push(emaPrev);
      }
      return out;
    }
    const emaFast = emaSeries(values, fast);
    const emaSlow = emaSeries(values, slow);
    const macdLine = values.map((_, i) => emaFast[i] - emaSlow[i]);
    const signal = emaSeries(macdLine.slice(slow - 1), signalPeriod);
    const lastMACD = macdLine[macdLine.length - 1];
    const lastSignal = signal[signal.length - 1];
    const hist = lastMACD - lastSignal;
    return { macd: lastMACD, signal: lastSignal, hist };
  }

  function atr(highs, lows, closes, period = 14) {
    const len = closes.length;
    if (len <= period) return null;
    const trs = [];
    for (let i = 1; i < len; i++) {
      const high = highs[i];
      const low  = lows[i];
      const prevClose = closes[i-1];
      const tr = Math.max(
        high - low,
        Math.abs(high - prevClose),
        Math.abs(low - prevClose)
      );
      trs.push(tr);
    }
    if (trs.length < period) return null;
    let sum = 0;
    for (let i = trs.length - period; i < trs.length; i++) sum += trs[i];
    return sum / period;
  }

  function fibPivot(lastHigh, lastLow, lastClose) {
    if (lastHigh == null || lastLow == null || lastClose == null) return null;
    const P = (lastHigh + lastLow + lastClose) / 3;
    const range = lastHigh - lastLow;
    return {
      P,
      R3: P + 1.0 * range,
      R2: P + 0.618 * range,
      R1: P + 0.382 * range,
      S1: P - 0.382 * range,
      S2: P - 0.618 * range
    };
  }

  function formatNum(x, decimals = 2) {
    if (x == null || Number.isNaN(x)) return "-";
    return Number(x).toFixed(decimals);
  }

  function formatPct(x) {
    if (x == null || Number.isNaN(x)) return "-";
    const v = Number(x);
    return (v > 0 ? "+" : v < 0 ? "" : "") + v.toFixed(2) + "%";
  }

  // ===== BACKEND FETCH =====
  async function fetchOhlcv(apiSymbol, interval) {
    const url = `${BASE_URL}/api/tvohlc/ohlcv?symbol=${encodeURIComponent(apiSymbol)}&interval=${encodeURIComponent(interval)}&bars_count=${BARS_COUNT}`;
    const res = await fetch(url, { cache:"no-store" });
    if (!res.ok) throw new Error("HTTP " + res.status);
    const json = await res.json();
    const rec = (json.results || []).find(r => r.symbol === apiSymbol) || (json.results || [])[0];
    if (!rec || !rec.bars || !rec.bars.length) throw new Error("No bars");
    return rec.bars;
  }

  function normalizeBars(rawBars) {
    const dates  = [];
    const values = [];
    const volumes = [];
    const highs = [];
    const lows  = [];
    const closes = [];

    for (let i = 0; i < rawBars.length; i++) {
      const b = rawBars[i];
      const o = Number(b.open);
      const h = Number(b.high);
      const l = Number(b.low);
      const c = Number(b.close);
      const v = Number(b.volume || b.vol || 0);

      let dLabel = "";
      if (b.time != null) {
        const t = (typeof b.time === "number" || typeof b.time === "bigint")
          ? new Date(Number(b.time) * 1000)
          : new Date(b.time);
        if (!isNaN(t.getTime())) {
          dLabel = t.toLocaleDateString("en-GB");
        }
      }
      if (!dLabel) dLabel = String(i + 1);

      dates.push(dLabel);
      values.push([o, c, l, h]);
      highs.push(h);
      lows.push(l);
      closes.push(c);
      volumes.push({
        value: v,
        itemStyle: { color: c >= o ? "#22c55e" : "#ef4444" }
      });
    }

    return { dates, values, volumes, highs, lows, closes };
  }

  // ===== ECHARTS INIT =====
  const mainChart = echarts.init(document.getElementById('mainChart'));
  const gaugeChart = echarts.init(document.getElementById('gaugeChart'));

  function renderMainChart(dates, values, volumes, ma20Arr, ma50Arr) {
    const option = {
      backgroundColor:'transparent',
      tooltip:{
        trigger:'axis',
        axisPointer:{ type:'cross' },
        backgroundColor:'rgba(15,15,15,0.95)',
        borderColor:'#333',
        textStyle:{ color:'#f5f5f5', fontFamily:'Fira Code', fontSize:10 }
      },
      grid:[
        { left:'52px', right:'14px', top:'8px', height:'70%' },
        { left:'52px', right:'14px', top:'78%', height:'16%' }
      ],
      xAxis:[
        {
          type:'category',
          data:dates,
          scale:true,
          boundaryGap:false,
          axisLine:{ lineStyle:{ color:'#333' } },
          axisLabel:{ color:'#777', fontSize:9 },
          splitLine:{ show:false }
        },
        {
          type:'category',
          gridIndex:1,
          data:dates,
          axisLabel:{ show:false },
          axisLine:{ show:false },
          splitLine:{ show:false }
        }
      ],
      yAxis:[
        {
          scale:true,
          splitLine:{ show:true, lineStyle:{ color:'#2b2b2b', width:0.8 } },
          axisLabel:{ color:'#777', fontSize:9 }
        },
        {
          scale:true,
          gridIndex:1,
          splitLine:{ show:false },
          axisLabel:{ show:false },
          axisLine:{ show:false }
        }
      ],
      dataZoom:[
        {
          type:'inside',
          xAxisIndex:[0,1],
          start:50,
          end:100
        }
      ],
      series:[
        {
          type:'candlestick',
          data:values,
          itemStyle:{
            color:'#22c55e',
            color0:'#ef4444',
            borderColor:'#22c55e',
            borderColor0:'#ef4444'
          }
        },
        {
          name:'MA 20',
          type:'line',
          data:ma20Arr,
          smooth:true,
          showSymbol:false,
          connectNulls:true,
          lineStyle:{ color:'#ffbf00', width:1 }
        },
        {
          name:'MA 50',
          type:'line',
          data:ma50Arr,
          smooth:true,
          showSymbol:false,
          connectNulls:true,
          lineStyle:{ color:'#38bdf8', width:1 }
        },
        {
          name:'Volume',
          type:'bar',
          xAxisIndex:1,
          yAxisIndex:1,
          data:volumes
        }
      ]
    };
    mainChart.setOption(option);
  }

  function renderGauge(score) {
    const option = {
      series:[
        {
          type:'gauge',
          startAngle:180,
          endAngle:0,
          min:0,
          max:1,
          splitNumber:5,
          radius:'95%',
          center:['50%','65%'],
          axisLine:{
            lineStyle:{
              width:7,
              color:[
                [0.2,'#ef4444'],
                [0.4,'#f97373'],
                [0.6,'#9b9b9b'],
                [0.8,'#4ade80'],
                [1.0,'#22c55e']
              ]
            }
          },
          pointer:{
            width:3,
            length:'60%',
            itemStyle:{ color:'#f5f5f5' }
          },
          axisTick:{ show:false },
          splitLine:{ show:false },
          axisLabel:{ show:false },
          detail:{ show:false },
          data:[{ value:score }]
        }
      ]
    };
    gaugeChart.setOption(option);
    
    const txt = document.getElementById('gaugeText');
    if(score < 0.2){
      txt.innerText = 'STRONG SELL';
      txt.style.color = '#ef4444';
    } else if(score < 0.4){
      txt.innerText = 'SELL';
      txt.style.color = '#f97373';
    } else if(score < 0.6){
      txt.innerText = 'NEUTRAL';
      txt.style.color = '#9b9b9b';
    } else if(score < 0.8){
      txt.innerText = 'BUY';
      txt.style.color = '#4ade80';
    } else {
      txt.innerText = 'STRONG BUY';
      txt.style.color = '#22c55e';
    }
  }

  // ===== UPDATE UI =====
  function updateTechTableFromIndicators(ind) {
    const { rsiVal, macdObj, sma50, ema200, atrVal } = ind;

    const sigRSI  = document.getElementById("sigRSI");
    const sigMACD = document.getElementById("sigMACD");
    const sigSMA  = document.getElementById("sigSMA");
    const sigEMA  = document.getElementById("sigEMA");
    const sigATR  = document.getElementById("sigATR");

    const valRSI  = document.getElementById("valRSI");
    const valMACD = document.getElementById("valMACD");
    const valSMA  = document.getElementById("valSMA");
    const valEMA  = document.getElementById("valEMA");
    const valATR  = document.getElementById("valATR");

    function setSig(el, type, text){
      el.className = "bg-neu";
      if (type === "buy") el.className = "bg-buy";
      if (type === "sell") el.className = "bg-sell";
      el.textContent = text;
    }

    // RSI
    if (rsiVal != null) {
      valRSI.textContent = formatNum(rsiVal, 2);
      if (rsiVal > 70) setSig(sigRSI, "sell", "Sell");
      else if (rsiVal < 30) setSig(sigRSI, "buy", "Buy");
      else setSig(sigRSI, "neu", "Neut");
    } else {
      valRSI.textContent = "-";
      setSig(sigRSI, "neu", "Neut");
    }

    // MACD
    if (macdObj) {
      valMACD.textContent = `${formatNum(macdObj.macd,2)} / ${formatNum(macdObj.signal,2)} / ${formatNum(macdObj.hist,2)}`;
      if (macdObj.hist > 0) setSig(sigMACD,"buy","Buy");
      else if (macdObj.hist < 0) setSig(sigMACD,"sell","Sell");
      else setSig(sigMACD,"neu","Neut");
    } else {
      valMACD.textContent = "-";
      setSig(sigMACD,"neu","Neut");
    }

    // SMA 50
    if (sma50 != null && ind.lastPrice != null) {
      valSMA.textContent = formatNum(sma50,2);
      if (ind.lastPrice > sma50) setSig(sigSMA,"buy","Above");
      else if (ind.lastPrice < sma50) setSig(sigSMA,"sell","Below");
      else setSig(sigSMA,"neu","At");
    } else {
      valSMA.textContent = "-";
      setSig(sigSMA,"neu","Neut");
    }

    // EMA 200
    if (ema200 != null && ind.lastPrice != null) {
      valEMA.textContent = formatNum(ema200,2);
      if (ind.lastPrice > ema200) setSig(sigEMA,"buy","Above");
      else if (ind.lastPrice < ema200) setSig(sigEMA,"sell","Below");
      else setSig(sigEMA,"neu","At");
    } else {
      valEMA.textContent = "-";
      setSig(sigEMA,"neu","Neut");
    }

    // ATR
    if (atrVal != null) {
      valATR.textContent = formatNum(atrVal,2);
      const volRatio = ind.lastPrice ? (atrVal / ind.lastPrice) : 0;
      if (volRatio > 0.02) setSig(sigATR,"sell","High");
      else if (volRatio < 0.005) setSig(sigATR,"buy","Calm");
      else setSig(sigATR,"neu","Normal");
    } else {
      valATR.textContent = "-";
      setSig(sigATR,"neu","Neut");
    }
  }

  function updateGaugeFromSignals(ind) {
    let scoreSum = 0;
    let count = 0;

    function addScore(val, buyCond, sellCond) {
      if (val == null) return;
      count++;
      if (buyCond()) scoreSum += 1;
      else if (!sellCond()) scoreSum += 0.5;
    }

    const rsiVal = ind.rsiVal;
    const macdObj = ind.macdObj;
    const lastPrice = ind.lastPrice;
    const sma50 = ind.sma50;
    const ema200 = ind.ema200;
    const atrVal = ind.atrVal;

    addScore(rsiVal,
      () => rsiVal < 30,
      () => rsiVal > 70
    );

    if (macdObj) {
      addScore(macdObj.hist,
        () => macdObj.hist > 0,
        () => macdObj.hist < 0
      );
    }

    addScore(sma50,
      () => lastPrice != null && lastPrice > sma50,
      () => lastPrice != null && lastPrice < sma50
    );

    addScore(ema200,
      () => lastPrice != null && lastPrice > ema200,
      () => lastPrice != null && lastPrice < ema200
    );

    if (atrVal != null && lastPrice != null) {
      const volRatio = atrVal / lastPrice;
      addScore(volRatio,
        () => volRatio < 0.01,
        () => volRatio > 0.03
      );
    }

    const score = count > 0 ? (scoreSum / count) : 0.5;
    renderGauge(score);
  }

  function updateLeftPanelFromPrices(closes, highs, lows, volumesArr) {
    if (!closes.length) return;
    const lastIdx = closes.length - 1;
    const lastClose = closes[lastIdx];
    const prevClose = closes[lastIdx - 1] ?? lastClose;

    const priceEl = document.getElementById("lblPrice");
    const changeEl = document.getElementById("lblChange");
    const openEl   = document.getElementById("valOpen");
    const highEl   = document.getElementById("valHigh");
    const lowEl    = document.getElementById("valLow");
    const volEl    = document.getElementById("valVol");

    priceEl.textContent = formatNum(lastClose, 2);
    const chg = lastClose - prevClose;
    const pct = (chg / prevClose) * 100;

    changeEl.textContent = `${chg > 0 ? "+" : ""}${formatNum(chg,2)} (${formatPct(pct).replace("%","")}%)`;
    changeEl.className = "price-change " + (chg > 0 ? "c-up" : chg < 0 ? "c-down" : "c-neutral");

    const lastH = highs[lastIdx];
    const lastL = lows[lastIdx];

    openEl.textContent = formatNum(prevClose, 2);
    highEl.textContent = formatNum(lastH, 2);
    lowEl.textContent  = formatNum(lastL, 2);

    const lastVol = volumesArr[lastIdx]?.value ?? 0;
    volEl.textContent = Math.round(lastVol).toLocaleString();

    const perfWEl   = document.getElementById("perfW");
    const perfMEl   = document.getElementById("perfM");
    const perfYEl   = document.getElementById("perfY");
    const perfYTDEl = document.getElementById("perfYTD");

    function perfFromLag(lag) {
      const idx = Math.max(0, closes.length - 1 - lag);
      const base = closes[idx];
      if (!base) return null;
      return ((lastClose / base) - 1) * 100;
    }

    const w   = perfFromLag(24);
    const m   = perfFromLag(120);
    const y   = perfFromLag(240);
    const ytd = perfFromLag(180);

    perfWEl.textContent   = formatPct(w);
    perfMEl.textContent   = formatPct(m);
    perfYEl.textContent   = formatPct(y);
    perfYTDEl.textContent = formatPct(ytd);
  }

  function updatePivotFromDaily(lastHigh, lastLow, lastClose) {
    const piv = fibPivot(lastHigh, lastLow, lastClose);
    const r3 = document.getElementById("ppR3");
    const r2 = document.getElementById("ppR2");
    const r1 = document.getElementById("ppR1");
    const p  = document.getElementById("ppP");
    const s1 = document.getElementById("ppS1");
    const s2 = document.getElementById("ppS2");
    if (!piv) {
      r3.textContent = r2.textContent = r1.textContent = "-";
      p.textContent  = "-";
      s1.textContent = s2.textContent = "-";
      return;
    }
    r3.textContent = formatNum(piv.R3, 2);
    r2.textContent = formatNum(piv.R2, 2);
    r1.textContent = formatNum(piv.R1, 2);
    p.textContent  = formatNum(piv.P, 2);
    s1.textContent = formatNum(piv.S1, 2);
    s2.textContent = formatNum(piv.S2, 2);
  }

  // ===== MAIN UPDATE FLOW =====
  async function updateAll() {
    const assetSel = document.getElementById("assetSelect");
    const tfSel    = document.getElementById("tfSelect");
    const btn      = document.getElementById("updateBtn");
    const chartTitle = document.getElementById("chartTitle");

    const asset = assetSel.value;
    const tf    = tfSel.value;
    const apiSymbol = SYMBOL_MAP[asset] || asset;
    const interval  = TF_MAP[tf] || "240";

    chartTitle.textContent = asset;
    btn.textContent = "LOADING...";
    btn.disabled = true;

    try {
      const rawBars = await fetchOhlcv(apiSymbol, interval);
      const norm = normalizeBars(rawBars);

      const closes = norm.closes;
      const highs  = norm.highs;
      const lows   = norm.lows;

      if (!closes.length) throw new Error("No close data");

      // MA chart pakai calcMA => hasil numeric + null
      const ma20Arr = calcMA(20, closes);
      const ma50Arr = calcMA(50, closes);

      renderMainChart(norm.dates, norm.values, norm.volumes, ma20Arr, ma50Arr);

      const rsiVal  = rsi(closes, 14);
      const macdObj = macd(closes, 12, 26, 9);
      const sma50   = sma(closes, 50);
      const ema200v = ema(closes, 200);
      const atrVal  = atr(highs, lows, closes, 14);
      const lastPrice = closes[closes.length - 1];

      updateLeftPanelFromPrices(closes, highs, lows, norm.volumes);
      updatePivotFromDaily(
        Math.max(...highs.slice(-10)),
        Math.min(...lows.slice(-10)),
        lastPrice
      );

      const indPack = { rsiVal, macdObj, sma50, ema200: ema200v, atrVal, lastPrice };
      updateTechTableFromIndicators(indPack);
      updateGaugeFromSignals(indPack);

    } catch (err) {
      console.error("Update error:", err);
      document.getElementById("lblPrice").textContent = "-";
      const ch = document.getElementById("lblChange");
      ch.textContent = "DATA ERROR";
      ch.className = "price-change c-down";
      renderGauge(0.5);
    } finally {
      btn.textContent = "UPDATE";
      btn.disabled = false;
    }
  }

  window.addEventListener('resize', () => {
    mainChart.resize();
    gaugeChart.resize();
  });

  document.getElementById('updateBtn').addEventListener('click', () => {
    updateAll();
  });

  // First load
  updateAll();
</script>

</body>
</html>
