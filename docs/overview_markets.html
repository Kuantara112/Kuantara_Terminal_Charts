<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Markets Overview - Pro Terminal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  >

  <style>
    :root {
      /* Kuantara Terminal Palette */
      --bg-root:#000000;
      --bg-main:#111111;
      --bg-card:#111111;
      --bg-card-hover:#151515;
      --bg-header:#111111;

      --border-subtle:#2b2b2b;
      --border-active:#ffbf00;

      --text-main:#f5f5f5;
      --text-muted:#9b9b9b;
      --text-dim:#555555;

      --accent-primary:#ffbf00;
      --accent-primary-dim:rgba(255,191,0,0.1);

      --color-up:#46c97f;
      --color-up-bg:rgba(70,201,127,0.15);
      --color-down:#ff4d4f;
      --color-down-bg:rgba(255,77,79,0.15);
      --color-neutral:#9b9b9b;

      /* Spacing & Radius (Terminal Compact) */
      --radius-sm:4px;
      --radius-md:4px;
      --spacing-sm:6px;
      --spacing-md:16px;

      /* Font sizes (9â€“14 px spec) */
      --fs-title:14px;
      --fs-subtitle:12px;
      --fs-body:11px;
      --fs-small:9.5px;

      /* Font â€“ Fira Code everywhere */
      --font-ui:"Fira Code",monospace;
      --font-mono:"Fira Code",monospace;
    }

    * {
      box-sizing:border-box;
      margin:0;
      padding:0;
      font-family:var(--font-ui);
    }

    /* Compact dark scrollbar */
    ::-webkit-scrollbar {
      width:6px;
      height:6px;
    }
    ::-webkit-scrollbar-track {
      background:#000000;
    }
    ::-webkit-scrollbar-thumb {
      background:#2b2b2b;
      border-radius:3px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background:#3a3a3a;
    }

    html,
    body {
      width:100%;
      height:100%;
    }

    body {
      background-color:var(--bg-root);
      color:var(--text-main);
      /* Default desktop behavior: Full screen app */
      height:100vh;
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }

    .font-mono {
      font-family:var(--font-mono)!important;
    }

    /* === Page Layout === */
    .kt-page {
      flex:1;
      display:flex;
      flex-direction:column;
      padding:var(--spacing-md);
      gap:var(--spacing-md);
      height:100%;
      background:var(--bg-main);
      overflow:hidden;
    }

    /* === Grid Layout (Desktop Default) === */
    .kt-grid {
      flex:1;
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      grid-template-rows:minmax(0, 1.3fr) minmax(0, 1fr);
      grid-template-areas:
        "ai ai headlines"
        "risk heatmap heatmap";
      gap:12px;
      min-height:0;
    }

    /* === Card Component === */
    .kt-card {
      background:var(--bg-card);
      border:1px solid var(--border-subtle);
      border-radius:var(--radius-md);
      display:flex;
      flex-direction:column;
      overflow:hidden;
      box-shadow:none;
      transition:background-color 0.15s ease;
      min-height:0;
    }

    /* Hapus efek border kuning, hanya darken background */
    .kt-card:hover {
      background-color:#121212;
    }

    .kt-card-header {
      padding:8px 12px;
      background:var(--bg-header);
      border-bottom:1px solid var(--border-subtle);
      display:flex;
      justify-content:space-between;
      align-items:center;
      flex-shrink:0;
    }

    .kt-card-title {
      font-size:var(--fs-subtitle);
      font-weight:600;
      color:var(--text-main);
      text-transform:uppercase;
      letter-spacing:0.6px;
    }

    .kt-card-subtitle {
      font-size:var(--fs-small);
      color:var(--text-muted);
      margin-top:1px;
      font-weight:400;
    }

    .kt-card-subtitle span#kt-timestamp {
      margin-left:6px;
      color:var(--text-dim);
    }

    .kt-card-btn {
      font-size:var(--fs-small);
      padding:3px 8px;
      border-radius:4px;
      border:1px solid var(--border-subtle);
      background:#000000;
      color:var(--text-muted);
      cursor:pointer;
      transition:0.15s;
    }
    .kt-card-btn:hover {
      color:var(--text-main);
      border-color:var(--accent-primary);
      background:var(--accent-primary-dim);
    }

    .kt-card-body {
      padding:0;
      flex:1;
      overflow:hidden;
      position:relative;
      font-size:var(--fs-body);
      line-height:1.5;
      display:flex;
      flex-direction:column;
    }

    /* === Grid Areas === */
    .ai-summary {
      grid-area:ai;
    }
    .headline-bubbles {
      grid-area:headlines;
    }
    .risk-meter-card {
      grid-area:risk;
    }
    .market-heatmap {
      grid-area:heatmap;
    }

    /* --- AI Summary Panel --- */
    .ai-summary-body {
      display:flex;
      flex-direction:row;
      height:100%;
      overflow:hidden;
    }

    .ai-summary-main {
      flex:7;
      padding:12px;
      overflow-y:auto;
      border-right:1px solid var(--border-subtle);
    }

    .ai-summary-text {
      color:#d4d4d4;
      white-space:pre-wrap;
      font-size:var(--fs-body);
      line-height:1.6;
    }
    .ai-summary-text b,
    .ai-summary-text strong {
      color:var(--accent-primary);
      font-weight:600;
    }

    .ai-signals-panel {
      flex:3;
      display:flex;
      flex-direction:column;
      background:#0b0b0b;
      min-width:160px;
    }

    .ai-signals-header {
      padding:8px 10px;
      font-size:var(--fs-small);
      font-weight:600;
      color:var(--text-muted);
      border-bottom:1px solid var(--border-subtle);
      background:var(--bg-card);
      flex-shrink:0;
    }

    .table-container {
      flex:1;
      overflow:auto;
    }

    /* --- Generic Table Styles --- */
    table {
      width:100%;
      border-collapse:collapse;
      font-size:var(--fs-body);
    }
    th {
      position:sticky;
      top:0;
      background:#111111;
      color:var(--text-muted);
      font-weight:500;
      font-size:9.5px;
      text-transform:uppercase;
      padding:6px 10px;
      text-align:right;
      z-index:2;
      border-bottom:1px solid var(--border-subtle);
    }
    th:first-child {
      text-align:left;
    }
    td {
      padding:6px 10px;
      border-bottom:1px solid var(--border-subtle);
      color:var(--text-main);
      white-space:nowrap;
      text-align:right;
      font-size:var(--fs-body);
    }
    td:first-child {
      text-align:left;
    }
    tr:hover td {
      background:var(--bg-card-hover);
    }

    .ai-signal-symbol {
      font-weight:600;
      color:var(--accent-primary);
      font-family:var(--font-mono);
    }
    .ai-signal-bias {
      font-weight:600;
      font-size:9.5px;
      padding:2px 6px;
      border-radius:4px;
    }
    .ai-signal-bias.long {
      background:var(--color-up-bg);
      color:var(--color-up);
    }
    .ai-signal-bias.short {
      background:var(--color-down-bg);
      color:var(--color-down);
    }
    .ai-signal-bias.neutral {
      background:#1a1a1a;
      color:var(--text-muted);
    }
    .ai-signal-conf {
      font-family:var(--font-mono);
      opacity:0.8;
      font-size:var(--fs-small);
    }

    /* --- Bubble Chart --- */
    .headline-bubble-chart {
      flex:1;
      width:100%;
      position:relative;
      background:#000000;
      overflow:hidden;
      min-height:150px;
    }

    .headline-bubble {
      position:absolute;
      border-radius:50%;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      text-align:center;
      padding:6px;
      cursor:pointer;
      transform:translate(-50%, -50%);
      transition:transform 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease;
      border:1px solid rgba(255,255,255,0.08);
      box-shadow:0 2px 8px rgba(0,0,0,0.5);
      color:#ffffff;
    }
    .headline-bubble:hover {
      transform:translate(-50%, -50%) scale(1.06);
      z-index:10;
      border-color:rgba(255,255,255,0.25);
    }

    .headline-bubble.low {
      background:radial-gradient(120% 120% at 30% 30%, rgba(70,201,127,0.3), #000000);
    }
    .headline-bubble.medium {
      background:radial-gradient(120% 120% at 30% 30%, rgba(255,191,0,0.35), #000000);
    }
    .headline-bubble.high {
      background:radial-gradient(120% 120% at 30% 30%, rgba(255,77,79,0.4), #000000);
    }

    .hb-title {
      font-size:9.5px;
      font-weight:500;
      line-height:1.2;
      max-width:100%;
      overflow:hidden;
      text-overflow:ellipsis;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
    }
    .hb-meta {
      font-size:8px;
      margin-top:3px;
      font-family:var(--font-mono);
      opacity:0.7;
    }

    .headline-bubbles-legend {
      position:absolute;
      bottom:8px;
      left:12px;
      display:flex;
      gap:10px;
      font-size:9px;
      color:var(--text-muted);
      background:rgba(0,0,0,0.7);
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.06);
    }
    .legend-dot {
      width:6px;
      height:6px;
      border-radius:50%;
      display:inline-block;
      margin-right:4px;
    }
    .legend-low {
      background:#46c97f;
    }
    .legend-medium {
      background:#ffbf00;
    }
    .legend-high {
      background:#ff4d4f;
    }

    /* --- Risk Meter --- */
    .risk-meter-wrapper {
      padding:12px;
      border-bottom:1px solid var(--border-subtle);
      flex-shrink:0;
    }

    .risk-meter-track {
      position:relative;
      height:6px;
      width:100%;
      background:linear-gradient(90deg,#E53935 0%,#FFB74D 45%,#FFD600 50%,#81C784 55%,#43A047 100%);
      border-radius:4px;
      margin:8px 0;
    }
    .risk-meter-pointer {
      position:absolute;
      top:-4px;
      width:4px;
      height:14px;
      background:#ffffff;
      border:1px solid #000000;
      transform:translateX(-50%);
      box-shadow:0 0 6px rgba(0,0,0,0.5);
      transition:left 0.5s cubic-bezier(0.4,0,0.2,1);
    }
    .risk-meter-labels {
      display:flex;
      justify-content:space-between;
      font-size:9px;
      color:var(--text-muted);
      margin-top:2px;
    }

    .risk-score-display {
      display:flex;
      justify-content:space-between;
      align-items:baseline;
    }
    .risk-val {
      font-size:18px;
      font-weight:700;
      color:var(--text-main);
      font-family:var(--font-mono);
    }
    .risk-tag {
      font-size:10px;
      color:var(--accent-primary);
      text-transform:uppercase;
      font-weight:600;
      letter-spacing:0.5px;
    }

    .quote-symbol {
      font-family:var(--font-mono);
      font-weight:600;
      color:var(--text-main);
      font-size:var(--fs-body);
    }
    .quote-change {
      font-family:var(--font-mono);
      font-weight:500;
      font-size:var(--fs-body);
    }
    .quote-change.pos {
      color:var(--color-up);
    }
    .quote-change.neg {
      color:var(--color-down);
    }

    /* --- Heatmap --- */
    .heatmap-grid {
      display:grid;
      grid-template-columns:repeat(3,1fr);
      grid-template-rows:repeat(6,1fr);
      gap:2px;
      flex:1;
      width:100%;
      padding:2px;
    }

    .heatmap-cell {
      background:#101010;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      text-align:center;
      padding:4px;
      transition:opacity 0.15s ease, background-color 0.15s ease;
      position:relative;
      border:1px solid rgba(0,0,0,0.25);
      overflow:hidden;
    }
    .heatmap-cell:hover {
      opacity:0.85;
    }

    .heatmap-symbol {
      font-size:9.5px;
      font-weight:700;
      color:#ffffff;
      margin-bottom:2px;
    }
    .heatmap-change {
      font-size:9.5px;
      font-family:var(--font-mono);
      font-weight:600;
      color:#ffffff;
    }

    /* Bubble Overlay */
    .hb-overlay {
      position:absolute;
      inset:0;
      background:rgba(0,0,0,0.7);
      z-index:50;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .hb-overlay-card {
      background:var(--bg-card);
      border:1px solid var(--border-active);
      padding:16px;
      width:80%;
      max-width:380px;
      border-radius:var(--radius-md);
      box-shadow:0 10px 30px rgba(0,0,0,0.6);
    }
    .hb-overlay-title {
      font-size:var(--fs-subtitle);
      font-weight:600;
      margin-bottom:8px;
      color:#ffffff;
    }
    .hb-overlay-meta {
      font-size:var(--fs-small);
      color:var(--text-muted);
      margin-bottom:10px;
      border-bottom:1px solid var(--border-subtle);
      padding-bottom:6px;
    }
    .hb-overlay-hint {
      font-size:9px;
      text-align:right;
      color:var(--text-dim);
      margin-top:8px;
      cursor:pointer;
    }

    /* =========================================
       RESPONSIVE
       ========================================= */
    @media (max-width:1024px) {
      body {
        height:auto;
        overflow-y:auto;
      }
      .kt-page {
        height:auto;
        min-height:100vh;
        overflow:visible;
      }
      .kt-grid {
        display:flex;
        flex-direction:column;
        gap:16px;
      }
      .ai-summary {
        min-height:500px;
      }
      .headline-bubbles {
        min-height:300px;
      }
      .risk-meter-card {
        min-height:300px;
      }
      .market-heatmap {
        min-height:400px;
      }
    }

    @media (max-width:768px) {
      .ai-summary-body {
        flex-direction:column;
      }
      .ai-summary-main {
        border-right:none;
        border-bottom:1px solid var(--border-subtle);
        height:250px;
        flex:none;
      }
      .ai-signals-panel {
        flex:none;
        max-height:300px;
      }
      .market-heatmap {
        height:450px;
      }
      .kt-card-title {
        font-size:13px;
      }
    }
  </style>
</head>
<body>
  <div class="kt-page">
    <div class="kt-grid">
      <!-- AI SUMMARY -->
      <section class="kt-card ai-summary">
        <div class="kt-card-header">
          <div>
            <div class="kt-card-title">AI Macro Summary</div>
            <div class="kt-card-subtitle">Synthesized Macro &amp; Trade Ideas</div>
          </div>
          <button class="kt-card-btn" onclick="generateSummary()">REFRESH AI</button>
        </div>

        <div class="kt-card-body ai-summary-body">
          <div class="ai-summary-main">
            <div id="ai-market-summary" class="ai-summary-text">
              Klik tombol "REFRESH AI" untuk ringkasan makro terkini dan ide trade multi-aset...
            </div>
          </div>

          <div class="ai-signals-panel">
            <div class="ai-signals-header">Live Signals</div>
            <div class="table-container">
              <table id="ai-signals-table">
                <thead>
                  <tr>
                    <th>Asset</th>
                    <th>Bias</th>
                    <th>Conf.</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td colspan="3" style="text-align:center; color:var(--text-muted);">
                      Menunggu data AI...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- CORE DRIVERS / BUBBLES -->
      <section class="kt-card headline-bubbles">
        <div class="kt-card-header">
          <div>
            <div class="kt-card-title">Core Market Drivers</div>
            <div class="kt-card-subtitle">Impact-Weighted Event Map</div>
          </div>
        </div>

        <div class="kt-card-body">
          <div id="headline-bubble-chart" class="headline-bubble-chart">
            <!-- populated by JS -->
          </div>

          <div class="headline-bubbles-legend">
            <div style="display:flex; align-items:center;">
              <span class="legend-dot legend-low"></span>Low
            </div>
            <div style="display:flex; align-items:center;">
              <span class="legend-dot legend-medium"></span>Med
            </div>
            <div style="display:flex; align-items:center;">
              <span class="legend-dot legend-high"></span>High
            </div>
          </div>
        </div>
      </section>

      <!-- RISK METER (HEADER REMOVED) -->
      <section class="kt-card risk-meter-card">
        <div class="kt-card-body" style="display:flex; flex-direction:column;">
          <div class="risk-meter-wrapper">
            <div class="risk-score-display">
              <div id="risk-meter-value" class="risk-val">50</div>
              <div id="risk-meter-tag" class="risk-tag">NEUTRAL</div>
            </div>

            <div class="risk-meter-track">
              <div
                id="risk-meter-pointer"
                class="risk-meter-pointer"
                style="left:50%;"
              ></div>
            </div>

            <div class="risk-meter-labels">
              <span>Risk-Off</span>
              <span>Neutral</span>
              <span>Risk-On</span>
            </div>
          </div>

          <div class="table-container">
            <table id="risk-quotes-table">
              <thead>
                <tr>
                  <th>Ticker</th>
                  <th>Last</th>
                  <th>% Chg</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td colspan="3" style="text-align:center; color:var(--text-muted);">
                    Loading market snapshot...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- HEATMAP (HEADER REMOVED) -->
      <section class="kt-card market-heatmap">
        <div class="kt-card-body">
          <div class="heatmap-grid" id="heatmap-grid">
            <!-- populated by JS -->
          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
    // ============================
    // CONFIG â€“ TradingView backend
    // ============================
    const BASE_URL = "https://kuancloud.loclx.io";
    const INTERVAL = "1D";
    const BARS_COUNT = 2;
    const MAX_CONCURRENT = 4;

    // Cache data
    let latestMarketData = {};

    const SYMBOL_CONFIG = {
      SPX:    { label:"SPX",    name:"S&P 500",              apiSymbol:"INDEX:SPX" },
      NDX:    { label:"NDX",    name:"Nasdaq 100",           apiSymbol:"INDEX:NDX" },
      RUT:    { label:"RUT",    name:"Russell 2000",         apiSymbol:"INDEX:RUT" },
      DXY:    { label:"DXY",    name:"US Dollar Index",      apiSymbol:"INDEX:DXY" },
      EURUSD: { label:"EURUSD", name:"EUR/USD",              apiSymbol:"FX:EURUSD" },
      USDJPY: { label:"USDJPY", name:"USD/JPY",              apiSymbol:"FX:USDJPY" },
      XAUUSD: { label:"XAU",    name:"Gold",                 apiSymbol:"OANDA:XAUUSD" },
      XAGUSD: { label:"XAG",    name:"Silver",               apiSymbol:"OANDA:XAGUSD" },
      WTI:    { label:"WTI",    name:"Crude Oil WTI",        apiSymbol:"TVC:USOIL" },
      BRENT:  { label:"BRENT",  name:"Brent Crude",          apiSymbol:"TVC:UKOIL" },
      HYG:    { label:"HYG",    name:"iShares High Yield",   apiSymbol:"AMEX:HYG" },
      LQD:    { label:"LQD",    name:"iShares IG Credit",    apiSymbol:"NYSE:LQD" },
      US10Y:  { label:"US10Y",  name:"US 10Y Yield",         apiSymbol:"TVC:US10Y" },
      US2Y:   { label:"US2Y",   name:"US 2Y Yield",          apiSymbol:"TVC:US02Y" },
      MOVE:   { label:"MOVE",   name:"MOVE Index",           apiSymbol:"INDEX:MOVE" },
      VIX:    { label:"VIX",    name:"VIX Index",            apiSymbol:"INDEX:VIX" },
      EEM:    { label:"EEM",    name:"EM Equities",          apiSymbol:"AMEX:EEM" },
      EFA:    { label:"EFA",    name:"DM ex-US Equities",    apiSymbol:"AMEX:EFA" },
      BTCUSD: { label:"BTC",    name:"Bitcoin",              apiSymbol:"CRYPTO:BTCUSD" }
    };

    const RISK_QUOTES_KEYS = ["SPX","NDX","DXY","XAUUSD","WTI","BTCUSD"];

    const HEATMAP_KEYS = [
      "SPX","NDX","RUT",
      "DXY","EURUSD","USDJPY",
      "XAUUSD","XAGUSD","WTI",
      "BRENT","HYG","LQD",
      "US10Y","US2Y","MOVE",
      "VIX","EEM","EFA"
    ];

    const RISK_ON_UP_KEYS   = ["SPX","NDX","RUT","EEM","HYG","LQD","BTCUSD","WTI","BRENT"];
    const RISK_ON_DOWN_KEYS = ["VIX","MOVE","DXY","XAUUSD","US10Y","US2Y"];

    function updateTimestamp(ts) {
      const el = document.getElementById("kt-timestamp");
      if (!el) return;
      el.textContent = "Â· Last: " + ts;
    }

    // ============================
    // AI SUMMARY & SIGNALS
    // ============================
    function updateAiSummary(summaryText) {
      const el = document.getElementById("ai-market-summary");
      if (!el) return;
      el.innerHTML = summaryText || "No summary generated yet. Click â€œREFRESH AIâ€.";
    }

    function updateTradingSignals(signals) {
      const tbody = document.querySelector("#ai-signals-table tbody");
      if (!tbody) return;
      tbody.innerHTML = "";

      const list = signals || [];
      if (!list.length) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 3;
        td.textContent = "No signals.";
        td.style.color = "var(--text-muted)";
        td.style.textAlign = "center";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      list.forEach(sig => {
        const tr = document.createElement("tr");

        const tdSym = document.createElement("td");
        tdSym.innerHTML = '<span class="ai-signal-symbol">' + (sig.symbol || "") + "</span>";

        const tdBias = document.createElement("td");
        const bias = (sig.bias || "neutral").toLowerCase();
        const spanBias = document.createElement("span");
        spanBias.className = "ai-signal-bias " + bias;
        spanBias.textContent = bias === "long" ? "LONG" : bias === "short" ? "SHORT" : "NEUT";
        tdBias.appendChild(spanBias);

        const tdConf = document.createElement("td");
        const pct = Number(sig.confidencePct || sig.confidence || 0);
        tdConf.className = "ai-signal-conf";
        tdConf.textContent = pct ? pct.toFixed(0) + "%" : "--";

        tr.appendChild(tdSym);
        tr.appendChild(tdBias);
        tr.appendChild(tdConf);
        tbody.appendChild(tr);
      });
    }

    // ============================
    // Bubble Overlay & Headline Bubbles
    // ============================
    function showBubbleOverlay(item) {
      const container = document.getElementById("headline-bubble-chart");
      if (!container) return;

      let overlay = container.querySelector(".hb-overlay");
      if (overlay) overlay.remove();

      overlay = document.createElement("div");
      overlay.className = "hb-overlay";
      overlay.addEventListener("click", (e) => {
        if (e.target === overlay) overlay.remove();
      });

      const card = document.createElement("div");
      card.className = "hb-overlay-card";

      const t = document.createElement("div");
      t.className = "hb-overlay-title";
      t.textContent = item.title || "No title";

      const meta = document.createElement("div");
      meta.className = "hb-overlay-meta";
      meta.textContent =
        (item.time ? "Time: " + item.time : "Time: -") +
        " | Impact: " +
        (item.impact != null ? item.impact.toFixed(0) + "%" : "N/A");

      const hint = document.createElement("div");
      hint.className = "hb-overlay-hint";
      hint.textContent = "Click outside to close";
      hint.onclick = () => overlay.remove();

      card.appendChild(t);
      card.appendChild(meta);
      card.appendChild(hint);
      overlay.appendChild(card);
      container.appendChild(overlay);
    }

    function updateHeadlines(items) {
      const container = document.getElementById("headline-bubble-chart");
      if (!container) return;
      container.innerHTML = "";

      const list = items || [];
      if (!list.length) {
        const dummy = document.createElement("div");
        dummy.style.position = "absolute";
        dummy.style.top = "50%";
        dummy.style.left = "50%";
        dummy.style.transform = "translate(-50%,-50%)";
        dummy.style.color = "var(--text-muted)";
        dummy.style.fontSize = "11px";
        dummy.textContent = "No headlines received.";
        container.appendChild(dummy);
        return;
      }

      const rect = container.getBoundingClientRect();
      const w = rect.width || container.clientWidth || 260;
      const h = rect.height || container.clientHeight || 180;
      const cx = w / 2;
      const cy = h / 2;

      const minSize = 60;
      const maxSize = 100;

      const sorted = list
        .map((it, idx) => ({ ...it, _idx: idx }))
        .sort(
          (a, b) =>
            (Number(b.impactPct || b.impact || 0) -
              Number(a.impactPct || a.impact || 0))
        );

      const maxRadius = Math.max(Math.min(w, h) / 2 - maxSize / 2 - 10, 30);
      const placed = [];

      sorted.forEach((item, order) => {
        const bubble = document.createElement("div");
        const impactRaw = Number(item.impactPct || item.impact || 0);
        const impact = Math.max(
          0,
          Math.min(100, isNaN(impactRaw) ? 0 : impactRaw)
        );

        const size = minSize + (impact / 100) * (maxSize - minSize);
        const radius = size / 2;
        bubble.style.width = size + "px";
        bubble.style.height = size + "px";

        bubble.className = "headline-bubble";
        if (impact >= 66) bubble.classList.add("high");
        else if (impact >= 33) bubble.classList.add("medium");
        else bubble.classList.add("low");

        let x = cx;
        let y = cy;

        if (order > 0) {
          const ringCount = Math.max(1, Math.ceil((sorted.length - 1) / 5));
          const ringIndex = Math.floor((order - 1) / 5);
          const inRingPos = (order - 1) % 5;

          const radiusFactor = (ringIndex + 1) / (ringCount + 0.2);
          const r = maxRadius * radiusFactor * 1.2;

          const angleStep = (2 * Math.PI) / Math.min(5, sorted.length - 1);
          const baseAngle = inRingPos * angleStep + ringIndex * 0.4;
          const jitter = (Math.random() - 0.5) * 0.4;
          const angle = baseAngle + jitter;

          x = cx + Math.cos(angle) * r;
          y = cy + Math.sin(angle) * r;
        }

        const margin = radius + 8;
        x = Math.max(margin, Math.min(w - margin, x));
        y = Math.max(margin, Math.min(h - margin, y));

        // simple collision relax (low N => tetap ringan)
        let safe = false;
        let attempts = 0;
        while (!safe && attempts < 15) {
          safe = true;
          for (const p of placed) {
            const dx = x - p.x;
            const dy = y - p.y;
            const dist = Math.sqrt(dx * dx + dy * dy) || 0.1;
            const minDist = radius + p.r + 2;
            if (dist < minDist) {
              safe = false;
              const ang = Math.atan2(dy, dx);
              const push = (minDist - dist) + 2;
              x += Math.cos(ang) * push;
              y += Math.sin(ang) * push;
              x = Math.max(margin, Math.min(w - margin, x));
              y = Math.max(margin, Math.min(h - margin, y));
            }
          }
          attempts++;
        }

        placed.push({ x, y, r: radius });
        bubble.style.left = x + "px";
        bubble.style.top = y + "px";

        const title = document.createElement("div");
        title.className = "hb-title";
        title.textContent = item.title || ("Headline " + (item._idx + 1));

        if (size > 70) {
          const meta = document.createElement("div");
          meta.className = "hb-meta";
          meta.textContent = (impact ? impact.toFixed(0) + "%" : "");
          bubble.appendChild(meta);
        }

        bubble.appendChild(title);
        bubble.addEventListener("click", (e) => {
          e.stopPropagation();
          showBubbleOverlay({
            title: item.title || ("Headline " + (item._idx + 1)),
            time: item.time || "",
            impact: impact
          });
        });

        container.appendChild(bubble);
      });
    }

    // ============================
    // Heatmap + Risk Meter + Quotes
    // ============================
    function formatNumberCompact(value) {
      const num = Number(value);
      if (Number.isNaN(num)) return "--";
      if (Math.abs(num) >= 100000) return num.toFixed(0);
      if (Math.abs(num) >= 1000)   return num.toFixed(1);
      if (Math.abs(num) >= 100)    return num.toFixed(2);
      return num.toFixed(3);
    }

    async function fetchOhlcv(apiSymbol) {
      try {
        const url = `${BASE_URL}/api/tvohlc/ohlcv?symbol=${encodeURIComponent(apiSymbol)}&interval=${INTERVAL}&bars_count=${BARS_COUNT}`;
        const res = await fetch(url, { cache:"no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const json = await res.json();
        const r = (json.results || []).find(x => x.symbol === apiSymbol) || (json.results || [])[0];
        if (!r || !r.bars || r.bars.length < 2) throw new Error("no bars");
        const bars = r.bars;
        const last = bars[bars.length - 1];
        const prev = bars[bars.length - 2];

        const lastClose = Number(last.close);
        const prevClose = Number(prev.close);
        const chg = lastClose - prevClose;
        const chgPct = prevClose ? (chg / prevClose) * 100 : 0;

        return {
          last: lastClose,
          change: chg,
          changePct: chgPct
        };
      } catch (e) {
        console.warn("fetchOhlcv error", apiSymbol, e);
        return null;
      }
    }

    async function loadMarketDataOnce() {
      const keys = Array.from(new Set([...RISK_QUOTES_KEYS, ...HEATMAP_KEYS]));
      const nextMap = { ...latestMarketData };

      let idx = 0;
      while (idx < keys.length) {
        const slice = keys.slice(idx, idx + MAX_CONCURRENT);
        const resultChunk = await Promise.all(
          slice.map(async key => {
            const cfg = SYMBOL_CONFIG[key];
            if (!cfg) return [key, null];
            const d = await fetchOhlcv(cfg.apiSymbol);
            return [key, d];
          })
        );
        resultChunk.forEach(([k, v]) => {
          if (v) nextMap[k] = v;
        });
        idx += MAX_CONCURRENT;
      }

      latestMarketData = nextMap;

      const now = new Date();
      updateTimestamp(now.toLocaleTimeString());

      updateQuotesFromMap(latestMarketData);
      updateHeatmapFromMap(latestMarketData);
      updateRiskMeterFromMap(latestMarketData);
    }

    function updateQuotesFromMap(dataMap) {
      const tbody = document.querySelector("#risk-quotes-table tbody");
      if (!tbody) return;
      tbody.innerHTML = "";

      RISK_QUOTES_KEYS.forEach(key => {
        const cfg = SYMBOL_CONFIG[key];
        const d = dataMap[key];
        const tr = document.createElement("tr");

        const tdAsset = document.createElement("td");
        const label = cfg ? cfg.label : key;
        tdAsset.innerHTML = '<span class="quote-symbol">' + label + "</span>";

        const tdLast = document.createElement("td");
        const tdPct  = document.createElement("td");

        if (!d) {
          tdLast.textContent = "--";
          tdPct.textContent  = "--";
        } else {
          tdLast.textContent = formatNumberCompact(d.last);
          tdLast.className = "font-mono";

          const signClass = d.changePct > 0 ? "pos" : d.changePct < 0 ? "neg" : "";
          tdPct.className = "quote-change " + signClass;
          tdPct.textContent = (d.changePct > 0 ? "+" : "") + d.changePct.toFixed(2) + "%";
        }

        tr.appendChild(tdAsset);
        tr.appendChild(tdLast);
        tr.appendChild(tdPct);
        tbody.appendChild(tr);
      });
    }

    function colorForChange(chgPct) {
      if (chgPct === null || chgPct === undefined || Number.isNaN(chgPct)) {
        return "#101010";
      }
      const v = chgPct;
      if (v >= 1.5) return "#1b5e20";
      if (v >= 0.5) return "#2e7d32";
      if (v > 0)    return "#388e3c";
      if (v <= -1.5) return "#b71c1c";
      if (v <= -0.5) return "#c62828";
      if (v < 0)    return "#d32f2f";
      return "#262626";
    }

    function updateHeatmapFromMap(dataMap) {
      const grid = document.getElementById("heatmap-grid");
      if (!grid) return;
      grid.innerHTML = "";

      const totalCells = 18;
      for (let i = 0; i < totalCells; i++) {
        const key = HEATMAP_KEYS[i];
        const cfg = SYMBOL_CONFIG[key];
        const d   = dataMap[key];

        const cell = document.createElement("div");
        cell.className = "heatmap-cell";

        const label = cfg ? cfg.label : (key || ("ASSET-" + (i+1)));
        const name  = cfg && cfg.name ? cfg.name : "";

        const sym = document.createElement("div");
        sym.className = "heatmap-symbol";
        sym.textContent = label;

        const chg = document.createElement("div");
        chg.className = "heatmap-change";

        if (d) {
          const prefix = d.changePct > 0 ? "+" : "";
          chg.textContent = prefix + d.changePct.toFixed(2) + "%";
          cell.style.backgroundColor = colorForChange(d.changePct);
        } else {
          chg.textContent = "--";
          cell.style.backgroundColor = "#101010";
        }

        cell.title = name ? (label + " â€“ " + name) : label;
        cell.appendChild(sym);
        cell.appendChild(chg);
        grid.appendChild(cell);
      }
    }

    function updateRiskMeterFromMap(dataMap) {
      const pointer = document.getElementById("risk-meter-pointer");
      const valueEl = document.getElementById("risk-meter-value");
      const tagEl   = document.getElementById("risk-meter-tag");
      if (!pointer || !valueEl || !tagEl) return;

      let scoreSum = 0;
      let count    = 0;

      RISK_ON_UP_KEYS.forEach(key => {
        const d = dataMap[key];
        if (!d) return;
        if (d.changePct > 0) scoreSum += 1;
        else if (d.changePct < 0) scoreSum -= 1;
        count++;
      });

      RISK_ON_DOWN_KEYS.forEach(key => {
        const d = dataMap[key];
        if (!d) return;
        if (d.changePct < 0) scoreSum += 1;
        else if (d.changePct > 0) scoreSum -= 1;
        count++;
      });

      const rawScore = 50 + scoreSum * 7;
      const s = Math.max(0, Math.min(100, rawScore));

      pointer.style.left = s.toFixed(0) + "%";
      valueEl.textContent = s.toFixed(0);

      let label = "NEUTRAL";
      let color = "var(--text-muted)";
      if (s <= 35) {
        label = "RISK-OFF";
        color = "var(--color-down)";
      } else if (s >= 65) {
        label = "RISK-ON";
        color = "var(--color-up)";
      }

      tagEl.textContent = label;
      tagEl.style.color = color;
    }

    // ============================
    // Static fallback (non-market) for first paint
    // ============================
    function renderStaticNonMarket() {
      updateHeadlines([
        {
          title:"US CPI in focus as markets reassess timing of first Fed cut",
          time:"Beberapa hari terakhir",
          impactPct:82
        },
        {
          title:"Dollar consolidates; JPY under pressure on policy divergence",
          time:"Beberapa hari terakhir",
          impactPct:68
        },
        {
          title:"Tech outperforms cyclicals as earnings revisions improve",
          time:"Beberapa hari terakhir",
          impactPct:51
        },
        {
          title:"Crude pulls back after sharp rally; positioning remains crowded",
          time:"Beberapa hari terakhir",
          impactPct:44
        },
        {
          title:"Credit spreads stay tight despite elevated yields",
          time:"Beberapa hari terakhir",
          impactPct:33
        }
      ]);

      updateTradingSignals([
        { symbol:"SPX", bias:"long",    confidencePct:72 },
        { symbol:"NDX", bias:"long",    confidencePct:80 },
        { symbol:"RUT", bias:"neutral", confidencePct:48 }
      ]);
    }

    // ============================
    // AI CONFIG (Sider)
    // ============================
    const API_BASE = "https://sider.ai/api/chat/v1";
    const TIMEZONE = "Asia/Makassar";
    const TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoyMTgzNzM0NiwicmVnaXN0ZXJfdHlwZSI6Im9hdXRoMiIsImFwcF9uYW1lIjoiQ2hpdENoYXRfQ2hyb21lX0V4dCIsInRva2VuX2lkIjoiZTZlOGIwZGUtN2Q3Zi00NTZkLTkxNGQtNzUwNDQ0ZjkyZTNjIiwiaXNzIjoic2lkZXIuYWkiLCJhdWQiOlsiIl0sImV4cCI6MTc4ODY5NjUxMCwibmJmIjoxNzU3NTkyNTEwLCJpYXQiOjE3NTc1OTI1MTB9.mcq86TwFwPtql3S77_vhnJRGj08878Ej5WGkvY3OxWI";

    const AI_STRUCTURED_PROMPT = `**WAJIB** gunakan fitur pencarian (tools search) untuk mengecek berita dan data **terbaru kurang dari 24 jam terakhir** sebelum menjawab. Jangan hanya mengandalkan pengetahuan statis. Bertindak sebagai **macro strategist Wall Street** dan **trader multi-aset**.
  
Tugasmu:
  
1. Jelaskan kondisi global makro **terbaru tanggal hari ini (<= 24 jam terakhir,WAJIB INFORMASI TANGGAL TERBARU!) dari sumber Reuters, Bloomberg, Investinglive, Livesquawk, Yahoo Finance atau sebagainya** mencakup: 
  
   - headlines berita global makro utama,
  
   - speech/komentar bank sentral (FED, ECB, BOE, BOJ, RBA, RBNZ, atau SNB),
  
   - informasi suku bunga dan probabilitas hikes/cuts/hold,
  
   - kondisi inflasi,
  
   - data ekonomi kunci,
  
   - sentimen investor,
  
   - kekuatan dolar AS,
  
   - faktor geopolitik utama **(pilih hanya yang betul-betul relevan & terbaru)**.
   
   - market research dari berbagai institusi keuangan besar: JP Morgan, Morgan Stanley, Citibank, Westpac, Danske, dll
  
2. Buat ide trade **hari ini** untuk 4 kelompok aset:
  
   - Forex â€“ 5â€“7 pasangan mayor/cross/minor,
  
   - Komoditas utama â€“ emas, perak, minyak, agrikultur dsb,
  
   - Indeks saham global utama,
  
   - Kripto besar.
  
   Untuk **setiap aset** berikan:
  
   - \`symbol\` (ticker),
  
   - \`bias\` salah satu dari: LONG, SHORT, NEUTRAL,
  
   - \`confidence\` angka 0â€“100 (seberapa yakin),
  
   - \`reason\` 1â€“2 kalimat singkat **berbasis narasi global makro** (bukan teknikal).
  
3. Dari narasi global makro dan ide trade di atas, rangkum **katalis utama** yang sedang menggerakkan pasar atau sedang pasar pricing in
  
   (misalnya: earnings,rilis CPI/NFP/GDP, surprise payrolls, statement dovish/hawkish, eskalasi geopolitik, dll)
  
   dan beri penilaian \`impact\` 0â€“100 untuk bobot pengaruhnya terhadap market saat ini.
  
4. Berikan \`risk_score\` 0â€“100 dimana 0 = sangat Risk-Off, 50 = netral, 100 = sangat Risk-On.
  

  
**Aturan Penting:**
  
- Gunakan **hanya informasi yang wajar terjadi dalam 24 jam terakhir**;
  
- **Jangan** tampilkan harga, level teknikal, atau timeframe spesifik.
  
- Fokus pada **bias** & **alasan makro**.
  
- Jawab dalam **Bahasa Indonesia**.
  

  
Output **WAJIB** hanya satu objek JSON valid **tanpa teks lain**, tanpa backticks, tanpa penjelasan tambahan.
  

  
Struktur JSON yang HARUS kamu ikuti:
  

  
{
  
  "summary": "Satu paragraf ringkas (Bahasa Indonesia) menjelaskan kondisi global makro terbaru. Gunakan <b>bold</b> untuk poin penting.",
  
  "risk_score": 58,
  
  "trades": {
  
    "forex": [
  
      {
  
        "symbol": "EURUSD",
  
        "bias": "LONG",
  
        "confidence": 78,
  
        "reason": "Alasan makro singkat berbasis data / narasi fundamental."
  
      }
  
    ],
  
    "commodities": [
  
      {
  
        "symbol": "XAUUSD",
  
        "bias": "SHORT",
  
        "confidence": 65,
  
        "reason": "Alasan makro."
  
      }
  
    ],
  
    "indices": [
  
      {
  
        "symbol": "SPX",
  
        "bias": "LONG",
  
        "confidence": 75,
  
        "reason": "Alasan makro terkait earnings, likuiditas, policy, dsb."
  
      }
  
    ],
  
    "crypto": [
  
      {
  
        "symbol": "BTCUSD",
  
        "bias": "LONG",
  
        "confidence": 70,
  
        "reason": "Alasan makro terkait likuiditas USD, adopsi institusional, regulasi, dsb."
  
      }
  
    ]
  
  },
  
  "catalysts": [
  
    {
  
      "title": "Judul katalis singkat",
  
      "time": "Hari ini / Semalam / Beberapa hari terakhir",
  
      "impact": 85
  
    }
  
  ]
  
}`;

    let isGenerating = false;

    function baseHeadersChat() {
      return {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit(537.36) Chrome/140.0.0.0 Safari/537.36",
        "Content-Type": "application/json",
        "Accept": "text/event-stream",
        "Cache-Control": "no-cache",
        "Connection": "keep-alive",
        "sec-ch-ua-platform": "\"Windows\"",
        "sec-ch-ua": "\"Chromium\";v=\"140\", \"Not=A?Brand\";v=\"24\", \"Google Chrome\";v=\"140\"",
        "authorization": `Bearer ${TOKEN}`,
        "x-app-name": "ChitChat_Web",
        "x-time-zone": TIMEZONE,
        "sec-ch-ua-mobile": "?0",
        "x-app-version": "1.0.0",
        "origin": "https://sider.ai",
        "sec-fetch-site": "same-origin",
        "sec-fetch-dest": "empty",
        "referer": "https://sider.ai/chat",
        "accept-language": "en-US,en;q=0.9,id;q=0.8"
      };
    }

    async function callAiMarketSummary() {
      const payload = {
        model: "gemini-3.0-pro",
        from: "chat",
        multi_content: [
          {
            type: "text",
            text: AI_STRUCTURED_PROMPT,
            user_input_text: "Generate macro market summary & trades"
          }
        ],
        tools: { auto: ["search"] },
        stream: true,
        output_language: "id"
      };

      const resp = await fetch(`${API_BASE}/completions`, {
        method: "POST",
        headers: baseHeadersChat(),
        body: JSON.stringify(payload),
        mode: "cors",
        credentials: "omit"
      });

      if (!resp.ok || !resp.body) {
        const txt = await resp.text().catch(()=>"");
        throw new Error(`HTTP ${resp.status} ${resp.statusText}${txt ? " â€“ " + txt.slice(0,300) : ""}`);
      }

      const reader = resp.body.getReader();
      const decoder = new TextDecoder();
      let buffer = "";
      let fullText = "";

      while (true) {
        const { value, done } = await reader.read();
        if (done) break;
        buffer += decoder.decode(value, { stream: true });

        let idx;
        while ((idx = buffer.indexOf("\n")) >= 0) {
          const rawLine = buffer.slice(0, idx);
          buffer = buffer.slice(idx + 1);

          const line = (rawLine || "").trim();
          if (!line) continue;
          if (line === "[DONE]") continue;

          let dataLine = line;
          if (dataLine.startsWith("data:")) dataLine = dataLine.slice(5).trim();
          if (!dataLine || dataLine === "[DONE]") continue;

          try {
            const obj = JSON.parse(dataLine);
            const payload = obj?.data || {};
            const type = payload?.type;

            if (type === "text") {
              const piece = payload?.text;
              if (typeof piece === "string") fullText += piece;
            } else {
              for (const k of ["text","token","content","output","message"]) {
                const v = payload?.[k];
                if (typeof v === "string" && v) {
                  fullText += v;
                  break;
                }
              }
            }
          } catch (e) {
            if (dataLine && dataLine !== "[DONE]") fullText += dataLine;
          }
        }
      }

      if (!fullText.trim()) {
        throw new Error("AI response kosong");
      }

      let jsonStr = fullText.trim();

      if (jsonStr.startsWith("```")) {
        jsonStr = jsonStr
          .replace(/^```json/i,"")
          .replace(/^```/i,"")
          .replace(/```$/,"")
          .trim();
      }

      return JSON.parse(jsonStr);
    }

    function applyAiMarketResult(result) {
      if (!result || typeof result !== "object") {
        updateAiSummary("Gagal membaca hasil AI.");
        return;
      }

      const summary = result.summary || "AI tidak mengembalikan summary.";
      const trades = result.trades || {};
      const riskScore = typeof result.risk_score === "number" ? result.risk_score : null;

      let summaryHtml =
        `<div style="margin-bottom:12px; font-size:14px; color:#fff;">${summary}</div>`;
      updateAiSummary(summaryHtml);

      // trading signals flatten
      const sectionOrder = [
        ["forex", "Forex"],
        ["commodities", "Komoditas"],
        ["indices", "Indeks Saham"],
        ["crypto", "Kripto"]
      ];

      const signals = [];
      sectionOrder.forEach(([key]) => {
        const arr = Array.isArray(trades[key]) ? trades[key] : [];
        arr.forEach(t => {
          signals.push({
            symbol: t.symbol || "",
            bias: (t.bias || "neutral").toLowerCase(),
            confidencePct: t.confidence != null ? Number(t.confidence) : null
          });
        });
      });
      updateTradingSignals(signals);

      // catalysts -> bubbles
      let catalysts = Array.isArray(result.catalysts) ? result.catalysts : [];

      if (!catalysts.length && signals.length) {
        sectionOrder.forEach(([key, label]) => {
          const arr = Array.isArray(trades[key]) ? trades[key] : [];
          arr.slice(0,2).forEach(t => {
            catalysts.push({
              title: `${label} â€“ ${t.symbol || ""} ${(t.bias || "").toUpperCase()}`,
              time: "Dari ide trade",
              impact: t.confidence != null ? Number(t.confidence) : 50
            });
          });
        });
      }

      const bubbles = catalysts.map(c => ({
        title: c.title || "",
        time: c.time || "",
        impactPct: c.impact != null ? Number(c.impact) : 50
      }));
      updateHeadlines(bubbles);

      // optional: jika AI memberi risk_score, override risk meter
      if (riskScore != null && !Number.isNaN(riskScore)) {
        const pointer = document.getElementById("risk-meter-pointer");
        const valueEl = document.getElementById("risk-meter-value");
        const tagEl   = document.getElementById("risk-meter-tag");
        const s = Math.max(0, Math.min(100, Number(riskScore)));

        if (pointer && valueEl && tagEl) {
          pointer.style.left = s.toFixed(0) + "%";
          valueEl.textContent = s.toFixed(0);

          let label = "NEUTRAL";
          let color = "var(--text-muted)";
          if (s <= 35) {
            label = "RISK-OFF";
            color = "var(--color-down)";
          } else if (s >= 65) {
            label = "RISK-ON";
            color = "var(--color-up)";
          }

          tagEl.textContent = label;
          tagEl.style.color = color;
        }
      }
    }

    async function generateSummary() {
      if (isGenerating) return;
      isGenerating = true;

      const btn = document.querySelector('.ai-summary .kt-card-btn');
      const oldLabel = btn ? btn.textContent : null;
      if (btn) {
        btn.textContent = "Processing...";
        btn.disabled = true;
        btn.style.opacity = "0.7";
      }

      updateAiSummary("Memahami kondisi market sekitar 20 detik, harap bersabar...");
      updateTradingSignals([]);
      updateHeadlines([]);

      try {
        const result = await callAiMarketSummary();
        applyAiMarketResult(result);
      } catch (err) {
        console.error(err);
        updateAiSummary("Gagal memuat AI Summary, coba Refresh lagi");
      } finally {
        isGenerating = false;
        if (btn) {
          btn.textContent = oldLabel || "REFRESH AI";
          btn.disabled = false;
          btn.style.opacity = "1";
        }
      }
    }

    // ============================
    // Init
    // ============================
    function initDashboard() {
      renderStaticNonMarket();  // lightweight dummy untuk first paint
      loadMarketDataOnce();     // Fetch TV data sekali saat user buka page
      generateSummary();        // ðŸ”¥ Auto-jalankan AI saat halaman dibuka
    }

    window.addEventListener("DOMContentLoaded", initDashboard);
  </script>
</body>
</html>