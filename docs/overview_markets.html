<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Markets Overview</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Fira Code -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;700&display=swap"/>

  <style>
    :root {
      --amber:#ffbf00;
      --bg-root:#000000;
      --bg-main:#111111;
      --border-soft:#2b2b2b;
      --text-main:#f5f5f5;
      --text-muted:#9b9b9b;

      --fs-title:14px;
      --fs-subtitle:12px;
      --fs-body:11px;
      --fs-small:9.5px;
    }

    * {
      box-sizing:border-box;
      margin:0;
      padding:0;
      font-family:"Fira Code",monospace !important;
    }

    html, body {
      height:100%;
      width:100%;
    }

    body {
      background-color:var(--bg-root);
      color:var(--text-main);
    }

    .kt-page {
      min-height:100vh;
      padding:16px;
      background:var(--bg-root);
      color:var(--text-main);
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .kt-page-header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }

    .kt-page-header-left {
      display:flex;
      flex-direction:column;
      gap:2px;
    }

    .kt-page-title {
      font-size:var(--fs-title);
      font-weight:500;
      letter-spacing:0.5px;
    }

    .kt-page-meta {
      font-size:var(--fs-small);
      color:var(--text-muted);
    }

    .kt-page-header-right {
      display:flex;
      align-items:center;
      gap:8px;
      flex-shrink:0;
    }

    .kt-action-btn {
      font-size:var(--fs-small);
      padding:4px 10px;
      border-radius:999px;
      border:1px solid var(--amber);
      background:transparent;
      color:var(--amber);
      cursor:pointer;
    }

    .kt-action-btn:hover {
      background:rgba(255,191,0,0.08);
    }

    /* === GRID: 2 atas, 3 bawah === */
    .kt-grid {
      flex:1;
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      grid-template-rows:1fr 1fr;
      grid-template-areas:
        "ai ai headlines"
        "risk calendar heatmap";
      gap:10px;
      min-height:0;
    }

    .kt-card {
      background:var(--bg-main);
      border:1px solid var(--border-soft);
      border-radius:4px;
      padding:12px 14px;
      display:flex;
      flex-direction:column;
      gap:8px;
      min-width:0;
      min-height:0;
    }

    .kt-card-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
      margin-bottom:2px;
    }

    .kt-card-header-left {
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }

    .kt-card-title {
      font-size:var(--fs-subtitle);
      font-weight:500;
    }

    .kt-card-subtitle {
      font-size:var(--fs-small);
      color:var(--text-muted);
    }

    .kt-card-body {
      font-size:var(--fs-body);
      line-height:1.4;
      color:var(--text-main);
      overflow:auto;
      min-height:0;
    }

    .kt-card-btn {
      font-size:var(--fs-small);
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--amber);
      background:transparent;
      color:var(--amber);
      cursor:pointer;
      flex-shrink:0;
      white-space:nowrap;
    }

    .kt-card-btn:hover {
      background:rgba(255,191,0,0.08);
    }

    /* === Layout areas === */
    .ai-summary { grid-area:ai; }
    .economic-calendar { grid-area:calendar; }
    .market-heatmap { grid-area:heatmap; }
    .headline-bubbles { grid-area:headlines; }
    .risk-meter-card { grid-area:risk; }

    /* === AI Market Summary + Trading Signals SPLIT === */
    .ai-summary-body {
      display:flex;
      gap:10px;
      height:100%;
      min-height:0;
    }

    .ai-summary-main {
      flex:3;
      overflow:auto;
      min-width:0;
    }

    .ai-summary-text {
      font-size:var(--fs-body);
      color:var(--text-main);
      white-space:pre-wrap;
    }

    .ai-signals-panel {
      flex:1;
      border-left:1px solid var(--border-soft);
      padding-left:10px;
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
      min-height:0;
    }

    .ai-signals-header {
      font-size:var(--fs-small);
      color:var(--text-muted);
      text-transform:uppercase;
      letter-spacing:0.5px;
    }

    .ai-signals-table {
      width:100%;
      border-collapse:collapse;
      font-size:var(--fs-small);
    }

    .ai-signals-table th,
    .ai-signals-table td {
      padding:3px 2px;
      border-bottom:1px solid rgba(43,43,43,0.7);
      white-space:nowrap;
      text-align:right;
    }

    .ai-signals-table th:first-child,
    .ai-signals-table td:first-child {
      text-align:left;
    }

    .ai-signal-symbol {
      font-weight:500;
      color:var(--amber);
    }

    .ai-signal-bias.long {
      color:#4caf50;
    }

    .ai-signal-bias.short {
      color:#ff5252;
    }

    .ai-signal-bias.neutral {
      color:var(--text-muted);
    }

    .ai-signal-conf {
      color:var(--text-main);
    }

    /* === Economic Calendar === */
    .calendar-table {
      width:100%;
      border-collapse:collapse;
      font-size:var(--fs-body);
    }

    .calendar-table thead {
      font-size:var(--fs-small);
      color:var(--text-muted);
    }

    .calendar-table th,
    .calendar-table td {
      padding:3px 4px;
      text-align:left;
      border-bottom:1px solid rgba(43,43,43,0.7);
      white-space:nowrap;
    }

    .calendar-table th:nth-child(4),
    .calendar-table td:nth-child(4) {
      text-align:right;
    }

    .cal-impact-low {
      color:#4caf50;
    }

    .cal-impact-medium {
      color:#ffbf00;
    }

    .cal-impact-high {
      color:#ff5252;
    }

    /* === Core Catalyst → Bubble Chart === */
    .headline-bubble-chart {
      position:relative;
      width:100%;
      height:100%;
      min-height:0;
      overflow:hidden;
    }

    .headline-bubble {
      position:absolute;
      border-radius:999px;
      padding:6px 10px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:flex-start;
      background:radial-gradient(circle at 30% 30%, rgba(255,255,255,0.12), rgba(0,0,0,0.6));
      border:1px solid rgba(255,255,255,0.06);
      cursor:default;
      overflow:hidden;
      transform:translate(-50%, -50%);
    }

    .headline-bubble.low {
      box-shadow:0 0 0 1px rgba(76,175,80,0.5);
    }

    .headline-bubble.medium {
      box-shadow:0 0 0 1px rgba(255,191,0,0.7);
    }

    .headline-bubble.high {
      box-shadow:0 0 0 1px rgba(255,82,82,0.8);
    }

    .hb-title {
      font-size:var(--fs-small);
      color:var(--text-main);
      white-space:nowrap;
      text-overflow:ellipsis;
      overflow:hidden;
      max-width:100%;
    }

    .hb-meta {
      font-size:8.5px;
      color:var(--text-muted);
      margin-top:2px;
      white-space:nowrap;
    }

    .headline-bubbles-legend {
      display:flex;
      justify-content:flex-start;
      gap:8px;
      font-size:8.5px;
      color:var(--text-muted);
      margin-top:4px;
    }

    .legend-dot {
      display:inline-block;
      width:7px;
      height:7px;
      border-radius:50%;
      margin-right:4px;
    }

    .legend-low { background:#4caf50; }
    .legend-medium { background:#ffbf00; }
    .legend-high { background:#ff5252; }

    /* === Market Heatmap (3 x 6) === */
    .heatmap-grid {
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      grid-template-rows:repeat(6, 1fr);
      gap:4px;
      width:100%;
      height:100%;
      min-height:0;
    }

    .heatmap-cell {
      border-radius:3px;
      border:1px solid rgba(0,0,0,0.4);
      background:#1a1a1a;
      padding:4px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      font-size:var(--fs-small);
      overflow:hidden;
    }

    .heatmap-symbol {
      font-weight:500;
      color:var(--text-main);
      white-space:nowrap;
      text-overflow:ellipsis;
      overflow:hidden;
    }

    .heatmap-value {
      font-size:var(--fs-small);
      color:var(--text-main);
    }

    .heatmap-change {
      font-size:var(--fs-small);
    }

    /* === Risk-On / Risk-Off – Horizontal Bar Meter + Quotes === */
    .risk-meter-wrapper {
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    .risk-meter-bar {
      position:relative;
      width:100%;
      height:18px;
      border-radius:999px;
      background:linear-gradient(90deg, #ff5252 0%, #ffbf00 50%, #4caf50 100%);
      border:1px solid var(--border-soft);
      overflow:hidden;
    }

    .risk-meter-pointer {
      position:absolute;
      top:50%;
      width:2px;
      height:26px;
      background:#ffffff;
      transform:translate(-50%, -50%);
      box-shadow:0 0 4px rgba(0,0,0,0.8);
    }

    .risk-meter-scale {
      display:flex;
      justify-content:space-between;
      font-size:var(--fs-small);
      color:var(--text-muted);
      padding:0 2px;
    }

    .risk-meter-value {
      font-size:var(--fs-body);
      text-align:center;
    }

    .risk-meter-tag {
      font-size:var(--fs-small);
      color:var(--text-muted);
      text-align:center;
      margin-bottom:4px;
    }

    .quotes-table {
      width:100%;
      border-collapse:collapse;
      font-size:var(--fs-body);
      margin-top:4px;
    }

    .quotes-table thead {
      font-size:var(--fs-small);
      color:var(--text-muted);
    }

    .quotes-table th,
    .quotes-table td {
      padding:3px 4px;
      text-align:right;
      border-bottom:1px solid rgba(43,43,43,0.7);
      white-space:nowrap;
    }

    .quotes-table th:first-child,
    .quotes-table td:first-child {
      text-align:left;
    }

    .quote-symbol {
      color:var(--amber);
      font-weight:500;
    }

    .quote-change.pos {
      color:#4caf50;
    }

    .quote-change.neg {
      color:#ff5252;
    }

    .risk-meter-card .kt-card-body {
      min-height:0;
      overflow:auto;
    }

    /* === Scroll helpers === */
    .ai-summary .kt-card-body,
    .economic-calendar .kt-card-body {
      min-height:0;
    }

    .market-heatmap .kt-card-body,
    .headline-bubbles .kt-card-body {
      flex:1;
      min-height:0;
      overflow:hidden;
    }

    /* Mobile tweaks */
    @media (max-width:900px) {
      .kt-grid {
        grid-template-columns:1fr;
        grid-template-rows:auto;
        grid-template-areas:
          "ai"
          "headlines"
          "risk"
          "calendar"
          "heatmap";
      }

      .headline-bubble-chart {
        min-height:220px;
      }

      .ai-summary-body {
        flex-direction:column;
      }

      .ai-signals-panel {
        border-left:none;
        border-top:1px solid var(--border-soft);
        padding-left:0;
        padding-top:8px;
      }
    }
  </style>
</head>
<body>
  <div class="kt-page">
    <div class="kt-page-header">
      <div class="kt-page-header-left">
        <div class="kt-page-title">Markets Overview</div>
        <div class="kt-page-meta" id="kt-timestamp">last update: demo mode</div>
      </div>
      <div class="kt-page-header-right">
        <button class="kt-action-btn" onclick="generateMarketReport()">Generate Market Report</button>
      </div>
    </div>

    <div class="kt-grid">
      <!-- AI Market Summary (TOP LEFT, spanning 2 columns) -->
      <section class="kt-card ai-summary" data-section="ai-summary">
        <div class="kt-card-header">
          <div class="kt-card-header-left">
            <div class="kt-card-title">AI Market Summary</div>
            <div class="kt-card-subtitle">multi-asset | intraday view</div>
          </div>
          <button class="kt-card-btn" onclick="generateSummary()">Generate Summary</button>
        </div>
        <div class="kt-card-body ai-summary-body">
          <div class="ai-summary-main">
            <div id="ai-market-summary" class="ai-summary-text">
No summary generated yet. Click “Generate Summary” to fetch AI view.
            </div>
          </div>
          <div class="ai-signals-panel">
            <div class="ai-signals-header">Trading Signals</div>
            <table class="ai-signals-table" id="ai-signals-table">
              <thead>
                <tr>
                  <th>Tick</th>
                  <th>Bias</th>
                  <th>Conf</th>
                </tr>
              </thead>
              <tbody>
                <!-- rows from JS -->
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Core Catalyst Bubble Chart (TOP RIGHT) -->
      <section class="kt-card headline-bubbles" data-section="headline-bubbles">
        <div class="kt-card-header">
          <div class="kt-card-header-left">
            <div class="kt-card-title">Core Catalyst</div>
            <div class="kt-card-subtitle">impact-weighted bubble map (%)</div>
          </div>
        </div>
        <div class="kt-card-body">
          <div id="headline-bubble-chart" class="headline-bubble-chart">
            <!-- bubbles from JS -->
          </div>
          <div class="headline-bubbles-legend">
            <span><span class="legend-dot legend-low"></span>Low</span>
            <span><span class="legend-dot legend-medium"></span>Medium</span>
            <span><span class="legend-dot legend-high"></span>High</span>
          </div>
        </div>
      </section>

      <!-- Risk-On / Risk-Off – Horizontal Meter + Market Quotes (BOTTOM LEFT) -->
      <section class="kt-card risk-meter-card" data-section="risk-meter">
        <div class="kt-card-header">
          <div class="kt-card-header-left">
            <div class="kt-card-title">Risk-On / Risk-Off</div>
            <div class="kt-card-subtitle">composite sentiment & key quotes</div>
          </div>
        </div>
        <div class="kt-card-body">
          <div class="risk-meter-wrapper">
            <div class="risk-meter-bar">
              <div id="risk-meter-pointer" class="risk-meter-pointer"></div>
            </div>
            <div class="risk-meter-scale">
              <span>Risk-Off</span>
              <span>Neutral</span>
              <span>Risk-On</span>
            </div>
            <div id="risk-meter-value" class="risk-meter-value">Score: -- / 100</div>
            <div id="risk-meter-tag" class="risk-meter-tag">waiting for data...</div>
          </div>

          <table class="quotes-table" id="risk-quotes-table">
            <thead>
              <tr>
                <th>Asset</th>
                <th>Last</th>
                <th>Chg</th>
                <th>%</th>
              </tr>
            </thead>
            <tbody>
              <!-- rows from JS -->
            </tbody>
          </table>
        </div>
      </section>

      <!-- Economic Calendar (BOTTOM MIDDLE) -->
      <section class="kt-card economic-calendar" data-section="economic-calendar">
        <div class="kt-card-header">
          <div class="kt-card-header-left">
            <div class="kt-card-title">Economic Calendar</div>
            <div class="kt-card-subtitle">today's key releases & impact</div>
          </div>
        </div>
        <div class="kt-card-body">
          <table class="calendar-table" id="calendar-table">
            <thead>
              <tr>
                <th>Time</th>
                <th>Event</th>
                <th>Currency</th>
                <th>Impact</th>
              </tr>
            </thead>
            <tbody>
              <!-- rows from JS -->
            </tbody>
          </table>
        </div>
      </section>

      <!-- Market Heatmap (BOTTOM RIGHT) -->
      <section class="kt-card market-heatmap" data-section="market-heatmap">
        <div class="kt-card-header">
          <div class="kt-card-header-left">
            <div class="kt-card-title">Market Heatmap</div>
            <div class="kt-card-subtitle">3 × 6 grid | multi-asset</div>
          </div>
        </div>
        <div class="kt-card-body">
          <div class="heatmap-grid" id="heatmap-grid">
            <!-- 18 cells -->
          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
    // ============================
    // Helpers for integration
    // ============================

    function updateTimestamp(ts) {
      const el = document.getElementById("kt-timestamp");
      if (!el) return;
      el.textContent = "last update: " + ts;
    }

    function generateMarketReport() {
      console.log("Generate Market Report clicked");
      alert("Generate Market Report – connect this button to your PDF backend.");
    }

    function generateSummary() {
      console.log("Generate Summary clicked");
      const demoSummary =
        "AI Summary (demo):\n" +
        "- Global equities trade mixed; US tech outperforms while value lags.\n" +
        "- USD index stabilizes near recent highs; rates market keeps pricing fewer cuts.\n" +
        "- Commodities show rotation from gold into energy and industrial metals.\n" +
        "- Credit spreads remain tight, supporting a moderate risk-on tone despite elevated yields.";
      updateAiSummary(demoSummary);

      // Contoh: langsung isi Trading Signals dari 'summary' (di real-case, dari backend)
      updateTradingSignals([
        { symbol:"SPX",   bias:"long",    confidencePct:78 },
        { symbol:"NDX",   bias:"long",    confidencePct:82 },
        { symbol:"DXY",   bias:"neutral", confidencePct:55 },
        { symbol:"XAU",   bias:"short",   confidencePct:60 },
        { symbol:"WTI",   bias:"long",    confidencePct:73 }
      ]);
    }

    // === 1) AI Market Summary ===
    function updateAiSummary(summaryText) {
      const el = document.getElementById("ai-market-summary");
      if (!el) return;
      el.textContent = summaryText || "No summary generated yet. Click “Generate Summary”.";
    }

    // === Trading Signals (inside AI card) ===
    // signals: [{ symbol, bias: "long|short|neutral", confidencePct }, ...]
    function updateTradingSignals(signals) {
      const tbody = document.querySelector("#ai-signals-table tbody");
      if (!tbody) return;
      tbody.innerHTML = "";

      const list = signals || [];
      if (!list.length) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 3;
        td.textContent = "No signals.";
        td.style.color = "var(--text-muted)";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      list.forEach(sig => {
        const tr = document.createElement("tr");

        const tdSym = document.createElement("td");
        tdSym.innerHTML = '<span class="ai-signal-symbol">' + (sig.symbol || "") + "</span>";

        const tdBias = document.createElement("td");
        const bias = (sig.bias || "neutral").toLowerCase();
        tdBias.className = "ai-signal-bias " + bias;
        tdBias.textContent =
          bias === "long" ? "LONG" :
          bias === "short" ? "SHORT" :
          "NEUTRAL";

        const tdConf = document.createElement("td");
        const pct = Number(sig.confidencePct || sig.confidence || 0);
        tdConf.className = "ai-signal-conf";
        tdConf.textContent = pct ? pct.toFixed(0) + "%" : "--";

        tr.appendChild(tdSym);
        tr.appendChild(tdBias);
        tr.appendChild(tdConf);
        tbody.appendChild(tr);
      });
    }

    // === 2) Economic Calendar ===
    function updateEconomicCalendar(events) {
      const tbody = document.querySelector("#calendar-table tbody");
      if (!tbody) return;
      tbody.innerHTML = "";

      (events || []).forEach(ev => {
        const tr = document.createElement("tr");

        const tdTime = document.createElement("td");
        tdTime.textContent = ev.time || "--";

        const tdEvent = document.createElement("td");
        tdEvent.textContent = ev.event || "";

        const tdCurr = document.createElement("td");
        tdCurr.textContent = ev.currency || "";

        const tdImpact = document.createElement("td");
        const pct = Number(ev.impactPct || ev.impact || 0);
        let cls = "cal-impact-low";
        if (pct >= 66) cls = "cal-impact-high";
        else if (pct >= 33) cls = "cal-impact-medium";
        tdImpact.className = cls;
        tdImpact.textContent = pct ? pct.toFixed(0) + "%" : "--";

        tr.appendChild(tdTime);
        tr.appendChild(tdEvent);
        tr.appendChild(tdCurr);
        tr.appendChild(tdImpact);
        tbody.appendChild(tr);
      });

      if (!events || !events.length) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 4;
        td.textContent = "No events received.";
        td.style.color = "var(--text-muted)";
        tr.appendChild(td);
        tbody.appendChild(tr);
      }
    }

    // === 3) Core Catalyst → Bubble Chart (no sticking) ===
    // items: [{ title, time, impactPct }, ...]
    function updateHeadlines(items) {
      const container = document.getElementById("headline-bubble-chart");
      if (!container) return;
      container.innerHTML = "";

      const list = items || [];
      if (!list.length) {
        const dummy = document.createElement("div");
        dummy.className = "hb-title";
        dummy.textContent = "No headlines received.";
        container.appendChild(dummy);
        return;
      }

      const n = list.length;
      const rect = container.getBoundingClientRect();
      const w = rect.width || container.clientWidth || 260;
      const h = rect.height || container.clientHeight || 180;
      const cx = w / 2;
      const cy = h / 2;

      const minSize = 55;
      const maxSize = 110;
      const sorted = list
        .map((it, idx) => ({ ...it, _idx: idx }))
        .sort((a, b) => (Number(b.impactPct || b.impact || 0) - Number(a.impactPct || a.impact || 0)));

      const maxRadius = Math.max(Math.min(w, h) / 2 - maxSize / 2 - 10, 30);
      const placed = []; // {x,y,r}

      sorted.forEach((item, order) => {
        const bubble = document.createElement("div");
        const impactRaw = Number(item.impactPct || item.impact || 0);
        const impact = Math.max(0, Math.min(100, isNaN(impactRaw) ? 0 : impactRaw));

        const size = minSize + (impact / 100) * (maxSize - minSize);
        const radius = size / 2;
        bubble.style.width = size + "px";
        bubble.style.height = size + "px";

        bubble.className = "headline-bubble";
        if (impact >= 66) bubble.classList.add("high");
        else if (impact >= 33) bubble.classList.add("medium");
        else bubble.classList.add("low");

        let x = cx;
        let y = cy;

        if (n === 1) {
          x = cx;
          y = cy;
        } else {
          if (order === 0) {
            x = cx;
            y = cy;
          } else {
            const idx = order - 1;
            const ringCount = Math.max(1, Math.ceil((n - 1) / 6));
            const ringIndex = Math.floor(idx / 6);
            const inRingPos = idx % 6;

            const radiusFactor = (ringIndex + 1) / (ringCount + 0.3);
            const r = maxRadius * radiusFactor;

            const angleStep = (2 * Math.PI) / Math.min(6, n - 1);
            const baseAngle = inRingPos * angleStep + ringIndex * 0.4;
            const jitter = (Math.random() - 0.5) * 0.4;
            const angle = baseAngle + jitter;

            x = cx + Math.cos(angle) * r;
            y = cy + Math.sin(angle) * r;
          }
        }

        const margin = radius + 6;
        x = Math.max(margin, Math.min(w - margin, x));
        y = Math.max(margin, Math.min(h - margin, y));

        // Simple collision avoidance: geser jika terlalu dekat bubble lain
        let safe = false;
        let attempts = 0;
        while (!safe && attempts < 40) {
          safe = true;
          for (const p of placed) {
            const dx = x - p.x;
            const dy = y - p.y;
            const dist = Math.sqrt(dx * dx + dy * dy) || 0.001;
            const minDist = radius + p.r + 4; // jarak minimum antar bubble

            if (dist < minDist) {
              safe = false;
              const angle = Math.atan2(dy, dx);
              const push = (minDist - dist);
              x += Math.cos(angle) * push;
              y += Math.sin(angle) * push;

              x = Math.max(margin, Math.min(w - margin, x));
              y = Math.max(margin, Math.min(h - margin, y));
            }
          }
          attempts++;
        }

        placed.push({ x, y, r: radius });

        bubble.style.left = x + "px";
        bubble.style.top = y + "px";

        const title = document.createElement("div");
        title.className = "hb-title";
        title.textContent = item.title || ("Headline " + (item._idx + 1));

        const meta = document.createElement("div");
        meta.className = "hb-meta";
        meta.textContent =
          (item.time ? item.time + " · " : "") +
          (impact ? ("Impact " + impact.toFixed(0) + "%") : "Impact N/A");

        bubble.appendChild(title);
        bubble.appendChild(meta);
        container.appendChild(bubble);
      });
    }

    // === 4) Market Heatmap 3 x 6 ===
    function updateHeatmap(cells) {
      const grid = document.getElementById("heatmap-grid");
      if (!grid) return;
      grid.innerHTML = "";

      const totalCells = 18;
      const data = cells || [];

      for (let i = 0; i < totalCells; i++) {
        const cellData = data[i] || {};
        const cell = document.createElement("div");
        cell.className = "heatmap-cell";

        if (cellData.color) {
          cell.style.background = cellData.color;
        }

        const sym = document.createElement("div");
        sym.className = "heatmap-symbol";
        sym.textContent = cellData.symbol || ("ASSET-" + (i + 1));

        const val = document.createElement("div");
        val.className = "heatmap-value";
        val.textContent = cellData.value != null ? cellData.value : "--";

        const chg = document.createElement("div");
        chg.className = "heatmap-change";
        if (cellData.change != null) {
          const prefix = cellData.change > 0 ? "+" : "";
          chg.textContent = prefix + cellData.change + "%";
          chg.style.color = cellData.change > 0 ? "#c5ffb0" :
                            cellData.change < 0 ? "#ffb0b0" :
                            "#e0e0e0";
        } else {
          chg.textContent = "";
        }

        cell.appendChild(sym);
        cell.appendChild(val);
        cell.appendChild(chg);
        grid.appendChild(cell);
      }
    }

    // === 5) Risk-On / Risk-Off Meter ===
    function updateRiskMeter(score) {
      const pointer = document.getElementById("risk-meter-pointer");
      const valueEl = document.getElementById("risk-meter-value");
      const tagEl = document.getElementById("risk-meter-tag");
      if (!pointer || !valueEl || !tagEl) return;

      const s = Math.max(0, Math.min(100, Number(score)));
      const pct = s;
      pointer.style.left = pct + "%";

      valueEl.textContent = "Score: " + s.toFixed(0) + " / 100";

      let label = "neutral";
      if (s <= 33) label = "Risk-Off";
      else if (s >= 67) label = "Risk-On";

      tagEl.textContent = "Composite regime: " + label;
    }

    // === 6) Market Quotes (inside Risk Meter card) ===
    function updateQuotes(rows) {
      const tbody = document.querySelector("#risk-quotes-table tbody");
      if (!tbody) return;
      tbody.innerHTML = "";

      (rows || []).forEach(row => {
        const tr = document.createElement("tr");

        const tdAsset = document.createElement("td");
        tdAsset.innerHTML =
          '<span class="quote-symbol">' + (row.symbol || "") + "</span>" +
          (row.name ? ' <span style="color:var(--text-muted);font-size:9px;">' + row.name + "</span>" : "");

        const tdLast = document.createElement("td");
        tdLast.textContent = row.last != null ? row.last : "--";

        const tdChg = document.createElement("td");
        const chg = row.change;
        const sign = chg > 0 ? "pos" : chg < 0 ? "neg" : "";
        tdChg.className = "quote-change " + sign;
        tdChg.textContent = chg != null ? chg : "--";

        const tdPct = document.createElement("td");
        const pct = row.changePct;
        tdPct.className = "quote-change " + sign;
        tdPct.textContent = pct != null ? (pct.toFixed(2) + "%") : "--";

        tr.appendChild(tdAsset);
        tr.appendChild(tdLast);
        tr.appendChild(tdChg);
        tr.appendChild(tdPct);
        tbody.appendChild(tr);
      });
    }

    // ============================
    // WebSocket / API skeleton
    // ============================
    // {
    //   ts: "2025-11-15 13:05:00",
    //   ai_summary: "...",
    //   signals: [{symbol, bias, confidencePct}, ...],
    //   calendar: [{time, event, currency, impactPct}, ...],
    //   headlines: [{title, time, impactPct}, ...],
    //   quotes: [{symbol, name, last, change, changePct}, ...],
    //   heatmap: [{symbol, value, change, color}, ...],
    //   risk_score: 58
    // }

    function connectWebSocket() {
      // const ws = new WebSocket("wss://your-websocket-endpoint");
      // ws.onopen = () => console.log("WS connected");
      // ws.onmessage = (event) => {
      //   const payload = JSON.parse(event.data);
      //
      //   if (payload.ts) updateTimestamp(payload.ts);
      //   if (payload.ai_summary) updateAiSummary(payload.ai_summary);
      //   if (payload.signals) updateTradingSignals(payload.signals);
      //   if (payload.calendar) updateEconomicCalendar(payload.calendar);
      //   if (payload.headlines) updateHeadlines(payload.headlines);
      //   if (payload.quotes) updateQuotes(payload.quotes);
      //   if (payload.heatmap) updateHeatmap(payload.heatmap);
      //   if (payload.risk_score != null) updateRiskMeter(payload.risk_score);
      // };
      // ws.onerror = (err) => console.error("WS error:", err);
      // ws.onclose = () => console.log("WS closed");
    }

    // ============================
    // Demo mock (bisa dihapus)
    // ============================
    function renderMockData() {
      updateTimestamp("demo mode");

      updateEconomicCalendar([
        { time:"19:30", event:"US CPI YoY", currency:"USD", impactPct:85 },
        { time:"19:30", event:"US Core CPI MoM", currency:"USD", impactPct:78 },
        { time:"21:00", event:"Fed Chair Speech", currency:"USD", impactPct:90 },
        { time:"14:00", event:"UK GDP MoM", currency:"GBP", impactPct:55 },
        { time:"16:00", event:"EZ Industrial Production", currency:"EUR", impactPct:40 }
      ]);

      updateHeadlines([
        { title:"US CPI in focus as markets reassess timing of first Fed cut", time:"12:10", impactPct:82 },
        { title:"Dollar consolidates; JPY under pressure on policy divergence", time:"11:55", impactPct:68 },
        { title:"Tech outperforms cyclicals as earnings revisions improve", time:"11:20", impactPct:51 },
        { title:"Crude pulls back after sharp rally; positioning remains crowded", time:"10:45", impactPct:44 },
        { title:"Credit spreads stay tight despite elevated yields", time:"10:05", impactPct:33 }
      ]);

      updateQuotes([
        { symbol:"SPX",   name:"S&P 500",    last:"5,230.4", change:+12.3, changePct:+0.24 },
        { symbol:"NDX",   name:"Nasdaq 100", last:"18,120",  change:+65.1, changePct:+0.36 },
        { symbol:"DXY",   name:"US Dollar",  last:"105.2",   change:-0.12, changePct:-0.11 },
        { symbol:"XAU",   name:"Gold",       last:"2,365",   change:-8.5,  changePct:-0.36 },
        { symbol:"WTI",   name:"Crude Oil",  last:"79.4",    change:+0.9,  changePct:+1.15 },
        { symbol:"BTC",   name:"Bitcoin",    last:"67,800",  change:+420,  changePct:+0.62 }
      ]);

      updateHeatmap([
        { symbol:"SPX",  value:"5,230", change:+0.24, color:"#234c39" },
        { symbol:"NDX",  value:"18,120", change:+0.36, color:"#24503e" },
        { symbol:"RUT",  value:"2,080", change:-0.15, color:"#4a2629" },
        { symbol:"DXY",  value:"105.2", change:-0.11, color:"#333333" },
        { symbol:"EURUSD", value:"1.085", change:+0.18, color:"#27513f" },
        { symbol:"USDJPY", value:"152.3", change:+0.22, color:"#4a2629" },
        { symbol:"XAUUSD", value:"2,365", change:-0.36, color:"#4a2629" },
        { symbol:"XAGUSD", value:"28.1", change:+0.45, color:"#27513f" },
        { symbol:"WTI", value:"79.4", change:+1.15, color:"#2b6344" },
        { symbol:"BRENT", value:"83.1", change:+0.92, color:"#295840" },
        { symbol:"HYG", value:"78.2", change:+0.05, color:"#234c39" },
        { symbol:"LQD", value:"108.5", change:-0.09, color:"#4a2629" },
        { symbol:"US10Y", value:"4.28%", change:+0.03, color:"#4a2629" },
        { symbol:"US2Y", value:"4.71%", change:+0.01, color:"#333333" },
        { symbol:"MOVE", value:"98", change:-1.8, color:"#27513f" },
        { symbol:"VIX", value:"16.2", change:-0.6, color:"#27513f" },
        { symbol:"EEM", value:"42.1", change:+0.30, color:"#27513f" },
        { symbol:"EFA", value:"82.4", change:+0.12, color:"#234c39" }
      ]);

      updateRiskMeter(58);

      // Demo Trading Signals default (kalau belum klik Generate Summary)
      updateTradingSignals([
        { symbol:"SPX", bias:"long", confidencePct:72 },
        { symbol:"NDX", bias:"long", confidencePct:80 },
        { symbol:"RUT", bias:"neutral", confidencePct:48 }
      ]);
    }

    function initDashboard() {
      renderMockData();
      // connectWebSocket();
    }

    window.addEventListener("DOMContentLoaded", initDashboard);
  </script>
</body>
</html>
