      const initFrontSignalControls = () => {
        if (!frontSignalControlsEl) return;
        frontSignalControlsEl.querySelectorAll(".front-nav").forEach((btn) => {
          btn.addEventListener("click", () => {
            const dir = btn.dataset.dir === "prev" ? -1 : 1;
            showFrontSignalAt(frontSignalIndex + dir);
          });
        });
        setFrontControlsState();
      };

      const renderInsightSkeleton = (rows = 4) => {
        if (!insightListEl) return;
        insightListEl.innerHTML = "";
        Array.from({ length: rows }).forEach(() => {
          const li = document.createElement("li");
          li.innerHTML = `
            <div class="border border-frame bg-ink/50 p-3 text-xs">
              <div class="mb-3 h-3 w-32 skeleton-line shimmer-line"></div>
              <div class="mb-2 h-4 w-full skeleton-line shimmer-line"></div>
              <div class="mb-2 h-3 w-4/5 skeleton-line shimmer-line"></div>
              <div class="h-3 w-3/5 skeleton-line shimmer-line"></div>
            </div>`;
          insightListEl.appendChild(li);
        });
      };
      renderInsightSkeleton();

      const renderAssetSkeleton = (rows = 3) => {
        if (!assetStoriesEl) return;
        assetStoriesEl.innerHTML = "";
        Array.from({ length: rows }).forEach(() => {
          const card = document.createElement("div");
          card.className = "asset-card border border-frame bg-ink/40 p-3";
          card.innerHTML = `
            <div class="mb-2 h-36 shimmer-line"></div>
            <div class="mb-2 h-3 w-32 shimmer-line"></div>
            <div class="mb-2 h-4 w-full shimmer-line"></div>
            <div class="mb-2 h-3 w-3/4 shimmer-line"></div>
            <div class="h-3 w-1/2 shimmer-line"></div>`;
          assetStoriesEl.appendChild(card);
        });
      };
      renderAssetSkeleton();

      const renderAssetTabs = () => {
        if (!assetTabsEl) return;
        assetTabsEl.innerHTML = "";
        ASSET_CLASSES.forEach(({ id, label }) => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.textContent = label;
          btn.className = `border border-frame px-3 py-1 ${
            id === assetActiveId ? "bg-[#FFBF00] text-black" : "text-neutral-400 hover:text-white"
          }`;
          btn.addEventListener("click", () => {
            if (assetActiveId === id) return;
            assetActiveId = id;
            renderAssetTabs();
            fetchAssetStories(assetActiveId);
          });
          assetTabsEl.appendChild(btn);
        });
      };

      const renderAssetStories = (stories) => {
        if (!assetStoriesEl) return;
        assetStoriesEl.innerHTML = "";
        if (!stories.length) {
          assetStoriesEl.innerHTML = '<p class="text-xs text-neutral-500">No data for this asset class.</p>';
          return;
        }
        stories.forEach((story) => {
          const tagsLine = tagTexts(story.tags).slice(0, 3).join(" • ");
          const summary = story.summary || tagsLine;
          const chipMarkup = buildChipMarkup(story.tags, 4);
          const imageMarkup = story.image_url
            ? `<img src="${story.image_url}" alt="${story.title}" class="border border-frame/50" />`
            : "";
          const card = document.createElement("a");
          card.href = story.url || "#";
          card.target = "_blank";
          card.rel = "noopener";
          card.className =
            "asset-card block border border-frame bg-ink/60 p-3 text-xs text-neutral-300 hover:border-[#FFBF00]";
          card.innerHTML = `
            ${imageMarkup}
            <p class="mt-2 text-[10px] uppercase text-neutral-500">${story.source || "News"}</p>
            <h3 class="mt-1 text-base font-semibold text-white">${story.title}</h3>
            ${summary ? `<p class="mt-2 text-neutral-400">${summary}</p>` : ""}
            ${chipMarkup ? `<div class="mt-3 flex flex-wrap gap-2">${chipMarkup}</div>` : ""}
            <p class="mt-3 text-[10px] uppercase text-neutral-500">${formatInsightTime(story.publish_time || story.publish_dt)}</p>
          `;
          assetStoriesEl.appendChild(card);
        });
      };

      const fetchAssetStories = async (assetId, { append = false } = {}) => {
        const label = ASSET_LABEL_MAP[assetId] || "Asset";
        const state = getAssetState(assetId);
        if (state.loading) return;
        if (append && state.exhausted) return;
        const nextPage = append ? state.page + 1 : 1;

        if (!append) {
          if (state.items.length) {
            renderAssetStories(state.items);
            if (assetStatusEl)
              assetStatusEl.textContent = `Cached ${label}${state.page ? ` • page ${state.page}` : ""}`;
          } else {
            renderAssetSkeleton();
          }
        }

        state.loading = true;
        if (assetStatusEl)
          assetStatusEl.textContent = append ? `Loading more ${label}…` : `Loading ${label}…`;

        try {
          const response = await fetchWithAuth(buildCityFalconUrl(assetId, nextPage), {
            headers: { Accept: "application/json" },
          });
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const payload = await response.json();
          const normalized = resolveCityFalconList(payload)
            .map(normalizeCityFalconStory)
            .filter(Boolean);

          if (append) {
            if (normalized.length) {
              state.items = state.items.concat(normalized);
              state.page = nextPage;
            } else {
              state.exhausted = true;
            }
          } else {
            state.items = normalized;
            state.page = normalized.length ? nextPage : 0;
            state.exhausted = normalized.length === 0;
          }

          renderAssetStories(state.items);
          if (assetStatusEl) {
            if (state.items.length) {
              const suffix = state.exhausted ? " • end" : "";
              assetStatusEl.textContent = state.exhausted
                ? `${label}${suffix}`
                : `${label}${state.page > 1 ? ` • page ${state.page}` : ""}`;
            } else {
              assetStatusEl.textContent = `No data for ${label}`;
            }
          }
        } catch (error) {
          console.error("Asset class feed error:", error);
          if (!append) {
            if (state.items.length) {
              renderAssetStories(state.items);
              if (assetStatusEl) assetStatusEl.textContent = `Offline • showing cached ${label}`;
            } else {
              renderAssetStories([]);
              if (assetStatusEl) assetStatusEl.textContent = `Error • ${error.message || "Network error"}`;
            }
          } else if (assetStatusEl) {
            assetStatusEl.textContent = `Load more failed • ${error.message || "Network error"}`;
          }
        } finally {
          state.loading = false;
        }
      };

      const formatInsightTime = (value) => {
        if (!value) return "Unknown time";
        if (value.includes("UTC")) return value;
        const dt = new Date(value);
        if (Number.isNaN(dt.getTime())) return value;
        return `${dt.toLocaleDateString("en-GB")} ${dt.toLocaleTimeString("en-GB", { hour12: false })} UTC`;
      };

      const formatRelativeTimestamp = (iso) => {
        if (!iso) return "";
        const dt = new Date(iso);
        if (Number.isNaN(dt.getTime())) return "";
        const now = new Date();
        const diffMinutes = Math.round((now - dt) / 60000);
        if (diffMinutes < 1) return "Updated just now";
        if (diffMinutes < 60) return `Updated ${diffMinutes}m ago`;
        const diffHours = Math.round(diffMinutes / 60);
        if (diffHours < 24) return `Updated ${diffHours}h ago`;
        return `Updated ${dt.toLocaleDateString("en-GB")} ${dt.toLocaleTimeString("en-GB", { hour12: false })} UTC`;
      };

      const formatSentiment = (value) => {
        const num = Number(value || 0);
        if (num > 0) return "Bullish";
        if (num < 0) return "Bearish";
        return "Neutral";
      };

      const buildSummary = (item) => {
        if (!item) return "";
        if (item.summary) return item.summary;
        const tags = tagTexts(item.tags).slice(0, 3).join(" • ");
        if (tags) return tags;
        if (Array.isArray(item.bullets) && item.bullets.length) {
          return item.bullets.slice(0, 3).join(" • ");
        }
        return "";
      };

      const buildIndicators = (item) => {
        if (!item) return "Awaiting data…";
        const bullets = Array.isArray(item.bullets) ? item.bullets : [];
        const tags = tagTexts(item.tags);
        const merged = [...tags, ...bullets].filter(Boolean).slice(0, 4);
        if (merged.length) return merged.join(" • ");
        const label = item._feed || item.source || "Source";
        return `${label} • Sentiment ${formatSentiment(item.sentiment)}`;
      };

      const resolveFastbullTagNames = (tagString) => {
        if (!tagString) return [];
        return tagString
          .split(",")
          .map((token) => fastbullTagMap.get(token.trim()))
          .filter(Boolean)
          .flatMap((entry) => entry.split("/").map((name) => name.trim()).filter(Boolean));
      };

      const formatFastbullUTC = (value) => {
        if (!value) return "Unknown time";
        let timestamp = Number(value);
        if (Number.isNaN(timestamp)) {
          const parsed = new Date(value);
          timestamp = parsed.getTime();
        }
        if (!timestamp) return "Unknown time";
        const date = new Date(timestamp);
        if (Number.isNaN(date.getTime())) return "Unknown time";
        const iso = date.toISOString();
        return `${iso.slice(0, 16).replace("T", " ")} UTC`;
      };

      const setLatestStatus = (text) => {
        if (latestStatusEl) latestStatusEl.textContent = text;
      };

      const resolveLatestCategoryLabel = (value) => {
        if (!latestDropdownEl) return "Semua";
        const options = Array.from(latestDropdownEl.options || []);
        const found = options.find((opt) => opt.value === value);
        return (found ? found.textContent : "Semua") || "Semua";
      };

      const updateLatestRecapButton = (value) => {
        if (!latestRecapBtn) return;
        const label = resolveLatestCategoryLabel(value);
        latestRecapBtn.textContent = `Recap ${label} Catalyst By Kuantara AI`;
      };

      const ensureLatestCategoryData = async (tagIds) => {
        let cache = latestCache.get(tagIds);
        if (cache && cache.items.length) return cache;
        await fetchFastbullNews(tagIds);
        cache = latestCache.get(tagIds);
        return cache || { items: [] };
      };

      const buildRecapPrompt = (label, items) => {
        const headlines = Array.isArray(items) ? items : [];
        if (!headlines.length) {
          return `Tidak ada headline untuk kategori ${label}. Jelaskan kondisi tersebut namun tetap berikan wawasan makro singkat.`;
        }
        const lines = headlines.slice(0, MAX_RECAP_ITEMS).map((item, idx) => {
          const time = formatFastbullUTC(item.timestamp);
          const tags = (item.tagNames || []).slice(0, 3).join(", ");
          return `${idx + 1}. [${time}] ${item.title}${tags ? ` (Tags: ${tags})` : ""}`;
        });
        return `Anda adalah Kuantara AI. Ringkaslah kategori ${label} dalam maksimal 10 poin tajuk utama + 1 paragraf kesimpulan, soroti katalis, risiko, dan peluang.\nData:\n${lines.join("\n")}`;
      };

      const normalizeCatalystItem = (item) => {
        if (!item) return null;
        const rawContent = item.content ?? item.summary ?? "";
        const contentValue =
          rawContent === null || rawContent === undefined
            ? ""
            : typeof rawContent === "string"
            ? rawContent.trim()
            : String(rawContent);
        return {
          timestamp: item.timestamp || item.time || "",
          headline: item.headline || item.title || "Untitled catalyst",
          content: contentValue,
          impact: item.impact || "Low Impact",
          category1: item.category1 || "",
          category2: item.category2 || "",
        };
      };

      const formatImpactBadgeClass = (impact = "") => {
        if (/high/i.test(impact)) return "impact-high";
        if (/medium/i.test(impact)) return "impact-medium";
        return "";
      };

      const catalystCategories = () => {
        const map = new Map();
        catalystItems.forEach((item) => {
          const key = item.category1 || "Lainnya";
          if (!map.has(key)) map.set(key, key);
        });
        return Array.from(map.keys()).sort();
      };

      const renderCatalystSkeleton = () => {
        if (!catalystListEl) return;
        catalystListEl.innerHTML = "";
        Array.from({ length: 3 }).forEach(() => {
          const li = document.createElement("li");
          li.className = "catalyst-card";
          li.innerHTML = `
            <div class="space-y-2">
              <p class="headline shimmer-line h-4 w-3/4"></p>
              <p class="shimmer-line h-3 w-full"></p>
              <p class="shimmer-line h-3 w-4/5"></p>
            </div>
          `;
          catalystListEl.appendChild(li);
        });
      };

      const fetchCatalystFeed = async ({ force = false, silent = false } = {}) => {
        if (catalystLoading) return;
        if (!force && catalystFetched) return;
        catalystLoading = true;
        const needsInitialUi = !catalystFetched || !catalystItems.length;
        if (needsInitialUi) {
          if (catalystStatusEl) catalystStatusEl.textContent = "Loading feed…";
          renderCatalystSkeleton();
        } else if (!silent && catalystStatusEl) {
          catalystStatusEl.textContent = "Refreshing…";
        }
        try {
          const response = await fetch(CATALYST_FEED_API, { headers: { Accept: "application/json" } });
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const data = await response.json();
          const list = Array.isArray(data) ? data : data?.items || [];
          catalystItems = list.map(normalizeCatalystItem).filter(Boolean);
          catalystFetched = true;
          populateCatalystDropdown();
          renderCatalystFeed();
          if (catalystStatusEl) catalystStatusEl.textContent = "Updated";
        } catch (error) {
          console.error("Catalyst feed error:", error);
          if (catalystStatusEl) catalystStatusEl.textContent = `Feed error • ${error.message || "Network error"}`;
          if (catalystListEl)
            catalystListEl.innerHTML =
              '<li class="text-xs text-rose-300">Gagal memuat catalyst feed.</li>';
        } finally {
          catalystLoading = false;
        }
      };

      const populateCatalystDropdown = () => {
        if (!catalystDropdownEl) return;
        const selected = catalystDropdownEl.value || "all";
        catalystDropdownEl.innerHTML = '<option value="all">Semua</option>';
        catalystCategories().forEach((cat) => {
          const option = document.createElement("option");
          option.value = cat;
          option.textContent = cat;
          catalystDropdownEl.appendChild(option);
        });
        if (Array.from(catalystDropdownEl.options).some((opt) => opt.value === selected)) {
          catalystDropdownEl.value = selected;
          catalystSelected = selected;
        } else {
          catalystDropdownEl.value = "all";
          catalystSelected = "all";
        }
        updateCatalystRecapButton();
      };

      const updateCatalystRecapButton = () => {
        if (!catalystRecapBtn || !catalystDropdownEl) return;
        const label =
          catalystDropdownEl.value === "all"
            ? "Semua"
            : catalystDropdownEl.options[catalystDropdownEl.selectedIndex]?.textContent || "Semua";
        catalystRecapBtn.textContent = `Recap ${label} Catalyst By Kuantara AI`;
      };

      const filterCatalystItems = () => {
        if (catalystSelected === "all") return catalystItems;
        return catalystItems.filter((item) => (item.category1 || "") === catalystSelected);
      };

      const buildCatalystCard = (item) => {
        const li = document.createElement("li");
        li.className = "catalyst-card";
        const isHigh = /high/i.test(item.impact);
        const isMedium = /medium/i.test(item.impact);
        if (isHigh) li.classList.add("high-impact-card");
        if (isMedium) li.classList.add("impact-medium-card");
        const impactClass = formatImpactBadgeClass(item.impact);
        const chips = [item.category1, item.category2].filter(Boolean);
        const chipMarkup = chips
          .map((chip) => `<span class="chip">${chip}</span>`)
          .join("");
        li.innerHTML = `
          <div class="space-y-2">
            <div class="headline-container">
              ${
                /high/i.test(item.impact)
                  ? '<span class="important-dot"></span>'
                  : ""
              }
              <p class="headline">${item.headline}</p>
            </div>
            <p class="text-xs text-neutral-500">${formatFastbullUTC(item.timestamp)}</p>
            <p class="text-neutral-300">${item.content}</p>
            ${
              chipMarkup
                ? `<div class="catalyst-tags">${chipMarkup}</div>`
                : ""
            }
            <div class="impact-row">
              <span class="impact-badge ${impactClass}">${item.impact || "Impact"}</span>
              <button class="copy-btn" aria-label="Salin headline">
                ${COPY_ICON}
              </button>
            </div>
          </div>
        `;
        const copyBtn = li.querySelector(".copy-btn");
        if (copyBtn) {
          copyBtn.addEventListener("click", () => copyLatestHeadline(item.headline, copyBtn));
        }
        return li;
      };

      const renderCatalystFeed = () => {
        if (!catalystListEl) return;
        const items = filterCatalystItems();
        catalystListEl.innerHTML = "";
        if (!items.length) {
          catalystListEl.innerHTML =
            '<li class="text-xs text-neutral-500">Tidak ada catalyst untuk kategori ini.</li>';
          return;
        }
        items.slice(0, 30).forEach((item) => {
          catalystListEl.appendChild(buildCatalystCard(item));
        });
      };

      const ensureCatalystCategoryData = async (category) => {
        if (!catalystFetched) await fetchCatalystFeed();
        if (!catalystFetched) return { items: [] };
        const list = category === "all" ? catalystItems : catalystItems.filter((item) => (item.category1 || "") === category);
        return { items: list };
      };

      const buildCatalystRecapPrompt = (label, items) => {
        if (!items.length) return "";
        const lines = items.slice(0, MAX_RECAP_ITEMS).map((item, idx) => {
          const hasContent = item.content !== undefined && item.content !== null;
          const contentText = hasContent ? String(item.content).trim() : "";
          const detail = contentText ? ` — ${contentText}` : "";
          return `${idx + 1}. [${formatFastbullUTC(item.timestamp)}] ${item.headline}${detail} — Impact: ${item.impact}`;
        });
        return `Anda adalah Kuantara AI. Buat rangkuman catalyst untuk kategori ${label} dengan maksimal 5 poin utama dan satu kesimpulan yang menekankan dampak pasar.\nData:\n${lines.join(
          "\n"
        )}`;
      };

      const formatXFeedRelativeTime = (ts) => {
        if (!ts) return "now";
        const value = Number(ts);
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) return "now";
        const diffMs = Date.now() - date.getTime();
        const diffMinutes = Math.floor(diffMs / 60000);
        if (diffMinutes < 1) return "now";
        if (diffMinutes < 60) return `${diffMinutes}m`;
        const diffHours = Math.floor(diffMinutes / 60);
        if (diffHours < 24) return `${diffHours}h`;
        const diffDays = Math.floor(diffHours / 24);
        return `${diffDays}d`;
      };

      const normalizeXFeedItem = (item) => {
        if (!item) return null;
        return {
          id: item.id || item.statusId || "",
          timestamp: Number(item.ts) || Date.now(),
          name: item.name || item.screenName || "X Feed",
          screenName: item.screenName || "",
          avatar: item.avatar || "",
          text: item.text || "",
          media: item.media || "",
          tweetUrl: item.link || item.url || "",
          externalUrl: item.externalUrl || "",
          titleUrl: item.titleUrl || "",
          descriptionUrl: item.descriptionUrl || "",
          tts: item.tts || "",
        };
      };

      const renderXFeedSkeleton = () => {
        if (!xFeedListEl) return;
        xFeedListEl.innerHTML = "";
        Array.from({ length: 3 }).forEach(() => {
          const li = document.createElement("li");
          li.className = "x-feed-card";
          li.innerHTML = `
            <div class="space-y-3">
              <div class="shimmer-line h-4 w-1/3"></div>
              <div class="shimmer-line h-5 w-full"></div>
              <div class="shimmer-line h-48 w-full"></div>
            </div>
          `;
          xFeedListEl.appendChild(li);
        });
      };

      const openXFeedLink = (url) => {
        if (!url) return;
        window.open(url, "_blank", "noopener");
      };

      const createXFeedActionButton = (label, handler, disabled = false) => {
        const button = document.createElement("button");
        button.type = "button";
        button.className = "x-feed-action";
        button.textContent = label;
        if (disabled) {
          button.disabled = true;
          button.classList.add("disabled");
        } else if (typeof handler === "function") {
          button.addEventListener("click", handler);
        }
        return button;
      };

      const buildXFeedCard = (item) => {
        const li = document.createElement("li");
        li.className = "x-feed-card";
        const header = document.createElement("div");
        header.className = "x-feed-header";

        const avatar = document.createElement("img");
        avatar.className = "x-feed-avatar";
        avatar.src = item.avatar || DEFAULT_IMAGE;
        avatar.alt = item.name || item.screenName || "X Feed";
        header.appendChild(avatar);

        const author = document.createElement("div");
        author.className = "x-feed-author";
        const nameEl = document.createElement("span");
        nameEl.className = "x-feed-name";
        nameEl.textContent = item.name || "X Feed";
        author.appendChild(nameEl);
        if (item.screenName) {
          const handle = document.createElement("span");
          handle.className = "x-feed-handle";
          handle.textContent = `@${item.screenName}`;
          author.appendChild(handle);
        }
        header.appendChild(author);

        const timeEl = document.createElement("span");
        timeEl.className = "x-feed-time";
        timeEl.textContent = formatXFeedRelativeTime(item.timestamp);
        header.appendChild(timeEl);

        li.appendChild(header);

        if (item.text) {
          const text = document.createElement("p");
          text.className = "x-feed-text";
          text.textContent = item.text;
          li.appendChild(text);
        }

        const hasPreview = Boolean(item.externalUrl || item.titleUrl || item.descriptionUrl);

        if (item.media && !hasPreview) {
          const media = document.createElement("div");
          media.className = "x-feed-media";
          const img = document.createElement("img");
          img.src = item.media;
          img.alt = item.titleUrl || "X media";
          media.appendChild(img);
          li.appendChild(media);
        }

        if (hasPreview) {
          const preview = document.createElement("a");
          preview.className = "x-feed-preview";
          preview.href = item.externalUrl || item.tweetUrl || "#";
          preview.target = "_blank";
          preview.rel = "noopener";
          if (item.media) {
            const previewImg = document.createElement("img");
            previewImg.src = item.media;
            previewImg.alt = item.titleUrl || "Preview";
            preview.appendChild(previewImg);
          }
          const body = document.createElement("div");
          body.className = "x-feed-preview-body";
          if (item.externalUrl) {
            const source = document.createElement("p");
            source.className = "x-feed-preview-source";
            try {
              const hostname = new URL(item.externalUrl).hostname.replace("www.", "");
              source.textContent = hostname;
            } catch {
              source.textContent = "Source";
            }
            body.appendChild(source);
          }
          if (item.titleUrl) {
            const titleEl = document.createElement("p");
            titleEl.className = "x-feed-preview-title";
            titleEl.textContent = item.titleUrl;
            body.appendChild(titleEl);
          }
          if (item.descriptionUrl) {
            const descEl = document.createElement("p");
            descEl.className = "x-feed-preview-desc";
            descEl.textContent = item.descriptionUrl;
            body.appendChild(descEl);
          }
          preview.appendChild(body);
          li.appendChild(preview);
        }

        const buttons = document.createElement("div");
        buttons.className = "x-feed-buttons";
        const readBtn = createXFeedActionButton("READ", () => openXFeedReader(item), !item.id);
        const quickBtn = createXFeedActionButton(
          "QUICK",
          () => openXFeedLink(item.externalUrl || item.tweetUrl),
          !(item.externalUrl || item.titleUrl)
        );
        const insightBtn = createXFeedActionButton(
          "INSIGHT",
          () => showXFeedInsight(item),
          !item.descriptionUrl
        );
        buttons.append(readBtn, quickBtn, insightBtn);
        li.appendChild(buttons);
        return li;
      };

      const renderXFeed = () => {
        if (!xFeedListEl) return;
        xFeedListEl.innerHTML = "";
        if (!xFeedItems.length) {
          xFeedListEl.innerHTML =
            '<li class="text-xs text-neutral-500">Tidak ada update dari X Feed.</li>';
          return;
        }
        xFeedItems.slice(0, 30).forEach((item) => {
          const card = buildXFeedCard(item);
          xFeedListEl.appendChild(card);
        });
      };

      const fetchXFeed = async ({ silent = false } = {}) => {
        if (!xFeedListEl || xFeedLoading) return;
        xFeedLoading = true;
        const needsInitialUi = !xFeedFetched || !xFeedItems.length;
        if (needsInitialUi) {
          renderXFeedSkeleton();
          if (xFeedStatusEl) xFeedStatusEl.textContent = "Loading feed…";
        } else if (!silent && xFeedStatusEl) {
          xFeedStatusEl.textContent = "Refreshing feed…";
        }
        try {
          const response = await fetch(X_FEED_API, { headers: { Accept: "application/json" } });
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const payload = await response.json();
          const list = Array.isArray(payload?.items) ? payload.items : [];
          xFeedItems = list.map(normalizeXFeedItem).filter(Boolean);
          xFeedFetched = true;
          renderXFeed();
          if (xFeedStatusEl) {
            xFeedStatusEl.textContent = xFeedItems.length > 0 ? "Live" : "No posts";
          }
        } catch (error) {
          console.error("X feed error:", error);
          if (xFeedStatusEl) xFeedStatusEl.textContent = `Feed error • ${error.message || "Network error"}`;
          if (xFeedListEl)
            xFeedListEl.innerHTML = '<li class="text-xs text-rose-300">Gagal memuat X Feed.</li>';
        } finally {
          xFeedLoading = false;
        }
      };

      const ensureXFeedData = async () => {
        if (!xFeedFetched) await fetchXFeed();
        return { items: xFeedItems };
      };

      const buildXFeedRecapPrompt = (label, items) => {
        if (!items.length) return "";
        const lines = items.slice(0, MAX_RECAP_ITEMS).map((item, idx) => {
          const text = item.text || item.titleUrl || "Tanpa teks";
          return `${idx + 1}. [${formatFastbullUTC(item.timestamp)}] ${item.name}: ${text}`;
        });
        return `Anda adalah Kuantara AI. Ringkas ${label} menjadi maksimal 5 poin headline dan 1 paragraf kesimpulan berbahasa Indonesia, soroti sentimen pasar, risiko, dan peluang.\nData:\n${lines.join(
          "\n"
        )}`;
      };

      const showXFeedInsight = (item) => {
        if (!item || !item.descriptionUrl) return;
        openReaderShell(item.titleUrl || "Insight");
        setReaderLoading(false);
        if (readerBodyEl) {
          const desc = document.createElement("p");
          desc.className = "text-sm leading-relaxed text-neutral-100";
          desc.textContent = item.descriptionUrl;
          readerBodyEl.innerHTML = "";
          readerBodyEl.appendChild(desc);
          if (item.externalUrl) {
            const link = document.createElement("a");
            link.href = item.externalUrl;
            link.target = "_blank";
            link.rel = "noopener";
            link.className =
              "inline-flex items-center gap-2 text-xs uppercase tracking-[0.3em] text-amber-300 underline";
            link.textContent = "Buka sumber";
            readerBodyEl.appendChild(link);
          }
        }
      };

      const openXFeedReader = async (item) => {
        if (!item || !item.id) return;
        openReaderShell(item.titleUrl || item.text || "X Feed Reader");
        setReaderLoading(true);
        if (readerBodyEl) readerBodyEl.innerHTML = "";

        let fallbackTriggered = false;
        let fallbackAttempted = false;
        const tryRedirectToFallbackLink = (reason = "HTTP 404") => {
          fallbackAttempted = true;
          if (fallbackTriggered) return true;
          const fallbackUrl = item.externalUrl || item.tweetUrl;
          if (!fallbackUrl) return false;
          fallbackTriggered = true;
          if (readerBodyEl) {
            readerBodyEl.innerHTML = `<p class="text-sm text-neutral-300">Reader tidak tersedia (${reason}). Membuka sumber asli…</p>`;
          }
          openXFeedLink(fallbackUrl);
          return true;
        };

        try {
          const response = await fetch(buildXFeedReaderUrl(item.id), {
            headers: { Accept: "application/json" },
          });
          if (!response.ok) {
            if (response.status === 404 && tryRedirectToFallbackLink("HTTP 404")) {
              return;
            }
            throw new Error(`HTTP ${response.status}`);
          }
          const payload = await response.json();
          const html = payload?.reader;
          if (readerBodyEl) {
            readerBodyEl.innerHTML =
              html || '<p class="text-sm text-neutral-400">Reader tidak tersedia.</p>';
          }
        } catch (error) {
          console.error("Reader error:", error);
          const message = error?.message || "Network error";
          if (/404/.test(message) && tryRedirectToFallbackLink("HTTP 404")) {
            return;
          }
          if (readerBodyEl) {
            readerBodyEl.innerHTML = `<p class="text-sm text-rose-300">Gagal memuat reader. ${message}${
              fallbackAttempted && !fallbackTriggered ? ". Tidak ada tautan sumber." : ""
            }</p>`;
          }
        } finally {
          setReaderLoading(false);
        }
      };

      const updateCcCounter = () => {
        if (ccWordCountEl) {
          ccWordCountEl.textContent = `${liveCcWords.length} / ${LIVE_CC_THRESHOLD} kata`;
        }
      };

      const pushLiveSummaryCard = (markdown, status = "AI Catalyst Summary") => {
        if (!aiSummaryFeedEl || aiSummaryFeedEl.dataset.enabled !== "true") return;
        if (aiSummaryFeedEl.dataset.empty !== "false") {
          aiSummaryFeedEl.innerHTML =
            '<p class="text-xs text-neutral-500 uppercase tracking-[0.25em] mb-3">AI SUMMARY FEED</p><p class="text-xs text-neutral-500">Mengumpulkan ringkasan…</p>';
          aiSummaryFeedEl.dataset.empty = "false";
          aiSummaryFeedEl.classList.remove("hidden");
        }
        const card = document.createElement("article");
        card.className = "summary-card";
        card.innerHTML = `
          <h4>${status} • ${new Date().toLocaleTimeString("en-GB", { hour12: false })}</h4>
          <div class="md">${markdownToHtml(markdown || "Tidak ada ringkasan.")}</div>
        `;
        aiSummaryFeedEl.prepend(card);
        while (aiSummaryFeedEl.childElementCount > 5) {
          aiSummaryFeedEl.removeChild(aiSummaryFeedEl.lastElementChild);
        }
      };

      const requestLiveSummary = async (chunk) => {
        const prompt = `Anda adalah editor realtime yang merangkum closed caption siaran berita. Buat ringkasan singkat (maks 4 kalimat) dan satu kalimat implikasi praktis. Gunakan bahasa Indonesia dan gaya lugas.\n\nTranskrip:\n"""${chunk}"""`;
        const payload = {
          model: "grok-4",
          from: "chat",
          client_prompt: {},
          multi_content: [{ type: "text", text: prompt, user_input_text: prompt }],
          prompt_templates: [],
          tools: { auto: [] },
          stream: true,
          output_language: "id",
          customize_instructions: { enable: true },
        };
        let summary = "";
        try {
          const resp = await fetch(`${API_BASE}/completions`, {
            method: "POST",
            headers: baseHeaders_chat(),
            body: JSON.stringify(payload),
            mode: "cors",
            credentials: "omit",
          });
          if (!resp.ok || !resp.body) throw new Error(`HTTP ${resp.status}`);
          const reader = resp.body.getReader();
          const decoder = new TextDecoder();
          let buffer = "";
          while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            buffer += decoder.decode(value, { stream: true });
            let idx;
            while ((idx = buffer.indexOf("\n")) >= 0) {
              const line = buffer.slice(0, idx).trim();
              buffer = buffer.slice(idx + 1);
              if (!line || line === "[DONE]") continue;
              if (line.startsWith("data:")) {
                const dataLine = line.slice(5).trim();
                if (dataLine === "[DONE]") continue;
                try {
                  const json = JSON.parse(dataLine);
                  const piece = json?.data?.text;
                  if (typeof piece === "string") summary += piece;
                } catch {
                  summary += dataLine;
                }
              } else {
                summary += line;
              }
            }
          }
          summary = summary.trim();
          if (!summary) summary = "AI belum menemukan ringkasan.";
          pushLiveSummaryCard(summary);
        } catch (error) {
          console.error("Live summary error:", error);
          pushLiveSummaryCard(`Gagal membuat ringkasan: ${error.message || error}`, "AI Summary Error");
        }
      };

      const maybeProcessLiveSummary = () => {
        if (!aiSummaryEnabled) return;
        if (liveSummaryInFlight) return;
        if (liveCcWords.length < LIVE_CC_THRESHOLD) return;
        const chunk = liveCcWords.splice(0, LIVE_CC_THRESHOLD).join(" ");
        liveSummaryInFlight = true;
        updateCcCounter();
        requestLiveSummary(chunk).finally(() => {
          liveSummaryInFlight = false;
          updateCcCounter();
          maybeProcessLiveSummary();
        });
      };

      const appendLiveCaption = (text) => {
        if (!text) return;
        const words = text
          .trim()
          .split(/\s+/)
          .filter(Boolean);
        if (!words.length) return;
        liveCcWords.push(...words);
        updateCcCounter();
        maybeProcessLiveSummary();
      };

      const setAiSummaryState = (enabled) => {
        aiSummaryEnabled = enabled;
        if (aiSummaryToggleBtn)
          aiSummaryToggleBtn.dataset.active = enabled ? "true" : "false";
        if (aiSummaryFeedEl) {
          aiSummaryFeedEl.dataset.enabled = enabled ? "true" : "false";
          if (!enabled) {
            aiSummaryFeedEl.classList.add("hidden");
            aiSummaryFeedEl.dataset.empty = "true";
            aiSummaryFeedEl.innerHTML =
              '<p class="text-xs text-neutral-500 uppercase tracking-[0.25em]">AI SUMMARY FEED</p><p class="mt-2 text-sm text-neutral-400">Belum ada ringkasan. Aktifkan AI auto-summary untuk mulai mengumpulkan insight.</p>';
          } else {
            aiSummaryFeedEl.classList.remove("hidden");
            if (aiSummaryFeedEl.dataset.empty === "true") {
              aiSummaryFeedEl.innerHTML =
                '<p class="text-xs text-neutral-500 uppercase tracking-[0.25em] mb-3">AI SUMMARY FEED</p><p class="text-xs text-neutral-500">Menunggu ringkasan pertama…</p>';
            }
          }
        }
        if (enabled) maybeProcessLiveSummary();
      };

      const setCaptionsState = (enabled) => {
        captionsEnabled = enabled;
        if (captionsToggleBtn)
          captionsToggleBtn.dataset.active = enabled ? "true" : "false";
        attachCaptionHandlers();
        updateHlsSubtitleState();
        if (enabled && liveVideoEl && liveVideoEl.paused) {
          liveVideoEl.play().catch(() => {});
        }
      };

      const handleCaptionCueChange = (event) => {
        const cues = event?.target?.activeCues || [];
        let text = "";
        for (let i = 0; i < cues.length; i += 1) {
          const cueText = cues[i]?.text;
          if (cueText) text += `${cueText} `;
        }
        appendLiveCaption(text.trim());
      };

      const attachCaptionHandlers = () => {
        if (!liveVideoEl || !liveVideoEl.textTracks) return;
        const tracks = liveVideoEl.textTracks;
        if (!tracks || !tracks.length) return;
        for (let i = 0; i < tracks.length; i += 1) {
          const track = tracks[i];
          track.removeEventListener?.("cuechange", handleCaptionCueChange);
          track.addEventListener?.("cuechange", handleCaptionCueChange);
          track.mode = captionsEnabled ? "showing" : "disabled";
        }
      };

      const updateHlsSubtitleState = () => {
        if (!liveHlsInstance) return;
        if (captionsEnabled) {
          const available = liveHlsInstance.subtitleTracks || [];
          if (available.length) {
            liveHlsInstance.subtitleDisplay = true;
            if (liveHlsInstance.subtitleTrack < 0) liveHlsInstance.subtitleTrack = 0;
          } else {
            liveHlsInstance.subtitleTrack = -1;
          }
        } else {
          liveHlsInstance.subtitleDisplay = false;
          liveHlsInstance.subtitleTrack = -1;
        }
      };

      const initializeLivePlayer = () => {
        if (!liveVideoEl || !LIVE_STREAM_SRC) return;
        liveVideoEl.crossOrigin = "anonymous";
        try {
          if (window.Hls && window.Hls.isSupported()) {
            if (liveHlsInstance) {
              liveHlsInstance.destroy();
              liveHlsInstance = null;
            }
            const hls = new window.Hls({ enableWorker: true, enableWebVTT: true });
            hls.loadSource(LIVE_STREAM_SRC);
            hls.attachMedia(liveVideoEl);
            hls.on(window.Hls.Events.SUBTITLE_TRACKS_UPDATED, updateHlsSubtitleState);
            hls.on(window.Hls.Events.MANIFEST_PARSED, updateHlsSubtitleState);
            liveHlsInstance = hls;
            updateHlsSubtitleState();
          } else if (liveVideoEl.canPlayType("application/vnd.apple.mpegurl")) {
            liveVideoEl.src = LIVE_STREAM_SRC;
          } else {
            console.warn("HLS not supported in this browser.");
          }
          liveVideoEl.muted = true;
        } catch (error) {
          console.error("Live player init error:", error);
        }
        liveVideoEl.addEventListener("loadedmetadata", attachCaptionHandlers);
        liveVideoEl.addEventListener("loadeddata", attachCaptionHandlers);
        if (liveVideoEl.textTracks?.addEventListener) {
          liveVideoEl.textTracks.addEventListener("addtrack", attachCaptionHandlers);
        }
      };

      const openKuantaraModal = async (context) => {
        if (!kuantaraModal || !context) return;
        const { label = "Headline", key = label, ensureData, buildPrompt, autoRecap = true } = context;
        kuantaraModal.classList.remove("hidden");
        document.body.classList.add("overflow-hidden");
        if (kuantaraTitleEl) kuantaraTitleEl.textContent = `${label} Recap`;
        if (!recapConversations.has(key)) recapConversations.set(key, []);
        messages = recapConversations.get(key);
        renderChat();
        if (!autoRecap || isStreaming) return;
        try {
          const dataset = (await ensureData?.()) || { items: [] };
          const prompt = buildPrompt ? buildPrompt(dataset.items || [], label) : "";
          if (!prompt) {
            addMessage("Kuantara", `Tidak ada data untuk ${label}.`);
            return;
          }
          kuantaraRecapActive = true;
          startStreaming(prompt, { userVisibleText: null });
        } catch (error) {
          console.error("Recap modal error:", error);
          addMessage("Kuantara", `Gagal menyiapkan data recap.\n\n${error.message || error}`);
        }
      };

      const closeKuantaraModal = () => {
        if (!kuantaraModal) return;
        kuantaraModal.classList.add("hidden");
        document.body.classList.remove("overflow-hidden");
      };

      const openReaderShell = (title = "Reader") => {
        if (!readerModal) return;
        readerModal.classList.remove("hidden");
        document.body.classList.add("overflow-hidden");
        if (readerTitleEl) readerTitleEl.textContent = title || "Reader";
        if (readerBodyEl) readerBodyEl.innerHTML = "";
      };

      const closeReaderModal = () => {
        if (!readerModal) return;
        readerModal.classList.add("hidden");
        document.body.classList.remove("overflow-hidden");
      };

      const setReaderLoading = (state) => {
        if (!readerLoadingEl) return;
        readerLoadingEl.classList.toggle("hidden", !state);
      };

      const updateMainColumnHeight = () => {
        if (!mainColumnEl || !sidebarEl) return;
        const sidebarHeight = sidebarEl.offsetHeight;
        if (sidebarHeight > 0) {
          mainColumnEl.style.setProperty("--main-column-height", `${sidebarHeight}px`);
        }
      };
      if (sidebarEl && window.ResizeObserver) {
        const sidebarObserver = new ResizeObserver(() => updateMainColumnHeight());
        sidebarObserver.observe(sidebarEl);
      }
      window.addEventListener("resize", updateMainColumnHeight);
      updateMainColumnHeight();

      const createLatestSkeletonCard = () => {
        const li = document.createElement("li");
        li.className = "latest-card";
        const line = document.createElement("div");
        line.className = "space-y-3";
        const header = document.createElement("div");
        header.className = "h-4 w-3/4 shimmer-line";
        const sub = document.createElement("div");
        sub.className = "h-3 w-1/2 shimmer-line";
        const chips = document.createElement("div");
        chips.className = "flex gap-2";
        const chip = document.createElement("div");
        chip.className = "h-4 w-16 shimmer-line";
        const chip2 = document.createElement("div");
        chip2.className = "h-4 w-20 shimmer-line";
        chips.append(chip, chip2);
        line.append(header, sub, chips);
        li.appendChild(line);
        return li;
      };

      const renderLatestSkeleton = () => {
        if (!latestTickerEl) return;
        latestTickerEl.innerHTML = "";
        Array.from({ length: 3 }).forEach(() => {
          latestTickerEl.appendChild(createLatestSkeletonCard());
        });
      };

      const normalizeFastbullNews = (item) => {
        if (!item) return null;
        const title = (item.newsTitle || "").trim();
        const tags = typeof item.tags === "string" ? item.tags : "";
        return {
          id: item.newsId || item.path || title || String(item.releasedDate || Math.random()),
          title: title || "Untitled headline",
          tagIds: tags,
          tagNames: resolveFastbullTagNames(tags),
          timestamp: item.releasedDate || Date.now(),
          important: Number(item.important) === 1,
          source: item.simWebsiteName || item.simWebsite || "FastBull",
        };
      };

      const copyLatestHeadline = (text, button) => {
        if (!text || !button) return;
        const original = button.innerHTML;
        const handleSuccess = () => {
          button.classList.add("copied");
          button.innerHTML = CHECK_ICON;
          setTimeout(() => {
            button.classList.remove("copied");
            button.innerHTML = original;
          }, 1500);
        };
        const fallbackCopy = () => {
          const textarea = document.createElement("textarea");
          textarea.value = text;
          textarea.style.position = "fixed";
          textarea.style.opacity = "0";
          document.body.appendChild(textarea);
          textarea.select();
          try {
            document.execCommand("copy");
            handleSuccess();
          } catch (error) {
            console.error("Copy failed:", error);
          } finally {
            document.body.removeChild(textarea);
          }
        };
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(text).then(handleSuccess).catch(fallbackCopy);
        } else {
          fallbackCopy();
        }
      };

      const createLatestCardElement = (item) => {
        const li = document.createElement("li");
        li.className = "latest-card";
        if (item.important) li.classList.add("important");
        const row = document.createElement("div");
        row.className = "flex items-start gap-3";
        const content = document.createElement("div");
        content.className = "flex-1 space-y-2";
        const headlineWrap = document.createElement("div");
        headlineWrap.className = "headline-container";
        if (item.important) {
          const badge = document.createElement("span");
          badge.className = "important-dot";
          headlineWrap.appendChild(badge);
        }
        const headline = document.createElement("p");
        headline.className = "headline leading-snug";
        headline.textContent = item.title;
        headlineWrap.appendChild(headline);
        const meta = document.createElement("div");
        meta.className = "latest-meta";
        const timeEl = document.createElement("span");
        timeEl.textContent = formatFastbullUTC(item.timestamp);
        meta.append(timeEl);
        const tagsRow = document.createElement("div");
        tagsRow.className = "latest-tags";
        const tags = item.tagNames && item.tagNames.length ? item.tagNames : ["Berita"];
        tags.slice(0, 4).forEach((tagName) => {
          const span = document.createElement("span");
          span.className = "label-tag";
          span.textContent = tagName;
          tagsRow.appendChild(span);
        });
        content.append(headlineWrap, meta, tagsRow);
        const copyButton = document.createElement("button");
        copyButton.type = "button";
        copyButton.className = "copy-btn";
        copyButton.innerHTML = COPY_ICON;
        copyButton.setAttribute("aria-label", "Salin headline");
        copyButton.addEventListener("click", () => copyLatestHeadline(item.title, copyButton));
        row.append(content, copyButton);
        li.appendChild(row);
        return li;
      };

      const renderLatestFeed = (items) => {
        if (!latestTickerEl) return;
        latestTickerEl.innerHTML = "";
        if (!items.length) {
          const empty = document.createElement("li");
          empty.className = "text-xs text-neutral-500";
          empty.textContent = "Tidak ada berita untuk kategori ini.";
          latestTickerEl.appendChild(empty);
          return;
        }
        items.forEach((item) => {
          const card = createLatestCardElement(item);
          latestTickerEl.appendChild(card);
        });
      };

      const buildFastbullUrl = (tagIds = "-1") => {
        const url = new URL(FASTBULL_NEWS_ENDPOINT);
        url.searchParams.set("checkImportant", "0");
        url.searchParams.set("pageSize", "15");
        url.searchParams.set("timestamp", "");
        url.searchParams.set("includeCalendar", "0");
        url.searchParams.set("tagIds", tagIds);
        return url.toString();
      };

      const fetchFastbullNews = async (tagIds = "-1", { silent = false } = {}) => {
        if (!latestTickerEl) return;
        updateLatestRecapButton(tagIds);
        const existing = latestCache.get(tagIds);
        const shouldRenderCached = !silent || !existing || !existing.items.length;
        if (shouldRenderCached) {
          if (existing && existing.items.length) {
            renderLatestFeed(existing.items);
            const cachedLabel = formatRelativeTimestamp(existing.updatedIso) || "Cached feed";
            setLatestStatus(cachedLabel);
          } else {
            renderLatestSkeleton();
            setLatestStatus("Loading feed…");
          }
        }
        const token = ++latestFetchToken;
        try {
          const response = await fetch(buildFastbullUrl(tagIds), { headers: FASTBULL_HEADERS });
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const payload = await response.json();
          const body =
            typeof payload.bodyMessage === "string"
              ? JSON.parse(payload.bodyMessage)
              : payload.bodyMessage || {};
          const list = Array.isArray(body?.pageDatas) ? body.pageDatas : [];
          const normalized = list.map(normalizeFastbullNews).filter(Boolean);
          latestCache.set(tagIds, { items: normalized, updatedIso: new Date().toISOString() });
          if (token !== latestFetchToken) return;
          renderLatestFeed(normalized);
          setLatestStatus(
            normalized.length
              ? `Updated ${new Date().toLocaleTimeString("en-GB", { hour12: false })}`
              : "No headlines"
          );
        } catch (error) {
          console.error("Latest feed error:", error);
          if (token !== latestFetchToken) return;
          setLatestStatus(`Feed error • ${error.message || "Network error"}`);
          latestTickerEl.innerHTML =
            '<li class="text-xs text-rose-300">Gagal memuat headline FastBull.</li>';
        }
      };

      const renderFrontSignal = (item, fallbackMessage) => {
        if (!analysisEls.title) return;
        if (!item) {
          analysisEls.title.textContent = "Front signal unavailable";
          if (analysisEls.summary) {
            analysisEls.summary.textContent =
              fallbackMessage || "Hubungkan server front-signal untuk menampilkan headline terbaru.";
          }
          if (analysisEls.meta) analysisEls.meta.textContent = "Waiting for data";
          if (analysisEls.chips)
            analysisEls.chips.innerHTML =
              '<span class="px-2 py-1 text-[10px] uppercase tracking-wide border border-amber-500/40 bg-amber-500/5 text-amber-100">Menunggu feed real-time</span>';
          if (analysisEls.stats) analysisEls.stats.textContent = "Sentiment —";
          if (analysisEls.badge) analysisEls.badge.textContent = "OFFLINE";
          if (analysisEls.image) {
            analysisEls.image.src = DEFAULT_IMAGE;
            analysisEls.image.alt = "Insight placeholder";
          }
          if (analysisEls.indicators) analysisEls.indicators.textContent = "Menunggu data feed…";
          if (analysisEls.link) analysisEls.link.removeAttribute("href");
          if (analysisEls.sourceLabel) analysisEls.sourceLabel.textContent = "Feed";
          return;
        }
        const sourceName = item._feed || item.source || "Source";
        analysisEls.title.textContent = item.title || "Untitled insight";
        if (analysisEls.summary) {
          const summary = buildSummary(item) || `Live update from ${sourceName}.`;
          analysisEls.summary.textContent = summary;
        }
        if (analysisEls.meta) analysisEls.meta.textContent = item.timeago || formatInsightTime(item.publish_dt);
        if (analysisEls.sourceLabel) analysisEls.sourceLabel.textContent = sourceName;
        if (analysisEls.chips) {
          const chipsMarkup = buildChipMarkup(item.tags, 5);
          analysisEls.chips.innerHTML = chipsMarkup
            ? chipsMarkup
            : '<span class="px-2 py-1 text-[10px] uppercase tracking-wide border border-neutral-600 bg-neutral-800 text-neutral-200">Detail pending</span>';
        }
        if (analysisEls.stats) {
          const parts = [`Sentiment ${formatSentiment(item.sentiment)}`];
          if (typeof item.score === "number") parts.push(`Score ${item.score}`);
          if (typeof item.cf_score === "number") parts.push(`CF ${item.cf_score}`);
          analysisEls.stats.textContent = parts.join(" • ");
        }
        if (analysisEls.badge) analysisEls.badge.textContent = sourceName.toUpperCase();
        if (analysisEls.image) {
          analysisEls.image.src = item.image_url || DEFAULT_IMAGE;
          analysisEls.image.alt = item.title || "Insight visual";
        }
        if (analysisEls.indicators) analysisEls.indicators.textContent = buildIndicators(item);
        if (analysisEls.link) {
          if (item.url) {
            analysisEls.link.href = item.url;
            analysisEls.link.target = "_blank";
            analysisEls.link.rel = "noopener";
          } else {
            analysisEls.link.removeAttribute("href");
          }
        }
      };

      const renderInsightItems = (items) => {
        if (!insightListEl) return;
        insightListEl.innerHTML = "";
        if (!items.length) {
          insightListEl.innerHTML = '<li class="text-xs text-neutral-500">Tidak ada data dari sumber ini.</li>';
          return;
        }
        items.forEach((item) => {
          const summary = buildSummary(item);
          const sourceName = item._feed || item.source || "Source";
          const meta = `${item.timeago || formatInsightTime(item.publish_dt)} • ${sourceName}`;
          const li = document.createElement("li");
          li.innerHTML = `
            <a class="flex gap-3 border border-frame bg-ink/60 p-3 text-xs text-neutral-300 hover:border-[#FFBF00]" href="${item.url || "#"}" target="_blank" rel="noopener">
              <div class="space-y-1">
                <p class="text-neutral-500">${meta}</p>
                <p class="text-sm text-white">${item.title || "Untitled insight"}</p>
                ${summary ? `<p class="text-neutral-400">${summary}</p>` : ""}
              </div>
            </a>
          `;
          insightListEl.appendChild(li);
        });
      };

      const populateSourceOptions = (sources) => {
        if (!insightSourceSelect) return;
        const list = Array.isArray(sources) ? sources : [];
        const seen = new Set();
        const uniqueSources = [];
        list.forEach((source) => {
          if (typeof source !== "string") return;
          const trimmed = source.trim();
          if (!trimmed || seen.has(trimmed)) return;
          seen.add(trimmed);
          uniqueSources.push(trimmed);
        });
        const previousValue = insightSourceSelect.value || "all";
        insightSourceSelect.innerHTML = '<option value="all">All Sources</option>';
        uniqueSources.forEach((source) => {
          const option = document.createElement("option");
          option.value = source;
          option.textContent = source;
          insightSourceSelect.appendChild(option);
        });
        if (uniqueSources.includes(previousValue)) {
          insightSourceSelect.value = previousValue;
          selectedSource = previousValue;
        } else {
          insightSourceSelect.value = "all";
          selectedSource = "all";
        }
      };

      const filterInsights = () => {
        if (selectedSource === "all") return insightCache;
        const token = selectedSource.toLowerCase();
        return insightCache.filter((item) => {
          const feed = (item._feed || "").toLowerCase();
          const src = (item.source || "").toLowerCase();
          return feed === token || src === token;
        });
      };

      const refreshInsightView = () => {
        const filtered = filterInsights();
        renderInsightItems(filtered);
      };

      const setFrontStatus = (text) => {
        if (analysisEls.status) analysisEls.status.textContent = text;
      };

      const setInsightStatus = (text) => {
        if (insightStatusEl) insightStatusEl.textContent = text;
      };

      const fetchInsights = async ({ silent = false } = {}) => {
        const shouldShowSkeleton = !insightCache.length || !silent;
        if (shouldShowSkeleton) {
          setInsightStatus("Loading feed…");
          renderInsightSkeleton();
        }
        try {
          const response = await fetchWithAuth(INSIGHTS_API, { headers: { Accept: "application/json" } });
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const payload = await response.json();
          const items = Array.isArray(payload.items) ? payload.items : [];
          const lookup = buildFeedLookup(payload.sources);
          insightCache = hydrateFeedLabels(items, lookup);
          availableSources = payload.available_sources || [];
          lastUpdatedIso = payload.updated_at || null;
          if (!insightCache.length) throw new Error("Payload kosong");
          populateSourceOptions(availableSources);
          refreshInsightView();
          setInsightStatus(formatRelativeTimestamp(lastUpdatedIso) || "Feed updated");
        } catch (error) {
          console.error("Insight feed error:", error);
          insightCache = [];
          availableSources = [];
          populateSourceOptions(availableSources);
          refreshInsightView();
          setInsightStatus(`Feed error • ${error.message || "Network error"}`);
        }
      };

      const fetchFrontSignal = async ({ silent = false } = {}) => {
        const shouldShowSkeleton = !frontSignalStories.length || !silent;
        if (shouldShowSkeleton) {
          setFrontStatus("Loading front signal…");
          toggleFrontSignalSkeleton(true);
        }
        clearFrontSignalTimer();
        try {
          const response = await fetchWithAuth(buildCityFalconUrl(FRONT_SIGNAL_ASSET_CLASS), {
            headers: { Accept: "application/json" },
          });
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const payload = await response.json();
          const stories = resolveCityFalconList(payload)
            .map(normalizeCityFalconStory)
            .filter(Boolean);
          const eligible = stories.filter((story) => typeof story.cf_score === "number" && story.cf_score >= 20);
          if (!eligible.length) throw new Error("No story with CF score > 20");
          frontSignalStories = eligible.slice(0, 6);
          frontSignalIndex = 0;
          toggleFrontSignalSkeleton(false);
          showFrontSignalAt(0);
        } catch (error) {
          console.error("Front signal error:", error);
          frontSignalStories = [];
          frontSignalIndex = 0;
          clearFrontSignalTimer();
          if (frontSignalDotsEl) frontSignalDotsEl.innerHTML = "";
          setFrontControlsState();
          toggleFrontSignalSkeleton(false);
          renderFrontSignal(null, error.message || "Network error");
          setFrontStatus(`Front signal error • ${error.message || "Network error"}`);
        }
      };

      if (insightSourceSelect) {
        insightSourceSelect.addEventListener("change", (ev) => {
          selectedSource = ev.target.value;
          refreshInsightView();
        });
      }

      renderAssetTabs();
      initFrontSignalControls();
      if (assetActiveId) {
        fetchAssetStories(assetActiveId);
      }

      if (assetSentinelEl && "IntersectionObserver" in window) {
        const observer = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              if (!entry.isIntersecting) return;
              const state = getAssetState(assetActiveId);
              if (!state.items.length || state.loading || state.exhausted) return;
              fetchAssetStories(assetActiveId, { append: true });
            });
          },
          { root: null, rootMargin: "200px 0px 200px 0px", threshold: 0 }
        );
        observer.observe(assetSentinelEl);
      }

      fetchFrontSignal();
      fetchInsights();
      if (latestDropdownEl) {
        latestDropdownEl.addEventListener("change", (event) => {
          fetchFastbullNews(event.target.value || "-1");
        });
        fetchFastbullNews(latestDropdownEl.value || "-1");
      } else {
        fetchFastbullNews("-1");
      }

      const captureScrollSnapshot = () => {
        const doc = document.documentElement;
        const windowTop = window.scrollY || doc.scrollTop || 0;
        const snapshot = {
          window: {
            top: windowTop,
            nearBottom: windowTop + window.innerHeight >= doc.scrollHeight - 16,
          },
          containers: [],
        };
        const track = (el) => {
          if (!el) return;
          snapshot.containers.push({
            el,
            top: el.scrollTop,
            nearBottom: el.scrollTop + el.clientHeight >= el.scrollHeight - 8,
          });
        };
        track(insightListEl);
        track(latestTickerContainerEl);
        track(catalystTickerContainerEl);
        track(xFeedTickerContainerEl);
        return snapshot;
      };

      const restoreScrollSnapshot = (snapshot) => {
        if (!snapshot) return;
        const doc = document.documentElement;
        if (snapshot.window) {
          const maxTop = Math.max(0, doc.scrollHeight - window.innerHeight);
          const targetTop = snapshot.window.nearBottom
            ? maxTop
            : Math.min(Math.max(0, snapshot.window.top), maxTop);
          window.scrollTo({ top: targetTop });
        }
        (snapshot.containers || []).forEach(({ el, top, nearBottom }) => {
          if (!el) return;
          const maxTop = Math.max(0, el.scrollHeight - el.clientHeight);
          el.scrollTop = nearBottom ? maxTop : Math.min(Math.max(0, top), maxTop);
        });
      };

      const stopAutoRefreshLoop = () => {
        if (autoRefreshTimer) {
          clearInterval(autoRefreshTimer);
          autoRefreshTimer = null;
        }
      };

      const runAutoRefreshCycle = () => {
        if (autoRefreshInProgress || document.hidden) return;
        autoRefreshInProgress = true;
        const snapshot = captureScrollSnapshot();
        const tagIds = latestDropdownEl?.value || "-1";
        const tasks = [
          fetchFrontSignal({ silent: true }),
          fetchInsights({ silent: true }),
          fetchFastbullNews(tagIds, { silent: true }),
          fetchCatalystFeed({ silent: true, force: true }),
          fetchXFeed({ silent: true }),
        ];
        Promise.allSettled(tasks).finally(() => {
          restoreScrollSnapshot(snapshot);
          autoRefreshInProgress = false;
        });
      };

      const startAutoRefreshLoop = () => {
        stopAutoRefreshLoop();
        autoRefreshTimer = setInterval(runAutoRefreshCycle, AUTO_REFRESH_INTERVAL);
      };

      if (AUTO_REFRESH_INTERVAL > 0) {
        startAutoRefreshLoop();
        document.addEventListener("visibilitychange", () => {
          if (document.hidden) {
            stopAutoRefreshLoop();
          } else {
            runAutoRefreshCycle();
            startAutoRefreshLoop();
          }
        });
        window.addEventListener("beforeunload", stopAutoRefreshLoop);
      }

      const recapTabs = document.querySelectorAll(".recap-tab");
      const catalystPanel = document.getElementById("catalystPanel");
      const latestPanel = document.getElementById("latestPanel");
      recapTabs.forEach((tab) => {
        tab.addEventListener("click", () => {
          recapTabs.forEach((btn) => {
            btn.classList.remove("bg-[#FFBF00]", "text-black");
            btn.classList.add("text-neutral-400");
          });
          tab.classList.add("bg-[#FFBF00]", "text-black");
          tab.classList.remove("text-neutral-400");
          if (tab.dataset.panel === "catalyst") {
            catalystPanel.classList.remove("hidden");
            latestPanel.classList.add("hidden");
          } else {
            catalystPanel.classList.add("hidden");
            latestPanel.classList.remove("hidden");
          }
        });
      });

      const insightTabs = document.querySelectorAll(".insight-tab");
      const insightPane = document.getElementById("insightPane");
      const tvPane = document.getElementById("tvPane");
      insightTabs.forEach((tab) => {
        tab.addEventListener("click", () => {
          insightTabs.forEach((btn) => btn.classList.remove("bg-[#FFBF00]", "text-black"));
          insightTabs.forEach((btn) => btn.classList.add("text-neutral-400"));
          tab.classList.remove("text-neutral-400");
          tab.classList.add("bg-[#FFBF00]", "text-black");
          if (tab.dataset.pane === "insight") {
            insightPane.classList.remove("hidden");
            tvPane.classList.add("hidden");
          } else {
            insightPane.classList.add("hidden");
            tvPane.classList.remove("hidden");
          }
        });
      });

      const API_BASE = "https://sider.ai/api/chat/v1";
      const TIMEZONE = "Asia/Makassar";
      const TOKEN =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoyMTgzNzM0NiwicmVnaXN0ZXJfdHlwZSI6Im9hdXRoMiIsImFwcF9uYW1lIjoiQ2hpdENoYXRfQ2hyb21lX0V4dCIsInRva2VuX2lkIjoiZTZlOGIwZGUtN2Q3Zi00NTZkLTkxNGQtNzUwNDQ0ZjkyZTNjIiwiaXNzIjoic2lkZXIuYWkiLCJhdWQiOlsiIl0sImV4cCI6MTc4ODY5NjUxMCwibmJmIjoxNzU3NTkyNTEwLCJpYXQiOjE3NTc1OTI1MTB9.mcq86TwFwPtql3S77_vhnJRGj08878Ej5WGkvY3OxWI";

      let cid = null;
      let parentMessageId = null;
      let isStreaming = false;
      let streamBuffer = "";

      const chatListEl = document.getElementById("chatList");
      const inputEl = document.getElementById("input");
      const sendBtn = document.getElementById("send");
      const card = document.getElementById("card");

      function setAdaptiveHeight() {
        const vh = window.innerHeight || 0;
        const isMobile = vh && window.matchMedia("(max-width: 820px)").matches;
        const base = isMobile ? Math.round(vh * 0.66) : Math.round(vh * 0.6);
        document.documentElement.style.setProperty("--chat-h", Math.max(260, base) + "px");
      }
      setAdaptiveHeight();
      const syncResultMaxHeight = () => {
        if (!chatListEl) return;
        const h = getComputedStyle(document.documentElement).getPropertyValue("--chat-h");
        chatListEl.style.maxHeight = `calc(${h.trim() || "360px"} - 40px)`;
      };
      const handleChatResize = () => {
        setAdaptiveHeight();
        syncResultMaxHeight();
      };
      syncResultMaxHeight();
      window.addEventListener("resize", handleChatResize);
      if (window.ResizeObserver && card) {
        const ro = new ResizeObserver(syncResultMaxHeight);
        ro.observe(card);
      }

      const recapConversations = new Map();
      let messages = [];
      const markdownToHtml = (md) =>
        window.marked ? window.marked.parse(md || "") : (md || "").replace(/\n/g, "<br>");

      const renderChat = () => {
        if (!chatListEl) return;
        if (!messages.length) {
          chatListEl.innerHTML = '<p class="placeholder text-center">Belum ada percakapan.</p>';
          return;
        }
        chatListEl.innerHTML = messages
          .map(
            (msg) => `
          <div class="kuantara-message ${msg.sender === "Anda" ? "user" : "ai"}">
            <p class="kuantara-label">${msg.sender === "Anda" ? "YOU" : "AI"}</p>
            <div class="kuantara-block">
              <div class="md">${markdownToHtml(msg.contentMD || "")}</div>
            </div>
          </div>`
          )
          .join("");
        chatListEl.scrollTop = chatListEl.scrollHeight;
      };

      const addMessage = (sender, contentMD) => {
        messages.push({ sender, contentMD });
        renderChat();
        return messages.length - 1;
      };

      const updateMessage = (index, contentMD) => {
        if (index == null || index < 0 || index >= messages.length) return;
        messages[index].contentMD = contentMD;
        renderChat();
      };

      renderChat();

      function baseHeaders_chat() {
        return {
          "User-Agent":
            "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/140.0.0.0 Safari/537.36",
          "Content-Type": "application/json",
          "sec-ch-ua-platform": '"Windows"',
          Accept: "text/event-stream",
          "Cache-Control": "no-cache",
          Connection: "keep-alive",
          "sec-ch-ua": '"Chromium";v="140", "Not=A?Brand";v="24", "Google Chrome";v="140"',
          authorization: `Bearer ${TOKEN}`,
          "x-app-name": "ChitChat_Web",
          "x-time-zone": TIMEZONE,
          "sec-ch-ua-mobile": "?0",
          "x-app-version": "1.0.0",
          origin: "https://sider.ai",
          "sec-fetch-site": "same-origin",
          "sec-fetch-dest": "empty",
          referer: "https://sider.ai/chat",
          "accept-language": "en-US,en;q=0.9,id;q=0.8",
        };
      }
      function baseHeaders_list() {
        return {
          "User-Agent":
            "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/141.0.0.0 Safari/537.36",
          "Accept-Encoding": "gzip, deflate, br, zstd",
          "Content-Type": "application/json",
          "sec-ch-ua-platform": '"Windows"',
          authorization: `Bearer ${TOKEN}`,
          "x-app-name": "ChitChat_Web",
          "sec-ch-ua": '"Google Chrome";v="141", "Not?A_Brand";v="8", "Chromium";v="141"',
          "x-time-zone": TIMEZONE,
          "sec-ch-ua-mobile": "?0",
          "x-trace-id": crypto.randomUUID ? crypto.randomUUID() : "trace-" + Date.now(),
          "x-app-version": "1.0.0",
          origin: "https://sider.ai",
          "sec-fetch-site": "same-origin",
          "sec-fetch-dest": "empty",
          referer: "https://sider.ai/chat",
          "accept-language": "en-US,en;q=0.9,id;q=0.8",
          priority: "u=1, i",
          Cookie: "lang=en",
        };
      }

      async function fetchCurrentLeaf(conversationId, limit = 100, timeoutMs = 15000) {
        const ctrl = new AbortController();
        const t = setTimeout(() => ctrl.abort(), timeoutMs);
        try {
          const resp = await fetch(`${API_BASE}/conversation/list`, {
            method: "POST",
            headers: baseHeaders_list(),
            body: JSON.stringify({ limit, client_type: "chat", sort_type: "desc" }),
            signal: ctrl.signal,
            mode: "cors",
            credentials: "omit",
          });
          if (!resp.ok) return null;
          const data = await resp.json().catch(() => null);
          const convs = data?.data?.conversations || [];
          for (const c of convs) {
            if (c?.id === conversationId) return c.current_leaf_message_id || null;
          }
          return null;
        } catch {
          return null;
        } finally {
          clearTimeout(t);
        }
      }

      async function startStreaming(promptText, { userVisibleText = null } = {}) {
        if (isStreaming) return;
        if (cid) {
          const leaf = await fetchCurrentLeaf(cid);
          if (leaf) parentMessageId = leaf;
        }
        let aiMessageIndex = null;
        if (userVisibleText) addMessage("Anda", userVisibleText);
        aiMessageIndex = addMessage("Kuantara", "_Sedang berpikir…_");
        isStreaming = true;
        streamBuffer = "";

        const payload = {
          model: "grok-4",
          from: "chat",
          client_prompt: {},
          multi_content: [{ type: "text", text: promptText, user_input_text: promptText }],
          prompt_templates: [],
          tools: { auto: ["search"] },
          stream: true,
          output_language: "id",
          customize_instructions: { enable: true },
        };
        if (cid) payload.cid = cid;
        if (parentMessageId) payload.parent_message_id = parentMessageId;

        let resp;
        try {
          resp = await fetch(`${API_BASE}/completions`, {
            method: "POST",
            headers: baseHeaders_chat(),
            body: JSON.stringify(payload),
            mode: "cors",
            credentials: "omit",
          });
        } catch (err) {
          updateMessage(aiMessageIndex, `**Error koneksi:** ${err?.message || err}`);
          resetStreamFlags();
          return;
        }

        if (!resp.ok || !resp.body) {
          const text = await safeText(resp);
          updateMessage(
            aiMessageIndex,
            `**HTTP ${resp.status} ${resp.statusText}**${text ? "\n\n" + text.slice(0, 300) : ""}`
          );
          resetStreamFlags();
          return;
        }

        const reader = resp.body.getReader();
        const decoder = new TextDecoder();
        let buffer = "";
        try {
          while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            buffer += decoder.decode(value, { stream: true });

            let idx;
            while ((idx = buffer.indexOf("\n")) >= 0) {
              const rawLine = buffer.slice(0, idx);
              buffer = buffer.slice(idx + 1);
              const line = (rawLine || "").trim();
              if (!line) continue;
              if (line === "[DONE]") continue;
              if (line.startsWith("data:")) {
                const dataLine = line.slice(5).trim();
                if (dataLine === "[DONE]") continue;
                handleSSEData(dataLine);
              } else {
                handleSSEData(line);
              }
            }

            if (streamBuffer) {
              updateMessage(aiMessageIndex, streamBuffer);
            }
          }
        } catch (err) {
          updateMessage(aiMessageIndex, `**Stream error:** ${err?.message || err}`);
        } finally {
          if (streamBuffer) {
            updateMessage(aiMessageIndex, streamBuffer);
          } else {
            updateMessage(aiMessageIndex, "_Tidak ada respons._");
          }
          resetStreamFlags();
        }
      }

      function handleSSEData(dataStr) {
        try {
          const obj = JSON.parse(dataStr);
          const payload = obj?.data || {};
          const type = payload?.type;
          if (type === "credit_info") return;
          if (type === "message_start") {
            const ms = payload?.message_start || {};
            if (ms?.cid) cid = ms.cid;
            if (ms?.assistant_message_id) parentMessageId = ms.assistant_message_id;
            return;
          }
          if (type === "text") {
            const piece = payload?.text;
            if (typeof piece === "string" && piece) {
              streamBuffer += piece;
            }
            return;
          }
          for (const key of ["text", "token", "content", "output", "message"]) {
            const value = payload?.[key];
            if (typeof value === "string" && value) {
              streamBuffer += value;
              return;
            }
          }
        } catch {
          if (dataStr && dataStr !== "[DONE]") streamBuffer += dataStr;
        }
      }

      async function safeText(resp) {
        try {
          return await resp.text();
        } catch {
          return "";
        }
      }

      function resetStreamFlags() {
        isStreaming = false;
        streamBuffer = "";
        if (kuantaraRecapActive) kuantaraRecapActive = false;
      }

      sendBtn?.addEventListener("click", () => {
        const txt = (inputEl?.value || "").trim();
        if (!txt || isStreaming) return;
        inputEl.value = "";
        autoResize();
        startStreaming(txt, { userVisibleText: txt });
      });
      inputEl?.addEventListener("keydown", (e) => {
        if ((e.key === "Enter" || e.keyCode === 13) && !e.shiftKey) {
          e.preventDefault();
          sendBtn?.click();
        }
      });

      function autoResize() {
        if (!inputEl) return;
        inputEl.style.height = "auto";
        const h = Math.min(220, Math.max(44, inputEl.scrollHeight + 2));
        inputEl.style.height = h + "px";
      }
      inputEl?.addEventListener("input", autoResize);

      const triggerHeadlineRecap = () => {
        const tagIds = latestDropdownEl?.value || "-1";
        const label = resolveLatestCategoryLabel(tagIds);
        openKuantaraModal({
          key: `headline:${tagIds}`,
          label,
          ensureData: () => ensureLatestCategoryData(tagIds),
          buildPrompt: (items) => buildRecapPrompt(label, items),
        });
      };
      if (latestRecapBtn) {
        latestRecapBtn.addEventListener("click", triggerHeadlineRecap);
      }
      const triggerXFeedRecap = () => {
        openKuantaraModal({
          key: "xfeed",
          label: "X Feed",
          ensureData: () => ensureXFeedData(),
          buildPrompt: (items) => buildXFeedRecapPrompt("X Feed", items),
        });
      };
      xFeedRecapBtn?.addEventListener("click", triggerXFeedRecap);
      kuantaraCloseBtn?.addEventListener("click", closeKuantaraModal);
      readerCloseBtn?.addEventListener("click", closeReaderModal);
      readerModal?.addEventListener("click", (event) => {
        if (event.target === readerModal) closeReaderModal();
      });

      aiSummaryToggleBtn?.addEventListener("click", () =>
        setAiSummaryState(!aiSummaryEnabled)
      );
      captionsToggleBtn?.addEventListener("click", () =>
        setCaptionsState(!captionsEnabled)
      );
      setAiSummaryState(false);
      setCaptionsState(false);
      updateCcCounter();
      initializeLivePlayer();
      window.pushLiveCaption = appendLiveCaption;

      const resolveCatalystLabel = (value) => {
        if (!catalystDropdownEl) return "Semua";
        if (value === "all") return "Semua";
        const option = catalystDropdownEl.options[catalystDropdownEl.selectedIndex];
        return option?.textContent || value || "Semua";
      };

      const triggerCatalystRecap = () => {
        const category = catalystDropdownEl?.value || "all";
        const label = resolveCatalystLabel(category);
        openKuantaraModal({
          key: `catalyst:${category}`,
          label,
          ensureData: () => ensureCatalystCategoryData(category),
          buildPrompt: (items) => buildCatalystRecapPrompt(label, items),
        });
      };

      catalystDropdownEl?.addEventListener("change", (event) => {
        catalystSelected = event.target.value || "all";
        updateCatalystRecapButton();
        renderCatalystFeed();
      });
      if (catalystRecapBtn) {
        catalystRecapBtn.addEventListener("click", triggerCatalystRecap);
      }

      updateCatalystRecapButton();
      fetchCatalystFeed();
      fetchXFeed();

    </script>
  </body>
</html>
