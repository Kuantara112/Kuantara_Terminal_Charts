<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Kuantara â€“ Forex Market Snapshot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;700&display=swap">

  <style>
    :root {
      --amber:#ffbf00;
      --bg-root:#000000;
      --bg-main:#111111;
      --border-soft:#2b2b2b;
      --text-main:#f5f5f5;
      --text-muted:#9b9b9b;

      --fs-title:14px;
      --fs-subtitle:12px;
      --fs-body:11px;
      --fs-small:9.5px;

      --green:#22c55e;
      --red:#ef4444;
    }

    * {
      box-sizing:border-box;
      margin:0;
      padding:0;
      font-family:"Fira Code",monospace !important;
      scrollbar-width:thin;
      scrollbar-color:rgba(255,255,255,0.2) transparent;
    }

    /* 1. KUNCI UTAMA: Body tidak boleh scroll */
    html, body {
      width:100%;
      height:100%;
      background:var(--bg-root);
      color:var(--text-main);
      overflow:hidden; /* Mencegah scroll global */
    }

    ::-webkit-scrollbar {
      width:4px;
      height:4px;
    }
    ::-webkit-scrollbar-track {
      background:transparent;
    }
    ::-webkit-scrollbar-thumb {
      background:rgba(255,255,255,0.2);
      border-radius:999px;
    }

    /* 2. STRUKTUR FLEXBOX: Mengisi tinggi layar */
    .kt-page {
      height: 100%;
      display: flex;
      flex-direction: column;
      padding:16px;
      background:var(--bg-root);
      overflow: hidden;
    }

    .kt-page-tabs {
      display:flex;
      gap:8px;
      margin-bottom:10px;
      flex-shrink: 0; /* Tabs tidak boleh mengecil */
      flex-wrap:wrap;
    }

    .kt-pill-page {
      border-radius:999px;
      border:1px solid var(--border-soft);
      padding:4px 12px;
      font-size:var(--fs-small);
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
      color:var(--text-muted);
      background:#050505;
      transition:background 0.15s ease, color 0.15s ease;
    }
    .kt-pill-page.active {
      border-color:var(--amber);
      color:#000;
      background:var(--amber);
      font-weight: 700;
    }

    /* Layout Container */
    .kt-layout {
      display: flex;
      flex-direction: column;
      flex: 1;      /* Ambil sisa tinggi vertikal */
      min-height: 0; /* Penting untuk nested scroll */
    }

    .kt-column {
      display:flex;
      flex-direction:column;
      flex: 1;
      min-height:0;
    }

    /* 3. CARD: Menjadi Flex Container */
    .kt-card {
      background:var(--bg-main);
      border:1px solid var(--border-soft);
      border-radius:6px;
      padding:0; /* Padding dipindah ke inner elements agar scroll rapi */
      display:flex;
      flex-direction:column;
      flex: 1; /* Card mengisi penuh kolom */
      min-height:0;
      overflow: hidden;
    }

    .kt-card-header {
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      font-size:var(--fs-subtitle);
      color:var(--text-main);
      border-bottom: 1px solid var(--border-soft);
      flex-shrink: 0; /* Header tidak boleh mengecil */
      background: var(--bg-main);
    }

    .kt-header-left {
      display:flex;
      flex-direction:column;
    }
    .kt-header-left #quotesTitle {
      font-weight: 700;
      color: var(--amber);
    }

    .kt-toolbar {
      display:flex;
      align-items:center;
      gap:8px;
    }

    .kt-search {
      display:flex;
      align-items:center;
      border-radius:4px;
      border:1px solid var(--border-soft);
      padding:4px 8px;
      background: #000;
      width: 180px;
    }

    .kt-search input {
      flex:1;
      border:none;
      outline:none;
      background:transparent;
      color:var(--text-main);
      font-size:var(--fs-small);
      min-width:0;
    }

    /* 4. SCROLLER AREA: Ini yang di-scroll */
    .kt-table-wrapper {
      flex:1;         /* Mengambil sisa tinggi card */
      overflow-y:auto; /* Scroll vertikal aktif DI SINI */
      overflow-x:hidden;
      background: var(--bg-main);
      position: relative;
    }

    /* Horizontal scroll untuk tabel lebar */
    .kt-table-scroller {
      width:100%;
      overflow-x:auto; 
    }

    table {
      width:100%;
      border-collapse:collapse;
      font-size:var(--fs-body);
      min-width: 800px; /* Lebar minimum tabel */
    }

    thead {
      position:sticky;
      top:0;
      background: #1a1a1a;
      z-index:10;
      box-shadow: 0 1px 0 var(--border-soft);
    }

    th, td {
      padding:8px 8px;
      text-align:right;
      white-space:nowrap;
      border-bottom: 1px solid #1f1f1f;
    }

    th {
      font-size:var(--fs-small);
      font-weight:500;
      color:var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    th:first-child, td:first-child { text-align:left; position:sticky; left:0; background:inherit; z-index:2; }
    th:nth-child(2), td:nth-child(2) { text-align:left; }

    /* Fix background untuk sticky column saat di hover */
    tbody tr:nth-child(even) td:first-child { background:#0d0d0d; }
    tbody tr:nth-child(odd) td:first-child { background:#090909; }
    tbody tr:hover td:first-child { background:#151515; }

    tbody tr:nth-child(even) { background:#0d0d0d; }
    tbody tr:nth-child(odd) { background:#090909; }
    tbody tr:hover { background:#151515; }

    .text-up { color:var(--green); }
    .text-down { color:var(--red); }

    .copy-btn {
      border-radius:4px;
      border:1px solid var(--border-soft);
      background:transparent;
      color:var(--text-muted);
      font-size:9px;
      padding:2px 6px;
      cursor:pointer;
      transition:0.2s;
    }
    .copy-btn:hover {
      border-color:var(--amber);
      color:var(--amber);
    }

    .spark-cell svg { display:block; }

    /* 5. MOBILE RESPONSIVE */
    @media (max-width:600px) {
      .kt-page {
        padding: 8px; /* Padding lebih tipis di mobile */
      }
      
      .kt-page-tabs {
        margin-bottom: 8px;
        gap: 6px;
      }
      
      .kt-pill-page {
        padding: 3px 10px;
        font-size: 10px;
      }

      .kt-card-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
        padding: 10px;
      }

      .kt-header-left {
        width: 100%;
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
      }

      .kt-toolbar {
        width: 100%;
      }
      
      .kt-search {
        width: 100%; /* Search full width di mobile */
      }

      th, td {
        padding: 6px 5px;
        font-size: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="kt-page">
    <div class="kt-page-tabs">
      <div class="kt-pill-page active" data-page="major">Major</div>
      <div class="kt-pill-page" data-page="minor">Minor</div>
      <div class="kt-pill-page" data-page="exotic">Exotic</div>
    </div>

    <div class="kt-layout">
      <div class="kt-column">
        <section class="kt-card">
          <header class="kt-card-header">
            <div class="kt-header-left">
              <div id="quotesTitle">Market Quotes</div>
              <div id="tickerMeta" class="subtitle" style="font-size:9px; color:var(--text-muted); display:none;"></div>
            </div>
            <div class="kt-toolbar">
              <div class="kt-search">
                <input id="searchInput" type="text" placeholder="Search Symbol...">
              </div>
            </div>
          </header>

          <div class="kt-table-wrapper">
            <div class="kt-table-scroller">
              <table id="fxTable">
                <thead>
                  <tr>
                    <th>Sym</th>
                    <th>Name</th>
                    <th>Trend (30D)</th>
                    <th>Last</th>
                    <th>Chg</th>
                    <th>%Chg</th>
                    <th>Open</th>
                    <th>High</th>
                    <th>Low</th>
                    <th>%YTD</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  </tbody>
              </table>
            </div>
          </div>
          </section>
      </div>
    </div>
  </div>

  <script>
    // ==========================
    //  CONFIG
    // ==========================
    const BASE_URL = "https://kuancloud.loclx.io";
    const INTERVAL = "1D";
    const BARS_COUNT = 30;
    const MAX_CONCURRENT = 3;
    const REFRESH_MS = 3000;

    const FX_CONFIG = {
      major: [
        { symbol:"EURUSD", name:"Euro", apiSymbol:"FX:EURUSD" },
        { symbol:"GBPUSD", name:"Pound", apiSymbol:"FX:GBPUSD" },
        { symbol:"USDJPY", name:"Yen", apiSymbol:"FX:USDJPY" },
        { symbol:"USDCHF", name:"Swissie", apiSymbol:"FX:USDCHF" },
        { symbol:"USDCAD", name:"Loonie", apiSymbol:"FX:USDCAD" },
        { symbol:"AUDUSD", name:"Aussie", apiSymbol:"FX:AUDUSD" },
        { symbol:"NZDUSD", name:"Kiwi", apiSymbol:"FX:NZDUSD" }
      ],
      minor: [
        { symbol:"EURGBP", name:"EUR/GBP", apiSymbol:"FX:EURGBP" },
        { symbol:"EURJPY", name:"EUR/JPY", apiSymbol:"FX:EURJPY" },
        { symbol:"GBPJPY", name:"GBP/JPY", apiSymbol:"FX:GBPJPY" },
        { symbol:"EURCHF", name:"EUR/CHF", apiSymbol:"FX:EURCHF" },
        { symbol:"EURCAD", name:"EUR/CAD", apiSymbol:"FX:EURCAD" },
        { symbol:"EURAUD", name:"EUR/AUD", apiSymbol:"FX:EURAUD" },
        { symbol:"EURNZD", name:"EUR/NZD", apiSymbol:"FX:EURNZD" },
        { symbol:"GBPCHF", name:"GBP/CHF", apiSymbol:"FX:GBPCHF" },
        { symbol:"GBPCAD", name:"GBP/CAD", apiSymbol:"FX:GBPCAD" },
        { symbol:"GBPAUD", name:"GBP/AUD", apiSymbol:"FX:GBPAUD" },
        { symbol:"GBPNZD", name:"GBP/NZD", apiSymbol:"FX:GBPNZD" },
        { symbol:"AUDCAD", name:"AUD/CAD", apiSymbol:"FX:AUDCAD" },
        { symbol:"AUDCHF", name:"AUD/CHF", apiSymbol:"FX:AUDCHF" },
        { symbol:"AUDJPY", name:"AUD/JPY", apiSymbol:"FX:AUDJPY" },
        { symbol:"AUDNZD", name:"AUD/NZD", apiSymbol:"FX:AUDNZD" },
        { symbol:"CADCHF", name:"CAD/CHF", apiSymbol:"FX:CADCHF" },
        { symbol:"CADJPY", name:"CAD/JPY", apiSymbol:"FX:CADJPY" },
        { symbol:"CHFJPY", name:"CHF/JPY", apiSymbol:"FX:CHFJPY" },
        { symbol:"NZDCAD", name:"NZD/CAD", apiSymbol:"FX:NZDCAD" },
        { symbol:"NZDCHF", name:"NZD/CHF", apiSymbol:"FX:NZDCHF" },
        { symbol:"NZDJPY", name:"NZD/JPY", apiSymbol:"FX:NZDJPY" }
      ],
      exotic: [
        { symbol:"USDTRY", name:"Lira", apiSymbol:"FX:USDTRY" },
        { symbol:"USDZAR", name:"Rand", apiSymbol:"FX:USDZAR" },
        { symbol:"USDMXN", name:"Peso", apiSymbol:"FX:USDMXN" },
        { symbol:"USDIDR", name:"Rupiah", apiSymbol:"FX:USDIDR" },
        { symbol:"USDINR", name:"Rupee", apiSymbol:"FX:USDINR" },
        { symbol:"USDCNH", name:"Yuan", apiSymbol:"FX:USDCNH" },
        { symbol:"USDSGD", name:"SGD", apiSymbol:"FX:USDSGD" },
        { symbol:"USDHKD", name:"HKD", apiSymbol:"FX:USDHKD" },
        { symbol:"EURTRY", name:"EUR/TRY", apiSymbol:"FX:EURTRY" },
        { symbol:"EURPLN", name:"Zloty", apiSymbol:"FX:EURPLN" }
      ]
    };

    // ==========================
    //  STATE
    // ==========================
    const tableBody = document.querySelector("#fxTable tbody");
    const searchInput = document.getElementById("searchInput");
    const quotesTitleEl = document.getElementById("quotesTitle");
    const tickerMetaEl = document.getElementById("tickerMeta");
    const pagePills = document.querySelectorAll(".kt-pill-page");
    const tableWrapper = document.querySelector(".kt-table-wrapper");

    let latestQuotes = [];
    let currentPage = "major";
    let isRefreshing = false;
    let refreshTimer = null;

    const datasets = { major: [], minor: [], exotic: [] };

    // ==========================
    //  UTIL
    // ==========================
    function sleep(ms) { return new Promise(res => setTimeout(res, ms)); }

    function formatNumber(value, isFx=false) {
      const num = Number(value);
      if (Number.isNaN(num)) return "";
      if (isFx) {
        if (Math.abs(num) >= 10) return num.toFixed(3); // Sedikit hemat tempat
        return num.toFixed(4); // Sedikit hemat tempat
      }
      return num.toFixed(2);
    }

    function formatSigned(value, isFx=false) {
      const num = Number(value);
      if (Number.isNaN(num)) return "";
      const decimals = isFx ? 4 : 2;
      if (num === 0) return "0.00";
      return (num > 0 ? "+" : "") + num.toFixed(decimals);
    }

    function copyTextToClipboard(text) {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).catch(() => {});
      } else {
        // Fallback simple
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
      }
    }

    function updateTickerMeta(count) {
      if (tickerMetaEl) {
        tickerMetaEl.style.display = "block";
        tickerMetaEl.textContent = `${count} Pairs`;
      }
    }

    function drawSparkline(cell, values) {
      if (!cell || !Array.isArray(values) || values.length < 2) return;
      cell.innerHTML = "";
      const w = 60, h = 20, pad = 2; // Sparkline lebih compact
      const min = Math.min(...values);
      const max = Math.max(...values);
      const range = (max - min) || 1;

      const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
      svg.setAttribute("width", w);
      svg.setAttribute("height", h);
      svg.setAttribute("viewBox", `0 0 ${w} ${h}`);

      let d = "";
      values.forEach((v, i) => {
        const x = pad + (i / (values.length - 1)) * (w - 2 * pad);
        const norm = (v - min) / range;
        const y = h - pad - norm * (h - 2 * pad);
        d += (i === 0 ? "M" : "L") + x + " " + y + " ";
      });

      const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
      path.setAttribute("d", d.trim());
      
      const first = values[0];
      const last = values[values.length - 1];
      let color = "#9b9b9b";
      if (last > first) color = "#22c55e";
      else if (last < first) color = "#ef4444";

      path.setAttribute("fill", "none");
      path.setAttribute("stroke", color);
      path.setAttribute("stroke-width", "1.5");
      svg.appendChild(path);
      cell.appendChild(svg);
    }

    // ==========================
    //  API LOGIC
    // ==========================
    async function fetchOhlcvWithRetry(apiSymbol) {
      // Simplified logic
      try {
        const url = `${BASE_URL}/api/tvohlc/ohlcv?symbol=${encodeURIComponent(apiSymbol)}&interval=${INTERVAL}&bars_count=${BARS_COUNT}`;
        const res = await fetch(url, { cache: "no-store" });
        if(!res.ok) throw new Error("Err");
        const json = await res.json();
        const r = (json.results || []).find(x => x.symbol === apiSymbol) || (json.results || [])[0];
        if(!r || !r.bars) throw new Error("No bars");
        return r.bars;
      } catch(e) {
        return null; 
      }
    }

    function buildRowFromBars(cfg, bars) {
      if(!bars) return { ...cfg, error:true };
      const last = bars[bars.length - 1];
      const prev = bars[bars.length - 2];
      const first = bars[0];
      const lastClose = Number(last.close);
      const prevClose = Number(prev.close);
      const chg = lastClose - prevClose;
      const chgPct = (chg / prevClose) * 100;
      const ytdPct = ((lastClose / Number(first.open)) - 1) * 100;

      return {
        ...cfg,
        open: Number(last.open),
        high: Number(last.high),
        low: Number(last.low),
        last: lastClose,
        close: lastClose,
        change: chg,
        changePct: chgPct,
        ytdPct: ytdPct,
        closes: bars.map(b => Number(b.close))
      };
    }

    async function loadCategoryData(pageKey) {
      const list = FX_CONFIG[pageKey] || [];
      const resultRows = [];
      
      // Batch processing to avoid hitting rate limits too hard
      let idx = 0;
      while(idx < list.length) {
        const slice = list.slice(idx, idx + MAX_CONCURRENT);
        const chunk = await Promise.all(slice.map(async item => {
          const bars = await fetchOhlcvWithRetry(item.apiSymbol);
          return buildRowFromBars(item, bars);
        }));
        resultRows.push(...chunk);
        idx += MAX_CONCURRENT;
        if(idx < list.length) await sleep(100);
      }
      datasets[pageKey] = resultRows;
    }

    // ==========================
    //  RENDER
    // ==========================
    function renderQuotesTable() {
      const filter = (searchInput.value || "").trim().toLowerCase();
      const scrollTop = tableWrapper.scrollTop; // Simpan posisi scroll

      tableBody.innerHTML = "";
      
      latestQuotes.filter(r => {
        if(r.error) return false;
        if(!filter) return true;
        return (r.symbol.toLowerCase().includes(filter) || r.name.toLowerCase().includes(filter));
      }).forEach(row => {
        const tr = document.createElement("tr");
        const isUp = row.changePct > 0;
        const isDown = row.changePct < 0;
        const isYtdUp = row.ytdPct > 0;
        const isYtdDown = row.ytdPct < 0;

        tr.innerHTML = `
          <td><span style="font-weight:700; color:#fff;">${row.symbol}</span></td>
          <td style="color:var(--text-muted)">${row.name}</td>
          <td class="spark-cell"></td>
          <td>${formatNumber(row.last, true)}</td>
          <td class="${isUp?"text-up":isDown?"text-down":""}">${formatSigned(row.change, true)}</td>
          <td class="${isUp?"text-up":isDown?"text-down":""}">${formatSigned(row.changePct, false)}%</td>
          <td>${formatNumber(row.open, true)}</td>
          <td>${formatNumber(row.high, true)}</td>
          <td>${formatNumber(row.low, true)}</td>
          <td class="${isYtdUp?"text-up":isYtdDown?"text-down":""}">${formatSigned(row.ytdPct, false)}%</td>
          <td></td>
        `;

        drawSparkline(tr.querySelector(".spark-cell"), row.closes);

        // Action Btn
        const btn = document.createElement("button");
        btn.className = "copy-btn";
        btn.textContent = "COPY";
        btn.onclick = () => copyTextToClipboard(`${row.symbol} Price: ${row.last}`);
        tr.lastElementChild.appendChild(btn);

        tableBody.appendChild(tr);
      });
      
      tableWrapper.scrollTop = scrollTop; // Kembalikan posisi scroll
    }

    function switchPage(key) {
      currentPage = key;
      pagePills.forEach(p => {
        p.classList.toggle("active", p.dataset.page === key);
      });
      quotesTitleEl.textContent = key === 'major' ? 'Major Pairs' : key === 'minor' ? 'Minor/Cross' : 'Exotic Pairs';
      latestQuotes = datasets[key] || [];
      renderQuotesTable();
      updateTickerMeta(latestQuotes.length);
      refreshCurrentPage();
    }

    async function refreshCurrentPage() {
      if(isRefreshing) return;
      isRefreshing = true;
      await loadCategoryData(currentPage);
      latestQuotes = datasets[currentPage];
      renderQuotesTable();
      updateTickerMeta(latestQuotes.length);
      isRefreshing = false;
    }

    // INIT
    pagePills.forEach(p => p.onclick = () => switchPage(p.dataset.page));
    searchInput.oninput = renderQuotesTable;
    
    // Start
    switchPage("major");
    setInterval(refreshCurrentPage, REFRESH_MS);

  </script>
</body>
</html>
