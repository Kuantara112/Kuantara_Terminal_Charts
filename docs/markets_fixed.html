<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Kuantara â€“ Fixed Income Market Snapshot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;700&display=swap">

  <style>
    :root {
      --amber:#ffbf00;
      --bg-root:#000000;
      --bg-main:#111111;
      --border-soft:#2b2b2b;
      --text-main:#f5f5f5;
      --text-muted:#9b9b9b;

      --fs-title:14px;
      --fs-subtitle:12px;
      --fs-body:11px;
      --fs-small:9.5px;

      --green:#22c55e;
      --red:#ef4444;
    }

    * {
      box-sizing:border-box;
      margin:0;
      padding:0;
      font-family:"Fira Code",monospace !important;
      scrollbar-width:thin;
      scrollbar-color:rgba(255,255,255,0.2) transparent;
    }

    html, body {
      width:100%;
      height:100%;
      background:var(--bg-root);
      color:var(--text-main);
      overflow:hidden;
    }

    ::-webkit-scrollbar {
      width:4px;
      height:4px;
    }
    ::-webkit-scrollbar-track {
      background:transparent;
    }
    ::-webkit-scrollbar-thumb {
      background:rgba(255,255,255,0.2);
      border-radius:999px;
    }

    .kt-page {
      height: 100%;
      display: flex;
      flex-direction: column;
      padding:16px;
      background:var(--bg-root);
      overflow: hidden;
    }

    .kt-page-tabs {
      display:flex;
      gap:8px;
      margin-bottom:10px;
      flex-shrink: 0;
      flex-wrap:wrap;
    }

    .kt-pill-page {
      border-radius:999px;
      border:1px solid var(--border-soft);
      padding:4px 12px;
      font-size:var(--fs-small);
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
      color:var(--text-muted);
      background:#050505;
      transition:background 0.15s ease, color 0.15s ease;
    }
    .kt-pill-page.active {
      border-color:var(--amber);
      color:#000;
      background:var(--amber);
      font-weight:700;
    }

    .kt-layout {
      display:flex;
      flex-direction:column;
      flex:1;
      min-height:0;
    }

    .kt-column {
      display:flex;
      flex-direction:column;
      flex:1;
      min-height:0;
    }

    .kt-card {
      background:var(--bg-main);
      border:1px solid var(--border-soft);
      border-radius:6px;
      padding:0;
      display:flex;
      flex-direction:column;
      flex:1;
      min-height:0;
      overflow:hidden;
    }

    .kt-card-header {
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      font-size:var(--fs-subtitle);
      color:var(--text-main);
      border-bottom:1px solid var(--border-soft);
      flex-shrink:0;
      background:var(--bg-main);
    }

    .kt-header-left {
      display:flex;
      flex-direction:column;
    }
    .kt-header-left #quotesTitle {
      font-weight:700;
      color:var(--amber);
    }

    .kt-toolbar {
      display:flex;
      align-items:center;
      gap:8px;
    }

    .kt-search {
      display:flex;
      align-items:center;
      border-radius:4px;
      border:1px solid var(--border-soft);
      padding:4px 8px;
      background:#000;
      width:180px;
    }

    .kt-search input {
      flex:1;
      border:none;
      outline:none;
      background:transparent;
      color:var(--text-main);
      font-size:var(--fs-small);
      min-width:0;
    }

    .kt-table-wrapper {
      flex:1;
      overflow-y:auto;
      overflow-x:hidden;
      background:var(--bg-main);
      position:relative;
    }

    .kt-table-scroller {
      width:100%;
      overflow-x:auto;
    }

    table {
      width:100%;
      border-collapse:collapse;
      font-size:var(--fs-body);
      min-width:800px;
    }

    thead {
      position:sticky;
      top:0;
      background:#1a1a1a;
      z-index:10;
      box-shadow:0 1px 0 var(--border-soft);
    }

    th, td {
      padding:8px 8px;
      text-align:right;
      white-space:nowrap;
      border-bottom:1px solid #1f1f1f;
    }

    th {
      font-size:var(--fs-small);
      font-weight:500;
      color:var(--text-muted);
      text-transform:uppercase;
      letter-spacing:0.5px;
    }

    th:first-child, td:first-child {
      text-align:left;
      position:sticky;
      left:0;
      background:inherit;
      z-index:2;
    }
    th:nth-child(2), td:nth-child(2) {
      text-align:left;
    }

    tbody tr:nth-child(even) td:first-child { background:#0d0d0d; }
    tbody tr:nth-child(odd) td:first-child { background:#090909; }
    tbody tr:hover td:first-child { background:#151515; }

    tbody tr:nth-child(even) { background:#0d0d0d; }
    tbody tr:nth-child(odd) { background:#090909; }
    tbody tr:hover { background:#151515; }

    .text-up { color:var(--green); }
    .text-down { color:var(--red); }

    .copy-btn {
      border-radius:4px;
      border:1px solid var(--border-soft);
      background:transparent;
      color:var(--text-muted);
      font-size:9px;
      padding:2px 6px;
      cursor:pointer;
      transition:0.2s;
    }
    .copy-btn:hover {
      border-color:var(--amber);
      color:var(--amber);
    }

    .spark-cell svg { display:block; }

    @media (max-width:600px) {
      .kt-page { padding:8px; }
      .kt-page-tabs { margin-bottom:8px; gap:6px; }
      .kt-pill-page { padding:3px 10px; font-size:10px; }

      .kt-card-header {
        flex-direction:column;
        align-items:flex-start;
        gap:8px;
        padding:10px;
      }

      .kt-header-left {
        width:100%;
        flex-direction:row;
        justify-content:space-between;
        align-items:center;
      }

      .kt-toolbar { width:100%; }
      .kt-search { width:100%; }

      th, td {
        padding:6px 5px;
        font-size:10px;
      }
    }
  </style>
</head>
<body>
  <div class="kt-page">
    <div class="kt-page-tabs">
      <div class="kt-pill-page active" data-page="bonds">Bonds</div>
      <div class="kt-pill-page" data-page="rates">Rates</div>
      <div class="kt-pill-page" data-page="credits">Credits</div>
    </div>

    <div class="kt-layout">
      <div class="kt-column">
        <section class="kt-card">
          <header class="kt-card-header">
            <div class="kt-header-left">
              <div id="quotesTitle">Government Bonds</div>
              <div id="tickerMeta" class="subtitle" style="font-size:9px; color:var(--text-muted); display:none;"></div>
            </div>
            <div class="kt-toolbar">
              <div class="kt-search">
                <input id="searchInput" type="text" placeholder="Search Symbol...">
              </div>
            </div>
          </header>

          <div class="kt-table-wrapper">
            <div class="kt-table-scroller">
              <table id="fiTable">
                <thead>
                  <tr>
                    <th>Sym</th>
                    <th>Name</th>
                    <th>Trend (30D)</th>
                    <th>Last</th>
                    <th>Chg</th>
                    <th>%Chg</th>
                    <th>Open</th>
                    <th>High</th>
                    <th>Low</th>
                    <th>%YTD</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <script>
    // ==========================
    //  CONFIG
    // ==========================
    const BASE_URL   = "http://kuancloud.loclx.io";
    const INTERVAL   = "1D";
    const BARS_COUNT = 30;
    const MAX_CONCURRENT = 3;
    const REFRESH_MS = 3000;

    const FI_CONFIG = {
      bonds: [
        { symbol:"US10Y", name:"US 10Y Treasury Yield",  apiSymbol:"TVC:US10Y" },
        { symbol:"US02Y", name:"US 2Y Treasury Yield",   apiSymbol:"TVC:US02Y" },
        { symbol:"US30Y", name:"US 30Y Treasury Yield",  apiSymbol:"TVC:US30Y" },
        { symbol:"DE10Y", name:"Germany 10Y Bund",       apiSymbol:"TVC:DE10Y" },
        { symbol:"UK10Y", name:"UK 10Y Gilt",            apiSymbol:"TVC:UK10Y" },
        { symbol:"JP10Y", name:"Japan 10Y JGB",          apiSymbol:"TVC:JP10Y" },
        { symbol:"IT10Y", name:"Italy 10Y BTP",          apiSymbol:"TVC:IT10Y" }
      ],
      rates: [
        { symbol:"ZQ1!",  name:"Fed Funds Futures",      apiSymbol:"CBOT:ZQ1!" },
        { symbol:"ZF1!",  name:"US 5Y Note Futures",     apiSymbol:"CBOT:ZF1!" },
        { symbol:"ZN1!",  name:"US 10Y Note Futures",    apiSymbol:"CBOT:ZN1!" },
        { symbol:"ZB1!",  name:"US 30Y Bond Futures",    apiSymbol:"CBOT:ZB1!" },
        { symbol:"FGBL1!",name:"Euro Bund Futures",      apiSymbol:"EUREX:FGBL1!" },
        { symbol:"FGBM1!",name:"Euro Bobl Futures",      apiSymbol:"EUREX:FGBM1!" },
        { symbol:"FGBS1!",name:"Euro Schatz Futures",    apiSymbol:"EUREX:FGBS1!" }
      ],
      credits: [
        { symbol:"HYG",   name:"US High Yield ETF",      apiSymbol:"AMEX:HYG" },
        { symbol:"JNK",   name:"US HY Corp Bond ETF",    apiSymbol:"AMEX:JNK" },
        { symbol:"LQD",   name:"US Investment Grade ETF",apiSymbol:"NYSE:LQD" },
        { symbol:"EMB",   name:"EM Sovereign Bond ETF",  apiSymbol:"AMEX:EMB" },
        { symbol:"IGOV",  name:"Intl Gov Bond ETF",      apiSymbol:"NASDAQ:IGOV" },
        { symbol:"HYS",   name:"Short-Term HY ETF",      apiSymbol:"AMEX:HYS" },
        { symbol:"IHY",   name:"Intl High Yield ETF",    apiSymbol:"AMEX:IHY" }
      ]
    };

    // ==========================
    //  STATE
    // ==========================
    const tableBody   = document.querySelector("#fiTable tbody");
    const searchInput = document.getElementById("searchInput");
    const quotesTitleEl = document.getElementById("quotesTitle");
    const tickerMetaEl  = document.getElementById("tickerMeta");
    const pagePills     = document.querySelectorAll(".kt-pill-page");
    const tableWrapper  = document.querySelector(".kt-table-wrapper");

    let latestQuotes = [];
    let currentPage  = "bonds";
    let isRefreshing = false;

    const datasets = { bonds: [], rates: [], credits: [] };

    // ==========================
    //  UTIL
    // ==========================
    function sleep(ms){ return new Promise(res => setTimeout(res, ms)); }

    function formatNumber(value){
      const num = Number(value);
      if (Number.isNaN(num)) return "-";
      if (Math.abs(num) >= 1000) return num.toFixed(1);
      if (Math.abs(num) >= 10)   return num.toFixed(2);
      return num.toFixed(3);
    }

    function formatSigned(value){
      const num = Number(value);
      if (Number.isNaN(num)) return "-";
      if (num === 0) return "0.00";
      return (num > 0 ? "+" : "") + num.toFixed(2);
    }

    function copyTextToClipboard(text){
      if (navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(text).catch(()=>{});
      } else {
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
      }
    }

    function updateTickerMeta(count){
      if (!tickerMetaEl) return;
      tickerMetaEl.style.display = "block";
      tickerMetaEl.textContent = `${count} Instruments`;
    }

    function drawSparkline(cell, values){
      if (!cell || !Array.isArray(values) || values.length < 2) return;
      cell.innerHTML = "";
      const w = 60, h = 20, pad = 2;
      const min = Math.min(...values);
      const max = Math.max(...values);
      const range = (max - min) || 1;

      const svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
      svg.setAttribute("width", w);
      svg.setAttribute("height", h);
      svg.setAttribute("viewBox", `0 0 ${w} ${h}`);

      let d = "";
      values.forEach((v,i)=>{
        const x = pad + (i/(values.length-1))*(w-2*pad);
        const norm = (v-min)/range;
        const y = h - pad - norm*(h-2*pad);
        d += (i===0?"M":"L") + x + " " + y + " ";
      });

      const path = document.createElementNS("http://www.w3.org/2000/svg","path");
      path.setAttribute("d", d.trim());

      const first = values[0];
      const last  = values[values.length-1];
      let color = "#9b9b9b";
      if (last > first) color = "#22c55e";
      else if (last < first) color = "#ef4444";

      path.setAttribute("fill","none");
      path.setAttribute("stroke",color);
      path.setAttribute("stroke-width","1.5");
      svg.appendChild(path);
      cell.appendChild(svg);
    }

    // ==========================
    //  API
    // ==========================
    async function fetchOhlcvWithRetry(apiSymbol){
      try{
        const url = `${BASE_URL}/api/tvohlc/ohlcv?symbol=${encodeURIComponent(apiSymbol)}&interval=${INTERVAL}&bars_count=${BARS_COUNT}`;
        const res = await fetch(url,{ cache:"no-store" });
        if (!res.ok) throw new Error("HTTP error");
        const json = await res.json();
        const r = (json.results || []).find(x => x.symbol === apiSymbol) || (json.results || [])[0];
        if (!r || !r.bars) throw new Error("No bars");
        return r.bars;
      }catch(e){
        return null;
      }
    }

    function buildRowFromBars(cfg, bars){
      if (!bars || !Array.isArray(bars) || bars.length < 2){
        return { ...cfg, error:true };
      }
      const last  = bars[bars.length-1];
      const prev  = bars[bars.length-2];
      const first = bars[0];

      const lastClose = Number(last.close);
      const prevClose = Number(prev.close);

      const chg    = lastClose - prevClose;
      const chgPct = (chg / prevClose) * 100;
      const ytdPct = ((lastClose / Number(first.open)) - 1) * 100;

      return {
        ...cfg,
        open:  Number(last.open),
        high:  Number(last.high),
        low:   Number(last.low),
        last:  lastClose,
        close: lastClose,
        change: chg,
        changePct: chgPct,
        ytdPct: ytdPct,
        closes: bars.map(b => Number(b.close)),
        error:false
      };
    }

    async function loadCategoryData(pageKey){
      const list = FI_CONFIG[pageKey] || [];
      const resultRows = [];

      let idx = 0;
      while (idx < list.length){
        const slice = list.slice(idx, idx + MAX_CONCURRENT);
        const chunk = await Promise.all(
          slice.map(async item=>{
            const bars = await fetchOhlcvWithRetry(item.apiSymbol);
            return buildRowFromBars(item, bars);
          })
        );
        resultRows.push(...chunk);
        idx += MAX_CONCURRENT;
        if (idx < list.length) await sleep(100);
      }
      datasets[pageKey] = resultRows;
    }

    // ==========================
    //  RENDER
    // ==========================
    function renderQuotesTable(){
      const filter = (searchInput.value || "").trim().toLowerCase();
      const scrollTop = tableWrapper.scrollTop;

      tableBody.innerHTML = "";

      latestQuotes
        .filter(r=>{
          if (!filter) return true;
          return (
            r.symbol.toLowerCase().includes(filter) ||
            r.name.toLowerCase().includes(filter)
          );
        })
        .forEach(row=>{
          const tr = document.createElement("tr");

          const isUp      = !row.error && row.changePct > 0;
          const isDown    = !row.error && row.changePct < 0;
          const isYtdUp   = !row.error && row.ytdPct > 0;
          const isYtdDown = !row.error && row.ytdPct < 0;

          const lastText  = row.error ? "-" : formatNumber(row.last);
          const chgText   = row.error ? "-" : formatSigned(row.change);
          const chgPctTxt = row.error ? "-" : (formatSigned(row.changePct) + "%");
          const openText  = row.error ? "-" : formatNumber(row.open);
          const highText  = row.error ? "-" : formatNumber(row.high);
          const lowText   = row.error ? "-" : formatNumber(row.low);
          const ytdText   = row.error ? "-" : (formatSigned(row.ytdPct) + "%");

          tr.innerHTML = `
            <td><span style="font-weight:700; color:#fff;">${row.symbol}</span></td>
            <td style="color:var(--text-muted)">${row.name}${row.error ? " (no data)" : ""}</td>
            <td class="spark-cell"></td>
            <td>${lastText}</td>
            <td class="${isUp?"text-up":isDown?"text-down":""}">${chgText}</td>
            <td class="${isUp?"text-up":isDown?"text-down":""}">${chgPctTxt}</td>
            <td>${openText}</td>
            <td>${highText}</td>
            <td>${lowText}</td>
            <td class="${isYtdUp?"text-up":isYtdDown?"text-down":""}">${ytdText}</td>
            <td></td>
          `;

          if (!row.error && row.closes && row.closes.length > 1){
            drawSparkline(tr.querySelector(".spark-cell"), row.closes);
          }

          const btn = document.createElement("button");
          btn.className = "copy-btn";
          btn.textContent = "COPY";
          const copyVal = row.error ? "" : row.last;
          btn.onclick = () => copyTextToClipboard(`${row.symbol} Last: ${copyVal}`);
          tr.lastElementChild.appendChild(btn);

          tableBody.appendChild(tr);
        });

      tableWrapper.scrollTop = scrollTop;
    }

    async function refreshCurrentPage(){
      if (isRefreshing) return;
      isRefreshing = true;
      await loadCategoryData(currentPage);
      latestQuotes = datasets[currentPage] || [];
      renderQuotesTable();
      updateTickerMeta(latestQuotes.length);
      isRefreshing = false;
    }

    function switchPage(key){
      currentPage = key;
      pagePills.forEach(p=>{
        p.classList.toggle("active", p.dataset.page === key);
      });

      if (key === "bonds")      quotesTitleEl.textContent = "Government Bonds";
      else if (key === "rates") quotesTitleEl.textContent = "Rates & Futures";
      else                      quotesTitleEl.textContent = "Credit & HY/IG";

      latestQuotes = datasets[key] || [];
      renderQuotesTable();
      updateTickerMeta(latestQuotes.length);
      refreshCurrentPage();
    }

    // INIT
    pagePills.forEach(p => p.onclick = () => switchPage(p.dataset.page));
    searchInput.oninput = renderQuotesTable;

    switchPage("bonds");
    setInterval(refreshCurrentPage, REFRESH_MS);
  </script>
</body>
</html>